{"version":3,"file":"index.mjs","sources":["../src/modules/config.js","../src/modules/misc.js","../src/modules/enums.js","../src/modules/constants.js","../src/modules/error-manager.js","../src/modules/users.js","../src/modules/remotecall.js","../src/modules/chat/chat-manager.js","../src/modules/icons.js","../src/modules/common/checkbars.js","../src/modules/app/gm-anarchy.js","../src/modules/app/handle-drag.js","../src/modules/app/gm-difficulty.js","../src/modules/app/gm-manager.js","../src/modules/attribute-actions.js","../src/modules/matrix-helper.js","../src/modules/modifiers/modifiers.js","../src/modules/roll/dice-cursor.js","../src/modules/actor/character-actor-essence.js","../src/modules/hooks-manager.js","../src/modules/roll/roll-parameters.js","../src/modules/roll/roll-dialog.js","../src/modules/skills.js","../src/modules/actor/actor-damage.js","../src/modules/actor/base-actor.js","../src/modules/confirmation.js","../src/modules/dialog/select-actor.js","../src/modules/actor/anarchy-actor-sheet.js","../src/modules/actor/character-base-sheet.js","../src/modules/actor/character-enhanced-sheet.js","../src/modules/damage.js","../src/modules/grammar.js","../src/modules/item/anarchy-base-item.js","../src/modules/item/skill-item.js","../src/modules/item/weapon-item.js","../src/modules/handlebars-manager.js","../src/modules/styles.js","../src/modules/theme-utilities.js","../src/modules/ui-customization.js","../src/modules/ui-customization-dialog.js","../src/modules/ui-customization-commands.js","../src/modules/performance-optimizer.js","../src/modules/roll/dice.js","../src/modules/roll/anarchy-roll.js","../src/modules/migrations.js","../src/modules/dialog/roll-celebrity.js","../src/modules/actor/character-actor.js","../src/modules/actor/device-actor.js","../src/modules/actor/vehicle-actor.js","../src/modules/actor/character-sheet.js","../src/modules/actor/device-sheet.js","../src/modules/actor/vehicle-sheet.js","../src/modules/actor/character-npc-sheet.js","../src/modules/item/metatype-item.js","../src/modules/item/cyberdeck-item.js","../src/modules/item/base-item-sheet.js","../src/modules/item/contact-item-sheet.js","../src/modules/item/cyberdeck-item-sheet.js","../src/modules/item/gear-item-sheet.js","../src/modules/item/metatype-item-sheet.js","../src/modules/item/quality-item-sheet.js","../src/modules/item/shadowamp-item-sheet.js","../src/modules/item/skill-item-sheet.js","../src/modules/item/weapon-item-sheet.js","../src/modules/item/contact-item.js","../src/modules/item/gear-item.js","../src/modules/item/quality-item.js","../src/modules/item/shadowamp-item.js","../src/modules/app/gm-convergence.js","../src/modules/anarchy-combat.js","../src/modules/actor/ic-sheet.js","../src/modules/actor/sprite-sheet.js","../src/modules/actor/sprite-actor.js","../src/modules/actor/ic-actor.js","../src/modules/token/hud-shortcuts.js","../src/modules/token/tokens.js","../src/modules/roll/roll-manager.js","../src/modules/combat/combat-manager.js","../src/modules/actor/character-tabbed-sheet.js","../src/integrations/index.js","../src/modules/anarchy-system.js","../src/start.js"],"sourcesContent":["export const ANARCHY = {\n  TYPES: {\n    Actor: {\n      character: 'TYPES.Actor.character',\n      vehicle: 'TYPES.Actor.vehicle',\n      device: 'TYPES.Actor.device',\n      sprite: 'TYPES.Actor.sprite',\n      ic: 'TYPES.Actor.ic',\n    },\n    Item: {\n      contact: 'TYPES.Item.contact',\n      cyberdeck: 'TYPES.Item.cyberdeck',\n      gear: 'TYPES.Item.gear',\n      metatype: 'TYPES.Item.metatype',\n      quality: 'TYPES.Item.quality',\n      shadowamp: 'TYPES.Item.shadowamp',\n      skill: 'TYPES.Item.skill',\n      weapon: 'TYPES.Item.weapon',\n    },\n  },\n  settings: {\n    defaultCssClass: {\n      name: 'ANARCHY.settings.defaultCssClass.name',\n      hint: 'ANARCHY.settings.defaultCssClass.hint',\n    },\n    anarchyHack: {\n      name: 'ANARCHY.settings.anarchyHack.name',\n      hint: 'ANARCHY.settings.anarchyHack.hint',\n    },\n    skillSet: {\n      name: 'ANARCHY.settings.skillSet.name',\n      hint: 'ANARCHY.settings.skillSet.hint',\n    },\n    gmDifficulty: {\n      name: 'ANARCHY.settings.gmDifficulty.name',\n      hint: 'ANARCHY.settings.gmDifficulty.hint',\n      default: 'ANARCHY.settings.gmDifficulty.default',\n      chatMessage: 'ANARCHY.settings.gmDifficulty.chatMessage',\n    },\n    damageMode: {\n      name: 'ANARCHY.settings.damageMode.name',\n      hint: 'ANARCHY.settings.damageMode.hint',\n      values: {\n        resistanceArmorMonitor: 'ANARCHY.settings.damageMode.values.resistanceArmorMonitor',\n        armorResistanceMonitor: 'ANARCHY.settings.damageMode.values.armorResistanceMonitor',\n        armorGivesResistance: 'ANARCHY.settings.damageMode.values.armorGivesResistance',\n        armorGiveResistanceHitsAvoid:\n          'ANARCHY.settings.damageMode.values.armorGiveResistanceHitsAvoid',\n      },\n    },\n    anarchyFirstMode: {\n      name: 'ANARCHY.settings.anarchyFirstMode.name',\n      hint: 'ANARCHY.settings.anarchyFirstMode.hint',\n    },\n    allowCoreFallback: {\n      name: 'ANARCHY.settings.allowCoreFallback.name',\n      hint: 'ANARCHY.settings.allowCoreFallback.hint',\n    },\n    preferCoreSheets: {\n      name: 'ANARCHY.settings.preferCoreSheets.name',\n      hint: 'ANARCHY.settings.preferCoreSheets.hint',\n    },\n  },\n  gmManager: {\n    title: 'ANARCHY.gmManager.title',\n    playerChangedAnarchy: 'ANARCHY.gmManager.playerChangedAnarchy',\n    gmReceivedAnarchy: 'ANARCHY.gmManager.gmReceivedAnarchy',\n    gmConvergence: 'ANARCHY.gmManager.gmConvergence',\n  },\n  chat: {\n    blindMessageToGM: 'ANARCHY.chat.blindMessageToGM',\n    sufferedDrain: 'ANARCHY.chat.sufferedDrain',\n    noDrain: 'ANARCHY.chat.noDrain',\n    defendAttack: 'ANARCHY.chat.defendAttack',\n    defendPilotAttack: 'ANARCHY.chat.defendPilotAttack',\n    partiallyDefended: 'ANARCHY.chat.partiallyDefended',\n    fullyDefended: 'ANARCHY.chat.fullyDefended',\n    applyDamage: 'ANARCHY.chat.applyDamage',\n  },\n  user: {\n    selectedTokenActors: 'ANARCHY.user.selectedTokenActors',\n  },\n  common: {\n    newEntry: 'ANARCHY.common.newEntry',\n    newName: 'ANARCHY.common.newName',\n    cancel: 'ANARCHY.common.cancel',\n    add: 'ANARCHY.common.add',\n    edit: 'ANARCHY.common.edit',\n    activate: 'ANARCHY.common.activate',\n    del: 'ANARCHY.common.del',\n    favorite: 'ANARCHY.common.favorite',\n    addFavorite: 'ANARCHY.common.addFavorite',\n    delFavorite: 'ANARCHY.common.delFavorite',\n    attach: 'ANARCHY.common.attach',\n    attachCopy: 'ANARCHY.common.attachCopy',\n    matrix: {\n      connectionMode: 'ANARCHY.common.matrix.connectionMode',\n    },\n    roll: {\n      button: 'ANARCHY.common.roll.button',\n      title: 'ANARCHY.common.roll.title',\n      attribute: 'ANARCHY.common.roll.attribute',\n      attribute2: 'ANARCHY.common.roll.attribute2',\n      modifiers: {\n        edge: 'ANARCHY.common.roll.modifiers.edge',\n        specialization: 'ANARCHY.common.roll.modifiers.specialization',\n        poolModifiers: 'ANARCHY.common.roll.modifiers.poolModifiers',\n        social: {\n          credibility: 'ANARCHY.common.roll.modifiers.social.credibility',\n          rumor: 'ANARCHY.common.roll.modifiers.social.rumor',\n        },\n        anarchyDisposition: 'ANARCHY.common.roll.modifiers.anarchyDisposition',\n        anarchyRisk: 'ANARCHY.common.roll.modifiers.anarchyRisk',\n        glitch: 'ANARCHY.common.roll.modifiers.glitch',\n        drain: 'ANARCHY.common.roll.modifiers.drain',\n        convergence: 'ANARCHY.common.roll.modifiers.convergence',\n        wounds: 'ANARCHY.common.roll.modifiers.wounds',\n        weaponRange: 'ANARCHY.common.roll.modifiers.weaponRange',\n        weaponArea: 'ANARCHY.common.roll.modifiers.weaponArea',\n        other: 'ANARCHY.common.roll.modifiers.other',\n        virtualReality: 'ANARCHY.common.roll.modifiers.virtualReality',\n        reduced: 'ANARCHY.common.roll.modifiers.reduced',\n        reroll: 'ANARCHY.common.roll.modifiers.reroll',\n        rerollForced: 'ANARCHY.common.roll.modifiers.rerollForced',\n        opponentReroll: 'ANARCHY.common.roll.modifiers.opponentReroll',\n        opponentPool: 'ANARCHY.common.roll.modifiers.opponentPool',\n      },\n      rollTheme: {\n        dicePool: 'ANARCHY.common.roll.rollTheme.dicePool',\n        reroll: 'ANARCHY.common.roll.rollTheme.reroll',\n        removed: 'ANARCHY.common.roll.rollTheme.removed',\n        rerollRemoved: 'ANARCHY.common.roll.rollTheme.rerollRemoved',\n        glitch: 'ANARCHY.common.roll.rollTheme.glitch',\n        drain: 'ANARCHY.common.roll.rollTheme.drain',\n        convergence: 'ANARCHY.common.roll.rollTheme.convergence',\n        anarchyRisk: 'ANARCHY.common.roll.rollTheme.anarchyRisk',\n      },\n      opponentRoll: 'ANARCHY.common.roll.opponentRoll',\n      totalSuccess: 'ANARCHY.common.roll.totalSuccess',\n      success: 'ANARCHY.common.roll.success',\n      risk: {\n        prowess: 'ANARCHY.common.roll.risk.prowess',\n        nothing: 'ANARCHY.common.roll.risk.nothing',\n        mixed: 'ANARCHY.common.roll.risk.mixed',\n        glitch: 'ANARCHY.common.roll.risk.glitch',\n      },\n      rerollSuccess: 'ANARCHY.common.roll.rerollSuccess',\n      rerollForcedLoss: 'ANARCHY.common.roll.rerollForcedLoss',\n      rerollForcedSuccess: 'ANARCHY.common.roll.rerollForcedSuccess',\n    },\n    confirmation: {\n      del: 'ANARCHY.common.confirmation.del',\n      delItem: 'ANARCHY.common.confirmation.delItem',\n      delOwner: 'ANARCHY.common.confirmation.delOwner',\n      attach: 'ANARCHY.common.confirmation.attach',\n      attachOrCopy: 'ANARCHY.common.confirmation.attachOrCopy',\n    },\n    selection: {\n      actorSettingMarks: 'ANARCHY.common.selection.actorSettingMarks',\n    },\n    errors: {\n      insufficient: 'ANARCHY.common.errors.insufficient',\n      outOfRange: 'ANARCHY.common.errors.outOfRange',\n      onlyGM: 'ANARCHY.common.errors.onlyGM',\n      noEdgeForActor: 'ANARCHY.common.errors.noEdgeForActor',\n      expectedType: 'ANARCHY.common.errors.expectedType',\n      ignoredTargets: 'ANARCHY.common.errors.ignoredTargets',\n      noTargetSelected: 'ANARCHY.common.errors.noTargetSelected',\n      maxTargetsExceedeed: 'ANARCHY.common.errors.maxTargetsExceedeed',\n      noDefenseOnWeapon: 'ANARCHY.common.errors.noDefenseOnWeapon',\n      noTokenActor: 'ANARCHY.common.errors.noTokenActor',\n      noValidPilotForVehicle: 'ANARCHY.common.errors.noValidPilotForVehicle',\n      cannotUseEdgeAnymore: 'ANARCHY.common.errors.cannotUseEdgeAnymore',\n      actorCannotApplyDamage: 'ANARCHY.common.errors.actorCannotApplyDamage',\n      actorCannotReceiveDamage: 'ANARCHY.common.errors.actorCannotReceiveDamage',\n      actorDoesNotHaveDefense: 'ANARCHY.common.errors.actorDoesNotHaveDefense',\n    },\n    sourceReference: 'ANARCHY.common.sourceReference',\n    sourceReferenceHelp: 'ANARCHY.common.sourceReferenceHelp',\n    description: 'ANARCHY.common.description',\n    gmnotes: 'ANARCHY.common.gmnotes',\n  },\n  actor: {\n    characterSheet: 'ANARCHY.actor.characterSheet',\n    characterTabbedSheet: 'ANARCHY.actor.characterTabbedSheet',\n    characterEnhancedSheet: 'ANARCHY.actor.characterEnhancedSheet',\n    vehicleSheet: 'ANARCHY.actor.vehicleSheet',\n    deviceSheet: 'ANARCHY.actor.deviceSheet',\n    spriteSheet: 'ANARCHY.actor.spriteSheet',\n    icSheet: 'ANARCHY.actor.icSheet',\n    characterNPCSheet: 'ANARCHY.actor.characterNPCSheet',\n    actorName: 'ANARCHY.actor.actorName',\n    genre: 'ANARCHY.actor.genre',\n    noMetatype: 'ANARCHY.actor.noMetatype',\n    celebrity: 'ANARCHY.actor.celebrity',\n    tabs: {\n      main: 'ANARCHY.actor.tabs.main',\n      equipment: 'ANARCHY.actor.tabs.equipment',\n      biography: 'ANARCHY.actor.tabs.biography',\n    },\n    words: {\n      keywords: 'ANARCHY.actor.words.keywords',\n      cues: 'ANARCHY.actor.words.cues',\n      dispositions: 'ANARCHY.actor.words.dispositions',\n    },\n    essence: {\n      adjustments: 'ANARCHY.actor.essence.adjustments',\n      adjustShort: 'ANARCHY.actor.essence.adjustShort',\n    },\n    counters: {\n      essence: 'ANARCHY.actor.counters.essence',\n      karma: 'ANARCHY.actor.counters.karma',\n      karmaTotal: 'ANARCHY.actor.counters.karmaTotal',\n      edge: 'ANARCHY.actor.counters.edge',\n      anarchy: 'ANARCHY.actor.counters.anarchy',\n      sceneAnarchy: 'ANARCHY.actor.counters.sceneAnarchy',\n      plot: 'ANARCHY.actor.counters.plot',\n      social: {\n        credibility: 'ANARCHY.actor.counters.social.credibility',\n        rumor: 'ANARCHY.actor.counters.social.rumor',\n      },\n    },\n    monitors: {\n      conditionMonitors: 'ANARCHY.actor.monitors.conditionMonitors',\n      overflow: 'ANARCHY.actor.monitors.overflow',\n      noMatrixMonitor: 'ANARCHY.actor.monitors.noMatrixMonitor',\n      physical: 'ANARCHY.actor.monitors.physical',\n      stun: 'ANARCHY.actor.monitors.stun',\n      matrix: 'ANARCHY.actor.monitors.matrix',\n      armor: 'ANARCHY.actor.monitors.armor',\n      structure: 'ANARCHY.actor.monitors.structure',\n      resistance: 'ANARCHY.actor.monitors.resistance',\n      marks: 'ANARCHY.actor.monitors.marks',\n      convergence: 'ANARCHY.actor.monitors.convergence',\n    },\n    vehicle: {\n      moves: 'ANARCHY.actor.vehicle.moves',\n      attacks: 'ANARCHY.actor.vehicle.attacks',\n      stealth: 'ANARCHY.actor.vehicle.stealth',\n      category: 'ANARCHY.actor.vehicle.category',\n      skill: 'ANARCHY.actor.vehicle.skill',\n    },\n    ownership: {\n      owner: 'ANARCHY.actor.ownership.owner',\n      unknown: 'ANARCHY.actor.ownership.unknown',\n      owned: 'ANARCHY.actor.ownership.owned',\n    },\n  },\n  actorType: {\n    character: 'ANARCHY.actorType.character',\n    vehicle: 'ANARCHY.actorType.vehicle',\n    device: 'ANARCHY.actorType.device',\n    sprite: 'ANARCHY.actorType.sprite',\n    ic: 'ANARCHY.actorType.ic',\n  },\n  item: {\n    sheet: 'ANARCHY.item.sheet',\n    tabs: {\n      main: 'ANARCHY.item.tabs.main',\n      modifiers: 'ANARCHY.item.tabs.modifiers',\n    },\n    common: {\n      inactive: 'ANARCHY.item.common.inactive',\n    },\n    skill: {\n      code: 'ANARCHY.item.skill.code',\n      copyDefault: 'ANARCHY.item.skill.useDefault',\n      isKnowledge: 'ANARCHY.item.skill.isKnowledge',\n      attribute: 'ANARCHY.item.skill.attribute',\n      value: 'ANARCHY.item.skill.value',\n      specialization: 'ANARCHY.item.skill.specialization',\n      hasDrain: 'ANARCHY.item.skill.isSocial',\n      hasDrain: 'ANARCHY.item.skill.hasDrain',\n      hasConvergence: 'ANARCHY.item.skill.hasConvergence',\n      specializationHelp: 'ANARCHY.item.skill.specializationHelp',\n    },\n    quality: {\n      positive: 'ANARCHY.item.quality.positive',\n    },\n    shadowamp: {\n      category: 'ANARCHY.item.shadowamp.category',\n      capacity: 'ANARCHY.item.shadowamp.capacity',\n      level: 'ANARCHY.item.shadowamp.level',\n      essence: 'ANARCHY.item.shadowamp.essence',\n      levelShort: 'ANARCHY.item.shadowamp.levelShort',\n      essenceShort: 'ANARCHY.item.shadowamp.essenceShort',\n    },\n    weapon: {\n      skill: 'ANARCHY.item.weapon.skill',\n      damage: 'ANARCHY.item.weapon.damage',\n      strength: 'ANARCHY.item.weapon.strength',\n      defense: 'ANARCHY.item.weapon.defense',\n      area: 'ANARCHY.item.weapon.area',\n      noArmor: 'ANARCHY.item.weapon.noArmor',\n      withArmor: 'ANARCHY.item.weapon.withArmor',\n      damageShort: 'ANARCHY.item.weapon.damageShort',\n      areaShort: 'ANARCHY.item.weapon.areaShort',\n      noArmorShort: 'ANARCHY.item.weapon.noArmorShort',\n      weaponWithoutActor: 'ANARCHY.item.weapon.weaponWithoutActor',\n      range: {\n        max: 'ANARCHY.item.weapon.range.max',\n      },\n    },\n    cyberdeck: {\n      programs: 'ANARCHY.item.cyberdeck.programs',\n      processing: 'ANARCHY.item.cyberdeck.processing',\n      processingHelp: 'ANARCHY.item.cyberdeck.processingHelp',\n    },\n  },\n  itemType: {\n    singular: {\n      metatype: 'ANARCHY.itemType.singular.metatype',\n      skill: 'ANARCHY.itemType.singular.skill',\n      quality: 'ANARCHY.itemType.singular.quality',\n      shadowamp: 'ANARCHY.itemType.singular.shadowamp',\n      weapon: 'ANARCHY.itemType.singular.weapon',\n      gear: 'ANARCHY.itemType.singular.gear',\n      cyberdeck: 'ANARCHY.itemType.singular.cyberdeck',\n      contact: 'ANARCHY.itemType.singular.contact',\n    },\n    plural: {\n      metatype: 'ANARCHY.itemType.plural.metatype',\n      skill: 'ANARCHY.itemType.plural.skill',\n      quality: 'ANARCHY.itemType.plural.quality',\n      shadowamp: 'ANARCHY.itemType.plural.shadowamp',\n      weapon: 'ANARCHY.itemType.plural.weapon',\n      gear: 'ANARCHY.itemType.plural.gear',\n      cyberdeck: 'ANARCHY.itemType.plural.cyberdeck',\n      contact: 'ANARCHY.itemType.plural.contact',\n    },\n  },\n  capacity: {\n    mundane: 'ANARCHY.capacity.mundane',\n    awakened: 'ANARCHY.capacity.awakened',\n    emerged: 'ANARCHY.capacity.emerged',\n  },\n  monitor: {\n    physical: 'ANARCHY.monitor.physical',\n    stun: 'ANARCHY.monitor.stun',\n    matrix: 'ANARCHY.monitor.matrix',\n    marks: 'ANARCHY.monitor.marks',\n  },\n  monitorLetter: {\n    physical: 'ANARCHY.monitorLetter.physical',\n    stun: 'ANARCHY.monitorLetter.stun',\n    matrix: 'ANARCHY.monitorLetter.matrix',\n    marks: 'ANARCHY.monitorLetter.marks',\n  },\n  shadowampCategory: {\n    adeptPower: 'ANARCHY.shadowampCategory.adeptPower',\n    bioware: 'ANARCHY.shadowampCategory.bioware',\n    complexForm: 'ANARCHY.shadowampCategory.complexForm',\n    cyberdeck: 'ANARCHY.shadowampCategory.cyberdeck',\n    cyberware: 'ANARCHY.shadowampCategory.cyberware',\n    drone: 'ANARCHY.shadowampCategory.drone',\n    equipment: 'ANARCHY.shadowampCategory.equipment',\n    focus: 'ANARCHY.shadowampCategory.focus',\n    program: 'ANARCHY.shadowampCategory.program',\n    spell: 'ANARCHY.shadowampCategory.spell',\n    special: 'ANARCHY.shadowampCategory.special',\n  },\n  attributes: {\n    noAttribute: 'ANARCHY.attributes.noAttributes',\n    strength: 'ANARCHY.attributes.strength',\n    agility: 'ANARCHY.attributes.agility',\n    willpower: 'ANARCHY.attributes.willpower',\n    logic: 'ANARCHY.attributes.logic',\n    charisma: 'ANARCHY.attributes.charisma',\n    edge: 'ANARCHY.attributes.edge',\n    autopilot: 'ANARCHY.attributes.autopilot',\n    handling: 'ANARCHY.attributes.handling',\n    firewall: 'ANARCHY.attributes.firewall',\n    system: 'ANARCHY.attributes.system',\n    knowledge: 'ANARCHY.attributes.knowledge',\n  },\n  attributeAction: {\n    defense: 'ANARCHY.attributeAction.defense',\n    judgeIntentions: 'ANARCHY.attributeAction.judgeIntentions',\n    perception: 'ANARCHY.attributeAction.perception',\n    resistTorture: 'ANARCHY.attributeAction.resistTorture',\n    composure: 'ANARCHY.attributeAction.composure',\n    memory: 'ANARCHY.attributeAction.memory',\n    catch: 'ANARCHY.attributeAction.catch',\n    lift: 'ANARCHY.attributeAction.lift',\n    matrixDefense: 'ANARCHY.attributeAction.matrixDefense',\n    astralDefense: 'ANARCHY.attributeAction.astralDefense',\n  },\n  defense: {\n    physicalDefense: 'ANARCHY.defense.physicalDefense',\n    physicalResistance: 'ANARCHY.defense.physicalResistance',\n    socialDefense: 'ANARCHY.defense.socialDefense',\n    matrixDefense: 'ANARCHY.defense.matrixDefense',\n    mentalResistance: 'ANARCHY.defense.mentalResistance',\n  },\n  skill: {\n    athletics: 'ANARCHY.skill.athletics',\n    acrobatics: 'ANARCHY.skill.acrobatics',\n    closeCombat: 'ANARCHY.skill.closeCombat',\n    projectileWeapons: 'ANARCHY.skill.projectileWeapons',\n    firearms: 'ANARCHY.skill.firearms',\n    heavyWeapons: 'ANARCHY.skill.heavyWeapons',\n    vehicleWeapons: 'ANARCHY.skill.vehicleWeapons',\n    stealth: 'ANARCHY.skill.stealth',\n    pilotingGround: 'ANARCHY.skill.pilotingGround',\n    pilotingOther: 'ANARCHY.skill.pilotingOther',\n    escapeArtist: 'ANARCHY.skill.escapeArtist',\n    astralCombat: 'ANARCHY.skill.astralCombat',\n    conjuring: 'ANARCHY.skill.conjuring',\n    sorcery: 'ANARCHY.skill.sorcery',\n    survival: 'ANARCHY.skill.survival',\n    biotech: 'ANARCHY.skill.biotech',\n    electronics: 'ANARCHY.skill.electronics',\n    hacking: 'ANARCHY.skill.hacking',\n    engineering: 'ANARCHY.skill.engineering',\n    tracking: 'ANARCHY.skill.tracking',\n    tasking: 'ANARCHY.skill.tasking',\n    con: 'ANARCHY.skill.con',\n    intimidation: 'ANARCHY.skill.intimidation',\n    negotiation: 'ANARCHY.skill.negotiation',\n    disguise: 'ANARCHY.skill.disguise',\n    animals: 'ANARCHY.skill.animals',\n    etiquette: 'ANARCHY.skill.etiquette',\n    knowledge: 'ANARCHY.skill.knowledge',\n  },\n  area: {\n    none: 'ANARCHY.area.none',\n    shotgun: 'ANARCHY.area.shotgun',\n    circle: 'ANARCHY.area.circle',\n    cone: 'ANARCHY.area.cone',\n    rect: 'ANARCHY.area.rect',\n    ray: 'ANARCHY.area.ray',\n  },\n  range: {\n    short: 'ANARCHY.range.short',\n    medium: 'ANARCHY.range.medium',\n    long: 'ANARCHY.range.long',\n  },\n  connectionMode: {\n    disconnected: 'ANARCHY.connectionMode.disconnected',\n    augmented: 'ANARCHY.connectionMode.augmented',\n    virtual: 'ANARCHY.connectionMode.virtual',\n  },\n  vehicleCategory: {\n    miniDrone: 'ANARCHY.vehicleCategory.miniDrone',\n    smallDrone: 'ANARCHY.vehicleCategory.smallDrone',\n    mediumDrone: 'ANARCHY.vehicleCategory.mediumDrone',\n    largeDrone: 'ANARCHY.vehicleCategory.largeDrone',\n    motorcycle: 'ANARCHY.vehicleCategory.motorcycle',\n    smallCar: 'ANARCHY.vehicleCategory.smallCar',\n    largeCar: 'ANARCHY.vehicleCategory.largeCar',\n    van: 'ANARCHY.vehicleCategory.van',\n    truck: 'ANARCHY.vehicleCategory.truck',\n    aircraft: 'ANARCHY.vehicleCategory.aircraft',\n    boat: 'ANARCHY.vehicleCategory.boat',\n  },\n  modifier: {\n    column: {\n      group: 'ANARCHY.modifier.column.group',\n      effect: 'ANARCHY.modifier.column.effect',\n      value: 'ANARCHY.modifier.column.value',\n      category: 'ANARCHY.modifier.column.category',\n      subCategory: 'ANARCHY.modifier.column.subCategory',\n      target: 'ANARCHY.modifier.column.target',\n      condition: 'ANARCHY.modifier.column.condition',\n    },\n    group: {\n      roll: 'ANARCHY.modifier.group.roll',\n      attribute: 'ANARCHY.modifier.group.attribute',\n      monitor: 'ANARCHY.modifier.group.monitor',\n      other: 'ANARCHY.modifier.group.other',\n    },\n    roll: {\n      effect: {\n        pool: 'ANARCHY.modifier.roll.effect.pool',\n        reroll: 'ANARCHY.modifier.roll.effect.reroll',\n        glitch: 'ANARCHY.modifier.roll.effect.glitch',\n        successReroll: 'ANARCHY.modifier.roll.effect.successReroll',\n        opponentPool: 'ANARCHY.modifier.roll.effect.opponentPool',\n        opponentReroll: 'ANARCHY.modifier.roll.effect.opponentReroll',\n      },\n      category: {\n        attribute: 'ANARCHY.modifier.roll.category.attribute',\n        skill: 'ANARCHY.modifier.roll.category.skill',\n        attributeAction: 'ANARCHY.modifier.roll.category.attributeAction',\n      },\n    },\n    monitor: {\n      effect: {\n        armor: 'ANARCHY.modifier.monitor.effect.armor',\n        structure: 'ANARCHY.modifier.monitor.effect.structure',\n        stun: 'ANARCHY.modifier.monitor.effect.stun',\n        physical: 'ANARCHY.modifier.monitor.effect.physical',\n        matrix: 'ANARCHY.modifier.monitor.effect.matrix',\n      },\n      category: {\n        max: 'ANARCHY.modifier.monitor.category.max',\n        resistance: 'ANARCHY.modifier.monitor.category.resistance',\n      },\n    },\n    other: {\n      effect: {\n        ignoreWounds: 'ANARCHY.modifier.other.effect.ignoreWounds',\n        damageArmor: 'ANARCHY.modifier.other.effect.damageArmor',\n        sceneAnarchy: 'ANARCHY.modifier.other.effect.sceneAnarchy',\n        locationAnarchy: 'ANARCHY.modifier.other.effect.locationAnarchy',\n        essenceAdjustment: 'ANARCHY.modifier.other.effect.essenceAdjustment',\n        initiative: 'ANARCHY.modifier.other.effect.initiative',\n        celebrity: 'ANARCHY.modifier.other.effect.celebrity',\n      },\n      category: {},\n    },\n    condition: {\n      always: 'ANARCHY.modifier.condition.always',\n    },\n  },\n};\n","export class Misc {\n  static isString = (value) => typeof value === 'string' || value instanceof String;\n\n  static ascending(orderFunction = (x) => x) {\n    return (a, b) => Misc.sortingBy(orderFunction(a), orderFunction(b));\n  }\n\n  static descending(orderFunction = (x) => x) {\n    return (a, b) => Misc.sortingBy(orderFunction(b), orderFunction(a));\n  }\n\n  static sortingBy(a, b) {\n    if (a > b) return 1;\n    if (a < b) return -1;\n    return 0;\n  }\n\n  static bySortedArray(sortedArray) {\n    return (it) => sortedArray.indexOf(it);\n  }\n\n  static ascendingBySortedArray(sortedArray) {\n    return Misc.ascending(Misc.bySortedArray(sortedArray));\n  }\n\n  static sortedMap(map, compareFunction = (a, b) => 0) {\n    return Object.keys(map)\n      .sort(compareFunction)\n      .reduce((obj, key) => {\n        obj[key] = map[key];\n        return obj;\n      }, {});\n  }\n\n  static reindexIds(list) {\n    let index = 1;\n    list.forEach((it) => (it.id = index++));\n    return list;\n  }\n\n  static distinct(array) {\n    return [...new Set(array)];\n  }\n\n  static sum() {\n    return (a, b) => a + b;\n  }\n\n  static sumValues(list, value = (t) => t) {\n    return list\n      .map(value)\n      .filter((v) => v != undefined)\n      .reduce(Misc.sum(), 0);\n  }\n\n  static divint(value, divisor) {\n    return Math.floor(value / divisor);\n  }\n\n  static divup(value, divisor) {\n    return Math.ceil(value / divisor);\n  }\n\n  static join(params, separator = '') {\n    return params.reduce(Misc.joiner(separator));\n  }\n\n  static joiner(separator = '') {\n    return (a, b) => a + separator + b;\n  }\n\n  static classify(items, classifier = (it) => it.type) {\n    let itemsBy = {};\n    Misc.classifyInto(itemsBy, items, classifier);\n    return itemsBy;\n  }\n\n  static classifyFirst(items, classifier) {\n    let itemsBy = {};\n    for (const item of items) {\n      const classification = classifier(item);\n      if (!itemsBy[classification]) {\n        itemsBy[classification] = item;\n      }\n    }\n    return itemsBy;\n  }\n\n  static classifyInto(itemsBy, items, classifier = (it) => it.type) {\n    for (const item of items) {\n      const classification = classifier(item);\n      let list = itemsBy[classification];\n      if (!list) {\n        list = [];\n        itemsBy[classification] = list;\n      }\n      list.push(item);\n    }\n  }\n\n  static showControlWhen(control, condition) {\n    if (condition) {\n      control.show();\n    } else {\n      control.hide();\n    }\n  }\n  static minmax(value, min, max) {\n    return Math.max(min, Math.min(value, max));\n  }\n}\n","import { ANARCHY } from './config.js';\nimport { Misc } from './misc.js';\n\nconst actorWordTypes = {\n  keyword: 'keywords',\n  disposition: 'dispositions',\n  cue: 'cues',\n};\n\nexport class Enums {\n  static ENUMS;\n  static hbsAttributes;\n  static hbsItemTypes;\n  static hbsCapacities;\n  static hbsMonitors;\n  static hbsMonitorLetters;\n  static hbsShadowampCategories;\n  static hbsAreas;\n  static hbsRanges;\n\n  static sortedAttributeKeys;\n\n  // this method is the place to add settings-based entries in the enums\n  static init() {\n    Enums.hbsAttributes = Enums.mapObjetToKeyValue(ANARCHY.attributes).filter(\n      (a) => a.value != 'knowledge' && a.value != 'noAttribute',\n    );\n    Enums.hbsItemTypes = Enums.mapObjetToKeyValue(ANARCHY.itemType);\n    Enums.hbsCapacities = Enums.mapObjetToKeyValue(ANARCHY.capacity);\n    Enums.hbsMonitors = Enums.mapObjetToKeyValue(ANARCHY.monitor);\n    Enums.hbsMonitorLetters = Enums.mapObjetToKeyValue(ANARCHY.monitorLetter);\n    Enums.hbsShadowampCategories = Enums.mapObjetToKeyValue(ANARCHY.shadowampCategory);\n    Enums.hbsAreas = Enums.mapObjetToKeyValue(ANARCHY.area);\n    Enums.hbsRanges = Enums.mapObjetToKeyValue(ANARCHY.range);\n    Enums.hbsVehicleCategories = Enums.mapObjetToKeyValue(ANARCHY.vehicleCategory);\n\n    Enums.sortedAttributeKeys = Object.keys(ANARCHY.attributes);\n\n    Enums.registerHandleBarHelpers();\n  }\n\n  static registerHandleBarHelpers() {\n    Handlebars.registerHelper('sortedAttributes', (map) =>\n      Misc.sortedMap(map, Misc.ascendingBySortedArray(Enums.sortedAttributeKeys)),\n    );\n  }\n\n  static getEnums(filterAttributes = (it) => true, withKnowledge = false) {\n    return {\n      attributes: Enums.getAttributes(filterAttributes),\n      itemTypes: Enums.hbsItemTypes,\n      capacities: Enums.hbsCapacities,\n      monitors: Enums.hbsMonitors,\n      shadowampCategories: Enums.hbsShadowampCategories,\n      skills: game.system.anarchy.skills.getSkills({ withKnowledge }).map((it) => {\n        return { value: it.code, label: game.i18n.localize(it.labelkey), labelkey: it.labelkey };\n      }),\n      areas: Enums.hbsAreas,\n      ranges: Enums.hbsRanges,\n      vehicleCategories: Enums.hbsVehicleCategories,\n    };\n  }\n\n  static getAttributes(filterAttributes = (it) => true) {\n    return Enums.hbsAttributes.filter((it) => filterAttributes(it.value));\n  }\n\n  static getActorWordTypes() {\n    return actorWordTypes;\n  }\n\n  static getMonitors() {\n    return Enums.hbsMonitors;\n  }\n\n  static getMonitorLetters() {\n    return Enums.hbsMonitorLetters;\n  }\n\n  static getActorWordTypePlural(wordType) {\n    return actorWordTypes[wordType];\n  }\n\n  static localizeAttribute(attribute) {\n    if (!ANARCHY.attributes[attribute]) {\n      return game.i18n.localize(ANARCHY.attributes['noAttribute']);\n    }\n    return game.i18n.localize(ANARCHY.attributes[attribute]);\n  }\n\n  static getFromList(list, key, keyName = 'value', valueName = 'labelkey') {\n    const found = list.find((m) => m[keyName] == key);\n    return found ? found[valueName] : undefined;\n  }\n\n  static mapObjetToKeyValue(object, keyName = 'value', valueName = 'labelkey') {\n    return Object.entries(object).map((entry) => {\n      const ret = {};\n      ret[keyName] = entry[0];\n      ret[valueName] = entry[1];\n      return ret;\n    });\n  }\n}\n","/**\n * The constants file contains things that do not change\n *\n * Constants are written in ALL_CAPS_CONSTANTS and should never be changed during runtime.\n */\nexport const SYSTEM_NAME = 'anarchy';\nexport const SYSTEM_DESCRIPTION = 'Anarchy';\nexport const SYSTEM_SOCKET = `system.${SYSTEM_NAME}`;\nexport const SYSTEM_SCOPE = SYSTEM_NAME;\nexport const SYSTEM_PATH = `systems/${SYSTEM_NAME}`;\nexport const STYLE_PATH = `${SYSTEM_PATH}/style`;\nexport const TEMPLATES_PATH = `systems/${SYSTEM_NAME}/templates`;\nexport const ICONS_PATH = `${SYSTEM_PATH}/icons`;\nexport const ICONS_SKILLS_PATH = `${ICONS_PATH}/skills`;\nexport const LOG_HEAD = 'Anarchy | ';\n\nexport const ANARCHY_DICE_BONUS = 3;\nexport const SPECIALIZATION_BONUS = 2;\nexport const PLAYER_MAX_ANARCHY = 6;\n\nexport const TARGET_SUCCESS = 5;\nexport const TARGET_SUCCESS_EDGE = 4;\n\nexport const BASE_MONITOR = 8;\n\nexport const TEMPLATE = {\n  actorTypes: {\n    character: 'character',\n    vehicle: 'vehicle',\n    device: 'device',\n    sprite: 'sprite',\n    ic: 'ic',\n  },\n  itemType: {\n    metatype: 'metatype',\n    skill: 'skill',\n    quality: 'quality',\n    shadowamp: 'shadowamp',\n    weapon: 'weapon',\n    gear: 'gear',\n    cyberdeck: 'cyberdeck',\n    contact: 'contact',\n  },\n  attributes: {\n    agility: 'agility',\n    strength: 'strength',\n    willpower: 'willpower',\n    logic: 'logic',\n    charisma: 'charisma',\n    edge: 'edge',\n    autopilot: 'autopilot',\n    handling: 'handling',\n    firewall: 'firewall',\n    system: 'system',\n    knowledge: 'knowledge',\n  },\n  capacities: {\n    mundane: 'mundane',\n    awakened: 'awakened',\n    emerged: 'emerged',\n  },\n  monitors: {\n    stun: 'stun',\n    armor: 'armor',\n    physical: 'physical',\n    structure: 'structure',\n    matrix: 'matrix',\n    marks: 'marks',\n    convergence: 'convergence',\n    anarchy: 'anarchy',\n    plot: 'plot',\n    sceneAnarchy: 'sceneAnarchy',\n  },\n  counters: {\n    edge: 'edge',\n    social: {\n      celebrity: 'celebrity',\n      credibility: 'credibility',\n      rumor: 'rumor',\n    },\n  },\n  area: {\n    none: 'none',\n    shotgun: 'shotgun',\n    circle: 'circle',\n    cone: 'cone',\n    rect: 'rect',\n    ray: 'ray',\n  },\n};\n\nexport const ANARCHY_SYSTEM = {\n  rollType: {\n    attributeAction: 'attributeAction',\n    defense: 'defense',\n    defensePilot: 'defensePilot',\n    attribute: 'attribute',\n    skill: 'skill',\n    weapon: 'weapon',\n  },\n  actions: {\n    defense: 'defense',\n    resistTorture: 'resistTorture',\n    judgeIntentions: 'judgeIntentions',\n    perception: 'perception',\n    composure: 'composure',\n    memory: 'memory',\n    catch: 'catch',\n    lift: 'lift',\n    matrixDefense: 'matrixDefense',\n    astralDefense: 'astralDefense',\n  },\n  defenses: {\n    physicalDefense: 'physicalDefense',\n    physicalResistance: 'physicalResistance',\n    socialDefense: 'socialDefense',\n    matrixDefense: 'matrixDefense',\n    mentalResistance: 'mentalResistance',\n  },\n  fixedDefenseCode: {\n    // fix for old incorrect defense codes\n    mentalDefense: 'physicalResistance',\n    astralDefense: 'mentalResistance',\n  },\n};\n\n// export constant for JS hacks\nglobalThis.ANARCHY_CONSTANTS = {\n  SYSTEM_NAME,\n  SYSTEM_DESCRIPTION,\n  SYSTEM_SOCKET,\n  SYSTEM_SCOPE,\n  SYSTEM_PATH,\n  STYLE_PATH,\n  TEMPLATES_PATH,\n  ICONS_PATH,\n  ICONS_SKILLS_PATH,\n  LOG_HEAD,\n  ANARCHY_DICE_BONUS,\n  SPECIALIZATION_BONUS,\n  PLAYER_MAX_ANARCHY,\n  TARGET_SUCCESS,\n  TARGET_SUCCESS_EDGE,\n  BASE_MONITOR,\n  TEMPLATE,\n  ANARCHY_SYSTEM,\n};\n","import { ANARCHY } from './config.js';\n\nexport class ErrorManager {\n  static checkSufficient(resource, required, available) {\n    if (required > available) {\n      const error = game.i18n.format(ANARCHY.common.errors.insufficient, {\n        resource: game.i18n.localize(resource),\n        required: required,\n        available: available,\n      });\n      ui.notifications.error(error);\n      throw error;\n    }\n  }\n\n  static checkOutOfRange(resource, value, min, max) {\n    if (value < min || value > max) {\n      const error = game.i18n.format(ANARCHY.common.errors.outOfRange, {\n        resource: game.i18n.localize(resource),\n        value: value,\n        min: min,\n        max: max,\n      });\n      ui.notifications.error(error);\n      throw error;\n    }\n  }\n\n  static checkUserGM() {\n    if (!game.user.isGM) {\n      const error = game.i18n.localize(ANARCHY.common.errors.onlyGM);\n      ui.notifications.error(error);\n      throw error;\n    }\n  }\n\n  static checkItemType(item, expectedType) {\n    if (item.type != expectedType) {\n      const error = game.i18n.format(ANARCHY.common.errors.expectedType, {\n        type: game.i18n.localize(item.type ? ANARCHY.itemType.singular[item.type] : item.type),\n        expectedType: game.i18n.localize(expectedType),\n      });\n      ui.notifications.error(error);\n      throw error;\n    }\n  }\n\n  static checkActorCanReceiveDamage(damageType, monitor, actor) {\n    if (!monitor) {\n      const error = game.i18n.format(ANARCHY.common.errors.actorCannotReceiveDamage, {\n        actor: actor.name,\n        damageType: game.i18n.format('ANARCHY.actor.monitors.' + damageType),\n      });\n      ui.notifications.error(error);\n      throw error;\n    }\n  }\n\n  static checkWeaponDefense(weapon, actor) {\n    const defense = weapon.getDefense();\n    if (!defense) {\n      const error = game.i18n.format(ANARCHY.common.errors.noDefenseOnWeapon, {\n        actor: actor.name,\n        weapon: weapon.name,\n      });\n      ui.notifications.error(error);\n      throw error;\n    }\n  }\n\n  static checkTargetsCount(maxTargets, targets, area) {\n    if (maxTargets > 0 && targets.length > maxTargets) {\n      const error = game.i18n.format(ANARCHY.common.errors.maxTargetsExceedeed, {\n        weapon: this.name,\n        area: game.i18n.localize(ANARCHY.area[area]),\n        count: targets.length,\n        max: maxTargets,\n      });\n      ui.notifications.error(error);\n      throw error;\n    }\n  }\n\n  static checkMatrixMonitor(actor) {\n    if (!actor.hasMatrixMonitor()) {\n      const error = game.i18n.format(ANARCHY.actor.monitors.noMatrixMonitor, {\n        actor: actor.name,\n      });\n      ui.notifications.warn(error);\n      throw error;\n    }\n  }\n\n  static checkActorDefenseAction(actorAction, actor, defense) {\n    if (!actorAction) {\n      const error = game.i18n.format(ANARCHY.common.errors.actorDoesNotHaveDefense, {\n        actor: actor.name,\n        defense: game.i18n.localize(defense.labelkey),\n        actorType: game.i18n.localize(ANARCHY.actorType[actor.type]),\n      });\n      ui.notifications.error(error);\n      throw error;\n    }\n  }\n}\n","import { ANARCHY } from './config.js';\nimport { ErrorManager } from './error-manager.js';\nimport { Misc } from './misc.js';\nimport { RemoteCall } from './remotecall.js';\n\nconst BLIND_MESSAGE_TO_GM = 'Users.blindMessageToGM';\n\nexport class AnarchyUsers {\n  static init() {\n    RemoteCall.register(BLIND_MESSAGE_TO_GM, {\n      callback: (data) => AnarchyUsers.blindMessageToGM(data),\n      condition: (user) => user.isGM,\n    });\n  }\n\n  static blindMessageToGM(message) {\n    if (!RemoteCall.call(BLIND_MESSAGE_TO_GM, message)) {\n      ChatMessage.create({\n        user: message.user,\n        whisper: ChatMessage.getWhisperRecipients('GM'),\n        blind: true,\n        content: game.i18n.format(ANARCHY.chat.blindMessageToGM, {\n          user: game.user.name,\n          message: message.content,\n        }),\n      });\n    }\n  }\n\n  static getUsers(filter = (user) => true) {\n    return (game.version ? game.users : game.users.entities).filter(filter);\n  }\n\n  static firstConnectedGM() {\n    return (\n      AnarchyUsers.getUsers((u) => u.isGM && u.active)\n        .sort(Misc.ascending((u) => u.id))\n        .at(0) ?? {}\n    );\n  }\n\n  /**\n   * @returns true pour un seul utilisateur: le premier GM connectÃ© par ordre d'id\n   */\n  static isUniqueConnectedGM(user = game.user) {\n    return user.id == AnarchyUsers.firstConnectedGM().id;\n  }\n\n  static firstResponsible(document) {\n    if (!document.testUserPermission) {\n      return undefined;\n    }\n    return (\n      AnarchyUsers.getUsers(\n        (u) => u.active && document.testUserPermission(u, CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER),\n      ) == game.user\n    );\n  }\n\n  static getTargetTokens(user) {\n    return Array.from(user.targets);\n  }\n\n  static getSelectedTokens(user) {\n    return Array.from(canvas.tokens.controlled);\n  }\n\n  static getSelectedActors() {\n    return Array.from(canvas.tokens.controlled).map((t) => t.actor);\n  }\n\n  static getPlayerActor() {\n    return game.user.character;\n  }\n}\n","import { LOG_HEAD, SYSTEM_SOCKET } from './constants.js';\nimport { AnarchyUsers } from './users.js';\n\nexport class RemoteCall {\n  constructor() {\n    this.remoteCalls = {};\n    game.socket.on(SYSTEM_SOCKET, async (sockMsg) => this.onSocketMessage(sockMsg));\n  }\n\n  static async register(msg, remoteCall) {\n    game.system.anarchy.remoteCall._register(msg, remoteCall);\n  }\n\n  async _register(msg, remoteCall) {\n    if (this.remoteCalls[msg]) {\n      throw `RemoteCall msg ${msg} is already registered`;\n    }\n    foundry.utils.mergeObject(\n      remoteCall,\n      {\n        callback: (data) => {\n          console.log(LOG_HEAD + 'RemoteCall [', msg, '] (', data, ')');\n        },\n        condition: (user) => true,\n        multiple: false /* true if multiple users should handle the message */,\n      },\n      { overwrite: false },\n    );\n    this.remoteCalls[msg] = remoteCall;\n    console.log(LOG_HEAD + 'RemoteCall registered', msg);\n  }\n\n  static call(msg, data) {\n    return game.system.anarchy.remoteCall._remoteCall(msg, data);\n  }\n\n  _remoteCall(msg, data) {\n    const remoteCall = this.remoteCalls[msg];\n    if (\n      !remoteCall ||\n      remoteCall.condition(game.user) ||\n      (!remoteCall.multiple && AnarchyUsers.isUniqueConnectedGM())\n    ) {\n      return false;\n    }\n    game.socket.emit(SYSTEM_SOCKET, { msg: msg, data: data });\n    return true;\n  }\n\n  async onSocketMessage(sockMsg) {\n    const remoteCall = this.remoteCalls[sockMsg.msg];\n    if (remoteCall) {\n      const userMatchCondition = remoteCall.condition(game.user);\n      const isMultiple = remoteCall.multiple;\n      const isSelectedGM = AnarchyUsers.isUniqueConnectedGM();\n      if (userMatchCondition && (isMultiple || isSelectedGM)) {\n        remoteCall.callback(sockMsg.data);\n      } else {\n        console.log(\n          LOG_HEAD + 'RemoteCall.onSocketMessage(',\n          sockMsg,\n          ') ignored :',\n          userMatchCondition,\n          isMultiple,\n          isSelectedGM,\n        );\n      }\n    } else {\n      console.log(LOG_HEAD + 'RemoteCall: No callback registered for', sockMsg);\n    }\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { SYSTEM_SCOPE } from '../constants.js';\nimport { RemoteCall } from '../remotecall.js';\n\nexport const PARENT_MESSAGE_ID = 'parent-message-id';\nexport const MESSAGE_DATA = 'message-data';\nexport const CAN_USE_EDGE = 'can-use-edge';\nexport const OWNING_ACTOR = 'owning-actor';\n\nconst REMOVE_CHAT_MESSAGE = 'ChatManager.removeChatMessage';\nconst CHAT_MANAGER_REMOVE_FAMILY = 'ChatManager.removeChatMessageFamily';\n\nconst CHAT_MESSAGE_BUTTON_HANDLERS = [\n  {\n    selector: '.anarchy-button.click-edge-reroll',\n    controlVisibility: true,\n    handler: async (chatMsg, event) => await ChatManager.edgeReroll(chatMsg),\n  },\n  {\n    selector: '.anarchy-button.click-defend-attack',\n    controlVisibility: true,\n    handler: async (chatMsg, event) => await ChatManager.defendAttack(chatMsg),\n  },\n  {\n    selector: '.anarchy-button.click-defend-pilot-attack',\n    controlVisibility: true,\n    handler: async (chatMsg, event) => await ChatManager.defendPilotAttack(chatMsg),\n  },\n  {\n    selector: '.anarchy-button.click-apply-attack-damage',\n    controlVisibility: true,\n    handler: async (chatMsg, event) => await ChatManager.applyAttack(chatMsg),\n  },\n  {\n    selector: 'img.open-actor-sheet',\n    controlVisibility: false,\n    handler: async (chatMsg, event) => await ChatManager.openActorSheet(chatMsg, event),\n  },\n];\n\nexport class ChatManager {\n  static async init() {\n    Hooks.on(\n      'renderChatMessage',\n      async (app, html, msg) => await ChatManager.onRenderChatMessage(app, html, msg),\n    );\n\n    RemoteCall.register(CHAT_MANAGER_REMOVE_FAMILY, {\n      callback: (data) => this.removeFamily(data),\n      condition: (user) => user.isGM,\n    });\n\n    RemoteCall.register(REMOVE_CHAT_MESSAGE, {\n      callback: (data) => ChatManager.removeChatMessage(data),\n      condition: (user) => user.isGM,\n    });\n  }\n\n  static async onRenderChatMessage(app, html, msg) {\n    const chatMessage = ChatManager.getChatMessageFromHtml(html);\n    const showButtons = ChatManager.hasRight(chatMessage);\n    CHAT_MESSAGE_BUTTON_HANDLERS.forEach((it) => {\n      const jQueryButtonSelector = html.find(it.selector);\n      if (!it.controlVisibility || showButtons) {\n        jQueryButtonSelector.show();\n        jQueryButtonSelector.click(\n          async (event) => await it.handler(ChatManager.getChatMessage(event), event),\n        );\n      } else {\n        jQueryButtonSelector.hide();\n        jQueryButtonSelector.click(async (event) => {});\n      }\n    });\n  }\n\n  static async openActorSheet(chatMsg, event) {\n    const img = $(event.currentTarget).closest('img.open-actor-sheet');\n    const tokenId = img.attr('data-token-id');\n    if (tokenId) {\n      const token = canvas.tokens.get(tokenId);\n      if (token?.actor) {\n        token.actor.sheet.render(true);\n        return;\n      }\n    }\n    const actorId = img.attr('data-actor-id');\n    return game.actors.get(actorId)?.sheet.render(true);\n  }\n\n  static async edgeReroll(chatMsg) {\n    if (chatMsg.getFlag(SYSTEM_SCOPE, CAN_USE_EDGE)) {\n      const rollData = chatMsg.getFlag(SYSTEM_SCOPE, MESSAGE_DATA);\n      await game.system.anarchy.rollManager.edgeReroll(rollData);\n      ChatManager.removeFamily(chatMsg.id);\n    } else {\n      ui.notifications.info(game.i18n.localize(ANARCHY.common.errors.cannotUseEdgeAnymore));\n    }\n  }\n\n  static defendAttack(chatMsg) {\n    return game.system.anarchy.combatManager.onClickDefendAttack(\n      chatMsg.getFlag(SYSTEM_SCOPE, MESSAGE_DATA),\n    );\n  }\n\n  static defendPilotAttack(chatMsg) {\n    return game.system.anarchy.combatManager.onClickPilotDefendAttack(\n      chatMsg.getFlag(SYSTEM_SCOPE, MESSAGE_DATA),\n    );\n  }\n\n  static applyAttack(chatMsg) {\n    return game.system.anarchy.combatManager.onClickApplyAttackDamage(\n      chatMsg.getFlag(SYSTEM_SCOPE, MESSAGE_DATA),\n    );\n  }\n\n  static getChatMessage(event) {\n    const chatMessageId = $(event.currentTarget).closest('.chat-message').attr('data-message-id');\n    return game.messages.get(chatMessageId);\n  }\n\n  static getChatMessageFromHtml(html) {\n    const chatMessageId = $(html).closest('.chat-message').attr('data-message-id');\n    return game.messages.get(chatMessageId);\n  }\n\n  /**\n   * Method in charge of preparing ANARCHY flags to be set on Document, for ChatMessage\n   */\n  static prepareFlag(flags, key, data) {\n    if (flags[SYSTEM_SCOPE] == undefined) {\n      flags[SYSTEM_SCOPE] = { [key]: data };\n    } else {\n      flags[SYSTEM_SCOPE][key] = data;\n    }\n  }\n\n  static removeFamily(chatMessageId) {\n    if (!RemoteCall.call(CHAT_MANAGER_REMOVE_FAMILY, chatMessageId)) {\n      game.messages\n        .filter((m) => m.getFlag(SYSTEM_SCOPE, PARENT_MESSAGE_ID) == chatMessageId)\n        .forEach((m) => m.delete());\n      game.messages.get(chatMessageId)?.delete();\n    }\n  }\n\n  static removeChatMessage(chatMessageId) {\n    if (!RemoteCall.call(REMOVE_CHAT_MESSAGE, chatMessageId)) {\n      game.messages.get(chatMessageId)?.delete();\n    }\n  }\n\n  static messageActorRights(actor, right = CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER) {\n    return {\n      actorId: actor?.id,\n      tokenId: actor?.token?.id,\n      right: right ?? CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER,\n    };\n  }\n\n  static readActorRights(flag) {\n    const token = flag.tokenId ? ChatManager.getToken(flag.tokenId) : undefined;\n    return {\n      actor: token?.actor ?? game.actors.get(flag.actorId),\n      token: token,\n      right: flag.right,\n    };\n  }\n\n  static hasRight(chatMsg, right = CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER) {\n    const flagOwner = chatMsg.getFlag(SYSTEM_SCOPE, OWNING_ACTOR);\n    if (flagOwner) {\n      const neededRights = ChatManager.readActorRights(flagOwner);\n      if (neededRights) {\n        if (neededRights.actor) {\n          return neededRights.actor.testUserPermission(\n            game.user,\n            Math.min(neededRights.right, right),\n          );\n        }\n        return true;\n      }\n    }\n    return false;\n  }\n\n  static getToken(tokenId) {\n    return tokenId\n      ? game.scenes\n          .map((s) => s.tokens.find((it) => it.id == tokenId))\n          .find((it) => it != undefined)\n      : undefined;\n  }\n}\n","import { STYLE_PATH } from './constants.js';\n\nconst faClassD6 = [\n  'fas fa-dice',\n  'fas fa-dice-one',\n  'fas fa-dice-two',\n  'fas fa-dice-three',\n  'fas fa-dice-four',\n  'fas fa-dice-five',\n  'fas fa-dice-six',\n];\n\nexport class Icons {\n  static fontAwesome(faClass) {\n    return `<i class=\"${faClass}\"></i>`;\n  }\n\n  static iconSystemPath(src, cssClasses) {\n    return Icons.iconPath(`${STYLE_PATH}/${src}`, cssClasses);\n  }\n\n  static iconPath(src, cssClasses) {\n    return `<img class=\"${cssClasses}\" src=\"${src}\" />`;\n  }\n\n  static iconD6(dice) {\n    if (dice < 0 || dice > 6) {\n      throw `Dice ${dice} is out of dice range [1..6] or 0 for multidice`;\n    }\n    return Icons.fontAwesome(faClassD6[dice]);\n  }\n}\n\n// export Icons for JS plugins\nglobalThis.ANARCHY_ICONS = Icons;\n","import { ErrorManager } from '../error-manager.js';\nimport { ANARCHY } from '../config.js';\nimport { AnarchyUsers } from '../users.js';\nimport { Icons } from '../icons.js';\nimport { TEMPLATE } from '../constants.js';\n\nconst MONITORS = ANARCHY.actor.monitors;\nconst COUNTERS = ANARCHY.actor.counters;\n\nexport const DEFAULT_CHECKBARS = {\n  armor: {\n    path: 'system.monitors.armor.value',\n    monitor: (it) => it.system.monitors.armor,\n    iconChecked: Icons.fontAwesome('fas fa-shield-slash'),\n    iconUnchecked: Icons.fontAwesome('fas fa-shield-alt'),\n    iconHit: Icons.fontAwesome('fas fa-bahai'),\n    resource: MONITORS.armor,\n  },\n  stun: {\n    path: 'system.monitors.stun.value',\n    monitor: (it) => it.system.monitors.stun,\n    iconChecked: Icons.fontAwesome('fas fa-grimace'),\n    iconUnchecked: Icons.fontAwesome('far fa-smile'),\n    iconHit: Icons.fontAwesome('fas fa-bahai'),\n    resource: MONITORS.stun,\n    overflow: (actor) => TEMPLATE.monitors.physical,\n    useArmor: true,\n  },\n  physical: {\n    path: 'system.monitors.physical.value',\n    monitor: (it) => it.system.monitors.physical,\n    iconChecked: Icons.fontAwesome('fas fa-heartbeat'),\n    iconUnchecked: Icons.fontAwesome('far fa-heart'),\n    iconHit: Icons.fontAwesome('fas fa-bahai'),\n    resource: MONITORS.physical,\n    useArmor: true,\n  },\n  structure: {\n    path: 'system.monitors.structure.value',\n    monitor: (it) => it.system.monitors.structure,\n    iconChecked: Icons.fontAwesome('fas fa-car-crash'),\n    iconUnchecked: Icons.fontAwesome('fas fa-car-alt'),\n    iconHit: Icons.fontAwesome('fas fa-bahai'),\n    resource: MONITORS.structure,\n  },\n  matrix: {\n    path: 'system.monitors.matrix.value',\n    monitor: (it) => it.getMatrixMonitor(),\n    iconChecked: Icons.fontAwesome('fas fa-laptop-medical'),\n    iconUnchecked: Icons.fontAwesome('fas fa-laptop'),\n    iconHit: Icons.fontAwesome('fas fa-laptop-code'),\n    overflow: (actor) => actor.getMatrixOverflow(),\n    recomputeOverflow: (value) => 3,\n    resource: MONITORS.matrix,\n  },\n  marks: {\n    path: undefined,\n    monitor: (it) => {\n      return { value: 0, max: 5 };\n    },\n    iconChecked: Icons.fontAwesome('fas fa-bookmark'),\n    iconUnchecked: Icons.fontAwesome('far fa-bookmark'),\n    iconHit: Icons.fontAwesome('fas fa-fingerprint'),\n    resource: MONITORS.marks,\n  },\n  convergence: {\n    path: undefined,\n    monitor: (it) => {\n      return { value: 0, max: 5 };\n    },\n    iconChecked: Icons.fontAwesome('far fa-eye'),\n    iconUnchecked: Icons.fontAwesome('fas fa-eye-slash'),\n    iconHit: Icons.fontAwesome('fas fa-eye'),\n    resource: MONITORS.convergence,\n  },\n  anarchy: {\n    path: 'system.counters.anarchy.value',\n    monitor: (it) => {\n      return {\n        value: it.system.counters.anarchy.value,\n        max: 6,\n      };\n    },\n    iconChecked: Icons.iconSystemPath('anarchy-point.webp', 'checkbar-img'),\n    iconUnchecked: Icons.iconSystemPath('anarchy-point-off.webp', 'checkbar-img'),\n    resource: COUNTERS.anarchy,\n  },\n  plot: {\n    path: 'system.counters.anarchy.value',\n    monitor: (it) => {\n      const value = it.system.counters.anarchy.value;\n      return { value: value, max: value + 1 };\n    },\n    iconChecked: Icons.iconSystemPath('danger-point.webp', 'checkbar-img'),\n    iconUnchecked: Icons.iconSystemPath('danger-point-off.webp', 'checkbar-img'),\n    resource: COUNTERS.anarchy,\n  },\n  sceneAnarchy: {\n    path: 'system.counters.sceneAnarchy.value',\n    monitor: (it) => {\n      const value = it.system.counters.sceneAnarchy.value;\n      return { value: value, max: 3 };\n    },\n    iconChecked: Icons.iconSystemPath('anarchy-point-scene.webp', 'checkbar-img'),\n    iconUnchecked: Icons.iconSystemPath('anarchy-point-off.webp', 'checkbar-img'),\n    resource: COUNTERS.sceneAnarchy,\n  },\n  edge: {\n    path: 'system.counters.edge.value',\n    monitor: (it) => {\n      return {\n        value: it.system.counters.edge.value,\n        max: it.getAttributeValue(TEMPLATE.attributes.edge),\n      };\n    },\n    iconChecked: Icons.fontAwesome('fas fa-star'),\n    iconUnchecked: Icons.fontAwesome('far fa-star'),\n    resource: COUNTERS.edge,\n  },\n  credibility: {\n    path: 'system.counters.social.credibility.value',\n    monitor: (it) => {\n      return {\n        value: it.system.counters.social.credibility.value,\n        max: it.system.counters.social.credibility.max,\n      };\n    },\n    iconChecked: Icons.fontAwesome('fas fa-handshake'),\n    iconUnchecked: Icons.fontAwesome('far fa-handshake'),\n    resource: COUNTERS.social.credibility,\n  },\n  rumor: {\n    path: 'system.counters.social.rumor.value',\n    monitor: (it) => {\n      return {\n        value: it.system.counters.social.rumor.value,\n        max: it.system.counters.social.rumor.max,\n      };\n    },\n    iconChecked: Icons.fontAwesome('fas fa-grimace'),\n    iconUnchecked: Icons.fontAwesome('far fa-grimace'),\n    resource: COUNTERS.social.rumor,\n  },\n};\nexport const CHECKBARS = foundry.utils.mergeObject(DEFAULT_CHECKBARS, {});\n\nexport class Checkbars {\n  static init() {\n    Handlebars.registerHelper('iconCheckbar', Checkbars.iconCheckbar);\n    Handlebars.registerHelper('iconCheckbarHit', Checkbars.iconHit);\n  }\n\n  static hackCheckbars(overrides) {\n    if (overrides) {\n      const newBar = foundry.utils.mergeObject(DEFAULT_CHECKBARS, {});\n      foundry.utils.mergeObject(newBar, overrides, { recursive: true });\n      foundry.utils.mergeObject(CHECKBARS, newBar, { overwrite: true });\n    }\n  }\n\n  static iconCheckbar(monitor, checked) {\n    return checked ? Checkbars.iconChecked(monitor) : Checkbars.iconUnchecked(monitor);\n  }\n\n  static iconChecked(monitor) {\n    return CHECKBARS[monitor]?.iconChecked;\n  }\n\n  static iconUnchecked(monitor) {\n    return CHECKBARS[monitor]?.iconUnchecked;\n  }\n\n  static iconHit(monitor) {\n    return CHECKBARS[monitor]?.iconHit ?? CHECKBARS[monitor]?.iconChecked;\n  }\n\n  static useArmor(monitor) {\n    return CHECKBARS[monitor]?.useArmor;\n  }\n\n  static max(target, monitor) {\n    const it = CHECKBARS[monitor]?.monitor(target);\n    return (it?.max ?? 0) + (it?.maxBonus ?? 0);\n  }\n\n  static value(target, monitor) {\n    const it = CHECKBARS[monitor]?.monitor(target);\n    return it?.value ?? 0;\n  }\n\n  static resistance(target, monitor) {\n    const it = CHECKBARS[monitor]?.monitor(target);\n    return (it?.resistance ?? 0) + (it?.resistanceBonus ?? 0);\n  }\n\n  static newValue(index, checked) {\n    return index + (checked ? 0 : 1);\n  }\n\n  static async switchMonitorCheck(\n    target,\n    monitor,\n    index,\n    checked,\n    sourceActorId = undefined,\n    item = undefined,\n  ) {\n    await Checkbars.setCounter(\n      target,\n      monitor,\n      Checkbars.newValue(index, checked),\n      sourceActorId,\n      item,\n    );\n  }\n\n  static async addCounter(target, monitor, value, sourceActorId = undefined) {\n    if (value != 0) {\n      const current = Checkbars.getCounterValue(target, monitor, sourceActorId) ?? 0;\n      await Checkbars.setCounter(target, monitor, current + value, sourceActorId);\n    }\n  }\n\n  static async setCounter(target, monitor, value, sourceActorId = undefined, item = undefined) {\n    switch (monitor) {\n      case TEMPLATE.monitors.marks:\n        return await Checkbars.setActorMarks(target, value, sourceActorId, item);\n      case TEMPLATE.monitors.matrix:\n        ErrorManager.checkMatrixMonitor(target);\n        return await Checkbars.setCheckbar(target, monitor, value, item);\n      case TEMPLATE.monitors.convergence:\n        return await Checkbars.setActorConvergence(target, value);\n      case TEMPLATE.monitors.anarchy:\n        return await Checkbars.setAnarchy(target, value);\n      case TEMPLATE.monitors.sceneAnarchy:\n        return await Checkbars.setSceneAnarchy(target, value);\n    }\n    return await Checkbars.setCheckbar(target, monitor, value);\n  }\n\n  static getCounterValue(target, monitor, sourceActorId) {\n    switch (monitor) {\n      case TEMPLATE.monitors.marks:\n        return Checkbars.getActorMarks(target, sourceActorId);\n      case TEMPLATE.monitors.convergence:\n        return Checkbars.getActorConvergence(target);\n      case TEMPLATE.monitors.anarchy:\n        return Checkbars.getAnarchy(target, monitor);\n    }\n    return Checkbars.value(target, monitor);\n  }\n\n  static async setCheckbar(target, monitor, value) {\n    if (value == Checkbars.getCounterValue(target, monitor)) {\n      return;\n    }\n    const checkbar = CHECKBARS[monitor];\n    if (checkbar.path) {\n      const max = Checkbars.max(target, monitor);\n      if (max <= 0) {\n        return;\n      }\n      await Checkbars._manageOverflow(checkbar, target, monitor, value, max);\n      value = Math.min(value, max);\n      ErrorManager.checkOutOfRange(checkbar.resource, value, 0, max);\n      await target.setCheckbarValue(checkbar.path, value);\n    }\n  }\n\n  static async _manageOverflow(checkbar, target, monitor, value, max) {\n    if (value > max) {\n      const overflowMonitor = checkbar.overflow ? checkbar.overflow(target) : undefined;\n      const overflow = checkbar.recomputeOverflow\n        ? checkbar.recomputeOverflow(value - max)\n        : value - max;\n      if (overflowMonitor && overflow > 0) {\n        Checkbars._notifyOverflow(target, monitor, overflow, overflowMonitor);\n        await Checkbars.addCounter(target, overflowMonitor, overflow);\n      }\n    }\n  }\n\n  static _notifyOverflow(target, monitor, overflow, overflowMonitor) {\n    ui.notifications.warn(\n      game.i18n.format(ANARCHY.actor.monitors.overflow, {\n        actor: target.name,\n        monitor: game.i18n.format('ANARCHY.actor.monitors.' + monitor),\n        overflow: overflow,\n        overflowMonitor: game.i18n.format('ANARCHY.actor.monitors.' + overflowMonitor),\n      }),\n    );\n  }\n\n  static async _manageStunOverflow(target, value, max) {\n    await Checkbars.addCounter(target, TEMPLATE.monitors.physical, value - max);\n  }\n\n  static async _manageMatrixOverflow(target, value, max) {\n    await Checkbars.addCounter(target, TEMPLATE.monitors.stun, value - max);\n  }\n  static async setAnarchy(target, newValue) {\n    if (!target.hasOwnAnarchy()) {\n      return;\n    }\n\n    if (target.hasGMAnarchy()) {\n      await game.system.anarchy.gmAnarchy.setAnarchy(newValue);\n      target.render();\n      return;\n    }\n\n    await Checkbars._setAnarchyMonitor(target, TEMPLATE.monitors.anarchy, newValue);\n  }\n\n  static async setSceneAnarchy(target, newValue) {\n    await Checkbars._setAnarchyMonitor(target, TEMPLATE.monitors.sceneAnarchy, newValue);\n  }\n\n  static async _setAnarchyMonitor(target, monitor, newValue) {\n    const current = Checkbars.value(target, monitor);\n    await Checkbars.setCheckbar(target, monitor, newValue);\n    if (!game.user.isGM) {\n      Checkbars.notifyAnarchyChange(target, monitor, current, newValue);\n    }\n  }\n\n  static getAnarchy(target, monitor) {\n    if (!game.user.isGM && (!target.hasOwnAnarchy() || target.hasGMAnarchy())) {\n      return 0; // undisclosed\n    }\n    if (monitor == COUNTERS.anarchy) {\n      if (!target.hasOwnAnarchy()) {\n        return 0;\n      }\n\n      if (target.hasGMAnarchy()) {\n        return 0;\n      }\n    }\n    return Checkbars.value(target, monitor);\n  }\n\n  static notifyAnarchyChange(target, monitor, current, newValue) {\n    AnarchyUsers.blindMessageToGM({\n      from: game.user.id,\n      content: game.i18n.format(ANARCHY.gmManager.playerChangedAnarchy, {\n        user: game.user.name,\n        actor: target.name,\n        monitor: game.i18n.localize(ANARCHY.actor.counters[monitor]),\n        from: current,\n        to: newValue,\n      }),\n    });\n  }\n\n  static getActorMarks(target, sourceActorId) {\n    return Checkbars._findActorMarks(target.getMatrixMarks(), sourceActorId)?.marks ?? 0;\n  }\n\n  static async addActorMark(target, sourceActorId, item = undefined) {\n    const previous = Checkbars._findActorMarks(target.getMatrixMarks(), sourceActorId);\n    Checkbars.setActorMarks(target, (previous.marks ?? 0) + 1, sourceActorId, item);\n  }\n\n  static async setActorMarks(target, value, sourceActorId, item = undefined) {\n    if (target.canReceiveMarks()) {\n      let marks = deepClone(target.getMatrixMarks());\n      ErrorManager.checkOutOfRange(\n        CHECKBARS.marks.resource,\n        value,\n        0,\n        Checkbars.max(target, 'marks'),\n      );\n      const sourceActorMarks = Checkbars._findActorMarks(marks, sourceActorId);\n      if (sourceActorMarks.marks == undefined) {\n        marks.push(sourceActorMarks);\n      }\n      sourceActorMarks.marks = Math.max(0, value);\n      marks = marks.filter((target) => target.marks > 0);\n      await target.setCheckbarValue('system.monitors.matrix.marks', marks);\n    }\n  }\n\n  static _findActorMarks(marks, sourceActorId) {\n    return marks.find((source) => source.actorId == sourceActorId) ?? { actorId: sourceActorId };\n  }\n\n  static getActorConvergence(target) {\n    game.system.anarchy.gmConvergence.getConvergence(target);\n  }\n\n  static async setActorConvergence(target, value) {\n    await game.system.anarchy.gmConvergence.setConvergence(target, value);\n  }\n}\n","import { Checkbars } from '../common/checkbars.js';\nimport { ANARCHY } from '../config.js';\nimport { SYSTEM_NAME, TEMPLATE } from '../constants.js';\nimport { ErrorManager } from '../error-manager.js';\nimport { RemoteCall } from '../remotecall.js';\n\nconst GM_ANARCHY = 'anarchy-gm';\nconst GM_SCENE_ANARCHY = 'scene-anarchy-gm';\nconst GM_ADD_ANARCHY = 'GMAnarchy.addAnarchy';\n\nexport class GMAnarchy {\n  constructor() {\n    game.settings.register(SYSTEM_NAME, GM_ANARCHY, {\n      scope: 'world',\n      config: false,\n      default: 1,\n      type: Number,\n    });\n    game.settings.register(SYSTEM_NAME, GM_SCENE_ANARCHY, {\n      scope: 'world',\n      config: false,\n      default: 0,\n      type: Number,\n    });\n\n    RemoteCall.register(GM_ADD_ANARCHY, {\n      callback: (data) => game.system.anarchy.gmAnarchy.addAnarchy(data),\n      condition: (user) => user.isGM,\n    });\n    this.anarchy = game.settings.get(SYSTEM_NAME, GM_ANARCHY);\n  }\n\n  getAnarchy() {\n    return {\n      isGM: true,\n      value: this.anarchy,\n      max: this.anarchy + 1,\n      scene: 0,\n    };\n  }\n\n  async actorGivesAnarchyToGM(actor, count) {\n    if (count > 0) {\n      ChatMessage.create({\n        user: game.user,\n        whisper: ChatMessage.getWhisperRecipients('GM'),\n        content: game.i18n.format(ANARCHY.gmManager.gmReceivedAnarchy, {\n          anarchy: count,\n          actor: actor.name,\n        }),\n      });\n      await this.addAnarchy(count);\n    }\n  }\n\n  async npcConsumesAnarchy(actor, count) {\n    await this.addAnarchy(-count);\n  }\n\n  async addAnarchy(count) {\n    if (!RemoteCall.call(GM_ADD_ANARCHY, count)) {\n      ErrorManager.checkSufficient(ANARCHY.actor.counters.plot, -count, this.anarchy);\n      await this.setAnarchy(this.anarchy + count);\n    }\n  }\n\n  async setAnarchy(newAnarchy) {\n    this.anarchy = newAnarchy;\n    game.settings.set(SYSTEM_NAME, GM_ANARCHY, newAnarchy);\n    await this._rebuild();\n    this._syncGMAnarchySheets();\n  }\n\n  async activateListeners(html) {\n    this.toolbar = html.find('.gm-anarchy-bar');\n    await this._rebuild();\n  }\n\n  async _rebuild() {\n    this.toolbar.find('.checkbar-root').replaceWith(await this._renderBar());\n    this.toolbar\n      .find('a.click-checkbar-element')\n      .click(async (event) => await this._onClickAnarchyCheckbar(event));\n  }\n\n  async _onClickAnarchyCheckbar(event) {\n    const index = Number.parseInt($(event.currentTarget).attr('data-index'));\n    const isChecked = $(event.currentTarget).attr('data-checked') == 'true';\n    const newAnarchy = Checkbars.newValue(index, isChecked);\n    await this.setAnarchy(newAnarchy);\n  }\n\n  async _renderBar() {\n    return await foundry.applications.handlebars.renderTemplate(\n      'systems/anarchy/templates/monitors/anarchy.hbs',\n      {\n        code: 'plot',\n        rowlength: 6,\n        value: this.getAnarchy().value,\n        max: this.getAnarchy().max,\n        scene: 0,\n        labelkey: ANARCHY.actor.counters.plot,\n      },\n    );\n  }\n\n  _syncGMAnarchySheets() {\n    const linkedActors = game.actors.filter((actor) => !actor.token || actor.token.isLinked);\n    const unlinkedActors = (game.canvas?.tokens?.getDocuments() ?? [])\n      .filter((t) => !t.isLinked)\n      .map((t) => t.actor);\n\n    linkedActors\n      .concat(unlinkedActors)\n      .filter((actor) => !actor.hasPlayerOwner)\n      .forEach((actor) => actor.render());\n  }\n}\n","export class HandleDragApplication {\n  constructor(getDocElement, options) {\n    this.getDocElement = getDocElement;\n    this.initial = options.initial ?? { left: 200, top: 200 };\n    this.maxPos = options.maxPos ?? { left: 200, top: 100 };\n    this.minPos = options.minPos ?? { left: 2, top: 2 };\n    this.settings = options.settings;\n\n    game.settings.register(this.settings.system, this.settings.keyPosition, {\n      scope: 'client',\n      config: false,\n      default: this.initial,\n      type: Object,\n    });\n    this.position = game.settings.get(this.settings.system, this.settings.keyPosition);\n    this._initDrag();\n  }\n\n  _initDrag() {\n    this.drag = {\n      topPos: 0,\n      leftPos: 0,\n      topEvent: 0,\n      leftEvent: 0,\n    };\n  }\n\n  _savePosition(newPosition) {\n    this.position = newPosition;\n    game.settings.set(this.settings.system, this.settings.keyPosition, this.position);\n  }\n\n  onMouseDown(event) {\n    if (this.isRightMouseButton(event)) {\n      this.handleMoveRightClick();\n    } else {\n      this.handleMoveDrag(event);\n    }\n  }\n\n  isRightMouseButton(event) {\n    event = event || window.event;\n    if ('which' in event) {\n      // Gecko (Firefox), WebKit (Safari/Chrome) & Opera\n      return event.which == 3;\n    } else if ('button' in event) {\n      // IE, Opera\n      return event.button == 2;\n    }\n    return false;\n  }\n\n  handleMoveRightClick(event) {\n    event.preventDefault();\n    this._savePosition(this.initial);\n  }\n\n  handleMoveDrag(event) {\n    event.preventDefault();\n    this._initDrag();\n    this._dragElement(this.getDocElement(document));\n  }\n\n  _dragElement(element) {\n    element.onmousedown = (e) => this._dragMouseDown(element, e);\n  }\n\n  _dragMouseDown(element, e) {\n    e = e || window.event;\n    e.preventDefault();\n    this.drag.leftEvent = e.clientX;\n    this.drag.topEvent = e.clientY;\n    document.onmouseup = (e) => this._closeDragElement(element, e);\n    document.onmousemove = (e) => this._elementDrag(element, e);\n  }\n\n  _elementDrag(element, e) {\n    e = e || window.event;\n    e.preventDefault();\n    // calculate the new cursor position:\n    this.drag.leftPos = this.drag.leftEvent - e.clientX;\n    this.drag.topPos = this.drag.topEvent - e.clientY;\n    this.drag.leftEvent = e.clientX;\n    this.drag.topEvent = e.clientY;\n\n    // set the element's new position:\n    this._setPositionStyle(element, {\n      top: element.offsetTop - this.drag.topPos,\n      left: element.offsetLeft - this.drag.leftPos,\n    });\n  }\n\n  _closeDragElement(element, e) {\n    // stop moving when mouse button is released:\n    element.onmousedown = null;\n    document.onmouseup = null;\n    document.onmousemove = null;\n\n    const newPosition = {\n      top: element.offsetTop - this.drag.topPos,\n      left: element.offsetLeft - this.drag.leftPos,\n    };\n    let newElementPos = this._constrain(newPosition);\n\n    if (newElementPos.left != this.drag.leftPos || newElementPos.top != this.drag.topPos) {\n      this._setPositionStyle(element, newElementPos);\n    }\n    this._savePosition(newElementPos);\n  }\n\n  setPosition(newPosition) {\n    newPosition = newPosition ?? this.position;\n    let application = this;\n    return new Promise((resolve) => {\n      // TODO: can be made into class method\n      function check() {\n        let element = application.getDocElement(document);\n        if (element) {\n          application._setPositionStyle(element, application._constrain(newPosition));\n          resolve();\n        } else {\n          setTimeout(check, 30);\n        }\n      }\n      check();\n    });\n  }\n\n  _setPositionStyle(element, position) {\n    element.style.bottom = undefined;\n    element.style.top = position.top + 'px';\n    element.style.left = position.left + 'px';\n  }\n\n  _constrain(newPosition) {\n    return {\n      left: Math.max(\n        this.minPos.left,\n        Math.min(window.innerWidth - this.maxPos.left, newPosition.left),\n      ),\n      top: Math.max(\n        this.minPos.top,\n        Math.min(window.innerHeight - this.maxPos.top, newPosition.top),\n      ),\n    };\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { SYSTEM_NAME } from '../constants.js';\n\nconst GM_DIFFICULTY_POOLS = 'gm-difficulty-pools';\nconst SYSTEM_KEY_GM_DIFFICULTY_POOL = `${SYSTEM_NAME}.${GM_DIFFICULTY_POOLS}`;\nexport class GMDifficulty {\n  constructor() {\n    Hooks.on('updateSetting', async (setting, update, options, id) =>\n      this.onUpdateSetting(setting, update, options, id),\n    );\n    Hooks.once('ready', () => this.onReady());\n  }\n\n  onReady() {\n    game.settings.register(SYSTEM_NAME, GM_DIFFICULTY_POOLS, {\n      scope: 'world',\n      name: game.i18n.localize(ANARCHY.settings.gmDifficulty.name),\n      hint: game.i18n.localize(ANARCHY.settings.gmDifficulty.hint),\n      config: true,\n      default: game.i18n.localize(ANARCHY.settings.gmDifficulty.default),\n      type: String,\n    });\n    this.loadDifficultySettings();\n  }\n\n  async onUpdateSetting(setting, update, options, id) {\n    if (game.user.isGM && setting.key == SYSTEM_KEY_GM_DIFFICULTY_POOL) {\n      this.loadDifficultySettings();\n      this._rebuild();\n      game.system.anarchy.gmManager.render(false);\n    }\n  }\n\n  loadDifficultySettings() {\n    const setting = game.settings.get(SYSTEM_NAME, GM_DIFFICULTY_POOLS);\n    this.difficultyPools = setting.split(',').map((it) => {\n      const kv = it.split(':');\n      if (kv[1]) {\n        return { difficulty: kv[0], pool: kv[1] };\n      }\n      return { pool: Number(kv[0]) };\n    });\n  }\n\n  getDifficultyData() {\n    return this.difficultyPools;\n  }\n\n  async activateListeners(html) {\n    this.toolbar = html.find('.gm-difficulty-bar');\n    await this._rebuild();\n  }\n\n  async _rebuild() {\n    this.toolbar.find('.gm-difficulty-bar').replaceWith(await this._renderBar());\n    this.toolbar\n      .find('a.click-roll-difficuty-pool')\n      .click(async (event) => await this._onClickDifficulty(event));\n  }\n\n  async _renderBar() {\n    return await foundry.applications.handlebars.renderTemplate(\n      'systems/anarchy/templates/app/gm-difficulty-buttons.hbs',\n      {\n        difficultyPools: this.difficultyPools,\n      },\n    );\n  }\n\n  async _onClickDifficulty(event) {\n    const pool = $(event.currentTarget).attr('data-pool');\n    const difficulty = $(event.currentTarget).attr('data-difficulty');\n    const roll = new Roll(`${pool}d6cs>=5`);\n    await roll.evaluate();\n    const flavor = game.i18n.format(ANARCHY.settings.gmDifficulty.chatMessage, {\n      pool: pool,\n      difficulty: difficulty ?? pool,\n      success: roll.total,\n    });\n    const message = await roll.toMessage({ flavor: flavor }, { create: false });\n    ChatMessage.create(message);\n  }\n}\n","import { HandleDragApplication } from './handle-drag.js';\nimport { ANARCHY } from '../config.js';\nimport { SYSTEM_NAME } from '../constants.js';\nimport { GMDifficulty } from './gm-difficulty.js';\nimport '../../styles/gm-manager.scss';\n\nconst GM_MANAGER = 'gm-manager';\nconst GM_MANAGER_POSITION = 'gm-manager-position';\nconst GM_MANAGER_INITIAL_POSITION = { top: 200, left: 200 };\nconst GM_MANAGER_TEMPLATE = 'systems/anarchy/templates/app/gm-manager.hbs';\n\nexport class GMManager extends Application {\n  constructor(gmAnarchy, gmConvergence) {\n    super();\n    this.gmAnarchy = gmAnarchy;\n    this.gmConvergence = gmConvergence;\n    this.gmDifficulty = new GMDifficulty();\n    this.handleDrag = new HandleDragApplication((doc) => doc.getElementById('gm-manager'), {\n      initial: GM_MANAGER_INITIAL_POSITION,\n      maxPos: { left: 200, top: 100 },\n      settings: {\n        system: SYSTEM_NAME,\n        keyPosition: GM_MANAGER_POSITION,\n      },\n    });\n    Hooks.once('ready', () => this.onReady());\n    Hooks.on('renderChatLog', async (app, html, data) => {\n      const templatePath = 'systems/anarchy/templates/app/chat-tools.hbs';\n      const templateData = {\n        title: game.i18n.localize('ANARCHY.gmManager.title'),\n        rollDice: game.i18n.localize('ANARCHY.chat_actions.rollDice.title'),\n        isGM: game.user.isGM,\n      };\n      const templateHTML = await foundry.applications.handlebars.renderTemplate(\n        templatePath,\n        templateData,\n      );\n      const template = $(templateHTML);\n      $(html).find('form.chat-form').append(template[0]);\n\n      const buttonDICE = $(html).find('form.chat-form .rolldice');\n\n      buttonDICE.on('click', (event) => {\n        event.preventDefault();\n        new Dialog({\n          title: game.i18n.localize('ANARCHY.chat_actions.rollDice.title'),\n          content:\n            '<div style=\"display:flex;margin:4px 0 8px 0;align-items:center;gap:8px\">' +\n            game.i18n.localize('ANARCHY.chat_actions.rollDice.instruction') +\n            '<input class=\"roll-dice-value\" name=\"macro-roll-count-dice\" type=\"number\" value=\"3\" /></div>',\n          buttons: {\n            cancel: {\n              label: game.i18n.localize('ANARCHY.common.cancel'),\n              icon: '<i class=\"fas fa-times\"></i>',\n            },\n            submit: {\n              label: game.i18n.localize('ANARCHY.common.roll.button'),\n              icon: '<i class=\"fas fa-dice\"></i>',\n              callback: async (html) => {\n                const count = $(html).find('input[name=\"macro-roll-count-dice\"]').val();\n                if (!count || isNaN(count) || count <= 0) {\n                  ui.notifications.warn(game.i18n.localize('ANARCHY.chat_actions.rollDice.error'));\n                  return;\n                }\n\n                const roll = new Roll(`${count}d6cs>4`);\n                await roll.evaluate({ async: true });\n\n                const results = roll.terms[0].results;\n                const ones = results.filter((it) => it.result == 1).length;\n\n                const flavor = game.i18n.format('ANARCHY.chat_actions.rollDice.result', {\n                  count: count,\n                  success: roll.total,\n                  ones: ones,\n                });\n                const message = await roll.toMessage({ flavor: flavor }, { create: false });\n\n                ChatMessage.create(message);\n              },\n            },\n          },\n          default: 'submit',\n        }).render(true);\n      });\n\n      const buttonGM = $(html).find('form.chat-form .gmmanager');\n      buttonGM.on('click', (event) => {\n        event.preventDefault();\n        if (this._element) {\n          this.close();\n        } else {\n          this.render(true);\n        }\n      });\n    });\n  }\n\n  onReady() {\n    if (game.user.isGM) {\n      this.render(true);\n    }\n  }\n\n  /* -------------------------------------------- */\n  static get defaultOptions() {\n    let options = super.defaultOptions;\n    options.id = GM_MANAGER;\n    options.title = game.i18n.localize(ANARCHY.gmManager.title);\n    options.template = GM_MANAGER_TEMPLATE;\n    options.popOut = false;\n    options.resizable = false;\n    options.height = 'auto';\n    options.width = 'auto';\n    return options;\n  }\n  async render(force, options) {\n    if (game.user.isGM) {\n      await super.render(force, options);\n    }\n  }\n\n  getData() {\n    this.handleDrag.setPosition();\n    return {\n      anarchy: this.gmAnarchy.getAnarchy(),\n      convergences: this.gmConvergence.getConvergences(),\n      difficultyPools: this.gmDifficulty.getDifficultyData(),\n      ANARCHY: ANARCHY,\n      options: {\n        classes: [game.system.anarchy.styles.selectCssClass()],\n      },\n    };\n  }\n\n  async activateListeners(html) {\n    super.activateListeners(html);\n\n    // Apply UI customizations to GM Manager\n    if (game.system.anarchy?.uiCustomization) {\n      game.system.anarchy.uiCustomization.applyCustomizationsToElement(html[0], 'gm-manager');\n    }\n\n    html.find('.app-title-bar').mousedown((event) => this.handleDrag.onMouseDown(event));\n    html.find('.gm-manager-hide-button').mousedown((event) => this.close());\n\n    this.gmAnarchy.activateListeners(html);\n    this.gmConvergence.activateListeners(html);\n    this.gmDifficulty.activateListeners(html);\n  }\n}\n","import { ANARCHY } from './config.js';\nimport { ANARCHY_SYSTEM, TEMPLATE } from './constants.js';\nimport { ErrorManager } from './error-manager.js';\nimport { Icons } from './icons.js';\n\nfunction action(\n  code,\n  attributeFunction1,\n  attributeFunction2,\n  icon,\n  actorTypes,\n  condition = (actor) => true,\n) {\n  return {\n    code: code,\n    labelkey: ANARCHY.attributeAction[code],\n    attributeFunction1: attributeFunction1 ?? ((__) => undefined),\n    attributeFunction2: attributeFunction2 ?? ((__) => undefined),\n    icon: icon,\n    actorTypes: actorTypes,\n    condition: condition,\n  };\n}\n\nfunction defense(code, actionCode) {\n  return {\n    code: code,\n    labelkey: ANARCHY.defense[code],\n    actionCode: actionCode,\n  };\n}\n\nconst ATTR = TEMPLATE.attributes;\nconst ACTOR = TEMPLATE.actorTypes;\nconst ACTION = ANARCHY_SYSTEM.actions;\nconst DEFENSE = ANARCHY_SYSTEM.defenses;\n\nconst ATTRIBUTE_ACTIONS = [\n  action(\n    ACTION.defense,\n    (__) => ATTR.agility,\n    (__) => ATTR.logic,\n    Icons.fontAwesome('fas fa-shield-alt'),\n    [ACTOR.character],\n  ),\n  action(\n    ACTION.defense,\n    (__) => ATTR.autopilot,\n    (__) => ATTR.handling,\n    Icons.fontAwesome('fas fa-tachometer-alt'),\n    [ACTOR.vehicle],\n  ),\n  // TODO: add a way to pilot a vehicle to fallback defense of controled vehicle\n  action(\n    ACTION.resistTorture,\n    (__) => ATTR.strength,\n    (__) => ATTR.willpower,\n    Icons.fontAwesome('fas fa-angry'),\n    [ACTOR.character],\n  ),\n\n  action(\n    ACTION.perception,\n    (__) => ATTR.logic,\n    (__) => ATTR.willpower,\n    Icons.fontAwesome('fas fa-eye'),\n    [ACTOR.character],\n  ),\n  action(ACTION.perception, (__) => ATTR.autopilot, undefined, Icons.fontAwesome('fas fa-video'), [\n    ACTOR.vehicle,\n  ]),\n  action(\n    ACTION.perception,\n    (actor) => actor.getMatrixLogic(),\n    (actor) => actor.getMatrixLogic(),\n    Icons.fontAwesome('fas fa-video'),\n    [ACTOR.device, ACTOR.sprite, ACTOR.ic],\n  ),\n\n  action(\n    ACTION.composure,\n    (__) => ATTR.charisma,\n    (__) => ATTR.willpower,\n    Icons.fontAwesome('fas fa-meh'),\n    [ACTOR.character],\n  ),\n  action(\n    ACTION.judgeIntentions,\n    (__) => ATTR.charisma,\n    (__) => ATTR.charisma,\n    Icons.fontAwesome('fas fa-theater-masks'),\n    [ACTOR.character],\n  ),\n  action(\n    ACTION.memory,\n    (__) => ATTR.logic,\n    (__) => ATTR.logic,\n    Icons.fontAwesome('fas fa-brain'),\n    [ACTOR.character],\n  ),\n  action(\n    ACTION.catch,\n    (__) => ATTR.agility,\n    (__) => ATTR.agility,\n    Icons.fontAwesome('fas fa-baseball-ball'),\n    [ACTOR.character],\n  ),\n  action(\n    ACTION.lift,\n    (__) => ATTR.strength,\n    (__) => ATTR.strength,\n    Icons.fontAwesome('fas fa-dumbbell'),\n    [ACTOR.character],\n  ),\n\n  action(\n    ACTION.matrixDefense,\n    (actor) => actor.getMatrixLogic(),\n    (actor) => actor.getMatrixFirewall(),\n    Icons.fontAwesome('fas fa-shield-virus'),\n    [ACTOR.character, ACTOR.sprite, ACTOR.ic, ACTOR.device, ACTOR.vehicle],\n  ),\n  action(\n    ACTION.astralDefense,\n    (___) => ATTR.logic,\n    (___) => ATTR.willpower,\n    Icons.fontAwesome('fas fa-shield-virus'),\n    [ACTOR.character],\n  ),\n];\n\nconst DEFENSES = [\n  defense(DEFENSE.physicalDefense, ACTION.defense),\n  defense(DEFENSE.physicalResistance, ACTION.resistTorture),\n  defense(DEFENSE.socialDefense, ACTION.composure),\n  defense(DEFENSE.matrixDefense, ACTION.matrixDefense),\n  defense(DEFENSE.mentalResistance, ACTION.perception),\n];\n\nexport class AttributeActions {\n  static init() {\n    Handlebars.registerHelper('fixedDefenseCode', (code) =>\n      AttributeActions.fixedDefenseCode(code),\n    );\n  }\n\n  static all(filter = undefined) {\n    return filter ? ATTRIBUTE_ACTIONS.filter(filter) : ATTRIBUTE_ACTIONS;\n  }\n\n  static getActorActions(actor) {\n    return ATTRIBUTE_ACTIONS.filter(\n      (it) => it.actorTypes.includes(actor.type) && it.condition(actor),\n    );\n  }\n\n  static fixedDefenseCode(code) {\n    return ANARCHY_SYSTEM.fixedDefenseCode[code] ?? code;\n  }\n  static getActorDefenses(actor) {\n    return DEFENSES.map((defense) => {\n      const actorAction = AttributeActions.getActorAction(actor, defense.actionCode);\n      return AttributeActions._convertToDefense(actorAction, defense);\n    }).filter((it) => it?.code);\n  }\n\n  static getDefenseAttributeAction(defenseCode) {\n    return DEFENSES.find((it) => it.code == defenseCode)?.actionCode;\n  }\n\n  static getActorAction(actor, actionCode) {\n    return AttributeActions.getActorActions(actor).find((it) => it.code == actionCode);\n  }\n\n  static getActorDefense(actor, defenseCode) {\n    defenseCode = AttributeActions.fixedDefenseCode(defenseCode);\n    const defense = DEFENSES.find((it) => it.code == defenseCode);\n    const actorAction = AttributeActions.getActorAction(actor, defense.actionCode);\n    ErrorManager.checkActorDefenseAction(actorAction, actor, defense);\n    return AttributeActions._convertToDefense(actorAction, defense);\n  }\n\n  static _convertToDefense(actorAction, defense) {\n    return actorAction\n      ? foundry.utils.mergeObject(defense, actorAction ?? {}, { overwrite: false, inplace: false })\n      : undefined;\n  }\n\n  static getDefenses() {\n    return DEFENSES;\n  }\n\n  static prepareShortcut(actor, actionCode) {\n    const action = AttributeActions.getActorActions(actor).find((a) => a.code == actionCode);\n    if (action) {\n      return {\n        icon: action.icon,\n        label: game.i18n.localize(action.labelkey),\n        callback: (token) => token.actor.rollAttributeAction(actionCode),\n      };\n    }\n    return undefined;\n  }\n}\n","export const NO_MATRIX_MONITOR = {\n  canMark: false,\n  marks: [],\n  value: 0,\n  max: 0,\n  resistance: 0,\n};\n\nexport const MATRIX = {\n  connectionMode: {\n    disconnected: 'disconnected',\n    augmented: 'augmented',\n    virtual: 'virtual',\n  },\n};\n\nexport class Matrix {\n  static resolveConnectionMode(connectionMode) {\n    switch (connectionMode) {\n      case MATRIX.connectionMode.disconnected:\n      case MATRIX.connectionMode.augmented:\n      case MATRIX.connectionMode.virtual:\n        return connectionMode;\n      case undefined:\n      default:\n        return MATRIX.connectionMode.disconnected;\n    }\n  }\n\n  static getNextConnectionMode(connectionMode) {\n    switch (connectionMode) {\n      case MATRIX.connectionMode.disconnected:\n        return MATRIX.connectionMode.augmented;\n      case MATRIX.connectionMode.augmented:\n        return MATRIX.connectionMode.virtual;\n      default:\n      case MATRIX.connectionMode.virtual:\n        return MATRIX.connectionMode.disconnected;\n    }\n  }\n}\n","import { AttributeActions } from '../attribute-actions.js';\nimport { ANARCHY } from '../config.js';\nimport { TEMPLATE } from '../constants.js';\nimport { Enums } from '../enums.js';\nimport { Misc } from '../misc.js';\n\nconst SHADOWAMP_TYPES = [\n  TEMPLATE.itemType.shadowamp,\n  TEMPLATE.itemType.weapon,\n  TEMPLATE.itemType.cyberdeck,\n];\n/**\n * Modifier: {group, effect, category, subCategory, value, condition, id}\n */\nexport class Modifiers {\n  constructor() {\n    this.modifiers = {\n      groups: Enums.mapObjetToKeyValue(ANARCHY.modifier.group, 'key', 'label'),\n      roll: Modifiers._buildGroupOptions('roll'),\n      attribute: Modifiers._buildGroupOptions('attribute'),\n      monitor: Modifiers._buildGroupOptions('monitor'),\n      other: Modifiers._buildGroupOptions('other'),\n    };\n    Hooks.once('ready', () => this.onReady());\n  }\n\n  static _buildGroupOptions(group) {\n    switch (group) {\n      case 'attribute':\n        return {\n          label: ANARCHY.modifier.group[group],\n          effects: Enums.hbsAttributes.map((it) => {\n            return { key: it['value'], label: it['labelkey'] };\n          }),\n          categories: [],\n        };\n    }\n    return {\n      label: ANARCHY.modifier.group[group],\n      effects: Enums.mapObjetToKeyValue(ANARCHY.modifier[group].effect, 'key', 'label'),\n      categories: Enums.mapObjetToKeyValue(ANARCHY.modifier[group].category, 'key', 'label'),\n    };\n  }\n\n  async onReady() {\n    Handlebars.registerHelper('modifierHasSubCategory', (group, effect, category) =>\n      this.hasSubCategory(group, effect, category),\n    );\n    Handlebars.registerHelper('modifierSelectOption', (value, options) =>\n      this.getSelectOptions(value, options),\n    );\n  }\n\n  hasSubCategory(group, effect, category) {\n    switch (group) {\n      case 'roll':\n        return true;\n    }\n    return false;\n  }\n\n  getSelectOptions(select, options) {\n    switch (select) {\n      case 'group':\n        return this.modifiers.groups;\n      case 'effect':\n        return this.modifiers[options.hash.group]?.effects;\n      case 'category':\n        return this.modifiers[options.hash.group]?.categories;\n      case 'subCategory':\n        switch (options.hash.group) {\n          case 'roll': {\n            return this.getSelectRollSubCategories(options.hash.category);\n          }\n        }\n        return [];\n    }\n    return [];\n  }\n\n  getSelectRollSubCategories(category) {\n    switch (category) {\n      case 'attribute':\n        return Enums.getAttributes().map((attr) => {\n          return { key: attr.value, label: attr.labelkey };\n        });\n      case 'skill':\n        return game.system.anarchy.skills.getSkills().map((it) => {\n          return { key: it.code, label: it.labelkey };\n        });\n      case 'attributeAction':\n        const actions = AttributeActions.all().map((action) => {\n          return { key: action.code, label: action.labelkey };\n        });\n        return Misc.distinct(actions.map((it) => it.key)).map((key) =>\n          actions.find((it) => it.key == key),\n        );\n    }\n    return [];\n  }\n\n  getEnums() {\n    return { modifiers: this.modifiers };\n  }\n\n  static buildRollModifiersFilter(context, effect) {\n    return (m) => {\n      if (m.group == 'roll' && m.effect == effect) {\n        switch (m.category) {\n          case 'attribute':\n            return [context.attribute1, context.attribute2].includes(m.subCategory);\n          case 'skill':\n            return m.subCategory == context.skill?.system.code;\n          case 'attributeAction':\n            return (\n              m.subCategory == context.attributeAction ||\n              m.subCategory == AttributeActions.getDefenseAttributeAction(context.defenseAction)\n            );\n        }\n      }\n      return false;\n    };\n  }\n\n  static computeRollModifiers(items, context, effect) {\n    const contextFilter = Modifiers.buildRollModifiersFilter(context, effect);\n    const filter = (m) => m.group == 'roll' && m.effect == effect && contextFilter(m);\n\n    const itemModifiers = Modifiers._activeItems(items)\n      .map((item) => Modifiers.itemModifiers(item, filter))\n      .reduce((a, b) => a.concat(b), [])\n      .sort(Misc.descending((im) => im.modifier.value));\n\n    const sumShadowamp = Modifiers.$sumShadowampModifiers(\n      itemModifiers\n        .filter((it) => SHADOWAMP_TYPES.includes(it.item.type))\n        .map((im) => im.modifier.value),\n    );\n    const sumOthers = Misc.sumValues(\n      itemModifiers\n        .filter((it) => !SHADOWAMP_TYPES.includes(it.item.type))\n        .map((im) => im.modifier.value),\n    );\n    return {\n      value: sumShadowamp + sumOthers,\n      sources: itemModifiers,\n    };\n  }\n\n  static $sumShadowampModifiers(shadowampModifiers) {\n    const maxPositive = shadowampModifiers.find((v) => v > 3) ?? 0;\n    const negative = Misc.sumValues(shadowampModifiers.filter((v) => v < 0));\n    const positive = Math.min(3, Misc.sumValues(shadowampModifiers.filter((v) => v > 0 && v <= 3)));\n    // allow only one item with modifier above 3 that replaces usual max of 3 to positive modifiers (for deltaware option in French rulebook)\n    return negative + Math.max(positive, maxPositive);\n  }\n\n  static computeModifiers(items, group, effect = undefined, category = undefined) {\n    const filter = Modifiers._createFilter(group, effect, category);\n    const itemModifiers = Modifiers._activeItems(items)\n      .map((item) => Modifiers.itemModifiers(item, filter))\n      .reduce((a, b) => a.concat(b), []);\n    const value = Misc.sumValues(itemModifiers, (m) => m.modifier.value);\n    return {\n      value: value,\n      sources: itemModifiers,\n    };\n  }\n\n  static sumMonitorModifiers(items, monitor, category) {\n    return Modifiers.sumModifiers(Modifiers._activeItems(items), 'monitor', monitor, category);\n  }\n\n  static sumModifiers(items, group, effect, category) {\n    const filter = Modifiers._createFilter(group, effect, category);\n    const itemModifiers = Modifiers._activeItems(items)\n      .map((item) => Modifiers.itemModifiers(item, filter))\n      .reduce((a, b) => a.concat(b), []);\n\n    return Misc.sumValues(itemModifiers, (m) => m.modifier.value);\n  }\n\n  static _createFilter(group, effect, category) {\n    return (m) =>\n      m.group == group &&\n      m.effect == (effect == undefined ? m.effect : effect) &&\n      m.category == (category == undefined ? m.category : category);\n  }\n\n  static countModifiers(items, group, effect = undefined, category = undefined) {\n    const filter = Modifiers._createFilter(group, effect, category);\n    const itemModifiers = Modifiers._activeItems(items)\n      .map((item) => Modifiers.itemModifiers(item, filter))\n      .reduce((a, b) => a.concat(b), []);\n\n    return itemModifiers.count;\n  }\n\n  static itemModifiers(item, filter) {\n    return Modifiers._listItemModifiers(item, filter).map((m) => Modifiers._itemModifier(item, m));\n  }\n\n  static _listItemModifiers(item, filter = (m) => true) {\n    return (item.system.modifiers ?? []).filter(filter);\n  }\n\n  static _itemModifier(item, modifier) {\n    return {\n      item: item,\n      modifier: modifier,\n    };\n  }\n\n  static _activeItems(items) {\n    return items.filter((it) => it.isActive());\n  }\n}\n","import { Misc } from '../misc.js';\n\nconst DICE_FAS_ICONS = {\n  highlighted: [\n    'far fa-times-circle',\n    'fas fa-dice-one',\n    'fas fa-dice-two',\n    'fas fa-dice-three',\n    'fas fa-dice-four',\n    'fas fa-dice-five',\n    'fas fa-dice-six',\n  ],\n  dimmed: [\n    'far fa-times-circle',\n    'far fa-dice-one',\n    'far fa-dice-two',\n    'far fa-dice-three',\n    'far fa-dice-four',\n    'far fa-dice-five',\n    'far fa-dice-six',\n  ],\n};\n\nexport class DiceCursor {\n  static init() {\n    Hooks.once('ready', async () => await this.onReady());\n    Handlebars.registerHelper('dice-cursor-array', (min, max) =>\n      DiceCursor.array(min ?? 0, max ?? 5),\n    );\n    Handlebars.registerHelper('dice-cursor-fas', (dice, value) => DiceCursor.fasClass(dice, value));\n    Handlebars.registerHelper('dice-cursor-active', (dice, value) =>\n      DiceCursor.activeClass(dice, value),\n    );\n    Handlebars.registerHelper('dice-cursor-color', (dice, editable) =>\n      DiceCursor.colorClass(dice, editable),\n    );\n  }\n\n  static async onReady() {\n    await loadTemplates(['systems/anarchy/templates/roll/parts/dice-cursor.hbs']);\n  }\n\n  static array(min, max) {\n    if (min > max) throw `min>max: ${min} > ${max}`;\n    return Array(max - min + 1)\n      .fill()\n      .map((item, index) => min + index);\n  }\n\n  static isActive(dice, value) {\n    return (value <= dice && dice < 0) || (0 < dice && dice <= value);\n  }\n\n  static activeClass(dice, value) {\n    return DiceCursor.isActive(dice, value) ? 'active' : 'inactive';\n  }\n\n  static fasClass(dice, value) {\n    const fasSource = DiceCursor.isActive(dice, value)\n      ? DICE_FAS_ICONS.highlighted\n      : DICE_FAS_ICONS.dimmed;\n    return DiceCursor.$getFas(fasSource, Math.abs(dice));\n    return fas;\n  }\n\n  static colorClass(dice, editable) {\n    if (dice == 0 || !editable) {\n      return dice < 0 ? 'fixed-dice-malus' : 'fixed-dice-bonus';\n    }\n    return dice < 0 ? 'variable-dice-malus' : 'variable-dice-bonus';\n  }\n\n  static $getFas(fasArray, dice) {\n    return fasArray[dice > 6 ? dice % 6 : dice];\n  }\n\n  static async diceCursor({ value, min, max, editable }) {\n    return await foundry.applications.handlebars.renderTemplate(\n      'systems/anarchy/templates/roll/parts/dice-cursor.hbs',\n      {\n        value,\n        min,\n        max,\n        editable,\n      },\n    );\n  }\n}\n","export class CharacterActorEssence {\n  static getMalus(actor, essence) {\n    const max = 6;\n    const malus = Math.min(0, -Math.floor((1 + max - essence) / 2));\n    return malus;\n  }\n}\n","import { CharacterActorEssence } from './actor/character-actor-essence.js';\nimport { CHECKBARS, Checkbars } from './common/checkbars.js';\nimport { ANARCHY } from './config.js';\nimport { LOG_HEAD, SYSTEM_NAME } from './constants.js';\n\nexport const ANARCHY_HOOKS = {\n  /**\n   * Hook to declare template data migrations\n   */\n  DECLARE_MIGRATIONS: 'anarchy-declareMigration',\n  /**\n   * Hook used to declare additional styles available\n   */\n  REGISTER_STYLES: 'anarchy-registerStyles',\n  /**\n   * Hook allowing to register additional roll parameters\n   */\n  REGISTER_ROLL_PARAMETERS: 'anarchy-registerRollParameters',\n  /**\n   * Hook allowing to modify some parameters (from Anarchy hacks modules).\n   * Setting property ignore=true allows to remove the parameter.\n   */\n  MODIFY_ROLL_PARAMETER: 'anarchy-forbidRollParameter',\n  /**\n   * Hook allowing to provide alternate skill sets for Anarchy hack modules\n   */\n  PROVIDE_SKILL_SET: 'anarchy-provideSkillSet',\n  /**\n   * Hook allowing to provide alternate way to apply damages for Anarchy hack modules\n   */\n  PROVIDE_DAMAGE_MODE: 'anarchy-provideDamageMode',\n  /**\n   * Hook allowing to define base essence\n   */\n  PROVIDE_BASE_ESSENCE: 'anarchy-provideBaseEssence',\n  /**\n   * Hook allowing to define base essence\n   */\n  PROVIDE_MALUS_ESSENCE: 'anarchy-provideMalusEssence',\n  /**\n   * Hook allowing to provide alternate anarchy hack (TODO: document)\n   */\n  ANARCHY_HACK: 'anarchy-hack',\n};\n\nconst SETTING_KEY_ANARCHY_HACK = `${SYSTEM_NAME}.${ANARCHY_HOOKS.ANARCHY_HACK}`;\n\nconst SHADOWRUN_ANARCHY_NO_HACK = {\n  id: SYSTEM_NAME,\n  name: 'Standard Shadowrun Anarchy',\n  hack: {\n    checkbars: () => CHECKBARS,\n  },\n};\n\n// export hooks and settings for JS hacks\nglobalThis.ANARCHY_HOOKS = ANARCHY_HOOKS;\nglobalThis.SETTING_KEY_ANARCHY_HACK = SETTING_KEY_ANARCHY_HACK;\nglobalThis.SHADOWRUN_ANARCHY_NO_HACK = SHADOWRUN_ANARCHY_NO_HACK;\n\nexport class HooksManager {\n  constructor() {\n    this.hooks = [];\n    this.hacks = {};\n    this.hackNames = {};\n    this.hookMethods = {};\n    this._register(ANARCHY_HOOKS.ANARCHY_HACK);\n    this._register(ANARCHY_HOOKS.PROVIDE_BASE_ESSENCE);\n    Hooks.on(ANARCHY_HOOKS.ANARCHY_HACK, (register) => register(SHADOWRUN_ANARCHY_NO_HACK));\n    Hooks.on(ANARCHY_HOOKS.PROVIDE_BASE_ESSENCE, (provide) =>\n      provide(SHADOWRUN_ANARCHY_NO_HACK, (actor) => 6),\n    );\n    Hooks.on(ANARCHY_HOOKS.PROVIDE_MALUS_ESSENCE, (provide) =>\n      provide(SHADOWRUN_ANARCHY_NO_HACK, (actor, essence) =>\n        CharacterActorEssence.getMalus(actor, essence),\n      ),\n    );\n    Hooks.on('updateSetting', async (setting, update, options, id) =>\n      this.onUpdateSetting(setting, update, options, id),\n    );\n    Hooks.once('ready', () => this.onReady());\n  }\n\n  async onReady() {\n    Hooks.callAll(ANARCHY_HOOKS.ANARCHY_HACK, (hack) => {\n      this.hacks[hack.id] = hack;\n      this.hackNames[hack.id] = hack.name;\n    });\n    game.settings.register(SYSTEM_NAME, ANARCHY_HOOKS.ANARCHY_HACK, {\n      scope: 'world',\n      name: game.i18n.localize(ANARCHY.settings.anarchyHack.name),\n      hint: game.i18n.localize(ANARCHY.settings.anarchyHack.hint),\n      config: true,\n      default: SHADOWRUN_ANARCHY_NO_HACK.id,\n      choices: this.hackNames,\n      type: String,\n    });\n    this.applySelectedAnarchyHack();\n  }\n\n  async onUpdateSetting(setting, update, options, id) {\n    if (setting.key == SETTING_KEY_ANARCHY_HACK) {\n      this.applySelectedAnarchyHack();\n    }\n  }\n\n  applySelectedAnarchyHack() {\n    const selectedHack = this.getSelectedHack();\n    if (selectedHack) {\n      Checkbars.hackCheckbars(selectedHack.hack.checkbars());\n      const overridableMethods = [\n        ANARCHY_HOOKS.PROVIDE_BASE_ESSENCE,\n        ANARCHY_HOOKS.PROVIDE_MALUS_ESSENCE,\n      ];\n      overridableMethods.forEach((hookMethod) => this.selectHookMethod(selectedHack, hookMethod));\n    }\n  }\n\n  selectHookMethod(selectedHack, hookMethod) {\n    Hooks.callAll(hookMethod, (hack, callback) => {\n      if (hack == selectedHack) {\n        this.hookMethods[hookMethod] = callback;\n      }\n    });\n  }\n\n  getSelectedHack() {\n    return this.hacks[game.settings.get(SYSTEM_NAME, ANARCHY_HOOKS.ANARCHY_HACK)];\n  }\n\n  getHookMethod(hookMethod, fallback) {\n    return this.hookMethods[hookMethod] ?? fallback;\n  }\n\n  callHookMethod(hookMethod, ...args) {\n    const method = this.hookMethods[hookMethod];\n    return method ? method(...args) : undefined;\n  }\n\n  static instance() {\n    return game.system.anarchy.hooks;\n  }\n\n  static register(name) {\n    HooksManager.instance()._register(name);\n  }\n\n  _register(name) {\n    console.log(LOG_HEAD + 'HooksManager.register', name);\n    if (!name.startsWith(SYSTEM_NAME + '-')) {\n      throw \"For safety Anarchy Hooks names must be prefixed by anarchy'-'\";\n    }\n    this.hooks.push(name);\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { ANARCHY_SYSTEM, LOG_HEAD, TEMPLATE, TEMPLATES_PATH } from '../constants.js';\nimport { Enums } from '../enums.js';\nimport { ANARCHY_HOOKS, HooksManager } from '../hooks-manager.js';\nimport { MATRIX } from '../matrix-helper.js';\nimport { Misc } from '../misc.js';\nimport { Modifiers } from '../modifiers/modifiers.js';\n\nexport const ROLL_PARAMETER_CATEGORY = {\n  title: 'title',\n  pool: 'pool',\n  reroll: 'reroll',\n  rerollForced: 'rerollForced',\n  successReroll: 'successReroll',\n  glitch: 'glitch',\n  drain: 'drain',\n  convergence: 'convergence',\n  edge: 'edge',\n  risk: 'risk',\n  opponentPool: 'opponentPool',\n  opponentReroll: 'opponentReroll',\n};\n\nconst DEFAULT_ROLL_PARAMETERS = [\n  // attribute1\n  {\n    code: 'attribute1',\n    options: {\n      order: 1,\n      category: ROLL_PARAMETER_CATEGORY.pool,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/select-attribute.hbs`,\n    },\n    condition: (context) => Object.values(ANARCHY_SYSTEM.rollType).includes(context.mode),\n    isUsed: (p) => true,\n    factory: (context) => {\n      const attribute = context.attribute1 ?? context.skill?.system.attribute;\n      return {\n        labelkey: attribute ? ANARCHY.attributes[attribute] : ANARCHY.attributes.noAttributes,\n        value: context.actor.getAttributeValue(attribute, context.activeItem),\n        flags: { editable: context.skill },\n        selected: attribute,\n        choices: Enums.getAttributes((it) => context.attributes.includes(it)),\n      };\n    },\n  },\n\n  // attribute2\n  {\n    code: 'attribute2',\n    options: {\n      order: 1,\n      category: ROLL_PARAMETER_CATEGORY.pool,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/select-attribute.hbs`,\n      hbsTemplateChat: `${TEMPLATES_PATH}/chat/parts/pool-attribute2.hbs`,\n    },\n    condition: (context) =>\n      [\n        ANARCHY_SYSTEM.rollType.attribute,\n        ANARCHY_SYSTEM.rollType.attributeAction,\n        ANARCHY_SYSTEM.rollType.defense,\n      ].includes(context.mode),\n    isUsed: (p) => p.used,\n    onChecked: (p, selected) => (p.used = selected ? true : false),\n    factory: (context) => {\n      const attribute = context.attribute2;\n      return {\n        labelkey: attribute ? ANARCHY.attributes[attribute] : ANARCHY.attributes.noAttributes,\n        value: context.actor.getAttributeValue(attribute, context.activeItem),\n        flags: { editable: ANARCHY_SYSTEM.rollType.attribute == context.mode },\n        selected: attribute,\n        choices: Enums.getAttributes((it) => context.attributes.includes(it)),\n      };\n    },\n  },\n\n  // skill\n  {\n    code: 'skill',\n    options: {\n      flags: {},\n      order: 3,\n      category: ROLL_PARAMETER_CATEGORY.pool,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n    },\n    condition: (context) => ['skill', 'weapon'].includes(context.mode),\n    factory: (context) => {\n      return {\n        label: context.skill?.name,\n        value: context.skill?.system.value ?? 0,\n      };\n    },\n  },\n  // specialization\n  {\n    code: 'specialization',\n    options: {\n      flags: { optional: true },\n      value: 2,\n      order: 4,\n      category: ROLL_PARAMETER_CATEGORY.pool,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/check-option.hbs`,\n    },\n    isUsed: (p) => p.used,\n    condition: (context) =>\n      (context.mode == 'skill' && context.specialization) ||\n      (context.mode == 'weapon' && context.skill?.system.specialization),\n    onChecked: (p, checked) => {\n      p.used = checked;\n      p.value = checked ? 2 : 0;\n    },\n    factory: (context) => {\n      return {\n        label: context.specialization ?? context.skill.system.specialization,\n        used: context.specialization != undefined,\n        value: 2,\n      };\n    },\n  },\n  // credibility usage\n  {\n    code: 'credibility',\n    options: {\n      flags: { editDice: true, editable: true },\n      order: 5,\n      category: ROLL_PARAMETER_CATEGORY.pool,\n      value: 0,\n      labelkey: ANARCHY.common.roll.modifiers.social.credibility,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n    },\n    condition: (context) =>\n      context.skill?.system.isSocial && context.actor.getCredibilityValue() > 0,\n    factory: (context) => {\n      return {\n        min: 0,\n        max: Math.min(context.actor.getCredibilityValue(), 3),\n      };\n    },\n  },\n  // modifiers bonus\n  {\n    code: 'poolModifiers',\n    options: {\n      flags: { editDice: true, editable: true },\n      labelkey: ANARCHY.common.roll.modifiers.poolModifiers,\n      order: 5,\n      category: ROLL_PARAMETER_CATEGORY.pool,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n      min: -4,\n      max: 4,\n    },\n    factory: (context) =>\n      RollParameters.computeRollModifiers(ROLL_PARAMETER_CATEGORY.pool, context),\n  },\n  // wounds\n  {\n    code: 'wounds',\n    options: {\n      flags: { optional: true },\n      order: 10,\n      category: ROLL_PARAMETER_CATEGORY.pool,\n      labelkey: ANARCHY.common.roll.modifiers.wounds,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n    },\n    isUsed: (p) => p.used,\n    condition: (context) => context.actor.getWounds(),\n    onChecked: (p, checked) => {\n      p.used = checked;\n      p.value = checked ? -p.wounds : 0;\n    },\n    factory: (context) => {\n      const wounds = context.actor.getWounds();\n      return {\n        wounds: wounds,\n        min: -wounds,\n        max: 0,\n        value: -wounds,\n        used: true,\n      };\n    },\n  },\n  // modifier for deckers/technomancers connected in virtual reality\n  {\n    code: 'virtualReality',\n    options: {\n      flags: { editDice: false, editable: false },\n      order: 24,\n      category: ROLL_PARAMETER_CATEGORY.pool,\n      value: 1,\n      labelkey: ANARCHY.common.roll.modifiers.virtualReality,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n      min: 1,\n      max: 1,\n    },\n    condition: (context) =>\n      context.actor.isMatrixSkill(context.skill) &&\n      context.actor.isMatrixConnected(MATRIX.connectionMode.virtual),\n    factory: (context) => {\n      return {\n        flags: {\n          used:\n            context.actor.isMatrixSkill(context.skill) &&\n            context.actor.isMatrixConnected(MATRIX.connectionMode.virtual),\n        },\n      };\n    },\n  },\n  // other modifiers\n  {\n    code: 'other',\n    options: {\n      flags: { editDice: true, editable: true },\n      order: 25,\n      category: ROLL_PARAMETER_CATEGORY.pool,\n      value: 0,\n      labelkey: ANARCHY.common.roll.modifiers.other,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n      min: -5,\n      max: 5,\n    },\n  },\n  // Drain\n  {\n    code: 'drain',\n    options: {\n      flags: { editDice: true, editable: true, forceDisplay: true },\n      order: 40,\n      category: ROLL_PARAMETER_CATEGORY.drain,\n      labelkey: ANARCHY.common.roll.modifiers.drain,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n      min: 0,\n      max: 6,\n    },\n    condition: (context) =>\n      (context.mode == 'skill' || context.mode == 'weapon') && context.skill?.system.hasDrain,\n    factory: (context) => {\n      return {\n        value:\n          context.mode == 'weapon' && context.weapon.hasDrain ? context.weapon.system.drain : 1,\n      };\n    },\n  },\n  // convergence\n  {\n    code: 'convergence',\n    options: {\n      flags: { editDice: false, optional: true, used: true, hideParameter: true },\n      order: 40,\n      category: ROLL_PARAMETER_CATEGORY.convergence,\n      value: 1,\n      labelkey: ANARCHY.common.roll.modifiers.convergence,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/check-option.hbs`,\n    },\n    isUsed: (p) => p.used,\n    condition: (context) =>\n      (context.mode == 'skill' || context.mode == 'weapon') && context.skill?.system.hasConvergence,\n    onChecked: (p, checked) => {\n      p.used = checked;\n      p.value = checked ? 1 : 0;\n    },\n  },\n  // glitch\n  {\n    code: 'glitch',\n    options: {\n      flags: { editDice: true, editable: true, forceDisplay: true },\n      order: 50,\n      category: ROLL_PARAMETER_CATEGORY.glitch,\n      labelkey: ANARCHY.common.roll.modifiers.glitch,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n      hbsTemplateChat: `${TEMPLATES_PATH}/chat/parts/glitch.hbs`,\n      min: 0,\n      max: 5,\n    },\n    isUsed: (p) => p.value > 0,\n    factory: (context) => {\n      const wounds = context.actor.getWounds();\n      const glitchModifiers = RollParameters.computeRollModifiers(\n        ROLL_PARAMETER_CATEGORY.glitch,\n        context,\n      );\n      return {\n        value: (wounds == 0 ? 0 : 1) + (context.glitch ?? 0) + glitchModifiers.value,\n      };\n    },\n  },\n  // social rumor\n  {\n    code: 'rumor',\n    options: {\n      flags: { editDice: true, editable: true },\n      order: 50,\n      category: ROLL_PARAMETER_CATEGORY.glitch,\n      value: 0,\n      labelkey: ANARCHY.common.roll.modifiers.social.rumor,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n      hbsTemplateChat: `${TEMPLATES_PATH}/chat/parts/glitch.hbs`,\n      min: 0,\n      max: 1,\n    },\n    condition: (context) => context.skill?.system.isSocial && context.actor.getRumorValue() > 0,\n  },\n  // rerolls\n  {\n    code: 'reroll',\n    options: {\n      flags: { editDice: true, editable: true },\n      order: 30,\n      category: ROLL_PARAMETER_CATEGORY.reroll,\n      labelkey: ANARCHY.common.roll.modifiers.reroll,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n      min: 0,\n      max: 4,\n    },\n    factory: (context) =>\n      RollParameters.computeRollModifiers(ROLL_PARAMETER_CATEGORY.reroll, context),\n  },\n  // reduction from opponent\n  {\n    code: 'reduced',\n    options: {\n      order: 29,\n      category: ROLL_PARAMETER_CATEGORY.pool,\n      labelkey: ANARCHY.common.roll.modifiers.reduced,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n      min: -4,\n      max: 0,\n    },\n    condition: (context) => (context.attackRoll?.param.opponentPool ?? 0) != 0,\n    factory: (context) => {\n      const reduced = -(context.attackRoll?.param.opponentPool ?? 0);\n      return {\n        flags: { editDice: true, used: true },\n        value: reduced,\n      };\n    },\n  },\n  // forced success rerolls\n  {\n    code: 'rerollForced',\n    options: {\n      order: 31,\n      category: ROLL_PARAMETER_CATEGORY.rerollForced,\n      labelkey: ANARCHY.common.roll.modifiers.rerollForced,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n      min: -5,\n      max: 0,\n    },\n    factory: (context) => {\n      const rerollForced = RollParameters.computeRollModifiers(\n        ROLL_PARAMETER_CATEGORY.successReroll,\n        context,\n      );\n      rerollForced.value = -rerollForced.value - (context.attackRoll?.param.opponentReroll ?? 0);\n      return foundry.utils.mergeObject(rerollForced, {\n        flags: { editDice: true, used: true, editable: true },\n      });\n    },\n  },\n  // anarchy dispositions\n  {\n    code: 'anarchyDisposition',\n    options: {\n      flags: { optional: true, isAnarchy: true, forceDisplay: true },\n      order: 70,\n      category: ROLL_PARAMETER_CATEGORY.pool,\n      value: 0,\n      min: 0,\n      max: 3,\n      labelkey: ANARCHY.common.roll.modifiers.anarchyDisposition,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/check-option.hbs`,\n    },\n    isUsed: (p) => p.used,\n    condition: (context) => context.actor.getAnarchyValue() > 0,\n    onChecked: (p, checked) => {\n      p.used = checked;\n      p.value = checked ? 3 : 0;\n    },\n  },\n  // anarchy take risks\n  {\n    code: 'anarchyRisk',\n    options: {\n      flags: { optional: true, isAnarchy: true, forceDisplay: true },\n      order: 70,\n      category: ROLL_PARAMETER_CATEGORY.risk,\n      value: 0,\n      labelkey: ANARCHY.common.roll.modifiers.anarchyRisk,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/check-option.hbs`,\n      hbsTemplateChat: `${TEMPLATES_PATH}/chat/parts/anarchy-risk.hbs`,\n    },\n    isUsed: (p) => p.used,\n    condition: (context) => context.actor.getAnarchyValue() > 0,\n    onChecked: (p, checked) => {\n      p.used = checked;\n      p.value = checked ? 1 : 0;\n    },\n  },\n  // edge\n  {\n    code: 'edge',\n    options: {\n      flags: { optional: true, forceDisplay: true },\n      value: 0,\n      order: 70,\n      category: ROLL_PARAMETER_CATEGORY.edge,\n      labelkey: ANARCHY.common.roll.modifiers.edge,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/check-option.hbs`,\n    },\n    isUsed: (p) => p.used,\n    condition: (context) => context.options.canUseEdge && context.actor.getRemainingEdge(),\n    onChecked: (p, checked) => {\n      p.used = checked;\n      p.value = checked ? 1 : 0;\n    },\n  },\n  // reduce opponent pool\n  {\n    code: 'opponentPool',\n    options: {\n      flags: { editDice: true, editable: true, forceDisplay: true },\n      order: 100,\n      category: ROLL_PARAMETER_CATEGORY.opponentPool,\n      labelkey: ANARCHY.common.roll.modifiers.opponentPool,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n      min: 0,\n      max: 4,\n    },\n    factory: (context) =>\n      RollParameters.computeRollModifiers(ROLL_PARAMETER_CATEGORY.opponentPool, context),\n    condition: (context) => !context.attributeAction,\n  },\n  // force opponent rerolls\n  {\n    code: 'opponentReroll',\n    options: {\n      flags: { editDice: true, editable: true, forceDisplay: true },\n      order: 100,\n      category: ROLL_PARAMETER_CATEGORY.opponentReroll,\n      value: 0,\n      labelkey: ANARCHY.common.roll.modifiers.opponentReroll,\n      hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n      min: 0,\n      max: 4,\n    },\n    factory: (context) =>\n      RollParameters.computeRollModifiers(ROLL_PARAMETER_CATEGORY.opponentReroll, context),\n    condition: (context) => !context.attributeAction,\n  },\n];\n\nexport class RollParameters {\n  constructor() {\n    this.registeredParameters = {};\n    HooksManager.register(ANARCHY_HOOKS.REGISTER_ROLL_PARAMETERS);\n    HooksManager.register(ANARCHY_HOOKS.MODIFY_ROLL_PARAMETER);\n    Hooks.on(ANARCHY_HOOKS.MODIFY_ROLL_PARAMETER, (p) => this._validate(p));\n    Hooks.once(ANARCHY_HOOKS.REGISTER_ROLL_PARAMETERS, (register) =>\n      DEFAULT_ROLL_PARAMETERS.forEach((parameter) => register(parameter)),\n    );\n    Hooks.once('ready', () => this.onReady());\n  }\n\n  async onReady() {\n    Hooks.callAll(ANARCHY_HOOKS.REGISTER_ROLL_PARAMETERS, async (rollParameter) => {\n      Hooks.callAll(ANARCHY_HOOKS.MODIFY_ROLL_PARAMETER, rollParameter);\n      if (!rollParameter.ignore) {\n        await this._register(rollParameter);\n      }\n    });\n    const templates = Misc.distinct(\n      []\n        .concat(Object.values(this.registeredParameters).map((p) => p.options.hbsTemplateRoll))\n        .concat(Object.values(this.registeredParameters).map((p) => p.options.hbsTemplateChat))\n        .filter((it) => it != undefined),\n    );\n    await loadTemplates(Misc.distinct(templates));\n    await loadTemplates([`${TEMPLATES_PATH}/roll/parts/parameter-label.hbs`]);\n  }\n\n  _validate(parameter) {\n    if (!parameter.code) {\n      console.error(`${LOG_HEAD} RollParameter does not have a code`, parameter);\n      parameter.ignore = true;\n    }\n  }\n\n  async _register(parameter) {\n    if (this.registeredParameters[parameter.code]) {\n      console.error(`${LOG_HEAD} RollParameter ${parameter.code} is already registered`, parameter);\n      return;\n    }\n\n    if (!parameter.onChecked) {\n      parameter.onChecked = (p, checked) => (p.used = checked);\n    }\n    parameter.onValue = (p, value) => (p.value = value);\n    this.registeredParameters[parameter.code] = parameter;\n  }\n\n  async _optionalLoadTemplate(hbsTemplate) {\n    if (hbsTemplate) {\n      await loadTemplates([hbsTemplate]);\n    }\n  }\n\n  build(context) {\n    return Object.values(this.registeredParameters)\n      .filter((p) => !p.condition || p.condition(context))\n      .map((p) => this._computeParameter(p, context));\n  }\n\n  compute(parameters) {\n    const actual = parameters.filter((it) => this.isParameterUsed(it));\n    const byCategory = Misc.classify(actual, (it) => it.category);\n    const sums = {};\n    Object.values(byCategory).forEach(\n      (list) =>\n        (sums[list[0].category] = Misc.sumValues(list, (it) => it.value ?? (it.optional ? 1 : 0))),\n    );\n    return sums;\n  }\n\n  isParameterUsed(it) {\n    const registeredParameter = this.findParameter(it.code);\n    if (registeredParameter?.isUsed != undefined) {\n      return registeredParameter.isUsed(it);\n    }\n    if (it.value != undefined) {\n      return it.value != 0;\n    }\n    console.error(\n      `registered parameter ${registeredParameter.code} does not have isUsed method`,\n      registeredParameter,\n    );\n    return false;\n  }\n\n  findParameter(code) {\n    return this.registeredParameters[code];\n  }\n\n  _computeParameter(param, context) {\n    const computed = {\n      code: param.code,\n      onChecked: param.onChecked,\n      onValue: param.onValue,\n      isUsed: param.isUsed,\n    };\n    foundry.utils.mergeObject(computed, param.options);\n    if (param.factory) {\n      foundry.utils.mergeObject(computed, param.factory(context, param.options));\n    }\n    foundry.utils.mergeObject(computed, {\n      used: computed.used || computed.value,\n      min: computed.min ?? 0,\n      max: computed.max ?? computed.value ?? 0,\n    });\n\n    return computed;\n  }\n\n  static computeRollModifiers(effect, context) {\n    const itemsFilter = (it) =>\n      it.type != TEMPLATE.itemType.weapon || (context.weapon && it.id == context.weapon.id);\n    const items = context.actor.items.filter(itemsFilter);\n    return Modifiers.computeRollModifiers(items, context, effect);\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { ANARCHY_SYSTEM, TEMPLATE, TEMPLATES_PATH } from '../constants.js';\nimport { Enums } from '../enums.js';\nimport { Misc } from '../misc.js';\nimport { DiceCursor } from './dice-cursor.js';\nimport { ROLL_PARAMETER_CATEGORY } from './roll-parameters.js';\n\n/**\n * Extend the base Dialog to select roll parameters\n * @extends {Dialog}\n */\nexport class RollDialog extends Dialog {\n  static init() {\n    Hooks.once('ready', async () => await this.onReady());\n  }\n\n  static async onReady() {\n    await loadTemplates([\n      'systems/anarchy/templates/roll/roll-parameters-category.hbs',\n      'systems/anarchy/templates/roll/parts/generic.hbs',\n      'systems/anarchy/templates/roll/parts/image-attribute.hbs',\n      'systems/anarchy/templates/roll/parts/image-attributeAction.hbs',\n      'systems/anarchy/templates/roll/parts/image-defense.hbs',\n      'systems/anarchy/templates/roll/parts/image-skill.hbs',\n      'systems/anarchy/templates/roll/parts/image-weapon.hbs',\n    ]);\n  }\n\n  static prepareActorRoll(actor, item = undefined) {\n    return {\n      actor: actor,\n      tokenId: actor.token?.id,\n      attributes: actor.getUsableAttributes(item),\n      options: {\n        canUseEdge: actor.canUseEdge(),\n      },\n    };\n  }\n\n  static async rollAttribute(actor, attribute) {\n    const rollData = foundry.utils.mergeObject(RollDialog.prepareActorRoll(actor), {\n      mode: ANARCHY_SYSTEM.rollType.attribute,\n      attribute1: attribute,\n    });\n    await RollDialog.create(rollData);\n  }\n\n  static async rollAttributeAction(actor, action) {\n    const rollData = foundry.utils.mergeObject(RollDialog.prepareActorRoll(actor), {\n      mode: ANARCHY_SYSTEM.rollType.attributeAction,\n      attributeAction: action.code,\n      attribute1: action.attributeFunction1(actor),\n      attribute2: action.attributeFunction2(actor),\n    });\n    await RollDialog.create(rollData);\n  }\n\n  static async rollAttribute(actor, attribute) {\n    const rollData = foundry.utils.mergeObject(RollDialog.prepareActorRoll(actor), {\n      mode: ANARCHY_SYSTEM.rollType.attribute,\n      attribute1: attribute,\n    });\n    await RollDialog.create(rollData);\n  }\n\n  static async rollSkill(actor, skill, specialization) {\n    const rollData = foundry.utils.mergeObject(RollDialog.prepareActorRoll(actor), {\n      mode: ANARCHY_SYSTEM.rollType.skill,\n      skill: skill,\n      attribute1: skill?.system.attribute ?? TEMPLATE.attributes.agility,\n      specialization: specialization,\n    });\n    await RollDialog.create(rollData);\n  }\n\n  static async rollWeapon(actor, skill, weapon, targeting) {\n    const rollData = foundry.utils.mergeObject(RollDialog.prepareActorRoll(actor), {\n      mode: ANARCHY_SYSTEM.rollType.weapon,\n      weapon: weapon,\n      skill: skill,\n      attribute1: skill?.system.attribute ?? actor.getPhysicalAgility(),\n      specialization: skill?.system.specialization,\n      targeting: targeting,\n    });\n    await RollDialog.create(rollData);\n  }\n\n  static async rollDefense(actor, action, attack, pilot = undefined) {\n    const rollData = foundry.utils.mergeObject(RollDialog.prepareActorRoll(actor), {\n      mode: ANARCHY_SYSTEM.rollType.defense,\n      attribute1: action.attributeFunction1(actor),\n      attribute2: action.attributeFunction2(actor),\n      defenseAction: action.code,\n      attackRoll: attack.attackRoll,\n      tokenId: attack.defenderTokenId,\n      choiceChatMessageId: attack.choiceChatMessageId,\n    });\n    await RollDialog.create(rollData);\n  }\n\n  static async itemAttributeRoll(item, attribute) {\n    const rollData = foundry.utils.mergeObject(RollDialog.prepareActorRoll(item.actor), {\n      mode: ANARCHY_SYSTEM.rollType.attribute,\n      item: item,\n      attribute1: attribute,\n      attributes: item.actor.getUsableAttributes(item),\n    });\n    await RollDialog.create(rollData);\n  }\n\n  static async create(roll) {\n    const rollParameters = game.system.anarchy.rollParameters\n      .build(roll)\n      .sort(Misc.ascending((p) => p.order ?? 200));\n    foundry.utils.mergeObject(roll, {\n      ENUMS: Enums.getEnums((attributeName) => roll.attributes.includes(attributeName)),\n      ANARCHY: ANARCHY,\n      parameters: rollParameters,\n    });\n\n    const title = await foundry.applications.handlebars.renderTemplate(\n      `${TEMPLATES_PATH}/roll/roll-dialog-title.hbs`,\n      roll,\n    );\n    const html = await foundry.applications.handlebars.renderTemplate(\n      `${TEMPLATES_PATH}/roll/roll-dialog.hbs`,\n      roll,\n    );\n    new RollDialog(title, html, roll).render(true);\n  }\n\n  constructor(title, html, roll) {\n    const config = {\n      title: title,\n      content: html,\n      default: 'roll',\n      buttons: {\n        roll: {\n          label: game.i18n.localize(ANARCHY.common.roll.button),\n          callback: async () => await game.system.anarchy.rollManager.roll(roll),\n        },\n      },\n    };\n    const options = {\n      classes: [game.system.anarchy.styles.selectCssClass(), 'anarchy-dialog'],\n      width: 500,\n      height: 'fit-content',\n      'z-index': 99999,\n    };\n\n    super(config, options);\n\n    this.roll = roll;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n    this.html = html;\n    this.bringToTop();\n\n    this.html.find('.select-attribute-parameter').change(async (event) => {\n      const parameter = this._getRollParameter(event);\n      const item = this._getEventItem(event, this.roll.actor);\n      const selected = event.currentTarget.value;\n      const value = this.roll.actor.getAttributeValue(selected, item);\n      this.roll[parameter.code] = selected;\n      await this._setParameterSelectedOption(parameter, selected, value);\n    });\n\n    this.html.find('.check-optional').click(async (event) => {\n      const parameter = this._getRollParameter(event);\n      parameter.onChecked(parameter, event.currentTarget.checked);\n      if (parameter.category == ROLL_PARAMETER_CATEGORY.pool) {\n        await this._updateParameterValue(parameter, parameter.value);\n      }\n    });\n\n    this.activateDiceParameterClick();\n\n    this.html.find('input.parameter-value:not(:disabled)').on('input', async (event) => {\n      const parameter = this._getRollParameter(event);\n      const value = Number.parseInt(event.currentTarget.value) ?? 0;\n      await this._updateParameterValue(parameter, value);\n    });\n\n    this.html.find('.select-option-parameter').change(async (event) => {\n      const parameter = this._getRollParameter(event);\n      const selected = event.currentTarget.value;\n      const value = Number.parseInt(selected);\n      await this._setParameterSelectedOption(parameter, selected, value);\n    });\n  }\n\n  activateDiceParameterClick() {\n    this.html.find('.input-cursor-parameter a').click(async (event) => {\n      const parameter = this._getRollParameter(event);\n      if (parameter.flags?.editDice) {\n        const clickedValue =\n          Number.parseInt(this.html.find(event.currentTarget).attr('data-dice')) ?? 0;\n        const value =\n          parameter.value != clickedValue || clickedValue == 0\n            ? clickedValue\n            : clickedValue > 0\n              ? clickedValue - 1\n              : clickedValue + 1;\n        await this._updateParameterValue(parameter, value);\n      }\n    });\n  }\n\n  async _setParameterSelectedOption(parameter, selected, value) {\n    parameter.onChecked(parameter, selected);\n    parameter.max = value;\n    await this._updateParameterValue(parameter, value);\n  }\n\n  async _updateParameterValue(parameter, value) {\n    parameter.onValue(parameter, value);\n\n    this.html\n      .find(`.parameter[data-parameter-code='${parameter.code}'] .parameter-value`)\n      .text(value);\n\n    const diceCursorHtml = await this.renderDiceCursor(parameter);\n    const diceCursor = this.html.find(\n      `.parameter[data-parameter-code='${parameter.code}'] .input-cursor-parameter`,\n    );\n    diceCursor.empty().append(diceCursorHtml);\n    this.activateDiceParameterClick();\n\n    const inputs = this.html.find(\n      `.parameter[data-parameter-code='${parameter.code}'] input.parameter-value`,\n    );\n    inputs.val(parameter.value);\n  }\n\n  async renderDiceCursor(parameter) {\n    return await DiceCursor.diceCursor({\n      value: parameter.value,\n      min: parameter.min,\n      max: parameter.max,\n      editable: parameter.flags?.editDice,\n    });\n  }\n\n  _getSelectedOption(parameter) {\n    return this.html\n      .find(\n        `.parameter[data-parameter-code='${parameter.code}'] select.select-option-parameter option:selected`,\n      )\n      .text();\n  }\n\n  _getEventItem(event, actor) {\n    const itemId = this.html.find(event.currentTarget).closest('.parameter').attr('data-item-id');\n    return itemId ? actor.items.get(itemId) : undefined;\n  }\n\n  _getRollParameter(event) {\n    const code = this.html\n      .find(event.currentTarget)\n      .closest('.parameter')\n      .attr('data-parameter-code');\n    return this.roll.parameters.find((it) => it.code == code);\n  }\n}\n","import { ANARCHY } from './config.js';\nimport {\n  ANARCHY_SYSTEM,\n  ICONS_SKILLS_PATH,\n  SYSTEM_NAME,\n  SYSTEM_PATH,\n  TEMPLATE,\n} from './constants.js';\nimport { ANARCHY_HOOKS, HooksManager } from './hooks-manager.js';\nimport { Misc } from './misc.js';\n\nconst SELECTED_SKILL_LIST = 'selected-skill-list';\nconst SETTING_KEY_SELECTED_SKILL_LIST = `${SYSTEM_NAME}.${SELECTED_SKILL_LIST}`;\n\nconst ATTR = TEMPLATE.attributes;\nconst DEFENSE = ANARCHY_SYSTEM.defenses;\n\nconst DEFAULT_SKILLSET_ANARCHY = 'shadowrun-anarchy-en';\nconst KNOWLEDGE = {\n  code: 'knowledge',\n  attribute: ATTR.knowledge,\n  icon: `${ICONS_SKILLS_PATH}/knowledge.svg`,\n};\n\nexport const ANARCHY_SKILLS = [\n  { code: 'athletics', attribute: ATTR.strength, icon: `${ICONS_SKILLS_PATH}/athletics.svg` },\n  {\n    code: 'acrobatics',\n    attribute: ATTR.agility,\n    icon: `${ICONS_SKILLS_PATH}/escape-artist.svg`,\n    lang: 'fr',\n  },\n  {\n    code: 'closeCombat',\n    attribute: ATTR.agility,\n    icon: `${ICONS_SKILLS_PATH}/close-combat.svg`,\n    defense: DEFENSE.physicalDefense,\n  },\n  {\n    code: 'projectileWeapons',\n    attribute: ATTR.agility,\n    icon: `${ICONS_SKILLS_PATH}/projectile-weapons.svg`,\n    defense: DEFENSE.physicalDefense,\n  },\n  {\n    code: 'firearms',\n    attribute: ATTR.agility,\n    icon: `${ICONS_SKILLS_PATH}/firearms.svg`,\n    defense: DEFENSE.physicalDefense,\n  },\n  {\n    code: 'heavyWeapons',\n    attribute: ATTR.agility,\n    icon: `${ICONS_SKILLS_PATH}/heavy-weapons.svg`,\n    defense: DEFENSE.physicalDefense,\n  },\n  {\n    code: 'vehicleWeapons',\n    attribute: ATTR.agility,\n    icon: `${ICONS_SKILLS_PATH}/vehicle-weapons.svg`,\n    defense: DEFENSE.physicalDefense,\n  },\n  { code: 'stealth', attribute: ATTR.agility, icon: `${ICONS_SKILLS_PATH}/stealth.svg` },\n  {\n    code: 'pilotingGround',\n    attribute: ATTR.agility,\n    icon: `${ICONS_SKILLS_PATH}/piloting-ground-steering-wheel.svg`,\n  },\n  {\n    code: 'pilotingOther',\n    attribute: ATTR.agility,\n    icon: `${ICONS_SKILLS_PATH}/piloting-other.svg`,\n  },\n  {\n    code: 'escapeArtist',\n    attribute: ATTR.agility,\n    icon: `${ICONS_SKILLS_PATH}/escape-artist.svg`,\n    lang: 'en',\n  },\n  {\n    code: 'conjuring',\n    attribute: ATTR.willpower,\n    hasDrain: true,\n    icon: `${ICONS_SKILLS_PATH}/conjuring.svg`,\n  },\n  {\n    code: 'sorcery',\n    attribute: ATTR.willpower,\n    hasDrain: true,\n    icon: `${ICONS_SKILLS_PATH}/sorcery.svg`,\n  },\n  {\n    code: 'astralCombat',\n    attribute: ATTR.willpower,\n    icon: `${ICONS_SKILLS_PATH}/astral-combat.svg`,\n    defense: DEFENSE.astralDefense,\n  },\n  { code: 'survival', attribute: ATTR.willpower, icon: `${ICONS_SKILLS_PATH}/survival.svg` },\n  { code: 'biotech', attribute: ATTR.logic, icon: `${ICONS_SKILLS_PATH}/biotech.svg` },\n  {\n    code: 'hacking',\n    attribute: ATTR.logic,\n    hasConvergence: true,\n    icon: `${ICONS_SKILLS_PATH}/hacking.svg`,\n    defense: DEFENSE.matrixDefense,\n  },\n  { code: 'electronics', attribute: ATTR.logic, icon: `${ICONS_SKILLS_PATH}/electronics.svg` },\n  { code: 'engineering', attribute: ATTR.logic, icon: `${ICONS_SKILLS_PATH}/engineering.svg` },\n  {\n    code: 'tasking',\n    attribute: ATTR.logic,\n    hasDrain: true,\n    icon: `${ICONS_SKILLS_PATH}/tasking.svg`,\n  },\n  { code: 'tracking', attribute: ATTR.logic, icon: `${ICONS_SKILLS_PATH}/tracking.svg` },\n  {\n    code: 'animals',\n    attribute: ATTR.charisma,\n    icon: `${ICONS_SKILLS_PATH}/animals.svg`,\n    lang: 'fr',\n  },\n  {\n    code: 'con',\n    attribute: ATTR.charisma,\n    isSocial: true,\n    icon: `${ICONS_SKILLS_PATH}/con-art.svg`,\n  },\n  {\n    code: 'etiquette',\n    attribute: ATTR.charisma,\n    isSocial: true,\n    icon: `${ICONS_SKILLS_PATH}/etiquette.svg`,\n    lang: 'fr',\n  },\n  {\n    code: 'intimidation',\n    attribute: ATTR.charisma,\n    isSocial: true,\n    icon: `${ICONS_SKILLS_PATH}/intimidation.svg`,\n  },\n  {\n    code: 'negotiation',\n    attribute: ATTR.charisma,\n    isSocial: true,\n    icon: `${ICONS_SKILLS_PATH}/negotiation.svg`,\n  },\n  {\n    code: 'disguise',\n    attribute: ATTR.charisma,\n    icon: `${ICONS_SKILLS_PATH}/disguise.svg`,\n    lang: 'en',\n  },\n];\nexport const MATRIX_SKILLS = ['tasking', 'hacking'];\n\nexport class Skills {\n  constructor() {\n    this.skillSets = {};\n    HooksManager.register(ANARCHY_HOOKS.PROVIDE_SKILL_SET);\n    Hooks.on(ANARCHY_HOOKS.PROVIDE_SKILL_SET, (provide) =>\n      provide(\n        DEFAULT_SKILLSET_ANARCHY,\n        'Shadowrun Anarchy EN',\n        ANARCHY_SKILLS.filter((it) => !it.lang || it.lang == 'en'),\n        { lang: 'en' },\n      ),\n    );\n    Hooks.on(ANARCHY_HOOKS.PROVIDE_SKILL_SET, (provide) =>\n      provide(\n        'shadowrun-anarchy-fr',\n        'Shadowrun Anarchy FR',\n        ANARCHY_SKILLS.filter((it) => !it.lang || it.lang == 'fr'),\n        { lang: 'fr' },\n      ),\n    );\n    Hooks.on('updateSetting', async (setting, update, options, id) =>\n      this.onUpdateSetting(setting, update, options, id),\n    );\n    Hooks.once('ready', () => this.onReady());\n  }\n\n  async onReady() {\n    this.$prepareSkill(KNOWLEDGE);\n    Hooks.callAll(ANARCHY_HOOKS.PROVIDE_SKILL_SET, (id, name, skills, details) => {\n      const skillSet = this.$prepareSkillSet(id, name, skills, details);\n      if (skillSet) {\n        this.skillSets[skillSet.id] = skillSet;\n      }\n    });\n\n    const skillSetChoices = Object.fromEntries(\n      Object.values(this.skillSets).map((e) => [e.id, e.name]),\n    );\n    game.settings.register(SYSTEM_NAME, SELECTED_SKILL_LIST, {\n      scope: 'world',\n      name: game.i18n.localize(ANARCHY.settings.skillSet.name),\n      hint: game.i18n.localize(ANARCHY.settings.skillSet.hint),\n      config: true,\n      default: DEFAULT_SKILLSET_ANARCHY,\n      choices: skillSetChoices,\n      type: String,\n    });\n    this.selectedSkills = game.settings.get(SYSTEM_NAME, SELECTED_SKILL_LIST);\n  }\n\n  async onUpdateSetting(setting, update, options, id) {\n    if (setting.key == SETTING_KEY_SELECTED_SKILL_LIST) {\n      this.selectedSkills = game.settings.get(SYSTEM_NAME, SELECTED_SKILL_LIST);\n    }\n  }\n\n  get(code) {\n    return this.getSkills({ withKnowledge: true }).find((it) => it.code == code);\n  }\n\n  getSkills(options = { withKnowledge: false }) {\n    const skills = this.$getConfiguredSkills().sort(Misc.ascending((it) => it.label));\n    if (options.withKnowledge) {\n      return [KNOWLEDGE, ...skills];\n    }\n    return skills;\n  }\n\n  $getConfiguredSkills() {\n    const skillSet =\n      this.skillSets[this.selectedSkills] ?? this.skillSets[DEFAULT_SKILLSET_ANARCHY];\n    return skillSet.skills;\n  }\n\n  $prepareSkillSet(id, name, skills, details) {\n    const skillSet = foundry.utils.mergeObject({ id: id, name: name, skills: skills }, details);\n    if (!this.$validateSkillSet(skillSet)) {\n      return undefined;\n    }\n    skillSet.skills.forEach((skill) => {\n      this.$prepareSkill(skill);\n    });\n    return skillSet;\n  }\n\n  $prepareSkill(skill) {\n    skill.labelkey = skill.labelkey ?? ANARCHY.skill[skill.code];\n    skill.icon = skill.icon ?? `${SYSTEM_PATH}/icons/skills/skills.svg`;\n  }\n\n  $validateSkillSet(skillSet) {\n    function check(check, error = '') {\n      if (!check) {\n        throw error;\n      }\n    }\n\n    try {\n      check(skillSet.id && skillSet.name, `Skills list does not have an id or name`);\n      const existing = this.skillSets[skillSet.id];\n      check(\n        !existing,\n        `Skills list ${skillSet.id} is already registered under name ${existing?.name}`,\n      );\n      check(Array.isArray(skillSet.skills), `Missing skills array`);\n      skillSet.skills.forEach((skill) => {\n        check(skill.code, `Missing skill code for ${skill} in ${skillSet.id}`);\n        check(\n          skill.labelkey || ANARCHY.skill[skill.code],\n          `Missing skill localization key for ${skill.code}`,\n        );\n        check(skill.attribute, `Missing skill attribute for ${skill.code}`);\n      });\n      const skillCodes = skillSet.skills.map((it) => it.code);\n      check(\n        skillSet.skills.length == Misc.distinct(skillCodes).length,\n        `Duplicate skill codes in ${skillCodes}`,\n      );\n      return true;\n    } catch (error) {\n      console.warn(\n        error + (skillSet.id ? ` in list ${skillSet.id}` : ' in unidentified list'),\n        skillSet,\n      );\n      return false;\n    }\n  }\n}\n","import { Checkbars } from '../common/checkbars.js';\nimport { ANARCHY } from '../config.js';\nimport { SYSTEM_NAME, TEMPLATE } from '../constants.js';\nimport { ErrorManager } from '../error-manager.js';\nimport { ANARCHY_HOOKS, HooksManager } from '../hooks-manager.js';\nimport { Modifiers } from '../modifiers/modifiers.js';\n\nconst DAMAGE_MODE = 'damage-mode';\nconst SETTING_KEY_DAMAGE_MODE = `${SYSTEM_NAME}.${DAMAGE_MODE}`;\n\nconst damageModeChoices = {};\nconst damageModeMethods = {};\n\nexport class ActorDamageManager {\n  static init() {\n    HooksManager.register(ANARCHY_HOOKS.PROVIDE_DAMAGE_MODE);\n    Hooks.on('updateSetting', async (setting, update, options, id) =>\n      ActorDamageManager.onUpdateSetting(setting, update, options, id),\n    );\n\n    Hooks.on(ANARCHY_HOOKS.PROVIDE_DAMAGE_MODE, (provide) => {\n      provide(\n        'resistanceArmorMonitor',\n        ANARCHY.settings.damageMode.values.resistanceArmorMonitor,\n        ActorDamageManager.sufferDamageResistanceArmorMonitor,\n      );\n      provide(\n        'armorResistanceMonitor',\n        ANARCHY.settings.damageMode.values.armorResistanceMonitor,\n        ActorDamageManager.sufferDamageArmorResistanceMonitor,\n      );\n      provide(\n        'armorGivesResistance',\n        ANARCHY.settings.damageMode.values.armorGivesResistance,\n        ActorDamageManager.sufferDamageArmorAsResistance_Earthdawn,\n      );\n      provide(\n        'armorGiveResistanceHitsAvoid',\n        ANARCHY.settings.damageMode.values.armorGiveResistanceHitsAvoid,\n        ActorDamageManager.sufferDamageArmorAsResistance_Cyberpunk,\n      );\n    });\n    Hooks.once('ready', () => ActorDamageManager.onReady());\n  }\n\n  static onReady() {\n    ActorDamageManager._registerDamageModeSetting();\n    ActorDamageManager._selectDamageMode();\n  }\n\n  static _registerDamageModeSetting() {\n    Hooks.callAll(ANARCHY_HOOKS.PROVIDE_DAMAGE_MODE, (code, labelkey, method) => {\n      damageModeChoices[code] = game.i18n.localize(labelkey);\n      damageModeMethods[code] = method;\n    });\n    game.settings.register(SYSTEM_NAME, DAMAGE_MODE, {\n      scope: 'world',\n      name: game.i18n.localize(ANARCHY.settings.damageMode.name),\n      hint: game.i18n.localize(ANARCHY.settings.damageMode.hint),\n      config: true,\n      default: Object.keys(damageModeChoices)[0],\n      choices: damageModeChoices,\n      type: String,\n    });\n  }\n\n  static async onUpdateSetting(setting, update, options, id) {\n    if (setting.key == SETTING_KEY_DAMAGE_MODE) {\n      ActorDamageManager._selectDamageMode();\n    }\n  }\n\n  static _selectDamageMode() {\n    let damageModeCode = game.settings.get(SYSTEM_NAME, DAMAGE_MODE);\n    if (!damageModeMethods[damageModeCode]) {\n      damageModeCode = Object.keys(damageModeChoices)[0];\n    }\n    ActorDamageManager.damageModeCode = damageModeCode;\n    ActorDamageManager.damageModeMethod = damageModeMethods[damageModeCode];\n  }\n\n  static async sufferDamage(\n    defender,\n    damageType,\n    damage,\n    success,\n    avoidArmor,\n    attacker,\n    attackWeapon,\n  ) {\n    const monitor = defender.getDamageMonitor(damageType);\n    ErrorManager.checkActorCanReceiveDamage(damageType, monitor, defender);\n    const sufferDamageMethod =\n      ActorDamageManager.damageModeMethod ?? ActorDamageManager.sufferDamageResistanceArmorMonitor;\n    await sufferDamageMethod(defender, monitor, damage, success, avoidArmor, attacker);\n    await defender.applyArmorDamage(\n      damageType,\n      Modifiers.sumModifiers([attackWeapon], 'other', 'damageArmor'),\n    );\n  }\n\n  static async sufferMarks(actor, sourceActor) {\n    await Checkbars.addCounter(actor, TEMPLATE.monitors.marks, 1, sourceActor.id);\n  }\n\n  static async sufferDamageResistanceArmorMonitor(\n    actor,\n    monitor,\n    damage,\n    success,\n    avoidArmor,\n    sourceActor,\n  ) {\n    if (monitor == TEMPLATE.monitors.marks) {\n      await ActorDamageManager.sufferMarks(actor, sourceActor);\n      return;\n    }\n    const resistance = Checkbars.resistance(actor, monitor);\n    let total = 0;\n\n    if (avoidArmor) {\n      const resisted1 = Math.min(resistance, damage);\n      const resisted2 = Math.min(resistance - resisted1, success);\n      total = damage - resisted1;\n      if (Checkbars.useArmor(monitor)) {\n        total -= await ActorDamageManager.damageToArmor(actor, total);\n      }\n      total += success - resisted2;\n    } else {\n      total = damage + success - resistance;\n      if (Checkbars.useArmor(monitor)) {\n        total -= await ActorDamageManager.damageToArmor(actor, total);\n      }\n    }\n    if (total > 0) {\n      await Checkbars.addCounter(actor, monitor, total);\n    }\n  }\n\n  static async sufferDamageArmorResistanceMonitor(\n    actor,\n    monitor,\n    damage,\n    success,\n    avoidArmor,\n    sourceActor,\n  ) {\n    if (monitor == TEMPLATE.monitors.marks) {\n      await ActorDamageManager.sufferMarks(actor, sourceActor);\n      return;\n    }\n    let total = 0;\n    if (Checkbars.useArmor(monitor)) {\n      if (avoidArmor) {\n        damage -= await ActorDamageManager.damageToArmor(actor, damage);\n        total = success + damage;\n      } else {\n        total = success + damage;\n        total -= await ActorDamageManager.damageToArmor(actor, total);\n      }\n    } else {\n      total = damage + success;\n    }\n    total -= Checkbars.resistance(actor, monitor);\n    if (total > 0) {\n      await Checkbars.addCounter(actor, monitor, total);\n    }\n    return total;\n  }\n\n  static async sufferDamageArmorAsResistance_Cyberpunk(\n    actor,\n    monitor,\n    damage,\n    success,\n    avoidArmor,\n    sourceActor,\n  ) {\n    if (monitor == TEMPLATE.monitors.marks) {\n      await ActorDamageManager.sufferMarks(actor, sourceActor);\n      return;\n    }\n    let total = damage + success;\n    if (Checkbars.useArmor(monitor) && total > 0) {\n      const ignoredArmor = avoidArmor ? success : 0;\n      const armorResistance = Math.max(\n        0,\n        ActorDamageManager._computeArmorResistance(actor) - ignoredArmor,\n      );\n      if (armorResistance > 0) {\n        await Checkbars.addCounter(actor, 'armor', 1);\n        total -= armorResistance;\n      }\n    }\n    total -= Checkbars.resistance(actor, monitor);\n    if (total > 0) {\n      await Checkbars.addCounter(actor, monitor, total);\n    }\n    return Math.max(total, 0);\n  }\n\n  static async sufferDamageArmorAsResistance_Earthdawn(\n    actor,\n    monitor,\n    damage,\n    success,\n    avoidArmor,\n    sourceActor,\n  ) {\n    if (monitor == TEMPLATE.monitors.marks) {\n      await ActorDamageManager.sufferMarks(actor, sourceActor);\n      return;\n    }\n    let total = damage + success;\n    if (Checkbars.useArmor(monitor) && !avoidArmor && total > 0) {\n      const armorResistance = ActorDamageManager._computeArmorResistance(actor);\n      if (armorResistance > 0) {\n        await Checkbars.addCounter(actor, 'armor', 1);\n        total -= armorResistance;\n      }\n    }\n    total -= ActorDamageManager._computeStrengthResistance(actor, monitor);\n    total -= Checkbars.resistance(actor, monitor);\n    if (total > 0) {\n      await Checkbars.addCounter(actor, monitor, total);\n    }\n    return total;\n  }\n\n  static async damageToArmor(actor, value) {\n    if (value > 0) {\n      const armorMax = Checkbars.max(actor, TEMPLATE.monitors.armor);\n      const armor = Checkbars.getCounterValue(actor, TEMPLATE.monitors.armor);\n      const armorReduction = Math.min(armorMax - armor, value);\n      const armorResistance = Checkbars.resistance(actor, TEMPLATE.monitors.armor);\n      const armorDmg = Math.max(0, armorReduction - armorResistance);\n      if (armorDmg > 0) {\n        await Checkbars.addCounter(actor, TEMPLATE.monitors.armor, armorDmg);\n      }\n      return armorReduction;\n    } else {\n      return 0;\n    }\n  }\n\n  static _computeArmorResistance(actor) {\n    const armorMax = Checkbars.max(actor, 'armor');\n    const armorDamage = Checkbars.getCounterValue(actor, 'armor');\n    const armor = Math.max(0, armorMax - armorDamage);\n    return Math.max(0, Math.ceil(armor / 3));\n  }\n\n  static _computeStrengthResistance(actor, monitor) {\n    switch (monitor) {\n      case TEMPLATE.monitors.matrix:\n        return 0;\n    }\n    const strength = actor.getAttributeValue(TEMPLATE.attributes.strength);\n    return Math.max(0, Math.floor(strength / 4));\n  }\n}\n","import { AttributeActions } from '../attribute-actions.js';\nimport { Checkbars } from '../common/checkbars.js';\nimport { ANARCHY } from '../config.js';\nimport { BASE_MONITOR, TEMPLATE } from '../constants.js';\nimport { Enums } from '../enums.js';\nimport { ErrorManager } from '../error-manager.js';\nimport { NO_MATRIX_MONITOR } from '../matrix-helper.js';\nimport { Misc } from '../misc.js';\nimport { Modifiers } from '../modifiers/modifiers.js';\nimport { RollDialog } from '../roll/roll-dialog.js';\nimport { MATRIX_SKILLS } from '../skills.js';\nimport { AnarchyUsers } from '../users.js';\nimport { ActorDamageManager } from './actor-damage.js';\n\nexport class AnarchyBaseActor extends Actor {\n  static init() {\n    Hooks.on('updateActor', (actor, updates, options, id) =>\n      AnarchyUsers.firstResponsible(actor)?.onUpdateActor(updates, options),\n    );\n  }\n\n  constructor(docData, context = {}) {\n    if (!context.anarchy?.ready) {\n      const ActorConstructor = game.system.anarchy.actorClasses[docData.type];\n      foundry.utils.mergeObject(context, { anarchy: { ready: true } });\n      if (ActorConstructor) {\n        if (!docData.img) {\n          docData.img = ActorConstructor.defaultIcon;\n        }\n        return new ActorConstructor(docData, context);\n      }\n    }\n    context.anarchy = undefined;\n    super(docData, context);\n  }\n\n  static get initiative() {\n    return '2d6 + @modifiers.initiative';\n  }\n\n  static get defaultIcon() {\n    return undefined;\n  }\n\n  static padWordListToMin(items, min) {\n    for (let index = items.length; index < min; index++) {\n      items.push({\n        word: '',\n        id: index + 1,\n        audio: '',\n        no_delete: false,\n      });\n    }\n    for (let index = 0; index < min; index++) {\n      items[index]['no_delete'] = true;\n    }\n    return items;\n  }\n\n  static sortSkills(actor, skills) {\n    if (!skills) {\n      return [];\n    }\n    return skills.sort((skilla, skillb) => {\n      const skillaIsKnowledge =\n        skilla.system.code === 'knowledge' || skilla.system.attribute === 'knowledge';\n      const skillbIsKnowledge =\n        skillb.system.code === 'knowledge' || skillb.system.attribute === 'knowledge';\n      if (skillaIsKnowledge && !skillbIsKnowledge) return 1;\n      if (!skillbIsKnowledge && skillaIsKnowledge) return -1;\n      if (skillaIsKnowledge && skillbIsKnowledge) {\n        if (skilla.name > skillb.name) return 1;\n        if (skilla.name > skillb.name) return -1;\n        return 0;\n      }\n\n      const skillATotal = actor.getAttributeValue(skilla.system.attribute) + skilla.system.value;\n      const skillBTotal = actor.getAttributeValue(skillb.system.attribute) + skillb.system.value;\n      if (skillATotal > skillBTotal) return -1;\n      if (skillATotal < skillBTotal) return 1;\n      return 0;\n    });\n  }\n\n  static sortQualities(qualities) {\n    if (!qualities) {\n      return [];\n    }\n    return qualities.sort((qa, qb) => {\n      // same type of quality\n      if (qa.system.positive === qb.system.positive) {\n        if (qa.name > qb.name) return 1;\n        if (qa.name < qb.name) return -1;\n        return 0;\n      }\n\n      if (qa.system.positive) return -1;\n      if (qb.system.positive) return 1;\n\n      return 0;\n    });\n  }\n\n  static sortShadowamps(shadowamps) {\n    if (!shadowamps) {\n      return [];\n    }\n    return shadowamps.sort((sa, sb) => {\n      if (sa.system.level > sb.system.level) return -1;\n      if (sa.system.level < sb.system.level) return 1;\n      if (sa.name > sb.name) return 1;\n      if (sa.name < sb.name) return -1;\n      return 0;\n    });\n  }\n\n  static sortAttributeButton(buttons) {\n    if (!buttons) {\n      return [];\n    }\n    return buttons.sort((a, b) => {\n      if (game.i18n.localize(a.labelkey) > game.i18n.localize(b.labelkey)) return 1;\n      if (game.i18n.localize(a.labelkey) < game.i18n.localize(b.labelkey)) return -1;\n      return 0;\n    });\n  }\n\n  getAllowedUsers(permission = CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER) {\n    return game.users.filter((user) => this.testUserPermission(user, permission));\n  }\n\n  getAllowedUserIds(permission = CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER) {\n    return this.getAllowedUsers(permission).map((it) => it.id);\n  }\n\n  getRightToDefend() {\n    return CONST.DOCUMENT_OWNERSHIP_LEVELS.OWNER;\n  }\n\n  hasOwnAnarchy() {\n    return false;\n  }\n  hasGMAnarchy() {\n    return !this.hasPlayerOwner;\n  }\n  isVehicle() {\n    return this.type == TEMPLATE.actorTypes.vehicle;\n  }\n  prepareData() {\n    super.prepareData();\n    this.cleanupFavorites();\n  }\n\n  prepareDerivedData() {\n    this.prepareMatrixMonitor();\n    this.system.modifiers = {\n      initiative: Modifiers.sumModifiers(this.items, 'other', 'initiative'),\n    };\n    if (this.system.monitors) {\n      Object.entries(this.system.monitors).forEach((kv) => {\n        kv[1].maxBonus = Modifiers.sumMonitorModifiers(this.items, kv[0], 'max');\n        kv[1].resistanceBonus = Modifiers.sumMonitorModifiers(this.items, kv[0], 'resistance');\n      });\n    }\n    if (this.system.attributes) {\n      Object.entries(this.system.attributes).forEach(\n        (kv) => (kv[1].total = this.getAttributeValue(kv[0])),\n      );\n    }\n    this.system.state = this.computeState();\n  }\n\n  getAttributes() {\n    return [];\n  }\n  getPhysicalAgility() {\n    return undefined;\n  }\n  getCorrespondingAttribute(attribute) {\n    const attributes = this.getAttributes();\n    if (attributes.includes(attribute)) {\n      return attribute;\n    }\n    return undefined;\n  }\n\n  prepareMatrixMonitor() {\n    const matrix = this.getMatrixDetails();\n    if (matrix.hasMatrix) {\n      this.system.monitors.matrix.max = this._getMonitorMax(matrix.logic);\n      this.system.monitors.matrix.canMark = true;\n    }\n  }\n\n  async onUpdateActor(updates, options) {\n    if (updates.system?.monitors != undefined && updates.system?.state == undefined) {\n      this.update({ 'system.state': this.computeState() });\n    }\n  }\n\n  computeState() {\n    return {\n      matrix: this.computeMatrixState(),\n      physical: this.computePhysicalState(),\n    };\n  }\n\n  computePhysicalState() {\n    return { value: 0, max: 0 };\n  }\n\n  computeMatrixState() {\n    const matrixDetails = this.getMatrixDetails();\n    if (matrixDetails.hasMatrix) {\n      return {\n        value: matrixDetails.monitor.max - matrixDetails.monitor.value,\n        max: matrixDetails.monitor.max,\n      };\n    }\n    return { value: 0, max: 0 };\n  }\n\n  getMatrixDetails() {\n    return {\n      hasMatrix: false,\n      logic: undefined,\n      firewall: undefined,\n      monitor: NO_MATRIX_MONITOR,\n      overflow: undefined,\n    };\n  }\n\n  getMatrixLogic() {\n    return this.getMatrixDetails().logic;\n  }\n  getMatrixFirewall() {\n    return this.getMatrixDetails().firewall;\n  }\n  getMatrixMonitor() {\n    return this.getMatrixDetails().monitor;\n  }\n  getMatrixMarks() {\n    return this.getMatrixDetails().monitor?.marks ?? [];\n  }\n  getMatrixOverflow() {\n    return this.getMatrixDetails().overflow;\n  }\n  hasMatrixMonitor() {\n    return this.getMatrixDetails().hasMatrix;\n  }\n  isMatrixConnected(mode = undefined) {\n    return false;\n  }\n  isMatrixSkill(skill) {\n    return MATRIX_SKILLS.includes(skill?.system.code);\n  }\n\n  async nextConnectionMode(cyberdeck) {}\n\n  async defSetMatrixMonitor(path, value) {\n    if (!this.getMatrixDetails().hasMatrix) {\n      game.system.anarchy.hacks.i18n.format(ANARCHY.actor.monitors.noMatrixMonitor, {\n        actor: this.name,\n      });\n    } else {\n      await this.update({ [path]: value });\n    }\n  }\n\n  async setCheckbarValue(path, value) {\n    if (path.startsWith('system.monitors.matrix.')) {\n      const matrixDetails = this.getMatrixDetails();\n      if (matrixDetails.setMatrixMonitor) {\n        return await matrixDetails.setMatrixMonitor(path, value);\n      }\n      return await this.defSetMatrixMonitor(path, value);\n    }\n    return await this.update({ [path]: value });\n  }\n\n  _getMonitorMax(attribute) {\n    const attributeValue = this.getAttributeValue(attribute);\n    return attributeValue == 0 ? 0 : BASE_MONITOR + Misc.divup(attributeValue, 2);\n  }\n\n  getAttributeActions() {\n    return AttributeActions.getActorActions(this);\n  }\n\n  getUsableAttributes(item = undefined) {\n    const itemsAttributes = (item ? [item] : this.items)\n      .map((it) => it.getUsableAttributes())\n      .reduce((a, b) => a.concat(b), []);\n    const usableAttributes = Misc.distinct(this.getAttributes().concat(itemsAttributes));\n    usableAttributes.sort(Misc.ascendingBySortedArray(Enums.sortedAttributeKeys));\n    return usableAttributes;\n  }\n\n  getAttributeValue(attribute, item = undefined) {\n    let value = 0;\n    attribute = this.getCorrespondingAttribute(attribute);\n    if (attribute) {\n      if (this.getAttributes().includes(attribute)) {\n        value = this.system.attributes[attribute].value;\n      } else if (!item) {\n        const candidateItems = this.items.filter(\n          (item) => item.isActive() && item.getAttributes().includes(attribute),\n        );\n        if (candidateItems.length > 0) {\n          const candidateValues = candidateItems.map((it) => it.getAttributeValue(attribute) ?? 0);\n          value = Math.max(...candidateValues);\n        }\n      } else if (this.isEmerged() && attribute == TEMPLATE.attributes.firewall) {\n        return this.getAttributeValue(TEMPLATE.attributes.logic);\n      } else {\n        value = item?.getAttributeValue(attribute) ?? 0;\n      }\n      value += Modifiers.sumModifiers(this.items, 'attribute', attribute);\n    }\n    return value;\n  }\n\n  getDamageMonitor(damageType) {\n    switch (damageType) {\n      case TEMPLATE.monitors.matrix:\n      case TEMPLATE.monitors.marks:\n        return damageType;\n    }\n    return undefined;\n  }\n\n  async applyArmorDamage(damageType, damage = 0) {\n    switch (damageType) {\n      case TEMPLATE.monitors.physical:\n      case TEMPLATE.monitors.stun:\n        await ActorDamageManager.damageToArmor(this, damage);\n    }\n  }\n\n  async rollAttribute(attribute) {\n    await RollDialog.rollAttribute(this, attribute);\n  }\n\n  async rollAttributeAction(code) {\n    const action = AttributeActions.getActorAction(this, code);\n    await RollDialog.rollAttributeAction(this, action);\n  }\n\n  async rollSkill(skill, specialization) {\n    await RollDialog.rollSkill(this, skill, specialization);\n  }\n\n  async rollWeapon(weapon) {\n    ErrorManager.checkWeaponDefense(weapon, this);\n    const targetedTokenIds = weapon.validateTargets(this)?.map((it) => it.id);\n    const targeting = {\n      attackerTokenId: game.scenes.current?.tokens.find((it) => it.actor?.id == this.id)?.id,\n      targetedTokenIds: targetedTokenIds,\n    };\n    const skill = this.items.find((it) => weapon.isWeaponSkill(it));\n    await RollDialog.rollWeapon(this, skill, weapon, targeting);\n  }\n\n  async rollDefense(attack) {\n    const defense = attack.attack.defense;\n    const action = AttributeActions.getActorDefense(this, defense);\n    await RollDialog.rollDefense(this, action, attack);\n  }\n\n  async rollPilotDefense(attack) {}\n\n  async rollDrain(drain) {}\n\n  async rollConvergence(convergence) {}\n\n  async switchMonitorCheck(monitor, index, checked, sourceActorId = undefined) {\n    await Checkbars.switchMonitorCheck(this, monitor, index, checked, sourceActorId);\n  }\n\n  async addCounter(monitor, value, sourceActorId = undefined) {\n    await Checkbars.addCounter(this, monitor, value, sourceActorId);\n  }\n\n  async setCounter(monitor, value, sourceActorId = undefined) {\n    await Checkbars.setCounter(this, monitor, value, sourceActorId);\n  }\n\n  canPilotVehicle() {\n    return false;\n  }\n\n  canSetMarks() {\n    return false;\n  }\n\n  getCyberdeck() {\n    return undefined;\n  }\n\n  canReceiveMarks() {\n    return this.system.monitors?.matrix?.canMark;\n  }\n\n  canApplyDamage(monitor) {\n    switch (monitor) {\n      case TEMPLATE.monitors.matrix:\n      case TEMPLATE.monitors.marks:\n        return this.hasMatrixMonitor();\n      case TEMPLATE.monitors.physical:\n      case TEMPLATE.monitors.stun:\n        return this.getDamageMonitor(monitor) != undefined;\n    }\n    return false;\n  }\n\n  canReceiveDamage(monitor) {\n    return this.canApplyDamage(monitor);\n  }\n\n  isEmerged() {\n    return false;\n  }\n\n  async addActorMark(sourceActorId) {\n    await Checkbars.addActorMark(this, sourceActorId);\n  }\n\n  getActorMarks(sourceActorId) {\n    return Checkbars.getActorMarks(this, sourceActorId)?.marks;\n  }\n\n  async onEnterCombat() {\n    const sceneAnarchy = Modifiers.sumModifiers(this.items, 'other', 'sceneAnarchy');\n    if (sceneAnarchy > 0) {\n      await Checkbars.setCounter(this, TEMPLATE.monitors.sceneAnarchy, sceneAnarchy);\n    }\n  }\n\n  async onLeaveCombat() {\n    await Checkbars.setCounter(this, TEMPLATE.monitors.sceneAnarchy, 0);\n  }\n\n  getCelebrityValue() {\n    return 0;\n  }\n  getCredibilityValue() {\n    return 0;\n  }\n  getRumorValue() {\n    return 0;\n  }\n\n  getAnarchy() {\n    const anarchy = this.hasGMAnarchy()\n      ? game.system.anarchy.gmAnarchy.getAnarchy()\n      : {\n          isGM: false,\n          value: 0,\n          max: 0,\n        };\n    anarchy.scene = this.getAnarchyScene();\n    return anarchy;\n  }\n\n  getAnarchyScene() {\n    return 0;\n  }\n\n  getAnarchyValue() {\n    return this.getAnarchy().value ?? 0;\n  }\n\n  async spendCredibility(count) {\n    await Checkbars.addCounter(this, TEMPLATE.counters.social.credibility, -count);\n  }\n  async spendRumor(count) {\n    await Checkbars.addCounter(this, TEMPLATE.counters.social.rumor, -count);\n  }\n\n  async spendAnarchy(count) {\n    if (count && !this.hasPlayerOwner) {\n      await game.system.anarchy.gmAnarchy.npcConsumesAnarchy(this, count);\n    }\n  }\n\n  getRemainingEdge() {\n    return this.system.counters?.edge?.value ?? 0;\n  }\n\n  canUseEdge() {\n    return this.getAttributes().includes(TEMPLATE.attributes.edge);\n  }\n\n  async spendEdge(count) {\n    if (count == 0) {\n      return;\n    }\n    if (!this.canUseEdge()) {\n      const message = game.system.anarchy.hacks.i18n.localize(\n        ANARCHY.common.errors.noEdgeForActor,\n        {\n          actor: this.name,\n          actorType: game.system.anarchy.hacks.i18n.localize(ANARCHY.actorType[this.type]),\n        },\n      );\n      ui.notifications.warn(message);\n      throw ANARCHY.common.errors.noEdgeForActor + message;\n    }\n    await Checkbars.addCounter(this, TEMPLATE.counters.edge, -count);\n  }\n\n  getSkillValue(skillId, specialization = undefined) {\n    const skill = this.items.get(skillId);\n    const attribute = this.getAttributeValue(skill.system.attribute);\n    return skill.system.value + attribute + (specialization && skill.system.specialization ? 2 : 0);\n  }\n\n  getWounds() {\n    return 0;\n  }\n\n  async removeOtherMetatype(metatype) {\n    const metatypeIds = this.items\n      .filter((it) => it.isMetatype() && it.id != metatype?.id)\n      .map((it) => it.id);\n    this.deleteEmbeddedDocuments('Item', metatypeIds);\n  }\n\n  /**\n   * @param ownerActor the Actor who becomes the owner of this Actor\n   */\n  async attachToOwnerActor(ownerActor = undefined, attachOrCopy = 'attach') {\n    if (ownerActor?.id == this.id) {\n      return;\n    }\n    if (ownerActor?.hasPlayerOwner) {\n      // TODO: enforce player to have rights if owner hasPlayer\n    }\n    let actorToAttach = this;\n    if (attachOrCopy == 'copy') {\n      const cloneTmp = this.clone();\n      const created = await Actor.createDocuments([cloneTmp]);\n      actorToAttach = created[0];\n    }\n    await actorToAttach.update({ 'system.ownerId': ownerActor?.id ?? '' });\n    ownerActor?.render();\n    this.render();\n  }\n\n  getOwnerActor() {\n    if (this.system.ownerId) {\n      return game.actors.get(this.system.ownerId);\n    }\n    return undefined;\n  }\n\n  getOwnedActors() {\n    return game.actors.filter((it) => it.system.ownerId == this.id);\n  }\n\n  hasFavorite(type, id) {\n    const search = AnarchyBaseActor._prepareFavorite(type, id);\n    return this.system.favorites.find((it) => AnarchyBaseActor._isSameFavorite(search, it))\n      ? true\n      : false;\n  }\n\n  static _prepareFavorite(type, id) {\n    return { type, id };\n  }\n\n  static _isSameFavorite(f1, f2) {\n    return f1.id == f2.id && f1.type == f2.type;\n  }\n\n  async switchFavorite(setFavorite, type, id) {\n    const favorite = AnarchyBaseActor._prepareFavorite(type, id);\n    const newFavorites = this.system.favorites.filter(\n      (it) => !AnarchyBaseActor._isSameFavorite(favorite, it),\n    );\n    if (setFavorite) {\n      newFavorites.push(favorite);\n    }\n    this.update({ 'system.favorites': newFavorites });\n  }\n\n  async cleanupFavorites() {\n    const newFavorites = this.computeShortcuts().filter((f) => !f.callback);\n    if (newFavorites.length < this.system.favorites) {\n      this.update({ 'system.favorites': newFavorites });\n    }\n  }\n\n  getShortcuts() {\n    return this.computeShortcuts().filter((s) => s.label && s.callback);\n  }\n\n  computeShortcuts() {\n    if (this.system.favorites) {\n      return this.system.favorites.map((f) => this.getShortcut(f.type, f.id));\n    }\n    return [];\n  }\n\n  getShortcut(type, id) {\n    const favorite = AnarchyBaseActor._prepareFavorite(type, id);\n    if (type == 'attributeAction') {\n      const shortcut = AttributeActions.prepareShortcut(this, id);\n      if (shortcut) {\n        return foundry.utils.mergeObject(shortcut, favorite);\n      }\n    } else if (Object.values(TEMPLATE.itemType).includes(type)) {\n      const shortcut = this.items.get(id)?.prepareShortcut();\n      if (shortcut) {\n        return foundry.utils.mergeObject(shortcut, favorite);\n      }\n    }\n    return favorite;\n  }\n}\n","import { ANARCHY } from './config.js';\nimport { Icons } from './icons.js';\n\nexport class ConfirmationDialog {\n  static async confirmDeleteItem(item, onConfirm = () => {}) {\n    let dialog = new Dialog({\n      title: game.i18n.localize(ANARCHY.common.confirmation.del),\n      content: game.i18n.format(ANARCHY.common.confirmation.delItem, {\n        name: item.name,\n        type: game.i18n.localize(ANARCHY.itemType.singular[item.type]),\n      }),\n      buttons: {\n        delete: {\n          icon: Icons.fontAwesome('fas fa-check'),\n          label: game.i18n.localize(ANARCHY.common.del),\n          callback: onConfirm,\n        },\n        cancel: {\n          icon: Icons.fontAwesome('fas fa-times'),\n          label: game.i18n.localize(ANARCHY.common.cancel),\n        },\n      },\n      default: 'cancel',\n    });\n    dialog.render(true);\n  }\n\n  static async confirmDetachOwnerActor(owner, owned, onConfirm = () => {}) {\n    let dialog = new Dialog({\n      title: game.i18n.localize(ANARCHY.common.confirmation.del),\n      content: game.i18n.format(ANARCHY.common.confirmation.delOwner, {\n        name: owner.name,\n      }),\n      buttons: {\n        delete: {\n          icon: Icons.fontAwesome('fas fa-check'),\n          label: game.i18n.localize(ANARCHY.common.del),\n          callback: onConfirm,\n        },\n        cancel: {\n          icon: Icons.fontAwesome('fas fa-times'),\n          label: game.i18n.localize(ANARCHY.common.cancel),\n        },\n      },\n      default: 'cancel',\n    });\n    dialog.render(true);\n  }\n\n  static async confirmAttachOrCopy(owner, owned, onAttach = () => {}, onAttachCopy = () => {}) {\n    let dialog = new Dialog({\n      title: game.i18n.localize(ANARCHY.common.confirmation.attach),\n      content: game.i18n.format(ANARCHY.common.confirmation.attachOrCopy, {\n        ownerName: owner.name,\n        ownerType: game.i18n.localize(ANARCHY.actorType[owner.type]),\n        ownedName: owned.name,\n        ownedType: game.i18n.localize(ANARCHY.actorType[owned.type]),\n      }),\n      buttons: {\n        attach: {\n          icon: Icons.fontAwesome('fas fa-user-tag'),\n          label: game.i18n.localize(ANARCHY.common.attach),\n          callback: onAttach,\n        },\n        attachCopy: {\n          icon: Icons.fontAwesome('fas fa-user-plus'),\n          label: game.i18n.localize(ANARCHY.common.attachCopy),\n          callback: onAttachCopy,\n        },\n        cancel: {\n          icon: Icons.fontAwesome('fas fa-times'),\n          label: game.i18n.localize(ANARCHY.common.cancel),\n        },\n      },\n      default: 'cancel',\n    });\n    dialog.render(true);\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { TEMPLATES_PATH } from '../constants.js';\nimport { Icons } from '../icons.js';\n\nexport class SelectActor extends Dialog {\n  static async selectActor(\n    title,\n    actors,\n    onActorSelected = async (actor) => {},\n    onCancel = async () => {},\n  ) {\n    let dialogOptions = { classes: ['select-actor'], width: 300, height: 300, 'z-index': 99999 };\n    let dialogConfig = {\n      title: title,\n      content: await foundry.applications.handlebars.renderTemplate(\n        `${TEMPLATES_PATH}/dialog/select-actor.hbs`,\n        {\n          actors: actors,\n        },\n      ),\n      buttons: {\n        cancel: {\n          icon: Icons.fontAwesome('fas fa-times'),\n          label: game.i18n.localize(ANARCHY.common.cancel),\n          callback: async () => {\n            await onCancel();\n          },\n        },\n      },\n      default: 'cancel',\n    };\n    new SelectActor(dialogConfig, dialogOptions, actors, onActorSelected).render(true);\n  }\n\n  constructor(dialogConfig, dialogOptions, actors, onActorSelected) {\n    super(dialogConfig, dialogOptions);\n    this.actors = actors;\n    this.onActorSelected = onActorSelected;\n  }\n\n  /* -------------------------------------------- */\n  activateListeners(html) {\n    super.activateListeners(html);\n    html.find('.click-select-actor').click((event) => this.onSelectActor(event));\n  }\n\n  async onSelectActor(event) {\n    const actorId = $(event.currentTarget).attr('data-actor-id');\n    const actor = this.actors.find((it) => it.id == actorId);\n    if (actor) {\n      this.onActorSelected(actor);\n      this.close();\n    }\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { TEMPLATE, TEMPLATES_PATH } from '../constants.js';\nimport { ConfirmationDialog } from '../confirmation.js';\nimport { Misc } from '../misc.js';\nimport { Enums } from '../enums.js';\nimport { SelectActor } from '../dialog/select-actor.js';\n\nexport class AnarchyActorSheet extends foundry.appv1.sheets.ActorSheet {\n  get template() {\n    return `${TEMPLATES_PATH}/actor/${this.actor.type}.hbs`;\n  }\n\n  /** @override */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      isGM: game.user.isGM,\n      dragDrop: [{ dragSelector: '.item ', dropSelector: null }],\n      classes: [game.system.anarchy.styles.selectCssClass(), 'sheet', 'actor'],\n      width: 600,\n      height: 600,\n      resizable: true,\n    });\n  }\n\n  getData(options) {\n    // Performance monitoring\n    const startTime = performance.now();\n\n    try {\n      let hbsData = foundry.utils.mergeObject(super.getData(options), {\n        items: {},\n        anarchy: this.actor.getAnarchy(),\n        ownerActor: this.actor.getOwnerActor(),\n        ownedActors: this.actor.getOwnedActors(),\n        options: {\n          limited: this.document.limited,\n          owner: this.document.isOwner,\n          cssClass: this.isEditable ? 'editable' : 'locked',\n        },\n        ENUMS: foundry.utils.mergeObject(\n          { attributeAction: this.actor.getAttributeActions() },\n          Enums.getEnums(),\n        ),\n        ANARCHY: ANARCHY,\n      });\n      hbsData.options.classes.push(`actor-${this.actor.type}`);\n      hbsData.options.classes = Misc.distinct(hbsData.options.classes);\n      hbsData.system = this.actor.system;\n\n      // Apply UI customizations and theme utilities\n      if (game.system.anarchy?.uiCustomization) {\n        hbsData.uiCustomizations = game.system.anarchy.uiCustomization.getActiveCustomizations();\n        hbsData.options.classes.push(\n          ...game.system.anarchy.uiCustomization.getCustomizationClasses('actor'),\n        );\n      }\n\n      // Add theme information\n      if (game.system.anarchy?.themeUtilities) {\n        hbsData.currentTheme = game.system.anarchy.styles.currentTheme;\n        hbsData.availableThemes = game.system.anarchy.styles.availableThemes;\n        hbsData.themeMetadata = game.system.anarchy.themeUtilities.getCurrentThemeMetadata();\n      }\n\n      Misc.classifyInto(hbsData.items, this.actor.items);\n\n      // Performance tracking\n      const endTime = performance.now();\n      const renderTime = endTime - startTime;\n\n      if (game.system.anarchy?.performanceOptimizer && renderTime > 50) {\n        console.warn(\n          `AnarchyActorSheet.getData: Slow data preparation for ${this.actor.name} took ${renderTime.toFixed(2)}ms`,\n        );\n      }\n\n      return hbsData;\n    } catch (error) {\n      console.error(\n        `AnarchyActorSheet.getData: Error preparing data for ${this.actor.name}`,\n        error,\n      );\n      ui.notifications.error(\n        `Failed to load actor sheet data for ${this.actor.name}. Please check console for details.`,\n      );\n\n      // Return minimal safe data to prevent complete failure\n      return foundry.utils.mergeObject(super.getData(options), {\n        items: {},\n        anarchy: { value: 0, max: 0, scene: 0 },\n        ownerActor: null,\n        ownedActors: [],\n        options: {\n          limited: this.document.limited,\n          owner: this.document.isOwner,\n          cssClass: 'locked',\n          classes: ['sheet', 'actor', `actor-${this.actor.type || 'character'}`],\n        },\n        ENUMS: {},\n        ANARCHY: ANARCHY,\n        system: this.actor.system || {},\n      });\n    }\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    // Apply UI customizations to rendered sheet\n    if (game.system.anarchy?.uiCustomization) {\n      game.system.anarchy.uiCustomization.applyCustomizationsToElement(html[0], 'actor');\n    }\n\n    // Apply theme-specific enhancements\n    if (game.system.anarchy?.themeUtilities) {\n      game.system.anarchy.themeUtilities.applyThemeEnhancements(html[0], 'actor');\n    }\n\n    // Setup modern event delegation for better performance\n    this._setupEventDelegation(html);\n\n    // Apply accessibility enhancements\n    this._enhanceAccessibility(html);\n\n    // items standard actions (add/edit/activate/delete)\n    html.find('.click-item-add').click(async (event) => {\n      event.stopPropagation();\n      await this.createNewItem(this.getEventItemType(event));\n    });\n\n    html.find('.click-item-edit').click(async (event) => {\n      event.stopPropagation();\n      this.getEventItem(event)?.sheet.render(true);\n    });\n\n    html.find('.click-item-activate').click(async (event) => {\n      event.stopPropagation();\n      const item = this.getEventItem(event);\n      const inactive = item.system.inactive;\n      await item.update({ 'system.inactive': !inactive });\n    });\n\n    html.find('a.click-matrix-connectionMode').click(async (event) => {\n      event.stopPropagation();\n      await this.actor.nextConnectionMode(this.getEventItem(event));\n    });\n\n    html.find('.click-item-delete').click(async (event) => {\n      event.stopPropagation();\n      const item = this.getEventItem(event);\n      ConfirmationDialog.confirmDeleteItem(item, async () => {\n        await this.actor.deleteEmbeddedDocuments('Item', [item.id]);\n      });\n    });\n\n    html.find('.click-favorite').click(async (event) => {\n      event.stopPropagation();\n      this.onClickFavorite({\n        skillId: $(event.currentTarget).attr('data-skill-id'),\n        specialization: $(event.currentTarget).attr('data-specialization'),\n        weaponId: $(event.currentTarget).attr('data-weapon-id'),\n        attributeAction: $(event.currentTarget).attr('data-attributeAction'),\n        isFavorite: $(event.currentTarget).attr('data-isFavorite'),\n      });\n    });\n\n    // ownership management\n    html.find('.click-owner-actor-unlink').click(async (event) => {\n      event.stopPropagation();\n      this.detachFromOwner(this.actor.getOwnerActor(), this.actor);\n    });\n    html.find('.click-owned-actor-view').click(async (event) => {\n      event.stopPropagation();\n      this.getEventOwnedActor(event)?.sheet.render(true);\n    });\n    html.find('.click-owned-actor-unlink').click(async (event) => {\n      event.stopPropagation();\n      this.detachFromOwner(this.actor, this.getEventOwnedActor(event));\n    });\n\n    // counters & monitors\n    html.find('a.click-checkbar-element').click(async (event) => {\n      event.stopPropagation();\n      const item = this.getEventItem(event);\n      const handler = item ?? this.actor;\n      const monitor = this.getEventMonitorCode(event);\n      const sourceActorId =\n        monitor == 'marks'\n          ? $(event.currentTarget).closest('.anarchy-marks').attr('data-actor-id')\n          : undefined;\n      await handler.switchMonitorCheck(\n        monitor,\n        this.getEventIndex(event),\n        this.isEventChecked(event),\n        sourceActorId,\n        item,\n      );\n    });\n    html.find('a.click-add-mark-actor').click(async (event) => {\n      event.stopPropagation();\n      this.onClickAddMark();\n    });\n\n    // rolls\n    html.find('.click-skill-roll').click(async (event) => {\n      event.stopPropagation();\n      this.actor.rollSkill(this.getEventItem(event), this.getEventSkillSpecialization(event));\n    });\n\n    html.find('.click-roll-attribute').click(async (event) => {\n      event.stopPropagation();\n      const handler = this.getEventItem(event) ?? this.actor;\n      handler.rollAttribute(\n        $(event.currentTarget).closest('.anarchy-attribute').attr('data-attribute'),\n      );\n    });\n\n    html.find('.click-roll-attribute-action').click(async (event) => {\n      event.stopPropagation();\n      this.actor.rollAttributeAction(this.getEventActionCode(event));\n    });\n\n    html.find('.click-weapon-roll').click(async (event) => {\n      event.stopPropagation();\n      this.actor.rollWeapon(this.getEventItem(event));\n    });\n  }\n\n  getEventItemType(event) {\n    return $(event.currentTarget).closest('.define-item-type').attr('data-item-type');\n  }\n\n  getEventItem(event) {\n    const itemId =\n      $(event.currentTarget).closest('.item').attr('data-item-id') ??\n      $(event.currentTarget).closest('.anarchy-metatype').attr('data-item-id');\n    return this.actor.items.get(itemId);\n  }\n\n  isEventChecked(event) {\n    return $(event.currentTarget).attr('data-checked') == 'true';\n  }\n\n  getEventSkillSpecialization(event) {\n    return $(event.currentTarget).closest('.click-skill-roll').attr('data-item-specialization');\n  }\n\n  getEventActionCode(event) {\n    return $(event.currentTarget).attr('data-action-code');\n  }\n\n  getEventMonitorCode(event) {\n    return $(event.currentTarget).closest('.click-checkbar-element').attr('data-monitor-code');\n  }\n\n  getEventIndex(event) {\n    return Number.parseInt($(event.currentTarget).attr('data-index'));\n  }\n\n  getEventOwnedActor(event) {\n    const ownedActorId = $(event.currentTarget)\n      .closest('.define-owned-actor')\n      .attr('data-actor-id');\n    return game.actors.get(ownedActorId);\n  }\n\n  async createNewItem(itemType) {\n    const name = game.i18n.format(ANARCHY.common.newName, {\n      type: game.i18n.localize(ANARCHY.itemType.singular[itemType]),\n    });\n    await this.actor.createEmbeddedDocuments('Item', [{ name: name, type: itemType }], {\n      renderSheet: true,\n    });\n  }\n\n  async onClickFavorite(options) {\n    const newState = options.isFavorite != 'true';\n    if (options.skillId) {\n      await this.actor.switchFavorite(\n        newState,\n        TEMPLATE.itemType.skill,\n        options.skillId,\n        options.specialization,\n      );\n    } else if (options.weaponId) {\n      await this.actor.switchFavorite(newState, TEMPLATE.itemType.weapon, options.weaponId);\n    } else if (options.attributeAction) {\n      await this.actor.switchFavorite(newState, 'attributeAction', options.attributeAction);\n    } else {\n      console.warn('Favorite not supported', options);\n    }\n  }\n\n  detachFromOwner(owner, owned) {\n    ConfirmationDialog.confirmDetachOwnerActor(owner, owned, async () => {\n      await owned.attachToOwnerActor();\n      this.render(true);\n    });\n  }\n\n  async _onDropActor(event, drag) {\n    const dropActor = fromUuidSync(drag.uuid);\n    if (dropActor?.id != this.actor.id) {\n      // check circular references: find a owner, without finding the owned id\n      ConfirmationDialog.confirmAttachOrCopy(\n        this.actor,\n        dropActor,\n        async () => await dropActor.attachToOwnerActor(this.actor),\n        async () => await dropActor.attachToOwnerActor(this.actor, 'copy'),\n      );\n    }\n    super._onDropActor(event, drag);\n  }\n\n  async onClickAddMark() {\n    if (this.actor.canReceiveMarks()) {\n      const title = game.i18n.format(ANARCHY.common.selection.actorSettingMarks, {\n        name: this.actor.name,\n      });\n      await SelectActor.selectActor(\n        title,\n        game.actors.filter((actor) => !this.actor.getActorMarks(actor.id) && actor.canSetMarks()),\n        (actor) => this.actor.addActorMark(actor.id),\n      );\n    }\n  }\n\n  /**\n   * Setup modern event delegation for better performance\n   * @param {jQuery} html - The rendered HTML\n   * @private\n   */\n  _setupEventDelegation(html) {\n    // Use event delegation for better performance with dynamic content\n    const element = html[0];\n\n    // Delegate click events to the sheet container\n    element.addEventListener('click', this._handleDelegatedClick.bind(this), { passive: false });\n\n    // Delegate change events for form inputs\n    element.addEventListener('change', this._handleDelegatedChange.bind(this), { passive: false });\n\n    // Add performance monitoring for event handling\n    if (game.system.anarchy?.performanceOptimizer) {\n      this._monitorEventPerformance(element);\n    }\n  }\n\n  /**\n   * Handle delegated click events\n   * @param {Event} event - The click event\n   * @private\n   */\n  _handleDelegatedClick(event) {\n    const target = event.target.closest('[data-action]');\n    if (!target) return;\n\n    const action = target.dataset.action;\n    const startTime = performance.now();\n\n    try {\n      // Route to appropriate handler based on action\n      switch (action) {\n        case 'item-add':\n          event.stopPropagation();\n          this.createNewItem(this.getEventItemType(event));\n          break;\n        case 'item-edit':\n          event.stopPropagation();\n          this.getEventItem(event)?.sheet.render(true);\n          break;\n        case 'item-activate':\n          event.stopPropagation();\n          this._handleItemActivate(event);\n          break;\n        // Add more actions as needed\n      }\n    } catch (error) {\n      console.error(`AnarchyActorSheet: Error handling action '${action}'`, error);\n      ui.notifications.error(`Action failed: ${action}. Check console for details.`);\n    } finally {\n      // Performance tracking\n      const endTime = performance.now();\n      const actionTime = endTime - startTime;\n\n      if (actionTime > 100) {\n        console.warn(`AnarchyActorSheet: Slow action '${action}' took ${actionTime.toFixed(2)}ms`);\n      }\n    }\n  }\n\n  /**\n   * Handle delegated change events\n   * @param {Event} event - The change event\n   * @private\n   */\n  _handleDelegatedChange(event) {\n    const target = event.target;\n    if (!target.dataset.action) return;\n\n    const action = target.dataset.action;\n\n    try {\n      // Route to appropriate handler based on action\n      switch (action) {\n        case 'update-field':\n          this._handleFieldUpdate(event);\n          break;\n        // Add more change actions as needed\n      }\n    } catch (error) {\n      console.error(`AnarchyActorSheet: Error handling change action '${action}'`, error);\n    }\n  }\n\n  /**\n   * Monitor event handling performance\n   * @param {HTMLElement} element - The sheet element\n   * @private\n   */\n  _monitorEventPerformance(element) {\n    const observer = new PerformanceObserver((list) => {\n      const entries = list.getEntries();\n      entries.forEach((entry) => {\n        if (entry.duration > 100) {\n          console.warn(\n            `AnarchyActorSheet: Slow event handling detected: ${entry.name} took ${entry.duration.toFixed(2)}ms`,\n          );\n        }\n      });\n    });\n\n    observer.observe({ entryTypes: ['measure'] });\n  }\n\n  /**\n   * Handle item activation with error recovery\n   * @param {Event} event - The click event\n   * @private\n   */\n  async _handleItemActivate(event) {\n    try {\n      const item = this.getEventItem(event);\n      if (!item) {\n        ui.notifications.warn('Item not found for activation');\n        return;\n      }\n\n      const inactive = item.system.inactive;\n      await item.update({ 'system.inactive': !inactive });\n    } catch (error) {\n      console.error('AnarchyActorSheet: Error activating item', error);\n      ui.notifications.error('Failed to activate/deactivate item');\n    }\n  }\n\n  /**\n   * Handle field updates with validation\n   * @param {Event} event - The change event\n   * @private\n   */\n  async _handleFieldUpdate(event) {\n    try {\n      const target = event.target;\n      const field = target.name;\n      const value = target.value;\n\n      if (!field) return;\n\n      // Validate the update\n      if (this._validateFieldUpdate(field, value)) {\n        await this.actor.update({ [field]: value });\n      }\n    } catch (error) {\n      console.error('AnarchyActorSheet: Error updating field', error);\n      ui.notifications.error('Failed to update field');\n    }\n  }\n\n  /**\n   * Validate field updates\n   * @param {string} field - The field name\n   * @param {any} value - The new value\n   * @returns {boolean} Whether the update is valid\n   * @private\n   */\n  _validateFieldUpdate(field, value) {\n    // Add field validation logic here\n    if (field.includes('system.attributes') && (isNaN(value) || value < 0)) {\n      ui.notifications.warn('Attribute values must be positive numbers');\n      return false;\n    }\n\n    return true;\n  }\n\n  /**\n   * Enhance accessibility features for the sheet\n   * @param {jQuery} html - The rendered HTML\n   * @private\n   */\n  _enhanceAccessibility(html) {\n    const element = html[0];\n\n    // Add ARIA labels for interactive elements\n    this._addAriaLabels(element);\n\n    // Enhance keyboard navigation\n    this._enhanceKeyboardNavigation(element);\n\n    // Add focus management\n    this._setupFocusManagement(element);\n\n    // Apply accessibility preferences\n    this._applyAccessibilityPreferences(element);\n  }\n\n  /**\n   * Add ARIA labels for better screen reader support\n   * @param {HTMLElement} element - The sheet element\n   * @private\n   */\n  _addAriaLabels(element) {\n    // Add ARIA labels to buttons without text\n    const iconButtons = element.querySelectorAll(\n      'button:not([aria-label]), a.item-control:not([aria-label])',\n    );\n    iconButtons.forEach((button) => {\n      const icon = button.querySelector('i[class*=\"fa-\"]');\n      if (icon) {\n        const action =\n          button.dataset.action || button.className.match(/click-(\\w+)/)?.[1] || 'action';\n        button.setAttribute('aria-label', `${action.replace('-', ' ')} button`);\n      }\n    });\n\n    // Add ARIA labels to form inputs\n    const inputs = element.querySelectorAll('input:not([aria-label]), select:not([aria-label])');\n    inputs.forEach((input) => {\n      const label = input.closest('.form-group')?.querySelector('label');\n      if (label && !input.getAttribute('aria-label')) {\n        input.setAttribute('aria-label', label.textContent.trim());\n      }\n    });\n\n    // Add ARIA roles for custom components\n    const monitors = element.querySelectorAll('.anarchy-monitor');\n    monitors.forEach((monitor) => {\n      monitor.setAttribute('role', 'progressbar');\n      const label = monitor.querySelector('.monitor-label')?.textContent;\n      if (label) {\n        monitor.setAttribute('aria-label', `${label} monitor`);\n      }\n    });\n  }\n\n  /**\n   * Enhance keyboard navigation\n   * @param {HTMLElement} element - The sheet element\n   * @private\n   */\n  _enhanceKeyboardNavigation(element) {\n    // Make clickable elements keyboard accessible\n    const clickableElements = element.querySelectorAll('[class*=\"click-\"]:not(button):not(a)');\n    clickableElements.forEach((el) => {\n      if (!el.hasAttribute('tabindex')) {\n        el.setAttribute('tabindex', '0');\n      }\n      if (!el.hasAttribute('role')) {\n        el.setAttribute('role', 'button');\n      }\n\n      // Add keyboard event listener\n      el.addEventListener('keydown', (event) => {\n        if (event.key === 'Enter' || event.key === ' ') {\n          event.preventDefault();\n          el.click();\n        }\n      });\n    });\n\n    // Add skip links for better navigation\n    this._addSkipLinks(element);\n  }\n\n  /**\n   * Add skip links for better navigation\n   * @param {HTMLElement} element - The sheet element\n   * @private\n   */\n  _addSkipLinks(element) {\n    const skipLinks = document.createElement('div');\n    skipLinks.className = 'skip-links';\n    skipLinks.innerHTML = `\n      <a href=\"#sheet-content\" class=\"skip-link\">Skip to main content</a>\n      <a href=\"#sheet-tabs\" class=\"skip-link\">Skip to navigation</a>\n    `;\n\n    element.insertBefore(skipLinks, element.firstChild);\n\n    // Add IDs to target elements if they don't exist\n    const content = element.querySelector('.sheet-body');\n    if (content && !content.id) {\n      content.id = 'sheet-content';\n    }\n\n    const tabs = element.querySelector('.sheet-tabs');\n    if (tabs && !tabs.id) {\n      tabs.id = 'sheet-tabs';\n    }\n  }\n\n  /**\n   * Setup focus management for better accessibility\n   * @param {HTMLElement} element - The sheet element\n   * @private\n   */\n  _setupFocusManagement(element) {\n    // Focus trap for modal-like behavior\n    const focusableElements = element.querySelectorAll(\n      'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])',\n    );\n\n    if (focusableElements.length > 0) {\n      const firstFocusable = focusableElements[0];\n      const lastFocusable = focusableElements[focusableElements.length - 1];\n\n      element.addEventListener('keydown', (event) => {\n        if (event.key === 'Tab') {\n          if (event.shiftKey && document.activeElement === firstFocusable) {\n            event.preventDefault();\n            lastFocusable.focus();\n          } else if (!event.shiftKey && document.activeElement === lastFocusable) {\n            event.preventDefault();\n            firstFocusable.focus();\n          }\n        }\n      });\n    }\n  }\n\n  /**\n   * Apply accessibility preferences from the style system\n   * @param {HTMLElement} element - The sheet element\n   * @private\n   */\n  _applyAccessibilityPreferences(element) {\n    // Check for accessibility preferences\n    const uiCustomization = game.system.anarchy?.uiCustomization;\n    if (!uiCustomization) return;\n\n    // Apply high contrast mode\n    if (uiCustomization.getCustomization('accessibility', 'highContrast')) {\n      element.classList.add('high-contrast');\n    }\n\n    // Apply reduced motion\n    if (uiCustomization.getCustomization('accessibility', 'reducedMotion')) {\n      element.classList.add('reduced-motion');\n    }\n\n    // Apply large text\n    if (uiCustomization.getCustomization('accessibility', 'largeText')) {\n      element.classList.add('large-text');\n    }\n\n    // Apply focus indicators\n    if (uiCustomization.getCustomization('accessibility', 'enhancedFocus')) {\n      element.classList.add('enhanced-focus');\n    }\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { AnarchyActorSheet } from './anarchy-actor-sheet.js';\nimport { TEMPLATES_PATH } from '../constants.js';\n\nexport class CharacterBaseSheet extends AnarchyActorSheet {\n  get template() {\n    return `${TEMPLATES_PATH}/actor/character.hbs`;\n  }\n\n  /** @override */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      width: 720,\n      height: 700,\n      tabs: [{ navSelector: '.sheet-tabs', contentSelector: '.sheet-body', initial: 'main' }],\n    });\n  }\n\n  getData(options) {\n    if (this.viewMode == undefined) {\n      this.viewMode = true;\n    }\n    const essence = this.actor.computeEssence();\n    const hbsData = foundry.utils.mergeObject(super.getData(options), {\n      essence: {\n        value: essence,\n        adjust: this.actor.computeMalusEssence(essence),\n      },\n      options: {\n        viewMode: this.viewMode,\n      },\n    });\n    return hbsData;\n  }\n\n  toggleViewMode() {\n    this.viewMode = !this.viewMode;\n    this.render();\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    html.find('.click-toggle-view-mode').click(async (event) => this.toggleViewMode());\n\n    // cues, dispositions, keywords\n    html.find('.click-word-add').click(async (event) => {\n      event.stopPropagation();\n      this.createNewWord(this.getEventWordType(event));\n    });\n\n    html.find('.click-word-say').click(async (event) => {\n      event.stopPropagation();\n      this.actor.sayWord(this.getEventWordType(event), this.getEventWordId(event));\n    });\n\n    html.find('.change-word-value').click(async (event) => {\n      event.stopPropagation();\n    });\n\n    html.find('.change-word-value').change(async (event) => {\n      event.stopPropagation();\n      const newWordValue = event.currentTarget.value;\n      await this.actor.updateWord(\n        this.getEventWordType(event),\n        this.getEventWordId(event),\n        newWordValue,\n      );\n    });\n\n    html.find('.click-word-delete').click(async (event) => {\n      event.stopPropagation();\n      this.actor.deleteWord(this.getEventWordType(event), this.getEventWordId(event));\n    });\n\n    html.find('.click-celebrity-roll').click(async (event) => {\n      event.stopPropagation();\n      this.actor.rollCelebrity();\n    });\n  }\n\n  createNewWord(wordType) {\n    const word = game.i18n.localize(ANARCHY.common.newEntry);\n    this.actor.createWord(wordType, word);\n  }\n\n  getEventWordType(event) {\n    return $(event.currentTarget).closest('.define-wordType').attr('data-word-type');\n  }\n\n  getEventWordId(event) {\n    return $(event.currentTarget).closest('.define-wordType').attr('data-word-id');\n  }\n}\n","import { TEMPLATES_PATH } from '../constants.js';\r\nimport { CharacterBaseSheet } from './character-base-sheet.js';\r\nimport '../../styles/character-enhanced-sheet.scss';\r\n\r\nexport class CharacterEnhancedSheet extends CharacterBaseSheet {\r\n  get template() {\r\n    return `${TEMPLATES_PATH}/actor/character-enhanced.hbs`;\r\n  }\r\n\r\n  /** @override */\r\n  static get defaultOptions() {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      width: 800,\r\n      height: 700,\r\n    });\r\n  }\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n\r\n    // Apply enhanced sheet specific UI customizations\r\n    if (game.system.anarchy?.uiCustomization) {\r\n      game.system.anarchy.uiCustomization.applyCustomizationsToElement(html[0], 'character-enhanced');\r\n    }\r\n\r\n    const actorId = this.actor._id;\r\n    html.find('.click-section').on('click', function () {\r\n      const sectionClass = $(this).data('class');\r\n      html.find(`.${sectionClass}`).toggleClass('closed');\r\n      localStorage.setItem(\r\n        `${actorId}-${sectionClass}`,\r\n        html.find(`.${sectionClass}`).hasClass('closed') ? 'closed' : null,\r\n      );\r\n    });\r\n  }\r\n\r\n  static ifTabClosed(id, sectionName, option) {\r\n    const isTabClosed = localStorage.getItem(`${id}-section-${sectionName}`) === 'closed';\r\n    if (isTabClosed) {\r\n      return option.fn(this);\r\n    }\r\n    return option.inverse(this);\r\n  }\r\n\r\n  static actorTabClosed(id, sectionName, option) {\r\n    const isTabClosed = localStorage.getItem(`${id}-section-${sectionName}`) === 'closed';\r\n    if (isTabClosed) {\r\n      return 'closed';\r\n    }\r\n    return '';\r\n  }\r\n}\r\n","import { Enums } from './enums.js';\n\nexport class Damage {\n  static monitor(code) {\n    return game.i18n.localize(Enums.getFromList(Enums.getMonitors(), code) ?? '');\n  }\n\n  static letter(code) {\n    return game.i18n.localize(Enums.getFromList(Enums.getMonitorLetters(), code) ?? '');\n  }\n}\n","export class Grammar {\n  static toLowerCaseNoAccent(words) {\n    return words\n      ?.normalize('NFD')\n      .toLowerCase()\n      .replace(/[\\u0300-\\u036f]/g, '');\n  }\n  static toUpperCaseNoAccent(words) {\n    return words\n      ?.normalize('NFD')\n      .toUpperCase()\n      .replace(/[\\u0300-\\u036f]/g, '');\n  }\n}\n","import { Checkbars } from '../common/checkbars.js';\nimport { Misc } from '../misc.js';\nimport { TEMPLATE } from '../constants.js';\nimport { RollDialog } from '../roll/roll-dialog.js';\nimport { NO_MATRIX_MONITOR } from '../matrix-helper.js';\n\nexport class AnarchyBaseItem extends Item {\n  static init() {\n    Hooks.on('createItem', (item, options, id) => item.onCreateItem(options, id));\n  }\n\n  async onCreateItem(options, id) {}\n\n  constructor(docData, context = {}) {\n    if (!context.anarchy?.ready) {\n      foundry.utils.mergeObject(context, { anarchy: { ready: true } });\n      const ItemConstructor = game.system.anarchy.itemClasses[docData.type];\n      if (ItemConstructor) {\n        if (!docData.img) {\n          docData.img = ItemConstructor.defaultIcon;\n        }\n        return new ItemConstructor(docData, context);\n      }\n    }\n    context.anarchy = undefined;\n    super(docData, context);\n  }\n\n  static get defaultIcon() {\n    return undefined;\n  }\n\n  getAttributes() {\n    return [];\n  }\n\n  getUsableAttributes() {\n    return this.isActive() ? this.getAttributes() : [];\n  }\n\n  getAttributeValue(attribute) {\n    if (this.system.attributes) {\n      return this.system.attributes[attribute]?.value ?? 0;\n    }\n    return 0;\n  }\n\n  hasOwnAnarchy() {\n    return false;\n  }\n  hasGMAnarchy() {\n    return false;\n  }\n\n  hasMatrixMonitor() {\n    return false;\n  }\n  getMatrixMonitor() {\n    return NO_MATRIX_MONITOR;\n  }\n\n  async nextConnectionMode() {}\n\n  async setCheckbarValue(checkbarPath, value) {\n    return await this.update({ [checkbarPath]: value });\n  }\n\n  isMetatype() {\n    return this.type == TEMPLATE.itemType.metatype;\n  }\n  isCyberdeck() {\n    return this.type == TEMPLATE.itemType.cyberdeck;\n  }\n  isWeapon() {\n    return this.type == TEMPLATE.itemType.weapon;\n  }\n\n  isActive() {\n    return !this.system.inactive;\n  }\n\n  canReceiveMarks() {\n    return this.system.monitors?.matrix?.canMark;\n  }\n\n  async rollAttribute(attribute) {\n    if (this.parent) {\n      await RollDialog.itemAttributeRoll(this, attribute);\n    }\n  }\n\n  async switchMonitorCheck(monitor, index, checked, sourceActorId = undefined) {\n    await Checkbars.switchMonitorCheck(this.parent, monitor, index, checked, sourceActorId, this);\n  }\n\n  async setCounter(monitor, value) {\n    await Checkbars.setCounter(this, monitor, value);\n  }\n\n  async addActorMark(sourceActorId) {\n    await Checkbars.addActorMark(this, sourceActorId);\n  }\n\n  async createModifier(modifier = {}) {\n    modifier = foundry.utils.mergeObject(modifier, {\n      group: 'roll',\n      effect: 'pool',\n      category: 'skill',\n      subCategory: '',\n      value: 0,\n      condition: '',\n    });\n    this._mutateModifiers((values) => values.concat([modifier]));\n  }\n\n  async deleteModifier(modifierId) {\n    await this._mutateModifiers((modifiers) => modifiers.filter((it) => it.id != modifierId));\n  }\n\n  async changeModifierSelection(modifierId, select, value) {\n    let impact = this._computeModifierImpact(select, value);\n\n    this._applyModifierUpdate(modifierId, impact);\n  }\n\n  _computeModifierImpact(select, value) {\n    switch (select) {\n      case 'group':\n        return (m) => {\n          if (m.group != value) {\n            m.group = value;\n            m.effect = '';\n            m.category = '';\n            m.subCategory = '';\n          }\n        };\n      case 'effect':\n        return (m) => (m.effect = value);\n      case 'category':\n        return (m) => {\n          if (m.category != value) {\n            m.category = value;\n            m.subCategory = '';\n          }\n        };\n      case 'subCategory':\n        return (m) => (m.subCategory = value);\n    }\n    return (m) => {};\n  }\n\n  async changeModifierValue(modifierId, value) {\n    this._applyModifierUpdate(modifierId, (m) => (m.value = Number(value)));\n  }\n\n  async changeModifierCondition(modifierId, value) {\n    this._applyModifierUpdate(modifierId, (m) => (m.condition = value));\n  }\n\n  async _applyModifierUpdate(id, updateFunction = (m) => {}) {\n    await this._mutateModifiers((values) =>\n      values.map((it) => {\n        if (it.id == id) {\n          updateFunction(it);\n        }\n        return it;\n      }),\n    );\n  }\n\n  async _mutateModifiers(mutation = (values) => values) {\n    const modifiers = mutation(this.system.modifiers);\n    Misc.reindexIds(modifiers);\n    await this.update({ 'system.modifiers': modifiers });\n  }\n\n  prepateShortcut() {\n    return undefined;\n  }\n}\n","import { ICONS_PATH } from '../constants.js';\nimport { AnarchyBaseItem } from './anarchy-base-item.js';\n\nexport class SkillItem extends AnarchyBaseItem {\n  static get defaultIcon() {\n    return `${ICONS_PATH}/skills/skills.svg`;\n  }\n\n  static prepareSkill(skillCode) {\n    const skill = game.system.anarchy.skills.get(skillCode);\n    if (!skill) {\n      return {\n        img: this.defaultIcon,\n        system: {\n          code: skillCode,\n          attribute: '',\n          hasDrain: false,\n          hasConvergence: false,\n        },\n      };\n    }\n\n    const updates = {\n      img: skill.icon,\n      system: {\n        code: skill.code,\n        attribute: skill.attribute,\n        hasDrain: skill.hasDrain ? true : false,\n        hasConvergence: skill.hasConvergence ? true : false,\n      },\n    };\n    if (skill.code != 'knowledge') {\n      updates.name = game.i18n.localize(skill.labelkey);\n    }\n    return updates;\n  }\n\n  isKnowledgeSkill() {\n    return this.system.code == 'knowledge';\n  }\n\n  isGeneralSkill() {\n    return this.system.code != 'knowledge';\n  }\n\n  prepareShortcut() {\n    return {\n      img: this.img,\n      label: this.system.specialization ? `${this.name}: ${this.system.specialization}` : this.name,\n      callback: (token) => token.actor.rollSkill(this, this.system.specialization),\n    };\n  }\n}\n","import { ICONS_PATH, TEMPLATE, TEMPLATES_PATH } from '../constants.js';\nimport { ANARCHY } from '../config.js';\nimport { Enums } from '../enums.js';\nimport { AnarchyBaseItem } from './anarchy-base-item.js';\nimport { Checkbars } from '../common/checkbars.js';\nimport { AnarchyUsers } from '../users.js';\nimport { ROLL_PARAMETER_CATEGORY } from '../roll/roll-parameters.js';\nimport { ANARCHY_HOOKS } from '../hooks-manager.js';\nimport { AttributeActions } from '../attribute-actions.js';\nimport { ErrorManager } from '../error-manager.js';\nimport { Misc } from '../misc.js';\nimport { SkillItem } from './skill-item.js';\n\nconst AREA_TARGETS = {\n  none: { targets: 1, adjust: [0] },\n  shotgun: { targets: 2, adjust: [0, -2] },\n  circle: { targets: undefined },\n  cone: { targets: undefined },\n  rect: { targets: undefined },\n  ray: { targets: undefined },\n};\n\n// weapon range\nconst WEAPON_RANGE_PARAMETER = {\n  code: 'weapon-range',\n  options: {\n    flags: { editable: true },\n    order: 20,\n    category: ROLL_PARAMETER_CATEGORY.pool,\n    labelkey: ANARCHY.common.roll.modifiers.weaponRange,\n    hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/select-option.hbs`,\n    hbsTemplateChat: undefined, //``\n  },\n  isUsed: (p) => true,\n  condition: (context) => context.weapon,\n  factory: (context) => {\n    const ranges = context.weapon.getRanges();\n    const rangeValues = ranges.map((it) => it.value);\n    return {\n      value: ranges[0].value,\n      min: Math.min(...rangeValues),\n      max: Math.max(...rangeValues),\n      choices: ranges,\n      selected: game.i18n.localize(ranges[0].labelkey),\n    };\n  },\n};\nconst WEAPON_AREA_PARAMETER = {\n  code: 'weapon-area',\n  options: {\n    used: true,\n    order: 20,\n    category: ROLL_PARAMETER_CATEGORY.pool,\n    labelkey: ANARCHY.common.roll.modifiers.weaponArea,\n    hbsTemplateRoll: `${TEMPLATES_PATH}/roll/parts/input-numeric.hbs`,\n    hbsTemplateChat: undefined, //``\n  },\n  isUsed: (p) => p.used,\n  condition: (context) => context.weapon && context.weapon.getArea() != TEMPLATE.area.none,\n  factory: (context) => {\n    const countTargets = context.targeting.targetedTokenIds?.length ?? 1;\n    const areaModifier = context.weapon.getAreaModifier(countTargets);\n    return {\n      value: areaModifier,\n      min: Math.min(0, areaModifier),\n      max: Math.max(0, areaModifier),\n      used: countTargets > 1,\n    };\n  },\n};\n\nexport class WeaponItem extends AnarchyBaseItem {\n  static init() {\n    Hooks.once(ANARCHY_HOOKS.REGISTER_ROLL_PARAMETERS, (register) => {\n      register(WEAPON_AREA_PARAMETER);\n      register(WEAPON_RANGE_PARAMETER);\n    });\n  }\n\n  static get defaultIcon() {\n    return `${ICONS_PATH}/weapons/mac-10.svg`;\n  }\n\n  isWeaponSkill(item) {\n    return item.type == 'skill' && item.system.code === this.system.skill;\n  }\n\n  get hasDrain() {\n    const skill = this.getWeaponSkill();\n    return skill.system.hasDrain;\n  }\n\n  get hasConvergence() {\n    const skill = this.getWeaponSkill();\n    return skill.system.hasConvergence;\n  }\n\n  getWeaponSkill() {\n    const actorSkill = this.actor?.items.find((skill) => this.isWeaponSkill(skill));\n    if (actorSkill) {\n      return actorSkill;\n    }\n    const worldSkill = game.items.find((skill) => this.isWeaponSkill(skill));\n    if (worldSkill) {\n      return worldSkill;\n    }\n    return SkillItem.prepareSkill(this.system.skill);\n  }\n\n  getDefense() {\n    return AttributeActions.fixedDefenseCode(this.system.defense);\n  }\n\n  getDamage() {\n    if (!this.parent) {\n      return undefined;\n    }\n    const damageAttributeValue = this.system.damageAttribute\n      ? (this.parent.getAttributeValue(this.system.damageAttribute) ?? 0)\n      : 0;\n    return {\n      value: WeaponItem.damageValue(\n        this.system.monitor,\n        this.system.damage,\n        this.system.damageAttribute,\n        damageAttributeValue,\n      ),\n      monitor: this.system.monitor,\n      noArmor: this.system.noArmor,\n      armorMode: WeaponItem.armorMode(this.system.monitor, this.system.noArmor),\n    };\n  }\n\n  static damageValue(monitor, damage, damageAttribute, actorAttribute) {\n    if (monitor == TEMPLATE.monitors.marks) {\n      return 1;\n    }\n    damage = Number(damage);\n    if (damageAttribute) {\n      if (actorAttribute !== undefined) {\n        damage = damage + Math.ceil(Number(actorAttribute) / 2);\n      } else {\n        console.warn('Weapon not attached to an actor');\n        return game.i18n.localize(ANARCHY.item.weapon.weaponWithoutActor);\n      }\n    }\n    return damage;\n  }\n\n  getDamageCode() {\n    return WeaponItem.damageCode(\n      this.system.monitor,\n      this.system.damage,\n      this.system.damageAttribute,\n    );\n  }\n\n  static damageCode(monitor, damage, damageAttribute) {\n    if (monitor == TEMPLATE.monitors.marks) {\n      return '1';\n    }\n    let code = '';\n    if (damageAttribute && ANARCHY.attributes[damageAttribute]) {\n      code +=\n        game.i18n.localize(ANARCHY.attributes[damageAttribute]).substring(0, 3).toUpperCase() +\n        '/2 + ';\n    }\n    code += String(damage);\n    return code;\n  }\n\n  static armorMode(monitor, noArmor) {\n    if (Checkbars.useArmor(monitor)) {\n      return noArmor ? 'noArmor' : 'withArmor';\n    }\n    return '';\n  }\n\n  getRanges() {\n    let ranges = [this._getRange('short')];\n    if (this.system.range.max != 'short') {\n      ranges.push(this._getRange('medium'));\n    }\n    if (this.system.range.max == 'long') {\n      ranges.push(this._getRange('long'));\n    }\n    return ranges;\n  }\n\n  _getRange(range) {\n    return {\n      value: this.system.range[range],\n      labelkey: Enums.getFromList(Enums.getEnums().ranges, range),\n    };\n  }\n\n  prepareShortcut() {\n    return {\n      img: this.img,\n      label: this.name,\n      callback: (token) => token.actor.rollWeapon(this),\n    };\n  }\n\n  validateTargets(actor) {\n    // TODO: add a weapon \"plane\" to define if attack is in matrix/astral/physical world\n    // use actorCannotApplyDamage?\n    const monitor = this.getDamage()?.monitor;\n    const targets = AnarchyUsers.getTargetTokens(game.user);\n    const validTargets = targets.filter((token) => token.actor?.canReceiveDamage(monitor));\n    const invalidTargets = targets\n      .filter((token) => !token.actor?.canReceiveDamage(monitor))\n      .map((token) => token.name);\n\n    if (invalidTargets.length > 0) {\n      ui.notifications.info(\n        game.i18n.format(ANARCHY.common.errors.ignoredTargets, {\n          targets: invalidTargets.reduce(Misc.joiner(', ')),\n        }),\n      );\n    }\n    if (validTargets.length == 0) {\n      ui.notifications.info(\n        game.i18n.format(ANARCHY.common.errors.noTargetSelected, {\n          weapon: this.name ?? game.i18n.localize(ANARCHY.itemType.singular.weapon),\n        }),\n      );\n    } else {\n      this.checkWeaponTargetsCount(validTargets);\n      // TODO: could check LOS, distance? ...\n    }\n    return validTargets;\n  }\n\n  checkWeaponTargetsCount(targets) {\n    const area = this.system.area;\n    const areaTargets = AREA_TARGETS[area] ?? {};\n    ErrorManager.checkTargetsCount(areaTargets.targets ?? 0, targets, area);\n  }\n\n  getAreaModifier(countTargets) {\n    const area = this.getArea();\n    const areaTargets = AREA_TARGETS[area] ?? {};\n    if (areaTargets.targets && areaTargets.adjust && countTargets <= areaTargets.targets) {\n      return areaTargets.adjust[countTargets - 1] ?? 0;\n    }\n    return 0;\n  }\n\n  getArea() {\n    if (this.system.area == '') {\n      return TEMPLATE.area.none;\n    }\n    return this.system.area ?? TEMPLATE.area.none;\n  }\n}\n","import { AnarchyBaseActor } from './actor/base-actor.js';\nimport { CharacterEnhancedSheet } from './actor/character-enhanced-sheet.js';\nimport { Damage } from './damage.js';\nimport { Enums } from './enums.js';\nimport { Grammar } from './grammar.js';\nimport { Icons } from './icons.js';\nimport { WeaponItem } from './item/weapon-item.js';\nimport { Misc } from './misc.js';\n\nconst HBS_PARTIAL_TEMPLATES = [\n  // -- monitors\n  'systems/anarchy/templates/monitors/anarchy-actor.hbs',\n  'systems/anarchy/templates/monitors/armor.hbs',\n  'systems/anarchy/templates/monitors/edge.hbs',\n  'systems/anarchy/templates/actor/parts/matrix-cyberdeck.hbs',\n  'systems/anarchy/templates/monitors/matrix.hbs',\n  'systems/anarchy/templates/monitors/physical.hbs',\n  'systems/anarchy/templates/monitors/social-credibility.hbs',\n  'systems/anarchy/templates/monitors/social-rumor.hbs',\n  'systems/anarchy/templates/monitors/structure.hbs',\n  'systems/anarchy/templates/monitors/stun.hbs',\n  'systems/anarchy/templates/actor/character/name.hbs',\n\n  // character\n  'systems/anarchy/templates/actor/character/capacity.hbs',\n  'systems/anarchy/templates/actor/character/description.hbs',\n  'systems/anarchy/templates/actor/character/essence.hbs',\n  'systems/anarchy/templates/actor/character/genre.hbs',\n  'systems/anarchy/templates/actor/character/karma.hbs',\n  'systems/anarchy/templates/actor/character/metatype.hbs',\n  'systems/anarchy/templates/actor/character/social-celebrity.hbs',\n  // character parts\n  'systems/anarchy/templates/actor/character-limited.hbs',\n  'systems/anarchy/templates/actor/parts/words.hbs',\n  'systems/anarchy/templates/actor/parts/contact.hbs',\n  'systems/anarchy/templates/actor/parts/contacts.hbs',\n  'systems/anarchy/templates/actor/parts/gear.hbs',\n  'systems/anarchy/templates/actor/parts/gears.hbs',\n  // character enhanced\n  'systems/anarchy/templates/actor/character-enhanced/metatype.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/attributes.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/capacity.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/attribute.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/karma.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/hexabox.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/words.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/skills.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/skill.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/shadowamp.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/shadowamps.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/quality.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/qualities.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/monitors.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/armor.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/stun.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/physical.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/checkbar.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/check-element.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/anarchy-actor.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/social-credibility.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/social-rumor.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/edge.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/actions.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/attributebutton.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/attributebuttons.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/gears.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/gear.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/cyberdecks.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/cyberdeck.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/weapons.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/weapon.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/damage-code.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/damage-armor.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/story.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/equipments.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/contact.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/contacts.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/gmnotes.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/description.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/owned-actor.hbs',\n  'systems/anarchy/templates/actor/character-enhanced/owned-actors.hbs',\n  // actor common\n  'systems/anarchy/templates/actor/parts/attributebutton.hbs',\n  'systems/anarchy/templates/actor/parts/attributebuttons.hbs',\n  'systems/anarchy/templates/actor/parts/attribute.hbs',\n  'systems/anarchy/templates/actor/parts/attributes.hbs',\n  'systems/anarchy/templates/actor/parts/description.hbs',\n  'systems/anarchy/templates/actor/parts/gmnotes.hbs',\n  'systems/anarchy/templates/actor/parts/owned-actor.hbs',\n  'systems/anarchy/templates/actor/parts/owned-actors.hbs',\n  'systems/anarchy/templates/monitors/marks-actor.hbs',\n  'systems/anarchy/templates/monitors/marks.hbs',\n  'systems/anarchy/templates/actor/parts/ownership.hbs',\n  'systems/anarchy/templates/actor/parts/qualities.hbs',\n  'systems/anarchy/templates/actor/parts/quality.hbs',\n  'systems/anarchy/templates/actor/parts/shadowamp.hbs',\n  'systems/anarchy/templates/actor/parts/shadowamps.hbs',\n  'systems/anarchy/templates/actor/parts/item-attribute.hbs',\n  'systems/anarchy/templates/actor/parts/cyberdeck.hbs',\n  'systems/anarchy/templates/actor/parts/cyberdecks.hbs',\n  'systems/anarchy/templates/actor/parts/skill.hbs',\n  'systems/anarchy/templates/actor/parts/skills.hbs',\n  'systems/anarchy/templates/actor/parts/weapon-range.hbs',\n  'systems/anarchy/templates/actor/parts/weapon.hbs',\n  'systems/anarchy/templates/actor/parts/weapons.hbs',\n  //-- NPC\n  'systems/anarchy/templates/actor/npc-parts/quality.hbs',\n  'systems/anarchy/templates/actor/npc-parts/qualities.hbs',\n  'systems/anarchy/templates/actor/npc-parts/shadowamp.hbs',\n  'systems/anarchy/templates/actor/npc-parts/shadowamps.hbs',\n  'systems/anarchy/templates/actor/npc-parts/skill.hbs',\n  'systems/anarchy/templates/actor/npc-parts/skills.hbs',\n  'systems/anarchy/templates/actor/npc-parts/weapon.hbs',\n  'systems/anarchy/templates/actor/npc-parts/weapons.hbs',\n  // Vehicles\n  'systems/anarchy/templates/actor/vehicle/vehicle-attributes.hbs',\n  'systems/anarchy/templates/actor/vehicle/vehicle-category.hbs',\n  'systems/anarchy/templates/actor/vehicle/vehicle-skill.hbs',\n  // item\n  'systems/anarchy/templates/item/parts/inactive.hbs',\n  'systems/anarchy/templates/item/parts/itemname.hbs',\n  'systems/anarchy/templates/item/parts/modifier.hbs',\n  'systems/anarchy/templates/item/parts/modifiers.hbs',\n  'systems/anarchy/templates/item/parts/references.hbs',\n  // common&technical partials\n  'systems/anarchy/templates/monitors/anarchy.hbs',\n  'systems/anarchy/templates/monitors/anarchy-scene.hbs',\n  'systems/anarchy/templates/common/view-mode.hbs',\n  'systems/anarchy/templates/common/check-element.hbs',\n  'systems/anarchy/templates/common/checkbar.hbs',\n  'systems/anarchy/templates/common/label.hbs',\n  'systems/anarchy/templates/common/damage-code.hbs',\n  'systems/anarchy/templates/common/damage-armor.hbs',\n  'systems/anarchy/templates/common/enum-value-label.hbs',\n  'systems/anarchy/templates/common/favorite.hbs',\n  'systems/anarchy/templates/common/item-control-add.hbs',\n  'systems/anarchy/templates/common/item-control-activate.hbs',\n  'systems/anarchy/templates/common/item-controls.hbs',\n  'systems/anarchy/templates/common/control-connectionMode.hbs',\n  'systems/anarchy/templates/common/actor-reference.hbs',\n  // dialogs\n  'systems/anarchy/templates/dialog/roll-modifier.hbs',\n  // apps\n  'systems/anarchy/templates/app/gm-anarchy.hbs',\n  'systems/anarchy/templates/app/gm-difficulty.hbs',\n  'systems/anarchy/templates/app/gm-difficulty-buttons.hbs',\n];\n\nexport class HandlebarsManager {\n  constructor() {\n    Hooks.once('ready', () => this.onReady());\n  }\n\n  async onReady() {\n    this.registerBasicHelpers();\n    await loadTemplates(Misc.distinct(HBS_PARTIAL_TEMPLATES));\n  }\n\n  registerBasicHelpers() {\n    Handlebars.registerHelper('concat', (...args) => Misc.join(args.slice(0, -1)));\n    Handlebars.registerHelper('substring', (str, from, to) => str?.substring(from, to));\n    Handlebars.registerHelper('toUpperCase', Grammar.toUpperCaseNoAccent);\n    Handlebars.registerHelper('weaponDamageLetter', Damage.letter);\n    Handlebars.registerHelper('weaponDamageCode', WeaponItem.damageCode);\n    Handlebars.registerHelper('weaponDamageValue', WeaponItem.damageValue);\n    Handlebars.registerHelper('weaponArmorMode', WeaponItem.armorMode);\n\n    Handlebars.registerHelper('skillValue', (actor, skillId) =>\n      actor.getSkillValue(skillId, false),\n    );\n    Handlebars.registerHelper('specializationValue', (actor, skillId) =>\n      actor.getSkillValue(skillId, true),\n    );\n    Handlebars.registerHelper('for', HandlebarsManager.hbsForLoop);\n    Handlebars.registerHelper('modulo', (value, divisor) => value % divisor);\n    Handlebars.registerHelper('divint', Misc.divint);\n    Handlebars.registerHelper('divup', Misc.divup);\n    Handlebars.registerHelper('sum', (v1, v2) => v1 + v2);\n    Handlebars.registerHelper('times', (v1, v2) => v1 * v2);\n    Handlebars.registerHelper('diff', (v1, v2) => v1 - v2);\n    Handlebars.registerHelper('min', (v1, v2) => Math.min(v1, v2));\n    Handlebars.registerHelper('max', (v1, v2) => Math.max(v1, v2));\n    Handlebars.registerHelper('either', (a, b) => (a ? a : b));\n    Handlebars.registerHelper('isInteger', (a) => a !== undefined && Number.isInteger(a));\n    Handlebars.registerHelper('actorAttribute', (attribute, actor, item = undefined) =>\n      actor.getAttributeValue(attribute, item),\n    );\n    Handlebars.registerHelper('localizeAttribute', Enums.localizeAttribute);\n    Handlebars.registerHelper('iconFA', Icons.fontAwesome);\n    Handlebars.registerHelper('iconSrc', Icons.iconSystemPath);\n    Handlebars.registerHelper('iconPath', Icons.iconPath);\n    Handlebars.registerHelper('iconD6', Icons.iconD6);\n    Handlebars.registerHelper('getActor', (id) => game.actors.get(id));\n    Handlebars.registerHelper('actorHasFavorite', (actorId, options) =>\n      HandlebarsManager.checkHasFavorite(actorId, options),\n    );\n    Handlebars.registerHelper('padWordListToMin', AnarchyBaseActor.padWordListToMin);\n    Handlebars.registerHelper('sortSkills', AnarchyBaseActor.sortSkills);\n    Handlebars.registerHelper('sortShadowamps', AnarchyBaseActor.sortShadowamps);\n    Handlebars.registerHelper('actorTabClosed', CharacterEnhancedSheet.actorTabClosed);\n    Handlebars.registerHelper('ifTabClosed', CharacterEnhancedSheet.ifTabClosed);\n    Handlebars.registerHelper('sortQualities', AnarchyBaseActor.sortQualities);\n    Handlebars.registerHelper('sortAttributeButton', AnarchyBaseActor.sortAttributeButton);\n    Handlebars.registerHelper('range', function (min, max) {\n      let array = [];\n      for (let i = min; i <= max; i++) {\n        array.push(i);\n      }\n      return array;\n    });\n    Handlebars.registerHelper('ifGte', function (value, threshold, options) {\n      if (value >= threshold) {\n        return options.fn(this);\n      } else {\n        return options.inverse(this);\n      }\n    });\n    Handlebars.registerHelper('ifTabClosed', CharacterEnhancedSheet.ifTabClosed);\n    Handlebars.registerHelper('actorTabClosed', CharacterEnhancedSheet.actorTabClosed);\n    Handlebars.registerHelper('length', function (context) {\n      return context?.length || 0;\n    });\n  }\n\n  static hbsForLoop(start, end, options) {\n    let accum = '';\n    for (let i = start; i < end; ++i) {\n      accum += options.fn(i);\n    }\n    return accum;\n  }\n\n  static checkHasFavorite(actorId, options) {\n    const actor = game.actors.get(actorId);\n    return actor?.hasFavorite(options.hash.type, options.hash.id);\n  }\n}\n","import { ANARCHY } from './config.js';\nimport { LOG_HEAD, SYSTEM_NAME } from './constants.js';\nimport { ANARCHY_HOOKS, HooksManager } from './hooks-manager.js';\n\nconst DEFAULT_CSS_CLASS = 'default-css-class';\nconst CSS_DEFAULT = 'style-anarchy-shadowrun';\n\nconst DEFAULT_STYLES = [\n  { name: 'Shadowrun Anarchy', cssClass: CSS_DEFAULT },\n  { name: 'Dark', cssClass: 'style-dark' },\n  { name: 'Dark glass', cssClass: 'style-darkglass' },\n];\n\n/**\n * The Styles class manages the addition of different styles\n */\nexport class Styles {\n  constructor() {\n    this.availableStyles = {};\n    HooksManager.register(ANARCHY_HOOKS.REGISTER_STYLES);\n\n    Hooks.once(ANARCHY_HOOKS.REGISTER_STYLES, (register) =>\n      DEFAULT_STYLES.forEach((it) => register(it.cssClass, it.name)),\n    );\n    Hooks.once('ready', () => this.onReady());\n  }\n\n  async onReady() {\n    Hooks.callAll(\n      ANARCHY_HOOKS.REGISTER_STYLES,\n      (style, name) => (this.availableStyles[style] = name),\n    );\n    console.log(LOG_HEAD + 'Loaded styles', this.availableStyles);\n\n    game.settings.register(SYSTEM_NAME, DEFAULT_CSS_CLASS, {\n      scope: 'world',\n      name: game.i18n.localize(ANARCHY.settings.defaultCssClass.name),\n      hint: game.i18n.localize(ANARCHY.settings.defaultCssClass.hint),\n      config: true,\n      default: CSS_DEFAULT,\n      choices: this.availableStyles,\n      type: String,\n    });\n  }\n\n  selectCssClass() {\n    const style = game.settings.get(SYSTEM_NAME, DEFAULT_CSS_CLASS);\n    return this.availableStyles[style] ? style : CSS_DEFAULT;\n  }\n\n  /**\n   * Extract theme ID from a CSS class name\n   * @param {string} cssClass - The CSS class name\n   * @returns {string} The theme ID\n   */\n  getThemeIdFromClass(cssClass) {\n    if (!cssClass) return 'default';\n    \n    // Map CSS classes to theme IDs\n    const themeMap = {\n      'style-anarchy-shadowrun': 'shadowrun',\n      'style-dark': 'dark',\n      'style-darkglass': 'darkglass',\n      'default-css-class': 'default'\n    };\n    \n    return themeMap[cssClass] || cssClass.replace(/^style-/, '').replace(/-/g, '_');\n  }\n\n  /**\n   * Get the current theme ID\n   * @returns {string} The current theme ID\n   */\n  getCurrentThemeId() {\n    const cssClass = this.selectCssClass();\n    return this.getThemeIdFromClass(cssClass);\n  }\n}\n","// Theme Utilities - Advanced Theme Operations\r\n// This module provides utilities for theme manipulation, analysis, and management\r\n\r\nimport { LOG_HEAD, SYSTEM_NAME } from './constants.js';\r\n\r\n/**\r\n * Theme Utilities class providing advanced theme operations\r\n */\r\nexport class ThemeUtilities {\r\n  constructor(stylesManager) {\r\n    this.styles = stylesManager;\r\n  }\r\n\r\n  // =============================================================================\r\n  // THEME ANALYSIS UTILITIES\r\n  // =============================================================================\r\n\r\n  /**\r\n   * Analyze theme contrast ratios for accessibility\r\n   */\r\n  analyzeThemeContrast(themeId) {\r\n    const theme = this.styles.getThemeMetadata(themeId);\r\n    if (!theme) {\r\n      throw new Error(`Theme ${themeId} not found`);\r\n    }\r\n\r\n    // Apply theme temporarily for analysis\r\n    const originalTheme = this.styles.currentTheme;\r\n    this.styles.applyTheme(theme.cssClass);\r\n\r\n    const analysis = {\r\n      themeId,\r\n      themeName: theme.name,\r\n      contrastRatios: {},\r\n      accessibility: {\r\n        wcagAA: true,\r\n        wcagAAA: true,\r\n        issues: []\r\n      }\r\n    };\r\n\r\n    // Analyze key color combinations\r\n    const combinations = [\r\n      { bg: '--background-primary', fg: '--text-primary', name: 'Primary Text' },\r\n      { bg: '--background-secondary', fg: '--text-secondary', name: 'Secondary Text' },\r\n      { bg: '--anarchy-background-attributes', fg: '--text-primary', name: 'Attribute Text' },\r\n      { bg: '--interactive-primary', fg: '--text-inverse', name: 'Button Text' }\r\n    ];\r\n\r\n    combinations.forEach(combo => {\r\n      const bgColor = this.styles.getCSSVariable(combo.bg.replace('--', ''));\r\n      const fgColor = this.styles.getCSSVariable(combo.fg.replace('--', ''));\r\n      \r\n      if (bgColor && fgColor) {\r\n        const ratio = this.calculateContrastRatio(bgColor, fgColor);\r\n        analysis.contrastRatios[combo.name] = {\r\n          ratio: ratio,\r\n          wcagAA: ratio >= 4.5,\r\n          wcagAAA: ratio >= 7,\r\n          background: bgColor,\r\n          foreground: fgColor\r\n        };\r\n\r\n        if (ratio < 4.5) {\r\n          analysis.accessibility.wcagAA = false;\r\n          analysis.accessibility.issues.push(`${combo.name} fails WCAG AA (${ratio.toFixed(2)}:1)`);\r\n        }\r\n        if (ratio < 7) {\r\n          analysis.accessibility.wcagAAA = false;\r\n        }\r\n      }\r\n    });\r\n\r\n    // Restore original theme\r\n    this.styles.applyTheme(originalTheme);\r\n\r\n    return analysis;\r\n  }\r\n\r\n  /**\r\n   * Calculate contrast ratio between two colors\r\n   */\r\n  calculateContrastRatio(color1, color2) {\r\n    // Simplified contrast calculation\r\n    // In a real implementation, you'd parse the CSS colors and calculate luminance\r\n    const luminance1 = this.getRelativeLuminance(color1);\r\n    const luminance2 = this.getRelativeLuminance(color2);\r\n    \r\n    const lighter = Math.max(luminance1, luminance2);\r\n    const darker = Math.min(luminance1, luminance2);\r\n    \r\n    return (lighter + 0.05) / (darker + 0.05);\r\n  }\r\n\r\n  /**\r\n   * Get relative luminance (simplified)\r\n   */\r\n  getRelativeLuminance(color) {\r\n    // This is a simplified version - in production you'd use a proper color parsing library\r\n    if (color.includes('hsl')) {\r\n      // Extract lightness from HSL\r\n      const match = color.match(/hsl\\([^,]+,\\s*[^,]+,\\s*(\\d+)%/);\r\n      if (match) {\r\n        return parseInt(match[1]) / 100;\r\n      }\r\n    }\r\n    return 0.5; // Default fallback\r\n  }\r\n\r\n  // =============================================================================\r\n  // THEME PERFORMANCE UTILITIES\r\n  // =============================================================================\r\n\r\n  /**\r\n   * Measure theme application performance\r\n   */\r\n  measureThemePerformance(themeClass, iterations = 5) {\r\n    const measurements = [];\r\n    \r\n    for (let i = 0; i < iterations; i++) {\r\n      const startTime = performance.now();\r\n      this.styles.applyTheme(themeClass);\r\n      const endTime = performance.now();\r\n      measurements.push(endTime - startTime);\r\n    }\r\n\r\n    return {\r\n      average: measurements.reduce((a, b) => a + b) / measurements.length,\r\n      min: Math.min(...measurements),\r\n      max: Math.max(...measurements),\r\n      measurements\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Analyze CSS variable usage across themes\r\n   */\r\n  analyzeVariableUsage() {\r\n    const analysis = {\r\n      totalVariables: 0,\r\n      themeVariables: {},\r\n      commonVariables: [],\r\n      uniqueVariables: {},\r\n      redundancy: 0\r\n    };\r\n\r\n    const allThemes = this.styles.getAllThemes();\r\n    const variableSets = {};\r\n\r\n    // Collect variables for each theme\r\n    allThemes.forEach(theme => {\r\n      const originalTheme = this.styles.currentTheme;\r\n      this.styles.applyTheme(theme.cssClass);\r\n      \r\n      const variables = this.styles.getCurrentThemeVariables();\r\n      variableSets[theme.id] = Object.keys(variables);\r\n      analysis.themeVariables[theme.id] = Object.keys(variables).length;\r\n      \r\n      this.styles.applyTheme(originalTheme);\r\n    });\r\n\r\n    // Find common and unique variables\r\n    const allVariables = new Set();\r\n    Object.values(variableSets).forEach(vars => {\r\n      vars.forEach(v => allVariables.add(v));\r\n    });\r\n\r\n    analysis.totalVariables = allVariables.size;\r\n\r\n    // Find variables common to all themes\r\n    analysis.commonVariables = Array.from(allVariables).filter(variable => {\r\n      return Object.values(variableSets).every(themeVars => themeVars.includes(variable));\r\n    });\r\n\r\n    // Find unique variables per theme\r\n    Object.entries(variableSets).forEach(([themeId, vars]) => {\r\n      analysis.uniqueVariables[themeId] = vars.filter(variable => {\r\n        return !analysis.commonVariables.includes(variable);\r\n      });\r\n    });\r\n\r\n    // Calculate redundancy\r\n    const totalVariableInstances = Object.values(analysis.themeVariables).reduce((a, b) => a + b, 0);\r\n    analysis.redundancy = Math.round((1 - analysis.totalVariables / totalVariableInstances) * 100);\r\n\r\n    return analysis;\r\n  }\r\n\r\n  // =============================================================================\r\n  // THEME GENERATION UTILITIES\r\n  // =============================================================================\r\n\r\n  /**\r\n   * Generate a new theme based on an existing theme with color modifications\r\n   */\r\n  generateThemeVariant(baseThemeId, variantName, colorModifications = {}) {\r\n    const baseTheme = this.styles.getThemeMetadata(baseThemeId);\r\n    if (!baseTheme) {\r\n      throw new Error(`Base theme ${baseThemeId} not found`);\r\n    }\r\n\r\n    const variantId = `${baseThemeId}-${variantName.toLowerCase().replace(/\\s+/g, '-')}`;\r\n    \r\n    const variant = {\r\n      ...baseTheme,\r\n      id: variantId,\r\n      name: `${baseTheme.name} (${variantName})`,\r\n      cssClass: `style-${variantId}`,\r\n      description: `${baseTheme.description} - ${variantName} variant`,\r\n      version: `${baseTheme.version}-variant`,\r\n      category: 'generated',\r\n      baseTheme: baseThemeId,\r\n      modifications: colorModifications\r\n    };\r\n\r\n    // Apply color modifications to preview\r\n    if (colorModifications.primaryColor) {\r\n      variant.preview.primaryColor = colorModifications.primaryColor;\r\n    }\r\n    if (colorModifications.backgroundColor) {\r\n      variant.preview.backgroundColor = colorModifications.backgroundColor;\r\n    }\r\n    if (colorModifications.textColor) {\r\n      variant.preview.textColor = colorModifications.textColor;\r\n    }\r\n\r\n    return variant;\r\n  }\r\n\r\n  /**\r\n   * Create accessibility-enhanced theme variant\r\n   */\r\n  createAccessibilityVariant(baseThemeId, accessibilityOptions = {}) {\r\n    const baseTheme = this.styles.getThemeMetadata(baseThemeId);\r\n    if (!baseTheme) {\r\n      throw new Error(`Base theme ${baseThemeId} not found`);\r\n    }\r\n\r\n    const variantName = 'Accessible';\r\n    const variant = this.generateThemeVariant(baseThemeId, variantName);\r\n    \r\n    // Apply accessibility enhancements\r\n    variant.accessibility = {\r\n      ...baseTheme.accessibility,\r\n      ...accessibilityOptions,\r\n      highContrast: accessibilityOptions.highContrast || false,\r\n      reducedMotion: accessibilityOptions.reducedMotion || false,\r\n      largeText: accessibilityOptions.largeText || false\r\n    };\r\n\r\n    // Modify colors for better accessibility if high contrast is enabled\r\n    if (variant.accessibility.highContrast) {\r\n      variant.preview.backgroundColor = '#000000';\r\n      variant.preview.textColor = '#ffffff';\r\n      variant.preview.primaryColor = '#ffff00';\r\n    }\r\n\r\n    return variant;\r\n  }\r\n\r\n  // =============================================================================\r\n  // THEME VALIDATION UTILITIES\r\n  // =============================================================================\r\n\r\n  /**\r\n   * Comprehensive theme validation\r\n   */\r\n  validateAllThemes() {\r\n    const results = {\r\n      valid: 0,\r\n      invalid: 0,\r\n      themes: {},\r\n      summary: {\r\n        totalThemes: 0,\r\n        validationErrors: [],\r\n        recommendations: []\r\n      }\r\n    };\r\n\r\n    const allThemes = this.styles.getAllThemes();\r\n    results.summary.totalThemes = allThemes.length;\r\n\r\n    allThemes.forEach(theme => {\r\n      const validation = this.styles.validateTheme(theme.id);\r\n      results.themes[theme.id] = validation;\r\n      \r\n      if (validation.valid) {\r\n        results.valid++;\r\n      } else {\r\n        results.invalid++;\r\n        results.summary.validationErrors.push(...validation.errors.map(error => `${theme.name}: ${error}`));\r\n      }\r\n\r\n      // Add contrast analysis\r\n      try {\r\n        const contrastAnalysis = this.analyzeThemeContrast(theme.id);\r\n        results.themes[theme.id].contrast = contrastAnalysis;\r\n        \r\n        if (!contrastAnalysis.accessibility.wcagAA) {\r\n          results.summary.recommendations.push(`${theme.name}: Consider improving contrast ratios for better accessibility`);\r\n        }\r\n      } catch (error) {\r\n        console.warn(LOG_HEAD + `Could not analyze contrast for theme ${theme.name}:`, error);\r\n      }\r\n    });\r\n\r\n    return results;\r\n  }\r\n\r\n  // =============================================================================\r\n  // THEME EXPORT/IMPORT UTILITIES\r\n  // =============================================================================\r\n\r\n  /**\r\n   * Export theme configuration for sharing\r\n   */\r\n  exportThemeConfiguration(themeId) {\r\n    const theme = this.styles.getThemeMetadata(themeId);\r\n    if (!theme) {\r\n      throw new Error(`Theme ${themeId} not found`);\r\n    }\r\n\r\n    const customizations = this.styles.getThemeCustomization(themeId);\r\n    \r\n    return {\r\n      theme: {\r\n        ...theme,\r\n        exportedAt: new Date().toISOString(),\r\n        systemVersion: game.system.version\r\n      },\r\n      customizations,\r\n      variables: this.extractThemeVariables(themeId)\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Extract all CSS variables for a specific theme\r\n   */\r\n  extractThemeVariables(themeId) {\r\n    const theme = this.styles.getThemeMetadata(themeId);\r\n    if (!theme) {\r\n      return {};\r\n    }\r\n\r\n    const originalTheme = this.styles.currentTheme;\r\n    this.styles.applyTheme(theme.cssClass);\r\n    \r\n    const variables = this.styles.getCurrentThemeVariables();\r\n    \r\n    this.styles.applyTheme(originalTheme);\r\n    \r\n    return variables;\r\n  }\r\n\r\n  // =============================================================================\r\n  // DEBUGGING AND DEVELOPMENT UTILITIES\r\n  // =============================================================================\r\n\r\n  /**\r\n   * Generate theme development report\r\n   */\r\n  generateDevelopmentReport() {\r\n    const report = {\r\n      timestamp: new Date().toISOString(),\r\n      systemVersion: game.system.version,\r\n      currentTheme: this.styles.currentTheme,\r\n      themes: {},\r\n      performance: {},\r\n      validation: {},\r\n      variableAnalysis: {},\r\n      recommendations: []\r\n    };\r\n\r\n    // Analyze all themes\r\n    const allThemes = this.styles.getAllThemes();\r\n    allThemes.forEach(theme => {\r\n      // Theme metadata\r\n      report.themes[theme.id] = {\r\n        metadata: theme,\r\n        validation: this.styles.validateTheme(theme.id)\r\n      };\r\n\r\n      // Performance analysis\r\n      try {\r\n        report.performance[theme.id] = this.measureThemePerformance(theme.cssClass, 3);\r\n      } catch (error) {\r\n        console.warn(LOG_HEAD + `Performance analysis failed for ${theme.name}:`, error);\r\n      }\r\n\r\n      // Contrast analysis\r\n      try {\r\n        report.themes[theme.id].contrast = this.analyzeThemeContrast(theme.id);\r\n      } catch (error) {\r\n        console.warn(LOG_HEAD + `Contrast analysis failed for ${theme.name}:`, error);\r\n      }\r\n    });\r\n\r\n    // Variable usage analysis\r\n    report.variableAnalysis = this.analyzeVariableUsage();\r\n\r\n    // Generate recommendations\r\n    report.recommendations = this.generateRecommendations(report);\r\n\r\n    return report;\r\n  }\r\n\r\n  /**\r\n   * Generate recommendations based on analysis\r\n   */\r\n  generateRecommendations(report) {\r\n    const recommendations = [];\r\n\r\n    // Performance recommendations\r\n    Object.entries(report.performance).forEach(([themeId, perf]) => {\r\n      if (perf.average > 50) {\r\n        recommendations.push({\r\n          type: 'performance',\r\n          theme: themeId,\r\n          message: `Theme application is slow (${perf.average.toFixed(2)}ms average)`,\r\n          suggestion: 'Consider optimizing CSS selectors and reducing complexity'\r\n        });\r\n      }\r\n    });\r\n\r\n    // Accessibility recommendations\r\n    Object.entries(report.themes).forEach(([themeId, themeData]) => {\r\n      if (themeData.contrast && !themeData.contrast.accessibility.wcagAA) {\r\n        recommendations.push({\r\n          type: 'accessibility',\r\n          theme: themeId,\r\n          message: 'Theme fails WCAG AA contrast requirements',\r\n          suggestion: 'Increase contrast between text and background colors',\r\n          details: themeData.contrast.accessibility.issues\r\n        });\r\n      }\r\n    });\r\n\r\n    // Variable optimization recommendations\r\n    if (report.variableAnalysis.redundancy > 30) {\r\n      recommendations.push({\r\n        type: 'optimization',\r\n        theme: 'all',\r\n        message: `High variable redundancy detected (${report.variableAnalysis.redundancy}%)`,\r\n        suggestion: 'Consider consolidating similar variables across themes'\r\n      });\r\n    }\r\n\r\n    return recommendations;\r\n  }\r\n\r\n  // =============================================================================\r\n  // THEME TESTING UTILITIES\r\n  // =============================================================================\r\n\r\n  /**\r\n   * Test theme switching functionality\r\n   */\r\n  testThemeSwitching() {\r\n    const results = {\r\n      success: true,\r\n      errors: [],\r\n      switchTimes: {},\r\n      totalTime: 0\r\n    };\r\n\r\n    const allThemes = this.styles.getAllThemes();\r\n    const originalTheme = this.styles.currentTheme;\r\n    \r\n    try {\r\n      allThemes.forEach(theme => {\r\n        const startTime = performance.now();\r\n        \r\n        try {\r\n          this.styles.applyTheme(theme.cssClass);\r\n          const endTime = performance.now();\r\n          results.switchTimes[theme.id] = endTime - startTime;\r\n          results.totalTime += endTime - startTime;\r\n        } catch (error) {\r\n          results.success = false;\r\n          results.errors.push(`Failed to apply theme ${theme.name}: ${error.message}`);\r\n        }\r\n      });\r\n    } finally {\r\n      // Always restore original theme\r\n      this.styles.applyTheme(originalTheme);\r\n    }\r\n\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Test CSS variable accessibility\r\n   */\r\n  testCSSVariableAccess() {\r\n    const results = {\r\n      accessible: [],\r\n      inaccessible: [],\r\n      total: 0\r\n    };\r\n\r\n    const variables = this.styles.getCurrentThemeVariables();\r\n    \r\n    Object.keys(variables).forEach(variable => {\r\n      results.total++;\r\n      \r\n      try {\r\n        const value = this.styles.getCSSVariable(variable.replace('--', ''));\r\n        if (value && value !== '') {\r\n          results.accessible.push(variable);\r\n        } else {\r\n          results.inaccessible.push(variable);\r\n        }\r\n      } catch (error) {\r\n        results.inaccessible.push(variable);\r\n      }\r\n    });\r\n\r\n    return results;\r\n  }\r\n\r\n  // =============================================================================\r\n  // DEVELOPMENT HELPERS\r\n  // =============================================================================\r\n\r\n  /**\r\n   * Log comprehensive theme information\r\n   */\r\n  logThemeInfo(themeId) {\r\n    const theme = this.styles.getThemeMetadata(themeId);\r\n    if (!theme) {\r\n      console.error(LOG_HEAD + `Theme ${themeId} not found`);\r\n      return;\r\n    }\r\n\r\n    console.group(LOG_HEAD + `Theme Info: ${theme.name}`);\r\n    console.info('Metadata:', theme);\r\n    console.info('Validation:', this.styles.validateTheme(themeId));\r\n    console.info('Contrast Analysis:', this.analyzeThemeContrast(themeId));\r\n    console.info('Performance:', this.measureThemePerformance(theme.cssClass, 3));\r\n    console.groupEnd();\r\n  }\r\n\r\n  /**\r\n   * Create theme comparison report\r\n   */\r\n  compareThemes(themeId1, themeId2) {\r\n    const theme1 = this.styles.getThemeMetadata(themeId1);\r\n    const theme2 = this.styles.getThemeMetadata(themeId2);\r\n    \r\n    if (!theme1 || !theme2) {\r\n      throw new Error('One or both themes not found');\r\n    }\r\n\r\n    const comparison = {\r\n      themes: [theme1.name, theme2.name],\r\n      differences: {\r\n        metadata: {},\r\n        variables: {},\r\n        performance: {}\r\n      },\r\n      recommendations: []\r\n    };\r\n\r\n    // Compare metadata\r\n    const metadataKeys = ['category', 'author', 'version'];\r\n    metadataKeys.forEach(key => {\r\n      if (theme1[key] !== theme2[key]) {\r\n        comparison.differences.metadata[key] = {\r\n          [theme1.name]: theme1[key],\r\n          [theme2.name]: theme2[key]\r\n        };\r\n      }\r\n    });\r\n\r\n    // Compare performance\r\n    const perf1 = this.measureThemePerformance(theme1.cssClass, 3);\r\n    const perf2 = this.measureThemePerformance(theme2.cssClass, 3);\r\n    \r\n    comparison.differences.performance = {\r\n      [theme1.name]: perf1.average,\r\n      [theme2.name]: perf2.average,\r\n      difference: Math.abs(perf1.average - perf2.average)\r\n    };\r\n\r\n    // Generate recommendations\r\n    if (comparison.differences.performance.difference > 20) {\r\n      const slower = perf1.average > perf2.average ? theme1.name : theme2.name;\r\n      comparison.recommendations.push(`${slower} is significantly slower and could benefit from optimization`);\r\n    }\r\n\r\n    return comparison;\r\n  }\r\n}\r\n","// UI/HUD Customization System - User preference storage and runtime adjustments\n// This module provides comprehensive UI/HUD customization capabilities\n\nimport { LOG_HEAD, SYSTEM_NAME } from './constants.js';\n\n/**\n * UI Customization Manager - Handles all UI/HUD customization features\n */\nexport class UICustomization {\n  constructor(stylesManager) {\n    this.styles = stylesManager;\n    this.customizations = new Map();\n    this.presets = new Map();\n    this.activeCustomizations = new Set();\n\n    // Initialize customization system\n    this.initializeCustomizations();\n\n    Hooks.once('ready', () => this.onReady());\n    Hooks.on('renderApplication', (app, html, data) => this.onRenderApplication(app, html, data));\n  }\n\n  async onReady() {\n    console.groupCollapsed(LOG_HEAD + 'UICustomization.onReady');\n\n    // Register UI customization settings\n    await this.registerCustomizationSettings();\n\n    // Load user customizations\n    await this.loadUserCustomizations();\n\n    // Apply saved customizations\n    this.applyAllCustomizations();\n\n    console.groupEnd();\n  }\n\n  // =============================================================================\n  // CUSTOMIZATION SETTINGS REGISTRATION\n  // =============================================================================\n\n  async registerCustomizationSettings() {\n    // UI Layout preferences\n    game.settings.register(SYSTEM_NAME, 'ui-layout-preferences', {\n      scope: 'client',\n      name: 'UI Layout Preferences',\n      hint: 'Customization settings for UI layout and positioning',\n      config: false,\n      default: {\n        sheetWidth: 'auto',\n        sheetHeight: 'auto',\n        compactMode: false,\n        hideUnusedSections: false,\n        sectionOrder: 'default',\n        tabLayout: 'horizontal',\n      },\n      type: Object,\n    });\n\n    // HUD customization preferences\n    game.settings.register(SYSTEM_NAME, 'hud-customization', {\n      scope: 'client',\n      name: 'HUD Customization',\n      hint: 'Customization settings for HUD elements and positioning',\n      config: false,\n      default: {\n        hudPosition: 'default',\n        hudSize: 'medium',\n        showShortcuts: true,\n        shortcutPosition: 'left',\n        gmManagerPosition: 'top-left',\n        gmManagerSize: 'medium',\n        hideInactiveElements: false,\n      },\n      type: Object,\n    });\n\n    // Visual customization preferences\n    game.settings.register(SYSTEM_NAME, 'visual-customization', {\n      scope: 'client',\n      name: 'Visual Customization',\n      hint: 'Visual appearance customization settings',\n      config: false,\n      default: {\n        animationSpeed: 'normal',\n        shadowIntensity: 'medium',\n        borderRadius: 'default',\n        spacing: 'default',\n        fontSize: 'default',\n        iconSize: 'default',\n        transparency: 'default',\n      },\n      type: Object,\n    });\n\n    // Component visibility preferences\n    game.settings.register(SYSTEM_NAME, 'component-visibility', {\n      scope: 'client',\n      name: 'Component Visibility',\n      hint: 'Show/hide specific UI components',\n      config: false,\n      default: {\n        showPassportImages: true,\n        showItemImages: true,\n        showSkillIcons: true,\n        showAttributeLabels: true,\n        showTooltips: true,\n        showAnimations: true,\n        showShadows: true,\n        showGradients: true,\n      },\n      type: Object,\n    });\n\n    // Advanced customization settings\n    game.settings.register(SYSTEM_NAME, 'advanced-ui-settings', {\n      scope: 'client',\n      name: 'Advanced UI Settings',\n      hint: 'Advanced UI customization options',\n      config: false,\n      default: {\n        customCSS: '',\n        componentOverrides: {},\n        layoutTemplates: {},\n        colorOverrides: {},\n        fontOverrides: {},\n      },\n      type: Object,\n    });\n  }\n\n  // =============================================================================\n  // CUSTOMIZATION INITIALIZATION\n  // =============================================================================\n\n  initializeCustomizations() {\n    console.groupCollapsed(LOG_HEAD + 'UICustomization.initializeCustomizations');\n\n    // Register built-in customization presets\n    this.registerBuiltInPresets();\n\n    // Register customization categories\n    this.registerCustomizationCategories();\n\n    console.groupEnd();\n  }\n\n  registerBuiltInPresets() {\n    // Compact layout preset\n    this.presets.set('compact', {\n      name: 'Compact Layout',\n      description: 'Optimized for smaller screens and minimal space usage',\n      settings: {\n        'ui-layout-preferences': {\n          compactMode: true,\n          hideUnusedSections: true,\n          tabLayout: 'vertical',\n        },\n        'visual-customization': {\n          spacing: 'tight',\n          fontSize: 'small',\n          iconSize: 'small',\n        },\n        'component-visibility': {\n          showPassportImages: false,\n          showShadows: false,\n          showGradients: false,\n        },\n      },\n    });\n\n    // Accessibility preset\n    this.presets.set('accessibility', {\n      name: 'Accessibility Enhanced',\n      description: 'Optimized for accessibility and screen readers',\n      settings: {\n        'visual-customization': {\n          fontSize: 'large',\n          spacing: 'loose',\n          shadowIntensity: 'none',\n          borderRadius: 'minimal',\n        },\n        'component-visibility': {\n          showTooltips: true,\n          showAnimations: false,\n          showShadows: false,\n        },\n      },\n    });\n\n    // Performance preset\n    this.presets.set('performance', {\n      name: 'Performance Optimized',\n      description: 'Reduced visual effects for better performance',\n      settings: {\n        'visual-customization': {\n          animationSpeed: 'fast',\n          shadowIntensity: 'light',\n          transparency: 'minimal',\n        },\n        'component-visibility': {\n          showAnimations: false,\n          showShadows: false,\n          showGradients: false,\n        },\n      },\n    });\n\n    // Immersive preset\n    this.presets.set('immersive', {\n      name: 'Immersive Experience',\n      description: 'Enhanced visual effects for maximum immersion',\n      settings: {\n        'visual-customization': {\n          animationSpeed: 'slow',\n          shadowIntensity: 'strong',\n          transparency: 'enhanced',\n        },\n        'component-visibility': {\n          showAnimations: true,\n          showShadows: true,\n          showGradients: true,\n        },\n      },\n    });\n  }\n\n  registerCustomizationCategories() {\n    this.customizations.set('layout', {\n      name: 'Layout & Positioning',\n      description: 'Customize sheet layouts, sizes, and positioning',\n      options: [\n        {\n          key: 'sheetWidth',\n          name: 'Sheet Width',\n          type: 'select',\n          values: ['auto', 'compact', 'wide', 'full'],\n        },\n        {\n          key: 'sheetHeight',\n          name: 'Sheet Height',\n          type: 'select',\n          values: ['auto', 'compact', 'tall', 'full'],\n        },\n        { key: 'compactMode', name: 'Compact Mode', type: 'boolean' },\n        {\n          key: 'tabLayout',\n          name: 'Tab Layout',\n          type: 'select',\n          values: ['horizontal', 'vertical'],\n        },\n      ],\n    });\n\n    this.customizations.set('visual', {\n      name: 'Visual Appearance',\n      description: 'Customize colors, fonts, and visual effects',\n      options: [\n        {\n          key: 'fontSize',\n          name: 'Font Size',\n          type: 'select',\n          values: ['small', 'default', 'large', 'xl'],\n        },\n        {\n          key: 'iconSize',\n          name: 'Icon Size',\n          type: 'select',\n          values: ['small', 'default', 'large'],\n        },\n        {\n          key: 'spacing',\n          name: 'Element Spacing',\n          type: 'select',\n          values: ['tight', 'default', 'loose'],\n        },\n        {\n          key: 'borderRadius',\n          name: 'Border Radius',\n          type: 'select',\n          values: ['none', 'minimal', 'default', 'rounded'],\n        },\n        {\n          key: 'shadowIntensity',\n          name: 'Shadow Intensity',\n          type: 'select',\n          values: ['none', 'light', 'medium', 'strong'],\n        },\n        {\n          key: 'animationSpeed',\n          name: 'Animation Speed',\n          type: 'select',\n          values: ['none', 'fast', 'normal', 'slow'],\n        },\n      ],\n    });\n\n    this.customizations.set('components', {\n      name: 'Component Visibility',\n      description: 'Show or hide specific UI components',\n      options: [\n        { key: 'showPassportImages', name: 'Show Passport Images', type: 'boolean' },\n        { key: 'showItemImages', name: 'Show Item Images', type: 'boolean' },\n        { key: 'showSkillIcons', name: 'Show Skill Icons', type: 'boolean' },\n        { key: 'showTooltips', name: 'Show Tooltips', type: 'boolean' },\n        { key: 'showAnimations', name: 'Show Animations', type: 'boolean' },\n        { key: 'showShadows', name: 'Show Shadows', type: 'boolean' },\n      ],\n    });\n\n    this.customizations.set('hud', {\n      name: 'HUD Elements',\n      description: 'Customize HUD positioning and behavior',\n      options: [\n        { key: 'hudSize', name: 'HUD Size', type: 'select', values: ['small', 'medium', 'large'] },\n        {\n          key: 'shortcutPosition',\n          name: 'Shortcut Position',\n          type: 'select',\n          values: ['left', 'right', 'top', 'bottom'],\n        },\n        {\n          key: 'gmManagerPosition',\n          name: 'GM Manager Position',\n          type: 'select',\n          values: ['top-left', 'top-right', 'bottom-left', 'bottom-right'],\n        },\n        { key: 'hideInactiveElements', name: 'Hide Inactive Elements', type: 'boolean' },\n      ],\n    });\n  }\n\n  // =============================================================================\n  // CUSTOMIZATION APPLICATION\n  // =============================================================================\n\n  async loadUserCustomizations() {\n    const layoutPrefs = game.settings.get(SYSTEM_NAME, 'ui-layout-preferences');\n    const hudCustomization = game.settings.get(SYSTEM_NAME, 'hud-customization');\n    const visualCustomization = game.settings.get(SYSTEM_NAME, 'visual-customization');\n    const componentVisibility = game.settings.get(SYSTEM_NAME, 'component-visibility');\n    const advancedSettings = game.settings.get(SYSTEM_NAME, 'advanced-ui-settings');\n\n    // Store loaded customizations\n    this.userCustomizations = {\n      layout: layoutPrefs,\n      hud: hudCustomization,\n      visual: visualCustomization,\n      components: componentVisibility,\n      advanced: advancedSettings,\n    };\n  }\n\n  applyAllCustomizations() {\n    console.groupCollapsed(LOG_HEAD + 'UICustomization.applyAllCustomizations');\n\n    // Apply each customization category\n    this.applyLayoutCustomizations();\n    this.applyVisualCustomizations();\n    this.applyComponentVisibility();\n    this.applyHUDCustomizations();\n    this.applyAdvancedCustomizations();\n\n    // Apply background rotation after other visual settings\n    this.applyBackgroundRotation();\n\n    console.groupEnd();\n  }\n\n  /**\n   * Background rotation and fallback\n   * Priority:\n   * 1) files under systems/anarchy/img/backgrounds/\n   * 2) fallback file systems/anarchy/img/2025.10_Bckgrnd.img.01.png if present\n   * 3) transparent 1x1 png data URI\n   */\n  async applyBackgroundRotation() {\n    try {\n      const root = document.documentElement;\n\n      // Candidate list\n      const base = '/systems/anarchy/img';\n      const dir = `${base}/backgrounds/`;\n\n      // Probe a list of common names plus any numbered backgrounds we know about\n      const candidates = ['2025.10_Bckgrnd.img.01.png', '2025.10_Bckgrnd.img.02.png'];\n\n      // Try to list a few expected files in backgrounds/. We can't read the directory,\n      // but we can probe a small fixed set of names to avoid 404 spam.\n      const backgroundNames = ['01.webp', '02.webp', '03.webp', '01.png', '02.png', '03.png'];\n\n      const probeUrls = backgroundNames.map((n) => `${dir}${n}`);\n\n      const existing = await this.#probeImages([\n        ...probeUrls,\n        ...candidates.map((n) => `${base}/${n}`),\n      ]);\n\n      let chosen =\n        existing.length > 0 ? existing[Math.floor(Math.random() * existing.length)] : undefined;\n      if (!chosen) {\n        // Final blank fallback: 1x1 transparent PNG\n        chosen =\n          'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=';\n      }\n\n      // Set CSS var used by themes\n      const cssValue = `repeat center/50% url(\"${chosen}\")`;\n      root.style.setProperty('--anarchy-background', cssValue);\n\n      // Expose for console force change support\n      globalThis.__anarchyBackgroundCandidates = existing;\n      console.debug('[Anarchy] Background applied:', chosen);\n    } catch (e) {\n      console.warn('[Anarchy] Failed to apply background rotation', e);\n    }\n  }\n\n  async #probeImages(urls) {\n    const checks = await Promise.allSettled(\n      urls.map((u) => fetch(u, { method: 'HEAD', cache: 'no-store' })),\n    );\n    const ok = [];\n    checks.forEach((r, idx) => {\n      if (r.status === 'fulfilled' && r.value.ok) ok.push(urls[idx]);\n    });\n    return ok;\n  }\n\n  applyLayoutCustomizations() {\n    const layout = this.userCustomizations.layout;\n    const root = document.documentElement;\n\n    // Sheet sizing\n    if (layout.sheetWidth !== 'auto') {\n      const widthMap = {\n        compact: '600px',\n        wide: '900px',\n        full: '100vw',\n      };\n      root.style.setProperty('--sheet-width', widthMap[layout.sheetWidth]);\n    }\n\n    if (layout.sheetHeight !== 'auto') {\n      const heightMap = {\n        compact: '500px',\n        tall: '800px',\n        full: '100vh',\n      };\n      root.style.setProperty('--sheet-height', heightMap[layout.sheetHeight]);\n    }\n\n    // Compact mode\n    if (layout.compactMode) {\n      document.body.classList.add('ui-compact-mode');\n    } else {\n      document.body.classList.remove('ui-compact-mode');\n    }\n\n    // Tab layout\n    if (layout.tabLayout === 'vertical') {\n      document.body.classList.add('ui-vertical-tabs');\n    } else {\n      document.body.classList.remove('ui-vertical-tabs');\n    }\n\n    console.info(LOG_HEAD + 'Applied layout customizations:', layout);\n  }\n\n  applyVisualCustomizations() {\n    const visual = this.userCustomizations.visual;\n    const root = document.documentElement;\n\n    // Font size scaling\n    const fontSizeMap = {\n      small: '0.85',\n      default: '1',\n      large: '1.15',\n      xl: '1.3',\n    };\n    if (visual.fontSize !== 'default') {\n      root.style.setProperty('--font-scale', fontSizeMap[visual.fontSize]);\n    }\n\n    // Icon size scaling\n    const iconSizeMap = {\n      small: '0.8',\n      default: '1',\n      large: '1.2',\n    };\n    if (visual.iconSize !== 'default') {\n      root.style.setProperty('--icon-scale', iconSizeMap[visual.iconSize]);\n    }\n\n    // Spacing adjustments\n    const spacingMap = {\n      tight: '0.75',\n      default: '1',\n      loose: '1.25',\n    };\n    if (visual.spacing !== 'default') {\n      root.style.setProperty('--spacing-scale', spacingMap[visual.spacing]);\n    }\n\n    // Border radius adjustments\n    const radiusMap = {\n      none: '0px',\n      minimal: '2px',\n      default: '6px',\n      rounded: '12px',\n    };\n    if (visual.borderRadius !== 'default') {\n      root.style.setProperty('--border-radius-override', radiusMap[visual.borderRadius]);\n    }\n\n    // Shadow intensity\n    const shadowMap = {\n      none: '0',\n      light: '0.5',\n      medium: '1',\n      strong: '1.5',\n    };\n    if (visual.shadowIntensity !== 'medium') {\n      root.style.setProperty('--shadow-intensity', shadowMap[visual.shadowIntensity]);\n    }\n\n    // Animation speed\n    const animationMap = {\n      none: '0ms',\n      fast: '100ms',\n      normal: '200ms',\n      slow: '400ms',\n    };\n    if (visual.animationSpeed !== 'normal') {\n      root.style.setProperty('--animation-duration', animationMap[visual.animationSpeed]);\n    }\n\n    console.info(LOG_HEAD + 'Applied visual customizations:', visual);\n  }\n\n  applyComponentVisibility() {\n    const components = this.userCustomizations.components;\n    const root = document.documentElement;\n\n    // Component visibility classes\n    Object.entries(components).forEach(([key, visible]) => {\n      const className = `hide-${key\n        .replace(/([A-Z])/g, '-$1')\n        .toLowerCase()\n        .replace('show-', '')}`;\n\n      if (!visible) {\n        document.body.classList.add(className);\n      } else {\n        document.body.classList.remove(className);\n      }\n    });\n\n    console.info(LOG_HEAD + 'Applied component visibility:', components);\n  }\n\n  applyHUDCustomizations() {\n    const hud = this.userCustomizations.hud;\n\n    // HUD size scaling\n    const hudSizeMap = {\n      small: '0.8',\n      medium: '1',\n      large: '1.2',\n    };\n    if (hud.hudSize !== 'medium') {\n      document.documentElement.style.setProperty('--hud-scale', hudSizeMap[hud.hudSize]);\n    }\n\n    // GM Manager positioning\n    const gmManager = document.getElementById('gm-manager');\n    if (gmManager && hud.gmManagerPosition !== 'top-left') {\n      gmManager.classList.remove(\n        'position-top-left',\n        'position-top-right',\n        'position-bottom-left',\n        'position-bottom-right',\n      );\n      gmManager.classList.add(`position-${hud.gmManagerPosition}`);\n    }\n\n    // Shortcut positioning\n    const shortcuts = document.querySelector('.anarchy-shortcuts');\n    if (shortcuts && hud.shortcutPosition !== 'left') {\n      shortcuts.classList.remove(\n        'position-left',\n        'position-right',\n        'position-top',\n        'position-bottom',\n      );\n      shortcuts.classList.add(`position-${hud.shortcutPosition}`);\n    }\n\n    console.info(LOG_HEAD + 'Applied HUD customizations:', hud);\n  }\n\n  applyAdvancedCustomizations() {\n    const advanced = this.userCustomizations.advanced;\n    const root = document.documentElement;\n\n    // Custom CSS injection\n    if (advanced.customCSS) {\n      this.injectCustomCSS(advanced.customCSS);\n    }\n\n    // Component overrides\n    if (advanced.componentOverrides) {\n      Object.entries(advanced.componentOverrides).forEach(([component, styles]) => {\n        Object.entries(styles).forEach(([property, value]) => {\n          root.style.setProperty(`--${component}-${property}`, value);\n        });\n      });\n    }\n\n    // Color overrides\n    if (advanced.colorOverrides) {\n      Object.entries(advanced.colorOverrides).forEach(([colorVar, value]) => {\n        root.style.setProperty(`--${colorVar}`, value);\n      });\n    }\n\n    console.info(LOG_HEAD + 'Applied advanced customizations:', advanced);\n  }\n\n  // =============================================================================\n  // CUSTOMIZATION METHODS\n  // =============================================================================\n\n  setCustomization(category, key, value) {\n    const settingKey = this.getCategorySettingKey(category);\n    const currentSettings = game.settings.get(SYSTEM_NAME, settingKey);\n\n    currentSettings[key] = value;\n    game.settings.set(SYSTEM_NAME, settingKey, currentSettings);\n\n    // Update local cache\n    this.userCustomizations[category][key] = value;\n\n    // Apply immediately\n    this.applySpecificCustomization(category, key, value);\n\n    console.info(LOG_HEAD + `Customization set: ${category}.${key} = ${value}`);\n  }\n\n  getCustomization(category, key) {\n    return this.userCustomizations[category]?.[key];\n  }\n\n  applySpecificCustomization(category, key, value) {\n    const root = document.documentElement;\n\n    switch (category) {\n      case 'visual':\n        this.applyVisualCustomization(key, value);\n        break;\n      case 'layout':\n        this.applyLayoutCustomization(key, value);\n        break;\n      case 'components':\n        this.applyComponentCustomization(key, value);\n        break;\n      case 'hud':\n        this.applyHUDCustomization(key, value);\n        break;\n    }\n  }\n\n  applyVisualCustomization(key, value) {\n    const root = document.documentElement;\n\n    switch (key) {\n      case 'fontSize':\n        const fontScale = { small: '0.85', default: '1', large: '1.15', xl: '1.3' }[value];\n        root.style.setProperty('--font-scale', fontScale);\n        break;\n      case 'iconSize':\n        const iconScale = { small: '0.8', default: '1', large: '1.2' }[value];\n        root.style.setProperty('--icon-scale', iconScale);\n        break;\n      case 'spacing':\n        const spacingScale = { tight: '0.75', default: '1', loose: '1.25' }[value];\n        root.style.setProperty('--spacing-scale', spacingScale);\n        break;\n      case 'animationSpeed':\n        const duration = { none: '0ms', fast: '100ms', normal: '200ms', slow: '400ms' }[value];\n        root.style.setProperty('--animation-duration', duration);\n        break;\n    }\n  }\n\n  applyLayoutCustomization(key, value) {\n    switch (key) {\n      case 'compactMode':\n        if (value) {\n          document.body.classList.add('ui-compact-mode');\n        } else {\n          document.body.classList.remove('ui-compact-mode');\n        }\n        break;\n      case 'tabLayout':\n        if (value === 'vertical') {\n          document.body.classList.add('ui-vertical-tabs');\n        } else {\n          document.body.classList.remove('ui-vertical-tabs');\n        }\n        break;\n    }\n  }\n\n  applyComponentCustomization(key, value) {\n    const className = `hide-${key\n      .replace(/([A-Z])/g, '-$1')\n      .toLowerCase()\n      .replace('show-', '')}`;\n\n    if (!value) {\n      document.body.classList.add(className);\n    } else {\n      document.body.classList.remove(className);\n    }\n  }\n\n  applyHUDCustomization(key, value) {\n    switch (key) {\n      case 'gmManagerPosition':\n        const gmManager = document.getElementById('gm-manager');\n        if (gmManager) {\n          gmManager.classList.remove(\n            'position-top-left',\n            'position-top-right',\n            'position-bottom-left',\n            'position-bottom-right',\n          );\n          gmManager.classList.add(`position-${value}`);\n        }\n        break;\n      case 'hudSize':\n        const hudScale = { small: '0.8', medium: '1', large: '1.2' }[value];\n        document.documentElement.style.setProperty('--hud-scale', hudScale);\n        break;\n    }\n  }\n\n  // =============================================================================\n  // PRESET MANAGEMENT\n  // =============================================================================\n\n  applyPreset(presetId) {\n    const preset = this.presets.get(presetId);\n    if (!preset) {\n      throw new Error(`Preset ${presetId} not found`);\n    }\n\n    console.groupCollapsed(LOG_HEAD + `Applying preset: ${preset.name}`);\n\n    // Apply all preset settings\n    Object.entries(preset.settings).forEach(([settingKey, settingValue]) => {\n      game.settings.set(SYSTEM_NAME, settingKey, settingValue);\n\n      // Update local cache\n      const category = this.getSettingCategory(settingKey);\n      if (category) {\n        this.userCustomizations[category] = {\n          ...this.userCustomizations[category],\n          ...settingValue,\n        };\n      }\n    });\n\n    // Reapply all customizations\n    this.applyAllCustomizations();\n\n    ui.notifications.info(`Applied preset: ${preset.name}`);\n    console.groupEnd();\n  }\n\n  getAvailablePresets() {\n    return Array.from(this.presets.entries()).map(([id, preset]) => ({\n      id,\n      ...preset,\n    }));\n  }\n\n  // =============================================================================\n  // UTILITY METHODS\n  // =============================================================================\n\n  getCategorySettingKey(category) {\n    const categoryMap = {\n      layout: 'ui-layout-preferences',\n      hud: 'hud-customization',\n      visual: 'visual-customization',\n      components: 'component-visibility',\n      advanced: 'advanced-ui-settings',\n    };\n    return categoryMap[category];\n  }\n\n  getSettingCategory(settingKey) {\n    const settingMap = {\n      'ui-layout-preferences': 'layout',\n      'hud-customization': 'hud',\n      'visual-customization': 'visual',\n      'component-visibility': 'components',\n      'advanced-ui-settings': 'advanced',\n    };\n    return settingMap[settingKey];\n  }\n\n  injectCustomCSS(css) {\n    // Remove existing custom CSS\n    const existingStyle = document.getElementById('anarchy-custom-css');\n    if (existingStyle) {\n      existingStyle.remove();\n    }\n\n    // Inject new custom CSS\n    if (css.trim()) {\n      const style = document.createElement('style');\n      style.id = 'anarchy-custom-css';\n      style.textContent = css;\n      document.head.appendChild(style);\n    }\n  }\n\n  onRenderApplication(app, html, data) {\n    // Apply customizations to newly rendered applications\n    if (app.constructor.name.includes('Sheet') || app.constructor.name.includes('Dialog')) {\n      this.applyCustomizationsToElement(html[0]);\n    }\n  }\n\n  applyCustomizationsToElement(element) {\n    // Apply current customizations to a specific element\n    const visual = this.userCustomizations.visual;\n\n    if (visual.fontSize !== 'default') {\n      element.style.setProperty('--local-font-scale', `var(--font-scale, 1)`);\n    }\n\n    if (visual.spacing !== 'default') {\n      element.style.setProperty('--local-spacing-scale', `var(--spacing-scale, 1)`);\n    }\n  }\n\n  // =============================================================================\n  // EXPORT/IMPORT CUSTOMIZATIONS\n  // =============================================================================\n\n  exportCustomizations() {\n    return {\n      customizations: this.userCustomizations,\n      presets: Array.from(this.presets.entries()),\n      metadata: {\n        exportedAt: new Date().toISOString(),\n        systemVersion: game.system.version,\n        foundryVersion: game.version,\n      },\n    };\n  }\n\n  importCustomizations(data) {\n    if (!data.customizations) {\n      throw new Error('Invalid customization data');\n    }\n\n    // Import each category\n    Object.entries(data.customizations).forEach(([category, settings]) => {\n      const settingKey = this.getCategorySettingKey(category);\n      if (settingKey) {\n        game.settings.set(SYSTEM_NAME, settingKey, settings);\n      }\n    });\n\n    // Reload and apply\n    this.loadUserCustomizations();\n    this.applyAllCustomizations();\n\n    ui.notifications.info('UI customizations imported successfully.');\n  }\n\n  resetAllCustomizations() {\n    // Reset all customization settings to defaults\n    const settingKeys = [\n      'ui-layout-preferences',\n      'hud-customization',\n      'visual-customization',\n      'component-visibility',\n      'advanced-ui-settings',\n    ];\n\n    settingKeys.forEach((key) => {\n      const setting = game.settings.settings.get(`${SYSTEM_NAME}.${key}`);\n      if (setting) {\n        game.settings.set(SYSTEM_NAME, key, setting.default);\n      }\n    });\n\n    // Remove custom CSS\n    this.injectCustomCSS('');\n\n    // Remove customization classes\n    document.body.classList.remove('ui-compact-mode', 'ui-vertical-tabs');\n\n    // Reset CSS variables\n    const root = document.documentElement;\n    const customProperties = [\n      '--font-scale',\n      '--icon-scale',\n      '--spacing-scale',\n      '--border-radius-override',\n      '--shadow-intensity',\n      '--animation-duration',\n    ];\n    customProperties.forEach((prop) => root.style.removeProperty(prop));\n\n    // Reload and apply defaults\n    this.loadUserCustomizations();\n    this.applyAllCustomizations();\n\n    ui.notifications.info('All UI customizations reset to defaults.');\n  }\n\n  // =============================================================================\n  // DEBUGGING AND ANALYSIS\n  // =============================================================================\n\n  debugCustomizations() {\n    console.group(LOG_HEAD + 'UI Customization Debug');\n    console.info('Current Customizations:', this.userCustomizations);\n    console.info('Available Presets:', this.getAvailablePresets());\n    console.info('Active CSS Variables:', this.getActiveCustomizationVariables());\n    console.info('Applied Classes:', this.getAppliedCustomizationClasses());\n    console.groupEnd();\n\n    return {\n      customizations: this.userCustomizations,\n      presets: this.getAvailablePresets(),\n      cssVariables: this.getActiveCustomizationVariables(),\n      appliedClasses: this.getAppliedCustomizationClasses(),\n    };\n  }\n\n  getActiveCustomizationVariables() {\n    const root = getComputedStyle(document.documentElement);\n    const customizationVars = {};\n\n    const varNames = [\n      '--font-scale',\n      '--icon-scale',\n      '--spacing-scale',\n      '--border-radius-override',\n      '--shadow-intensity',\n      '--animation-duration',\n      '--hud-scale',\n    ];\n\n    varNames.forEach((varName) => {\n      const value = root.getPropertyValue(varName);\n      if (value) {\n        customizationVars[varName] = value.trim();\n      }\n    });\n\n    return customizationVars;\n  }\n\n  getAppliedCustomizationClasses() {\n    return Array.from(document.body.classList).filter(\n      (cls) => cls.startsWith('ui-') || cls.startsWith('hide-') || cls.startsWith('position-'),\n    );\n  }\n}\n","// UI Customization Dialog - User interface for customizing UI/HUD elements\r\n// This module provides a user-friendly interface for UI customization\r\n\r\nimport { LOG_HEAD, SYSTEM_NAME, TEMPLATES_PATH } from './constants.js';\r\n\r\n/**\r\n * UI Customization Dialog - Provides user interface for customization\r\n */\r\nexport class UICustomizationDialog extends Dialog {\r\n  constructor(uiCustomization, options = {}) {\r\n    const dialogData = {\r\n      title: 'UI/HUD Customization',\r\n      content: '',\r\n      buttons: {\r\n        apply: {\r\n          label: 'Apply',\r\n          callback: (html) => this.onApply(html)\r\n        },\r\n        reset: {\r\n          label: 'Reset All',\r\n          callback: () => this.onReset()\r\n        },\r\n        export: {\r\n          label: 'Export',\r\n          callback: () => this.onExport()\r\n        },\r\n        import: {\r\n          label: 'Import',\r\n          callback: () => this.onImport()\r\n        },\r\n        close: {\r\n          label: 'Close'\r\n        }\r\n      },\r\n      default: 'apply'\r\n    };\r\n\r\n    const dialogOptions = {\r\n      classes: ['anarchy-dialog', 'ui-customization-dialog'],\r\n      width: 600,\r\n      height: 'auto',\r\n      resizable: true,\r\n      ...options\r\n    };\r\n\r\n    super(dialogData, dialogOptions);\r\n    \r\n    this.uiCustomization = uiCustomization;\r\n    this.currentSettings = {};\r\n  }\r\n\r\n  async getData() {\r\n    // Load current customization settings\r\n    await this.uiCustomization.loadUserCustomizations();\r\n    this.currentSettings = this.uiCustomization.userCustomizations;\r\n    \r\n    return {\r\n      customizations: this.uiCustomization.customizations,\r\n      presets: this.uiCustomization.getAvailablePresets(),\r\n      currentSettings: this.currentSettings,\r\n      categories: Array.from(this.uiCustomization.customizations.entries())\r\n    };\r\n  }\r\n\r\n  async _renderInner(data) {\r\n    const template = `\r\n      <div class=\"ui-customization-content\">\r\n        <div class=\"customization-tabs\">\r\n          <nav class=\"tab-navigation\">\r\n            <button class=\"tab-button active\" data-tab=\"presets\">Presets</button>\r\n            <button class=\"tab-button\" data-tab=\"layout\">Layout</button>\r\n            <button class=\"tab-button\" data-tab=\"visual\">Visual</button>\r\n            <button class=\"tab-button\" data-tab=\"components\">Components</button>\r\n            <button class=\"tab-button\" data-tab=\"hud\">HUD</button>\r\n            <button class=\"tab-button\" data-tab=\"advanced\">Advanced</button>\r\n          </nav>\r\n          \r\n          <div class=\"tab-content\">\r\n            <!-- Presets Tab -->\r\n            <div class=\"tab-panel active\" data-tab=\"presets\">\r\n              <h3>Quick Presets</h3>\r\n              <p>Apply pre-configured customization sets for common use cases.</p>\r\n              <div class=\"preset-grid\">\r\n                {{#each presets}}\r\n                <div class=\"preset-card\" data-preset=\"{{id}}\">\r\n                  <h4>{{name}}</h4>\r\n                  <p>{{description}}</p>\r\n                  <button class=\"apply-preset-btn\" data-preset=\"{{id}}\">Apply</button>\r\n                </div>\r\n                {{/each}}\r\n              </div>\r\n            </div>\r\n            \r\n            <!-- Layout Tab -->\r\n            <div class=\"tab-panel\" data-tab=\"layout\">\r\n              <h3>Layout & Positioning</h3>\r\n              <div class=\"customization-grid\">\r\n                <div class=\"setting-group\">\r\n                  <label>Sheet Width</label>\r\n                  <select name=\"layout.sheetWidth\">\r\n                    <option value=\"auto\">Auto</option>\r\n                    <option value=\"compact\">Compact</option>\r\n                    <option value=\"wide\">Wide</option>\r\n                    <option value=\"full\">Full Width</option>\r\n                  </select>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>Sheet Height</label>\r\n                  <select name=\"layout.sheetHeight\">\r\n                    <option value=\"auto\">Auto</option>\r\n                    <option value=\"compact\">Compact</option>\r\n                    <option value=\"tall\">Tall</option>\r\n                    <option value=\"full\">Full Height</option>\r\n                  </select>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>\r\n                    <input type=\"checkbox\" name=\"layout.compactMode\"> Compact Mode\r\n                  </label>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>Tab Layout</label>\r\n                  <select name=\"layout.tabLayout\">\r\n                    <option value=\"horizontal\">Horizontal</option>\r\n                    <option value=\"vertical\">Vertical</option>\r\n                  </select>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            \r\n            <!-- Visual Tab -->\r\n            <div class=\"tab-panel\" data-tab=\"visual\">\r\n              <h3>Visual Appearance</h3>\r\n              <div class=\"customization-grid\">\r\n                <div class=\"setting-group\">\r\n                  <label>Font Size</label>\r\n                  <select name=\"visual.fontSize\">\r\n                    <option value=\"small\">Small</option>\r\n                    <option value=\"default\">Default</option>\r\n                    <option value=\"large\">Large</option>\r\n                    <option value=\"xl\">Extra Large</option>\r\n                  </select>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>Icon Size</label>\r\n                  <select name=\"visual.iconSize\">\r\n                    <option value=\"small\">Small</option>\r\n                    <option value=\"default\">Default</option>\r\n                    <option value=\"large\">Large</option>\r\n                  </select>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>Element Spacing</label>\r\n                  <select name=\"visual.spacing\">\r\n                    <option value=\"tight\">Tight</option>\r\n                    <option value=\"default\">Default</option>\r\n                    <option value=\"loose\">Loose</option>\r\n                  </select>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>Animation Speed</label>\r\n                  <select name=\"visual.animationSpeed\">\r\n                    <option value=\"none\">None</option>\r\n                    <option value=\"fast\">Fast</option>\r\n                    <option value=\"normal\">Normal</option>\r\n                    <option value=\"slow\">Slow</option>\r\n                  </select>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>Shadow Intensity</label>\r\n                  <select name=\"visual.shadowIntensity\">\r\n                    <option value=\"none\">None</option>\r\n                    <option value=\"light\">Light</option>\r\n                    <option value=\"medium\">Medium</option>\r\n                    <option value=\"strong\">Strong</option>\r\n                  </select>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            \r\n            <!-- Components Tab -->\r\n            <div class=\"tab-panel\" data-tab=\"components\">\r\n              <h3>Component Visibility</h3>\r\n              <div class=\"customization-grid\">\r\n                <div class=\"setting-group\">\r\n                  <label>\r\n                    <input type=\"checkbox\" name=\"components.showPassportImages\"> Show Passport Images\r\n                  </label>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>\r\n                    <input type=\"checkbox\" name=\"components.showItemImages\"> Show Item Images\r\n                  </label>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>\r\n                    <input type=\"checkbox\" name=\"components.showSkillIcons\"> Show Skill Icons\r\n                  </label>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>\r\n                    <input type=\"checkbox\" name=\"components.showTooltips\"> Show Tooltips\r\n                  </label>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>\r\n                    <input type=\"checkbox\" name=\"components.showAnimations\"> Show Animations\r\n                  </label>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>\r\n                    <input type=\"checkbox\" name=\"components.showShadows\"> Show Shadows\r\n                  </label>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            \r\n            <!-- HUD Tab -->\r\n            <div class=\"tab-panel\" data-tab=\"hud\">\r\n              <h3>HUD Elements</h3>\r\n              <div class=\"customization-grid\">\r\n                <div class=\"setting-group\">\r\n                  <label>HUD Size</label>\r\n                  <select name=\"hud.hudSize\">\r\n                    <option value=\"small\">Small</option>\r\n                    <option value=\"medium\">Medium</option>\r\n                    <option value=\"large\">Large</option>\r\n                  </select>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>GM Manager Position</label>\r\n                  <select name=\"hud.gmManagerPosition\">\r\n                    <option value=\"top-left\">Top Left</option>\r\n                    <option value=\"top-right\">Top Right</option>\r\n                    <option value=\"bottom-left\">Bottom Left</option>\r\n                    <option value=\"bottom-right\">Bottom Right</option>\r\n                  </select>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>Shortcut Position</label>\r\n                  <select name=\"hud.shortcutPosition\">\r\n                    <option value=\"left\">Left</option>\r\n                    <option value=\"right\">Right</option>\r\n                    <option value=\"top\">Top</option>\r\n                    <option value=\"bottom\">Bottom</option>\r\n                  </select>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <label>\r\n                    <input type=\"checkbox\" name=\"hud.hideInactiveElements\"> Hide Inactive Elements\r\n                  </label>\r\n                </div>\r\n              </div>\r\n            </div>\r\n            \r\n            <!-- Advanced Tab -->\r\n            <div class=\"tab-panel\" data-tab=\"advanced\">\r\n              <h3>Advanced Customization</h3>\r\n              <div class=\"customization-grid\">\r\n                <div class=\"setting-group full-width\">\r\n                  <label>Custom CSS</label>\r\n                  <textarea name=\"advanced.customCSS\" rows=\"10\" placeholder=\"Enter custom CSS rules...\"></textarea>\r\n                  <small>Advanced users can add custom CSS rules here. Use with caution.</small>\r\n                </div>\r\n                <div class=\"setting-group\">\r\n                  <button type=\"button\" class=\"validate-css-btn\">Validate CSS</button>\r\n                  <button type=\"button\" class=\"clear-css-btn\">Clear CSS</button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n        \r\n        <div class=\"customization-preview\">\r\n          <h4>Live Preview</h4>\r\n          <div class=\"preview-area\">\r\n            <div class=\"preview-sheet\">\r\n              <div class=\"preview-header\">\r\n                <div class=\"preview-passport\">\r\n                  <img src=\"systems/anarchy/img/sample-character.webp\" alt=\"Preview\">\r\n                </div>\r\n                <div class=\"preview-info\">\r\n                  <h3>Sample Character</h3>\r\n                  <div class=\"preview-attributes\">\r\n                    <div class=\"attribute-box\">\r\n                      <span class=\"attribute-label\">AGI</span>\r\n                      <span class=\"attribute-value\">4</span>\r\n                    </div>\r\n                    <div class=\"attribute-box\">\r\n                      <span class=\"attribute-label\">STR</span>\r\n                      <span class=\"attribute-value\">3</span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n              <div class=\"preview-content\">\r\n                <div class=\"preview-section\">\r\n                  <h4>Skills</h4>\r\n                  <div class=\"preview-item\">\r\n                    <img src=\"systems/anarchy/icons/skills/athletics.svg\" alt=\"Athletics\">\r\n                    <span>Athletics</span>\r\n                    <span class=\"skill-rating\">6</span>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n    \r\n    return template;\r\n  }\r\n\r\n  activateListeners(html) {\r\n    super.activateListeners(html);\r\n    \r\n    // Tab navigation\r\n    html.find('.tab-button').click(event => {\r\n      const tabId = $(event.currentTarget).data('tab');\r\n      this.switchTab(html, tabId);\r\n    });\r\n    \r\n    // Preset application\r\n    html.find('.apply-preset-btn').click(event => {\r\n      const presetId = $(event.currentTarget).data('preset');\r\n      this.applyPreset(presetId);\r\n    });\r\n    \r\n    // Live preview updates\r\n    html.find('select, input[type=\"checkbox\"], textarea').change(event => {\r\n      this.updateLivePreview(html);\r\n    });\r\n    \r\n    // CSS validation\r\n    html.find('.validate-css-btn').click(() => {\r\n      this.validateCustomCSS(html);\r\n    });\r\n    \r\n    // Clear CSS\r\n    html.find('.clear-css-btn').click(() => {\r\n      html.find('textarea[name=\"advanced.customCSS\"]').val('');\r\n      this.updateLivePreview(html);\r\n    });\r\n  }\r\n\r\n  switchTab(html, tabId) {\r\n    // Update tab buttons\r\n    html.find('.tab-button').removeClass('active');\r\n    html.find(`.tab-button[data-tab=\"${tabId}\"]`).addClass('active');\r\n    \r\n    // Update tab panels\r\n    html.find('.tab-panel').removeClass('active');\r\n    html.find(`.tab-panel[data-tab=\"${tabId}\"]`).addClass('active');\r\n  }\r\n\r\n  updateLivePreview(html) {\r\n    // Collect current form values\r\n    const formData = new FormData(html.find('form')[0]);\r\n    const settings = {};\r\n    \r\n    for (let [key, value] of formData.entries()) {\r\n      const [category, setting] = key.split('.');\r\n      if (!settings[category]) settings[category] = {};\r\n      \r\n      // Handle different input types\r\n      if (html.find(`input[name=\"${key}\"]`).attr('type') === 'checkbox') {\r\n        settings[category][setting] = html.find(`input[name=\"${key}\"]`).is(':checked');\r\n      } else {\r\n        settings[category][setting] = value;\r\n      }\r\n    }\r\n    \r\n    // Apply to preview area\r\n    this.applyPreviewSettings(html, settings);\r\n  }\r\n\r\n  applyPreviewSettings(html, settings) {\r\n    const previewArea = html.find('.preview-area');\r\n    \r\n    // Apply font scaling\r\n    if (settings.visual?.fontSize) {\r\n      const fontScale = { small: '0.85', default: '1', large: '1.15', xl: '1.3' }[settings.visual.fontSize];\r\n      previewArea.css('--font-scale', fontScale);\r\n    }\r\n    \r\n    // Apply icon scaling\r\n    if (settings.visual?.iconSize) {\r\n      const iconScale = { small: '0.8', default: '1', large: '1.2' }[settings.visual.iconSize];\r\n      previewArea.css('--icon-scale', iconScale);\r\n    }\r\n    \r\n    // Apply spacing\r\n    if (settings.visual?.spacing) {\r\n      const spacingScale = { tight: '0.75', default: '1', loose: '1.25' }[settings.visual.spacing];\r\n      previewArea.css('--spacing-scale', spacingScale);\r\n    }\r\n    \r\n    // Apply component visibility\r\n    if (settings.components) {\r\n      Object.entries(settings.components).forEach(([key, visible]) => {\r\n        const className = `hide-${key.replace(/([A-Z])/g, '-$1').toLowerCase().replace('show-', '')}`;\r\n        \r\n        if (!visible) {\r\n          previewArea.addClass(className);\r\n        } else {\r\n          previewArea.removeClass(className);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  async onApply(html) {\r\n    console.groupCollapsed(LOG_HEAD + 'UICustomizationDialog.onApply');\r\n    \r\n    // Collect all form data\r\n    const formData = new FormData(html.find('form')[0]);\r\n    const settings = {};\r\n    \r\n    for (let [key, value] of formData.entries()) {\r\n      const [category, setting] = key.split('.');\r\n      if (!settings[category]) settings[category] = {};\r\n      \r\n      // Handle different input types\r\n      if (html.find(`input[name=\"${key}\"]`).attr('type') === 'checkbox') {\r\n        settings[category][setting] = html.find(`input[name=\"${key}\"]`).is(':checked');\r\n      } else {\r\n        settings[category][setting] = value;\r\n      }\r\n    }\r\n    \r\n    // Apply each category of settings\r\n    Object.entries(settings).forEach(([category, categorySettings]) => {\r\n      Object.entries(categorySettings).forEach(([key, value]) => {\r\n        this.uiCustomization.setCustomization(category, key, value);\r\n      });\r\n    });\r\n    \r\n    ui.notifications.info('UI customizations applied successfully.');\r\n    console.groupEnd();\r\n  }\r\n\r\n  onReset() {\r\n    Dialog.confirm({\r\n      title: 'Reset All Customizations',\r\n      content: '<p>Are you sure you want to reset all UI customizations to defaults? This cannot be undone.</p>',\r\n      yes: () => {\r\n        this.uiCustomization.resetAllCustomizations();\r\n        this.render(true); // Re-render dialog with default values\r\n      }\r\n    });\r\n  }\r\n\r\n  onExport() {\r\n    const exportData = this.uiCustomization.exportCustomizations();\r\n    const dataStr = JSON.stringify(exportData, null, 2);\r\n    \r\n    // Create download link\r\n    const blob = new Blob([dataStr], { type: 'application/json' });\r\n    const url = URL.createObjectURL(blob);\r\n    const link = document.createElement('a');\r\n    link.href = url;\r\n    link.download = `anarchy-ui-customizations-${new Date().toISOString().split('T')[0]}.json`;\r\n    link.click();\r\n    \r\n    URL.revokeObjectURL(url);\r\n    ui.notifications.info('UI customizations exported successfully.');\r\n  }\r\n\r\n  onImport() {\r\n    const input = document.createElement('input');\r\n    input.type = 'file';\r\n    input.accept = '.json';\r\n    \r\n    input.onchange = (event) => {\r\n      const file = event.target.files[0];\r\n      if (!file) return;\r\n      \r\n      const reader = new FileReader();\r\n      reader.onload = (e) => {\r\n        try {\r\n          const importData = JSON.parse(e.target.result);\r\n          this.uiCustomization.importCustomizations(importData);\r\n          this.render(true); // Re-render dialog with imported values\r\n        } catch (error) {\r\n          ui.notifications.error('Failed to import customizations: Invalid file format.');\r\n          console.error(LOG_HEAD + 'Import error:', error);\r\n        }\r\n      };\r\n      reader.readAsText(file);\r\n    };\r\n    \r\n    input.click();\r\n  }\r\n\r\n  applyPreset(presetId) {\r\n    Dialog.confirm({\r\n      title: 'Apply Preset',\r\n      content: `<p>Apply the \"${this.uiCustomization.presets.get(presetId).name}\" preset? This will override your current customizations.</p>`,\r\n      yes: () => {\r\n        this.uiCustomization.applyPreset(presetId);\r\n        this.render(true); // Re-render dialog with preset values\r\n      }\r\n    });\r\n  }\r\n\r\n  validateCustomCSS(html) {\r\n    const css = html.find('textarea[name=\"advanced.customCSS\"]').val();\r\n    \r\n    if (!css.trim()) {\r\n      ui.notifications.info('No custom CSS to validate.');\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      // Basic CSS validation\r\n      const style = document.createElement('style');\r\n      style.textContent = css;\r\n      document.head.appendChild(style);\r\n      document.head.removeChild(style);\r\n      \r\n      ui.notifications.info('Custom CSS is valid.');\r\n    } catch (error) {\r\n      ui.notifications.error('Custom CSS contains errors. Please check your syntax.');\r\n      console.error(LOG_HEAD + 'CSS validation error:', error);\r\n    }\r\n  }\r\n\r\n  // =============================================================================\r\n  // STATIC METHODS\r\n  // =============================================================================\r\n\r\n  static async show(uiCustomization) {\r\n    const dialog = new UICustomizationDialog(uiCustomization);\r\n    return dialog.render(true);\r\n  }\r\n}\r\n","// UI Customization Commands - Console commands for UI customization\n// This module provides console commands for easy access to customization features\n\nimport { LOG_HEAD } from './constants.js';\nimport { UICustomizationDialog } from './ui-customization-dialog.js';\n\n/**\n * UI Customization Commands - Console interface for customization\n */\nexport class UICustomizationCommands {\n  constructor(uiCustomization) {\n    this.uiCustomization = uiCustomization;\n    this.registerCommands();\n  }\n\n  registerCommands() {\n    // Register global console commands\n    globalThis.anarchyUI = {\n      // Open customization dialog\n      customize: () => this.openCustomizationDialog(),\n\n      // Quick customization methods\n      setFontSize: (size) => this.setFontSize(size),\n      setIconSize: (size) => this.setIconSize(size),\n      setSpacing: (spacing) => this.setSpacing(spacing),\n      setAnimationSpeed: (speed) => this.setAnimationSpeed(speed),\n\n      // Component visibility toggles\n      togglePassportImages: () => this.toggleComponent('showPassportImages'),\n      toggleItemImages: () => this.toggleComponent('showItemImages'),\n      toggleAnimations: () => this.toggleComponent('showAnimations'),\n      toggleShadows: () => this.toggleComponent('showShadows'),\n\n      // Preset application\n      applyCompactMode: () => this.applyPreset('compact'),\n      applyAccessibilityMode: () => this.applyPreset('accessibility'),\n      applyPerformanceMode: () => this.applyPreset('performance'),\n      applyImmersiveMode: () => this.applyPreset('immersive'),\n\n      // HUD positioning\n      moveGMManager: (position) => this.moveGMManager(position),\n      moveShortcuts: (position) => this.moveShortcuts(position),\n      setHUDSize: (size) => this.setHUDSize(size),\n\n      // Advanced operations\n      injectCSS: (css) => this.injectCustomCSS(css),\n      exportSettings: () => this.exportSettings(),\n      importSettings: (data) => this.importSettings(data),\n      resetAll: () => this.resetAll(),\n\n      // Debugging\n      debug: () => this.debugCustomizations(),\n      listCommands: () => this.listCommands(),\n\n      // Theme integration\n      setThemeCustomization: (themeId, property, value) =>\n        this.setThemeCustomization(themeId, property, value),\n      previewTheme: (themeClass) => this.previewTheme(themeClass),\n\n      // Background helpers\n      listBackgrounds: () => globalThis.__anarchyBackgroundCandidates ?? [],\n      setBackground: (urlOrName) => this.setBackground(urlOrName),\n\n      // Sheet management and diagnostics\n      fixSheets: () => this.fixSheets(),\n      debugSheets: () => this.debugSheets(),\n    };\n\n    console.info(\n      LOG_HEAD +\n        'UI Customization commands registered. Use anarchyUI.listCommands() to see available commands.',\n    );\n  }\n\n  // =============================================================================\n  // COMMAND IMPLEMENTATIONS\n  // =============================================================================\n\n  openCustomizationDialog() {\n    return UICustomizationDialog.show(this.uiCustomization);\n  }\n\n  setFontSize(size) {\n    const validSizes = ['small', 'default', 'large', 'xl'];\n    if (!validSizes.includes(size)) {\n      console.error(LOG_HEAD + `Invalid font size. Valid options: ${validSizes.join(', ')}`);\n      return;\n    }\n\n    this.uiCustomization.setCustomization('visual', 'fontSize', size);\n    console.info(LOG_HEAD + `Font size set to: ${size}`);\n  }\n\n  setIconSize(size) {\n    const validSizes = ['small', 'default', 'large'];\n    if (!validSizes.includes(size)) {\n      console.error(LOG_HEAD + `Invalid icon size. Valid options: ${validSizes.join(', ')}`);\n      return;\n    }\n\n    this.uiCustomization.setCustomization('visual', 'iconSize', size);\n    console.info(LOG_HEAD + `Icon size set to: ${size}`);\n  }\n\n  setSpacing(spacing) {\n    const validSpacing = ['tight', 'default', 'loose'];\n    if (!validSpacing.includes(spacing)) {\n      console.error(LOG_HEAD + `Invalid spacing. Valid options: ${validSpacing.join(', ')}`);\n      return;\n    }\n\n    this.uiCustomization.setCustomization('visual', 'spacing', spacing);\n    console.info(LOG_HEAD + `Spacing set to: ${spacing}`);\n  }\n\n  setAnimationSpeed(speed) {\n    const validSpeeds = ['none', 'fast', 'normal', 'slow'];\n    if (!validSpeeds.includes(speed)) {\n      console.error(LOG_HEAD + `Invalid animation speed. Valid options: ${validSpeeds.join(', ')}`);\n      return;\n    }\n\n    this.uiCustomization.setCustomization('visual', 'animationSpeed', speed);\n    console.info(LOG_HEAD + `Animation speed set to: ${speed}`);\n  }\n\n  toggleComponent(componentKey) {\n    const current = this.uiCustomization.getCustomization('components', componentKey);\n    const newValue = !current;\n\n    this.uiCustomization.setCustomization('components', componentKey, newValue);\n    console.info(LOG_HEAD + `${componentKey} ${newValue ? 'enabled' : 'disabled'}`);\n  }\n\n  applyPreset(presetId) {\n    try {\n      this.uiCustomization.applyPreset(presetId);\n      console.info(LOG_HEAD + `Applied preset: ${presetId}`);\n    } catch (error) {\n      console.error(LOG_HEAD + `Failed to apply preset: ${error.message}`);\n    }\n  }\n\n  moveGMManager(position) {\n    const validPositions = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];\n    if (!validPositions.includes(position)) {\n      console.error(LOG_HEAD + `Invalid position. Valid options: ${validPositions.join(', ')}`);\n      return;\n    }\n\n    this.uiCustomization.setCustomization('hud', 'gmManagerPosition', position);\n    console.info(LOG_HEAD + `GM Manager moved to: ${position}`);\n  }\n\n  moveShortcuts(position) {\n    const validPositions = ['left', 'right', 'top', 'bottom'];\n    if (!validPositions.includes(position)) {\n      console.error(LOG_HEAD + `Invalid position. Valid options: ${validPositions.join(', ')}`);\n      return;\n    }\n\n    this.uiCustomization.setCustomization('hud', 'shortcutPosition', position);\n    console.info(LOG_HEAD + `Shortcuts moved to: ${position}`);\n  }\n\n  setHUDSize(size) {\n    const validSizes = ['small', 'medium', 'large'];\n    if (!validSizes.includes(size)) {\n      console.error(LOG_HEAD + `Invalid HUD size. Valid options: ${validSizes.join(', ')}`);\n      return;\n    }\n\n    this.uiCustomization.setCustomization('hud', 'hudSize', size);\n    console.info(LOG_HEAD + `HUD size set to: ${size}`);\n  }\n\n  injectCustomCSS(css) {\n    this.uiCustomization.setCustomization('advanced', 'customCSS', css);\n    console.info(LOG_HEAD + 'Custom CSS injected');\n  }\n\n  exportSettings() {\n    const data = this.uiCustomization.exportCustomizations();\n    console.info(LOG_HEAD + 'Customization data:', data);\n    return data;\n  }\n\n  importSettings(data) {\n    try {\n      this.uiCustomization.importCustomizations(data);\n      console.info(LOG_HEAD + 'Settings imported successfully');\n    } catch (error) {\n      console.error(LOG_HEAD + `Import failed: ${error.message}`);\n    }\n  }\n\n  resetAll() {\n    this.uiCustomization.resetAllCustomizations();\n    console.info(LOG_HEAD + 'All customizations reset');\n  }\n\n  debugCustomizations() {\n    return this.uiCustomization.debugCustomizations();\n  }\n\n  setThemeCustomization(themeId, property, value) {\n    this.uiCustomization.styles.setThemeCustomization(themeId, property, value);\n    console.info(LOG_HEAD + `Theme customization set: ${themeId}.${property} = ${value}`);\n  }\n\n  previewTheme(themeClass) {\n    this.uiCustomization.styles.previewTheme(themeClass);\n    console.info(LOG_HEAD + `Previewing theme: ${themeClass}`);\n  }\n\n  listCommands() {\n    const commands = [\n      'anarchyUI.customize() - Open customization dialog',\n      'anarchyUI.setFontSize(size) - Set font size (small, default, large, xl)',\n      'anarchyUI.setIconSize(size) - Set icon size (small, default, large)',\n      'anarchyUI.setSpacing(spacing) - Set spacing (tight, default, loose)',\n      'anarchyUI.setAnimationSpeed(speed) - Set animation speed (none, fast, normal, slow)',\n      'anarchyUI.togglePassportImages() - Toggle passport images',\n      'anarchyUI.toggleItemImages() - Toggle item images',\n      'anarchyUI.toggleAnimations() - Toggle animations',\n      'anarchyUI.toggleShadows() - Toggle shadows',\n      'anarchyUI.applyCompactMode() - Apply compact preset',\n      'anarchyUI.applyAccessibilityMode() - Apply accessibility preset',\n      'anarchyUI.applyPerformanceMode() - Apply performance preset',\n      'anarchyUI.applyImmersiveMode() - Apply immersive preset',\n      'anarchyUI.moveGMManager(position) - Move GM manager (top-left, top-right, bottom-left, bottom-right)',\n      'anarchyUI.moveShortcuts(position) - Move shortcuts (left, right, top, bottom)',\n      'anarchyUI.setHUDSize(size) - Set HUD size (small, medium, large)',\n      'anarchyUI.injectCSS(css) - Inject custom CSS',\n      'anarchyUI.exportSettings() - Export customization settings',\n      'anarchyUI.importSettings(data) - Import customization settings',\n      'anarchyUI.resetAll() - Reset all customizations',\n      'anarchyUI.debug() - Debug current customizations',\n      'anarchyUI.setThemeCustomization(themeId, property, value) - Set theme-specific customization',\n      'anarchyUI.previewTheme(themeClass) - Preview a theme temporarily',\n      'anarchyUI.listBackgrounds() - List probed background image URLs',\n      'anarchyUI.setBackground(urlOrName) - Force a background from list or full URL',\n      'anarchyUI.fixSheets() - Fix all world actors/items to use Anarchy sheets',\n      'anarchyUI.debugSheets() - Debug current sheet registrations and assignments',\n    ];\n\n    console.group(LOG_HEAD + 'Available UI Customization Commands:');\n    commands.forEach((cmd) => console.info(cmd));\n    console.groupEnd();\n\n    return commands;\n  }\n\n  setBackground(urlOrName) {\n    const root = document.documentElement;\n    const list = globalThis.__anarchyBackgroundCandidates ?? [];\n    const match = list.find((u) => u.endsWith(urlOrName)) ?? urlOrName;\n    if (!match) {\n      console.error(LOG_HEAD + 'No background match');\n      return;\n    }\n    const cssValue = `repeat center/50% url(\"${match}\")`;\n    root.style.setProperty('--anarchy-background', cssValue);\n    console.info(LOG_HEAD + 'Background set:', match);\n  }\n\n  // =============================================================================\n  // SHEET MANAGEMENT AND DIAGNOSTICS\n  // =============================================================================\n\n  async fixSheets() {\n    if (!game.user.isGM) {\n      console.error(LOG_HEAD + 'fixSheets() requires GM permissions');\n      return;\n    }\n\n    console.group(LOG_HEAD + 'Fixing world sheets to use Anarchy defaults');\n\n    const SYSTEM_NAME = 'anarchy';\n    let actorCount = 0;\n    let itemCount = 0;\n\n    try {\n      // Fix actors\n      const actorUpdates = [];\n      for (const actor of game.actors.contents) {\n        const current = actor.getFlag('core', 'sheetClass');\n        let desired = undefined;\n\n        switch (actor.type) {\n          case 'character':\n            desired = `${SYSTEM_NAME}.CharacterEnhancedSheet`;\n            break;\n          case 'vehicle':\n            desired = `${SYSTEM_NAME}.VehicleSheet`;\n            break;\n          case 'device':\n            desired = `${SYSTEM_NAME}.DeviceSheet`;\n            break;\n          case 'sprite':\n            desired = `${SYSTEM_NAME}.SpriteActorSheet`;\n            break;\n          case 'ic':\n            desired = `${SYSTEM_NAME}.ICSheet`;\n            break;\n        }\n\n        if (desired && (!current || String(current).startsWith('core.') || current !== desired)) {\n          actorUpdates.push(actor.update({ 'flags.core.sheetClass': desired }));\n          actorCount++;\n          console.info(`  Actor: ${actor.name} (${actor.type}) â ${desired}`);\n        }\n      }\n\n      // Fix items\n      const itemUpdates = [];\n      for (const item of game.items.contents) {\n        const current = item.getFlag('core', 'sheetClass');\n        let desired = undefined;\n\n        switch (item.type) {\n          case 'contact':\n            desired = `${SYSTEM_NAME}.ContactItemSheet`;\n            break;\n          case 'cyberdeck':\n            desired = `${SYSTEM_NAME}.CyberdeckItemSheet`;\n            break;\n          case 'gear':\n            desired = `${SYSTEM_NAME}.GearItemSheet`;\n            break;\n          case 'metatype':\n            desired = `${SYSTEM_NAME}.MetatypeItemSheet`;\n            break;\n          case 'quality':\n            desired = `${SYSTEM_NAME}.QualityItemSheet`;\n            break;\n          case 'shadowamp':\n            desired = `${SYSTEM_NAME}.ShadowampItemSheet`;\n            break;\n          case 'skill':\n            desired = `${SYSTEM_NAME}.SkillItemSheet`;\n            break;\n          case 'weapon':\n            desired = `${SYSTEM_NAME}.WeaponItemSheet`;\n            break;\n        }\n\n        if (desired && (!current || String(current).startsWith('core.') || current !== desired)) {\n          itemUpdates.push(item.update({ 'flags.core.sheetClass': desired }));\n          itemCount++;\n          console.info(`  Item: ${item.name} (${item.type}) â ${desired}`);\n        }\n      }\n\n      // Execute updates\n      await Promise.allSettled([...actorUpdates, ...itemUpdates]);\n\n      console.info(LOG_HEAD + `Fixed ${actorCount} actors and ${itemCount} items`);\n      ui.notifications.info(\n        `Fixed ${actorCount} actors and ${itemCount} items to use Anarchy sheets`,\n      );\n    } catch (error) {\n      console.error(LOG_HEAD + 'Error fixing sheets:', error);\n      ui.notifications.error('Failed to fix some sheets. Check console for details.');\n    }\n\n    console.groupEnd();\n    return { actorCount, itemCount };\n  }\n\n  debugSheets() {\n    console.group(LOG_HEAD + 'Sheet Registration Debug');\n\n    const DSC = foundry.applications?.api?.DocumentSheetConfig;\n    if (!DSC) {\n      console.error('DocumentSheetConfig not available');\n      console.groupEnd();\n      return;\n    }\n\n    // Get registered sheets\n    const ActorDoc = CONFIG.Actor?.documentClass || Actor;\n    const ItemDoc = CONFIG.Item?.documentClass || Item;\n\n    console.group('Registered Actor Sheets:');\n    const actorSheets = DSC.getSheetClasses(ActorDoc);\n    Object.entries(actorSheets).forEach(([type, sheets]) => {\n      console.info(`${type}:`, sheets);\n    });\n    console.groupEnd();\n\n    console.group('Registered Item Sheets:');\n    const itemSheets = DSC.getSheetClasses(ItemDoc);\n    Object.entries(itemSheets).forEach(([type, sheets]) => {\n      console.info(`${type}:`, sheets);\n    });\n    console.groupEnd();\n\n    // Sample world documents\n    console.group('Sample World Documents (first 10):');\n    const sampleActors = game.actors.contents.slice(0, 10);\n    sampleActors.forEach((actor) => {\n      const sheetClass = actor.getFlag('core', 'sheetClass') || 'default';\n      const sheetConstructor = actor.sheet?.constructor?.name || 'unknown';\n      console.info(\n        `Actor: ${actor.name} (${actor.type}) | Flag: ${sheetClass} | Constructor: ${sheetConstructor}`,\n      );\n    });\n\n    const sampleItems = game.items.contents.slice(0, 10);\n    sampleItems.forEach((item) => {\n      const sheetClass = item.getFlag('core', 'sheetClass') || 'default';\n      const sheetConstructor = item.sheet?.constructor?.name || 'unknown';\n      console.info(\n        `Item: ${item.name} (${item.type}) | Flag: ${sheetClass} | Constructor: ${sheetConstructor}`,\n      );\n    });\n    console.groupEnd();\n\n    // System status\n    console.group('System Status:');\n    console.info('Anarchy System:', game.system.anarchy);\n    console.info('Proxy Detected:', game.system.anarchy?.proxyDetected);\n    console.info('Sheets Registered:', game.system.anarchy?.sheetsRegistered);\n    console.info('Settings:');\n    console.info('  anarchy-first-mode:', game.settings.get('anarchy', 'anarchy-first-mode'));\n    console.info('  allow-core-fallback:', game.settings.get('anarchy', 'allow-core-fallback'));\n    console.info('  prefer-core-sheets:', game.settings.get('anarchy', 'prefer-core-sheets'));\n    console.groupEnd();\n\n    console.groupEnd();\n\n    return {\n      actorSheets,\n      itemSheets,\n      sampleActors: sampleActors.map((a) => ({\n        name: a.name,\n        type: a.type,\n        sheetFlag: a.getFlag('core', 'sheetClass'),\n        sheetConstructor: a.sheet?.constructor?.name,\n      })),\n      sampleItems: sampleItems.map((i) => ({\n        name: i.name,\n        type: i.type,\n        sheetFlag: i.getFlag('core', 'sheetClass'),\n        sheetConstructor: i.sheet?.constructor?.name,\n      })),\n      systemStatus: {\n        proxyDetected: game.system.anarchy?.proxyDetected,\n        sheetsRegistered: game.system.anarchy?.sheetsRegistered,\n        settings: {\n          anarchyFirstMode: game.settings.get('anarchy', 'anarchy-first-mode'),\n          allowCoreFallback: game.settings.get('anarchy', 'allow-core-fallback'),\n          preferCoreSheets: game.settings.get('anarchy', 'prefer-core-sheets'),\n        },\n      },\n    };\n  }\n}\n","// Performance Optimizer - CSS tree-shaking and performance optimization\r\n// This module provides performance optimization capabilities for the styling system\r\n\r\nimport { LOG_HEAD, SYSTEM_NAME } from './constants.js';\r\n\r\n/**\r\n * Performance Optimizer - Handles CSS optimization and tree-shaking\r\n */\r\nexport class PerformanceOptimizer {\r\n  constructor(stylesManager, uiCustomization) {\r\n    this.styles = stylesManager;\r\n    this.uiCustomization = uiCustomization;\r\n    this.optimizations = new Map();\r\n    this.performanceMetrics = new Map();\r\n    this.unusedSelectors = new Set();\r\n    this.criticalCSS = new Set();\r\n    \r\n    // Initialize performance optimization\r\n    this.initializeOptimizations();\r\n    \r\n    Hooks.once('ready', () => this.onReady());\r\n    Hooks.on('renderApplication', (app, html, data) => this.onRenderApplication(app, html, data));\r\n  }\r\n\r\n  async onReady() {\r\n    console.groupCollapsed(LOG_HEAD + 'PerformanceOptimizer.onReady');\r\n    \r\n    // Register performance settings\r\n    await this.registerPerformanceSettings();\r\n    \r\n    // Analyze current CSS usage\r\n    await this.analyzeCSSUsage();\r\n    \r\n    // Apply performance optimizations\r\n    this.applyPerformanceOptimizations();\r\n    \r\n    console.groupEnd();\r\n  }\r\n\r\n  // =============================================================================\r\n  // PERFORMANCE SETTINGS\r\n  // =============================================================================\r\n\r\n  async registerPerformanceSettings() {\r\n    // Performance optimization settings\r\n    game.settings.register(SYSTEM_NAME, 'performance-optimization', {\r\n      scope: 'client',\r\n      name: 'Performance Optimization',\r\n      hint: 'Performance optimization settings',\r\n      config: false,\r\n      default: {\r\n        enableTreeShaking: true,\r\n        enableCriticalCSS: true,\r\n        enableLazyLoading: true,\r\n        enableCSSMinification: true,\r\n        enableUnusedSelectorRemoval: true,\r\n        performanceMode: 'balanced' // 'performance', 'balanced', 'quality'\r\n      },\r\n      type: Object\r\n    });\r\n\r\n    // CSS loading strategy\r\n    game.settings.register(SYSTEM_NAME, 'css-loading-strategy', {\r\n      scope: 'world',\r\n      name: 'CSS Loading Strategy',\r\n      hint: 'How CSS should be loaded and optimized',\r\n      config: false,\r\n      default: {\r\n        loadingMethod: 'progressive', // 'all', 'progressive', 'lazy'\r\n        componentSplitting: true,\r\n        themeSplitting: true,\r\n        criticalInline: true\r\n      },\r\n      type: Object\r\n    });\r\n\r\n    // Performance monitoring\r\n    game.settings.register(SYSTEM_NAME, 'performance-monitoring', {\r\n      scope: 'client',\r\n      name: 'Performance Monitoring',\r\n      hint: 'Performance monitoring and metrics collection',\r\n      config: false,\r\n      default: {\r\n        enableMetrics: true,\r\n        trackRenderTimes: true,\r\n        trackCSSUsage: true,\r\n        reportThreshold: 100 // ms\r\n      },\r\n      type: Object\r\n    });\r\n  }\r\n\r\n  // =============================================================================\r\n  // CSS USAGE ANALYSIS\r\n  // =============================================================================\r\n\r\n  async analyzeCSSUsage() {\r\n    console.groupCollapsed(LOG_HEAD + 'PerformanceOptimizer.analyzeCSSUsage');\r\n    \r\n    const analysis = {\r\n      totalSelectors: 0,\r\n      usedSelectors: new Set(),\r\n      unusedSelectors: new Set(),\r\n      criticalSelectors: new Set(),\r\n      componentUsage: new Map(),\r\n      themeUsage: new Map(),\r\n      performanceImpact: new Map()\r\n    };\r\n\r\n    // Analyze DOM for used selectors\r\n    this.analyzeUsedSelectors(analysis);\r\n    \r\n    // Identify critical CSS\r\n    this.identifyCriticalCSS(analysis);\r\n    \r\n    // Analyze component usage\r\n    this.analyzeComponentUsage(analysis);\r\n    \r\n    // Store analysis results\r\n    this.cssAnalysis = analysis;\r\n    \r\n    console.info(LOG_HEAD + 'CSS Usage Analysis:', analysis);\r\n    console.groupEnd();\r\n    \r\n    return analysis;\r\n  }\r\n\r\n  analyzeUsedSelectors(analysis) {\r\n    // Get all elements in the DOM\r\n    const allElements = document.querySelectorAll('*');\r\n    \r\n    // Check which CSS classes are actually used\r\n    allElements.forEach(element => {\r\n      element.classList.forEach(className => {\r\n        analysis.usedSelectors.add(`.${className}`);\r\n      });\r\n      \r\n      // Check for ID selectors\r\n      if (element.id) {\r\n        analysis.usedSelectors.add(`#${element.id}`);\r\n      }\r\n    });\r\n    \r\n    // Identify unused selectors (simplified analysis)\r\n    const cssText = this.getCurrentCSSText();\r\n    const allSelectors = this.extractSelectorsFromCSS(cssText);\r\n    \r\n    allSelectors.forEach(selector => {\r\n      if (!this.isSelectorUsed(selector, analysis.usedSelectors)) {\r\n        analysis.unusedSelectors.add(selector);\r\n      }\r\n    });\r\n    \r\n    analysis.totalSelectors = allSelectors.length;\r\n  }\r\n\r\n  identifyCriticalCSS(analysis) {\r\n    // Critical CSS includes:\r\n    // 1. Above-the-fold content\r\n    // 2. Core layout elements\r\n    // 3. Essential interactive elements\r\n    \r\n    const criticalSelectors = [\r\n      '.sheet',\r\n      '.sheet-header',\r\n      '.passport-header',\r\n      '.attribute-box',\r\n      '.anarchy-button',\r\n      '.section-group',\r\n      'nav.sheet-tabs',\r\n      '.anarchy-monitor',\r\n      ':root'\r\n    ];\r\n    \r\n    criticalSelectors.forEach(selector => {\r\n      analysis.criticalSelectors.add(selector);\r\n    });\r\n  }\r\n\r\n  analyzeComponentUsage(analysis) {\r\n    // Analyze which components are actually rendered\r\n    const componentSelectors = {\r\n      'character-enhanced': '.character-enhanced',\r\n      'gm-manager': '#gm-manager',\r\n      'roll-dialog': '.roll-dialog',\r\n      'weapon-list': '.weapon-list',\r\n      'item-components': '.items-group',\r\n      'monitor-components': '.anarchy-monitor'\r\n    };\r\n    \r\n    Object.entries(componentSelectors).forEach(([component, selector]) => {\r\n      const elements = document.querySelectorAll(selector);\r\n      analysis.componentUsage.set(component, elements.length);\r\n    });\r\n  }\r\n\r\n  // =============================================================================\r\n  // TREE-SHAKING IMPLEMENTATION\r\n  // =============================================================================\r\n\r\n  implementTreeShaking() {\r\n    console.groupCollapsed(LOG_HEAD + 'PerformanceOptimizer.implementTreeShaking');\r\n    \r\n    const settings = game.settings.get(SYSTEM_NAME, 'performance-optimization');\r\n    \r\n    if (!settings.enableTreeShaking) {\r\n      console.info(LOG_HEAD + 'Tree-shaking disabled by user settings');\r\n      console.groupEnd();\r\n      return;\r\n    }\r\n\r\n    // Remove unused CSS selectors\r\n    this.removeUnusedSelectors();\r\n    \r\n    // Optimize CSS delivery\r\n    this.optimizeCSSDelivery();\r\n    \r\n    // Implement lazy loading\r\n    this.implementLazyLoading();\r\n    \r\n    console.groupEnd();\r\n  }\r\n\r\n  removeUnusedSelectors() {\r\n    if (!this.cssAnalysis) return;\r\n    \r\n    const unusedCount = this.cssAnalysis.unusedSelectors.size;\r\n    const totalCount = this.cssAnalysis.totalSelectors;\r\n    const removalPercentage = Math.round((unusedCount / totalCount) * 100);\r\n    \r\n    console.info(LOG_HEAD + `Tree-shaking analysis: ${unusedCount}/${totalCount} selectors unused (${removalPercentage}%)`);\r\n    \r\n    // In a real implementation, you would remove unused selectors from the CSS\r\n    // For this demo, we'll just track the potential savings\r\n    this.performanceMetrics.set('treeshaking', {\r\n      unusedSelectors: unusedCount,\r\n      totalSelectors: totalCount,\r\n      potentialSavings: removalPercentage,\r\n      estimatedSizeReduction: Math.round((unusedCount / totalCount) * 100) // KB estimate\r\n    });\r\n  }\r\n\r\n  optimizeCSSDelivery() {\r\n    const settings = game.settings.get(SYSTEM_NAME, 'css-loading-strategy');\r\n    \r\n    if (settings.criticalInline) {\r\n      this.inlineCriticalCSS();\r\n    }\r\n    \r\n    if (settings.componentSplitting) {\r\n      this.implementComponentSplitting();\r\n    }\r\n    \r\n    if (settings.themeSplitting) {\r\n      this.implementThemeSplitting();\r\n    }\r\n  }\r\n\r\n  inlineCriticalCSS() {\r\n    if (!this.cssAnalysis) return;\r\n    \r\n    const criticalCSS = this.extractCriticalCSS();\r\n    \r\n    // Create critical CSS style element\r\n    const criticalStyle = document.createElement('style');\r\n    criticalStyle.id = 'anarchy-critical-css';\r\n    criticalStyle.textContent = criticalCSS;\r\n    \r\n    // Insert critical CSS at the beginning of head\r\n    document.head.insertBefore(criticalStyle, document.head.firstChild);\r\n    \r\n    console.info(LOG_HEAD + `Inlined critical CSS: ${criticalCSS.length} characters`);\r\n    \r\n    this.performanceMetrics.set('criticalCSS', {\r\n      size: criticalCSS.length,\r\n      selectors: this.cssAnalysis.criticalSelectors.size\r\n    });\r\n  }\r\n\r\n  extractCriticalCSS() {\r\n    // Extract critical CSS rules from the compiled CSS\r\n    // This is a simplified implementation\r\n    const criticalRules = [];\r\n    \r\n    this.cssAnalysis.criticalSelectors.forEach(selector => {\r\n      // In a real implementation, you would extract the actual CSS rules\r\n      criticalRules.push(`${selector} { /* critical styles */ }`);\r\n    });\r\n    \r\n    return criticalRules.join('\\n');\r\n  }\r\n\r\n  implementComponentSplitting() {\r\n    // Component-based CSS loading\r\n    const componentMap = {\r\n      'character-enhanced': 'character-enhanced.css',\r\n      'gm-manager': 'gm-manager.css',\r\n      'roll-dialog': 'dialogs.css',\r\n      'item-components': 'items.css'\r\n    };\r\n    \r\n    Object.entries(componentMap).forEach(([component, filename]) => {\r\n      if (this.cssAnalysis.componentUsage.get(component) > 0) {\r\n        this.loadComponentCSS(filename);\r\n      }\r\n    });\r\n  }\r\n\r\n  implementThemeSplitting() {\r\n    // Load only the active theme CSS\r\n    const currentTheme = this.styles.currentTheme;\r\n    const themeId = this.styles.getThemeIdFromClass(currentTheme);\r\n    \r\n    // In a real implementation, you would load only the active theme\r\n    console.info(LOG_HEAD + `Theme splitting: Loading only ${themeId} theme CSS`);\r\n    \r\n    this.performanceMetrics.set('themeSplitting', {\r\n      activeTheme: themeId,\r\n      potentialSavings: 'Estimated 30-40% reduction in theme CSS'\r\n    });\r\n  }\r\n\r\n  implementLazyLoading() {\r\n    const settings = game.settings.get(SYSTEM_NAME, 'performance-optimization');\r\n    \r\n    if (!settings.enableLazyLoading) return;\r\n    \r\n    // Implement intersection observer for lazy-loaded components\r\n    const lazyComponents = document.querySelectorAll('[data-lazy-component]');\r\n    \r\n    if (lazyComponents.length > 0) {\r\n      const observer = new IntersectionObserver((entries) => {\r\n        entries.forEach(entry => {\r\n          if (entry.isIntersecting) {\r\n            this.loadLazyComponent(entry.target);\r\n            observer.unobserve(entry.target);\r\n          }\r\n        });\r\n      });\r\n      \r\n      lazyComponents.forEach(component => observer.observe(component));\r\n      \r\n      console.info(LOG_HEAD + `Lazy loading enabled for ${lazyComponents.length} components`);\r\n    }\r\n  }\r\n\r\n  // =============================================================================\r\n  // PERFORMANCE MONITORING\r\n  // =============================================================================\r\n\r\n  startPerformanceMonitoring() {\r\n    const settings = game.settings.get(SYSTEM_NAME, 'performance-monitoring');\r\n    \r\n    if (!settings.enableMetrics) return;\r\n    \r\n    // Monitor render times\r\n    if (settings.trackRenderTimes) {\r\n      this.monitorRenderTimes();\r\n    }\r\n    \r\n    // Monitor CSS usage\r\n    if (settings.trackCSSUsage) {\r\n      this.monitorCSSUsage();\r\n    }\r\n    \r\n    console.info(LOG_HEAD + 'Performance monitoring started');\r\n  }\r\n\r\n  monitorRenderTimes() {\r\n    const originalRender = Application.prototype.render;\r\n    const reportThreshold = game.settings.get(SYSTEM_NAME, 'performance-monitoring').reportThreshold;\r\n    \r\n    Application.prototype.render = function(...args) {\r\n      const startTime = performance.now();\r\n      const result = originalRender.apply(this, args);\r\n      const endTime = performance.now();\r\n      const renderTime = endTime - startTime;\r\n      \r\n      if (renderTime > reportThreshold) {\r\n        console.warn(LOG_HEAD + `Slow render detected: ${this.constructor.name} took ${renderTime.toFixed(2)}ms`);\r\n      }\r\n      \r\n      return result;\r\n    };\r\n  }\r\n\r\n  monitorCSSUsage() {\r\n    // Monitor CSS selector usage over time\r\n    const observer = new MutationObserver((mutations) => {\r\n      mutations.forEach(mutation => {\r\n        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {\r\n          this.trackSelectorUsage(mutation.target);\r\n        }\r\n      });\r\n    });\r\n    \r\n    observer.observe(document.body, {\r\n      attributes: true,\r\n      subtree: true,\r\n      attributeFilter: ['class']\r\n    });\r\n  }\r\n\r\n  trackSelectorUsage(element) {\r\n    element.classList.forEach(className => {\r\n      const selector = `.${className}`;\r\n      const currentCount = this.performanceMetrics.get(selector) || 0;\r\n      this.performanceMetrics.set(selector, currentCount + 1);\r\n    });\r\n  }\r\n\r\n  // =============================================================================\r\n  // OPTIMIZATION STRATEGIES\r\n  // =============================================================================\r\n\r\n  initializeOptimizations() {\r\n    // Register optimization strategies\r\n    this.optimizations.set('minification', {\r\n      name: 'CSS Minification',\r\n      description: 'Remove whitespace and optimize CSS output',\r\n      enabled: true,\r\n      impact: 'high',\r\n      apply: () => this.applyCSSMinification()\r\n    });\r\n\r\n    this.optimizations.set('treeshaking', {\r\n      name: 'CSS Tree-Shaking',\r\n      description: 'Remove unused CSS selectors',\r\n      enabled: true,\r\n      impact: 'high',\r\n      apply: () => this.implementTreeShaking()\r\n    });\r\n\r\n    this.optimizations.set('criticalcss', {\r\n      name: 'Critical CSS Inlining',\r\n      description: 'Inline critical above-the-fold CSS',\r\n      enabled: true,\r\n      impact: 'medium',\r\n      apply: () => this.inlineCriticalCSS()\r\n    });\r\n\r\n    this.optimizations.set('lazyloading', {\r\n      name: 'Lazy Component Loading',\r\n      description: 'Load component CSS on demand',\r\n      enabled: true,\r\n      impact: 'medium',\r\n      apply: () => this.implementLazyLoading()\r\n    });\r\n\r\n    this.optimizations.set('caching', {\r\n      name: 'CSS Caching Optimization',\r\n      description: 'Optimize CSS caching strategies',\r\n      enabled: true,\r\n      impact: 'low',\r\n      apply: () => this.optimizeCSSCaching()\r\n    });\r\n  }\r\n\r\n  applyPerformanceOptimizations() {\r\n    const settings = game.settings.get(SYSTEM_NAME, 'performance-optimization');\r\n    \r\n    console.groupCollapsed(LOG_HEAD + 'Applying performance optimizations');\r\n    \r\n    // Apply optimizations based on performance mode\r\n    switch (settings.performanceMode) {\r\n      case 'performance':\r\n        this.applyPerformanceMode();\r\n        break;\r\n      case 'balanced':\r\n        this.applyBalancedMode();\r\n        break;\r\n      case 'quality':\r\n        this.applyQualityMode();\r\n        break;\r\n    }\r\n    \r\n    console.groupEnd();\r\n  }\r\n\r\n  applyPerformanceMode() {\r\n    // Maximum performance optimizations\r\n    console.info(LOG_HEAD + 'Applying performance mode optimizations');\r\n    \r\n    // Disable expensive visual effects\r\n    this.uiCustomization.setCustomization('visual', 'animationSpeed', 'fast');\r\n    this.uiCustomization.setCustomization('visual', 'shadowIntensity', 'light');\r\n    this.uiCustomization.setCustomization('components', 'showAnimations', false);\r\n    this.uiCustomization.setCustomization('components', 'showShadows', false);\r\n    \r\n    // Enable all optimizations\r\n    this.optimizations.forEach(optimization => {\r\n      if (optimization.enabled) {\r\n        optimization.apply();\r\n      }\r\n    });\r\n  }\r\n\r\n  applyBalancedMode() {\r\n    // Balanced performance and quality\r\n    console.info(LOG_HEAD + 'Applying balanced mode optimizations');\r\n    \r\n    // Moderate visual effects\r\n    this.uiCustomization.setCustomization('visual', 'animationSpeed', 'normal');\r\n    this.uiCustomization.setCustomization('visual', 'shadowIntensity', 'medium');\r\n    \r\n    // Enable key optimizations\r\n    this.optimizations.get('minification').apply();\r\n    this.optimizations.get('treeshaking').apply();\r\n    this.optimizations.get('criticalcss').apply();\r\n  }\r\n\r\n  applyQualityMode() {\r\n    // Maximum visual quality\r\n    console.info(LOG_HEAD + 'Applying quality mode optimizations');\r\n    \r\n    // Enhanced visual effects\r\n    this.uiCustomization.setCustomization('visual', 'animationSpeed', 'slow');\r\n    this.uiCustomization.setCustomization('visual', 'shadowIntensity', 'strong');\r\n    this.uiCustomization.setCustomization('components', 'showAnimations', true);\r\n    this.uiCustomization.setCustomization('components', 'showShadows', true);\r\n    \r\n    // Enable only non-intrusive optimizations\r\n    this.optimizations.get('caching').apply();\r\n  }\r\n\r\n  // =============================================================================\r\n  // SPECIFIC OPTIMIZATION IMPLEMENTATIONS\r\n  // =============================================================================\r\n\r\n  applyCSSMinification() {\r\n    // CSS minification would be handled by the build process\r\n    // This tracks the potential impact\r\n    \r\n    const currentSize = this.getCurrentCSSSize();\r\n    const estimatedMinifiedSize = Math.round(currentSize * 0.7); // ~30% reduction\r\n    \r\n    this.performanceMetrics.set('minification', {\r\n      originalSize: currentSize,\r\n      minifiedSize: estimatedMinifiedSize,\r\n      savings: currentSize - estimatedMinifiedSize,\r\n      savingsPercentage: Math.round(((currentSize - estimatedMinifiedSize) / currentSize) * 100)\r\n    });\r\n    \r\n    console.info(LOG_HEAD + `CSS minification: ${currentSize} â ${estimatedMinifiedSize} bytes (${this.performanceMetrics.get('minification').savingsPercentage}% reduction)`);\r\n  }\r\n\r\n  optimizeCSSCaching() {\r\n    // Implement CSS caching optimizations\r\n    const cacheStrategy = {\r\n      maxAge: 86400, // 24 hours\r\n      etag: true,\r\n      compression: true,\r\n      splitting: true\r\n    };\r\n    \r\n    // Set cache headers (would be handled by server in real implementation)\r\n    this.performanceMetrics.set('caching', cacheStrategy);\r\n    \r\n    console.info(LOG_HEAD + 'CSS caching optimized:', cacheStrategy);\r\n  }\r\n\r\n  loadComponentCSS(filename) {\r\n    // Load component-specific CSS\r\n    const link = document.createElement('link');\r\n    link.rel = 'stylesheet';\r\n    link.href = `systems/anarchy/style/components/${filename}`;\r\n    link.dataset.component = filename.replace('.css', '');\r\n    document.head.appendChild(link);\r\n    \r\n    console.info(LOG_HEAD + `Loaded component CSS: ${filename}`);\r\n  }\r\n\r\n  loadLazyComponent(element) {\r\n    const componentName = element.dataset.lazyComponent;\r\n    \r\n    if (componentName) {\r\n      this.loadComponentCSS(`${componentName}.css`);\r\n      element.removeAttribute('data-lazy-component');\r\n      element.classList.add('lazy-loaded');\r\n    }\r\n  }\r\n\r\n  // =============================================================================\r\n  // PERFORMANCE MEASUREMENT\r\n  // =============================================================================\r\n\r\n  measurePerformance() {\r\n    const measurements = {\r\n      cssSize: this.getCurrentCSSSize(),\r\n      selectorCount: this.cssAnalysis?.totalSelectors || 0,\r\n      unusedSelectors: this.cssAnalysis?.unusedSelectors.size || 0,\r\n      renderTime: this.measureAverageRenderTime(),\r\n      memoryUsage: this.estimateMemoryUsage(),\r\n      optimizationImpact: this.calculateOptimizationImpact()\r\n    };\r\n    \r\n    console.group(LOG_HEAD + 'Performance Measurements');\r\n    console.info('CSS Size:', `${measurements.cssSize} bytes`);\r\n    console.info('Selector Count:', measurements.selectorCount);\r\n    console.info('Unused Selectors:', measurements.unusedSelectors);\r\n    console.info('Average Render Time:', `${measurements.renderTime}ms`);\r\n    console.info('Estimated Memory Usage:', `${measurements.memoryUsage}KB`);\r\n    console.info('Optimization Impact:', measurements.optimizationImpact);\r\n    console.groupEnd();\r\n    \r\n    return measurements;\r\n  }\r\n\r\n  measureAverageRenderTime() {\r\n    // Simplified render time measurement\r\n    const startTime = performance.now();\r\n    \r\n    // Simulate typical operations\r\n    document.querySelector('.sheet')?.getBoundingClientRect();\r\n    document.querySelectorAll('.anarchy-button').forEach(btn => btn.getBoundingClientRect());\r\n    \r\n    const endTime = performance.now();\r\n    return Math.round(endTime - startTime);\r\n  }\r\n\r\n  estimateMemoryUsage() {\r\n    // Estimate CSS memory usage\r\n    const cssSize = this.getCurrentCSSSize();\r\n    const selectorCount = this.cssAnalysis?.totalSelectors || 0;\r\n    \r\n    // Rough estimation: CSS size + selector overhead\r\n    return Math.round((cssSize / 1024) + (selectorCount * 0.1));\r\n  }\r\n\r\n  calculateOptimizationImpact() {\r\n    const impact = {\r\n      treeshaking: this.performanceMetrics.get('treeshaking')?.potentialSavings || 0,\r\n      minification: this.performanceMetrics.get('minification')?.savingsPercentage || 0,\r\n      criticalCSS: this.performanceMetrics.get('criticalCSS')?.size || 0,\r\n      totalSavings: 0\r\n    };\r\n    \r\n    impact.totalSavings = impact.treeshaking + impact.minification;\r\n    \r\n    return impact;\r\n  }\r\n\r\n  // =============================================================================\r\n  // UTILITY METHODS\r\n  // =============================================================================\r\n\r\n  getCurrentCSSText() {\r\n    const stylesheets = Array.from(document.styleSheets);\r\n    let cssText = '';\r\n    \r\n    stylesheets.forEach(stylesheet => {\r\n      try {\r\n        const rules = Array.from(stylesheet.cssRules || []);\r\n        rules.forEach(rule => {\r\n          cssText += rule.cssText + '\\n';\r\n        });\r\n      } catch (e) {\r\n        // Cross-origin stylesheets may not be accessible\r\n      }\r\n    });\r\n    \r\n    return cssText;\r\n  }\r\n\r\n  getCurrentCSSSize() {\r\n    return this.getCurrentCSSText().length;\r\n  }\r\n\r\n  extractSelectorsFromCSS(cssText) {\r\n    // Extract all selectors from CSS text\r\n    const selectorRegex = /([^{}]+)\\s*\\{[^}]*\\}/g;\r\n    const selectors = new Set();\r\n    let match;\r\n    \r\n    while ((match = selectorRegex.exec(cssText)) !== null) {\r\n      const selector = match[1].trim();\r\n      if (selector && !selector.startsWith('@')) {\r\n        selectors.add(selector);\r\n      }\r\n    }\r\n    \r\n    return Array.from(selectors);\r\n  }\r\n\r\n  isSelectorUsed(selector, usedSelectors) {\r\n    // Simplified selector usage check\r\n    const cleanSelector = selector.replace(/::?[a-z-]+/g, '').trim();\r\n    \r\n    return usedSelectors.has(cleanSelector) || \r\n           cleanSelector.includes(':root') ||\r\n           cleanSelector.includes('@') ||\r\n           cleanSelector.includes('*');\r\n  }\r\n\r\n  onRenderApplication(app, html, data) {\r\n    // Track application render performance\r\n    const startTime = performance.now();\r\n    \r\n    // Apply optimizations to newly rendered applications\r\n    this.optimizeRenderedApplication(app, html);\r\n    \r\n    const endTime = performance.now();\r\n    const renderTime = endTime - startTime;\r\n    \r\n    if (renderTime > 50) { // Threshold for slow renders\r\n      console.warn(LOG_HEAD + `Slow application render: ${app.constructor.name} took ${renderTime.toFixed(2)}ms`);\r\n    }\r\n  }\r\n\r\n  optimizeRenderedApplication(app, html) {\r\n    // Apply performance optimizations to specific applications\r\n    const element = html[0];\r\n    \r\n    // Add lazy loading attributes for heavy components\r\n    const heavyComponents = element.querySelectorAll('.character-enhanced, .items-group-list');\r\n    heavyComponents.forEach(component => {\r\n      if (!component.dataset.lazyComponent) {\r\n        component.dataset.lazyComponent = component.className.split(' ')[0];\r\n      }\r\n    });\r\n  }\r\n\r\n  // =============================================================================\r\n  // PERFORMANCE REPORTING\r\n  // =============================================================================\r\n\r\n  generatePerformanceReport() {\r\n    const report = {\r\n      timestamp: new Date().toISOString(),\r\n      measurements: this.measurePerformance(),\r\n      optimizations: Array.from(this.optimizations.entries()).map(([id, opt]) => ({\r\n        id,\r\n        name: opt.name,\r\n        enabled: opt.enabled,\r\n        impact: opt.impact\r\n      })),\r\n      metrics: Object.fromEntries(this.performanceMetrics),\r\n      recommendations: this.generatePerformanceRecommendations()\r\n    };\r\n    \r\n    console.group(LOG_HEAD + 'Performance Report');\r\n    console.info('Report:', report);\r\n    console.groupEnd();\r\n    \r\n    return report;\r\n  }\r\n\r\n  generatePerformanceRecommendations() {\r\n    const recommendations = [];\r\n    \r\n    // CSS size recommendations\r\n    const cssSize = this.getCurrentCSSSize();\r\n    if (cssSize > 500000) { // 500KB\r\n      recommendations.push({\r\n        type: 'css-size',\r\n        severity: 'high',\r\n        message: 'CSS size is very large',\r\n        suggestion: 'Enable tree-shaking and component splitting'\r\n      });\r\n    }\r\n    \r\n    // Unused selector recommendations\r\n    const unusedCount = this.cssAnalysis?.unusedSelectors.size || 0;\r\n    const totalCount = this.cssAnalysis?.totalSelectors || 1;\r\n    const unusedPercentage = (unusedCount / totalCount) * 100;\r\n    \r\n    if (unusedPercentage > 30) {\r\n      recommendations.push({\r\n        type: 'unused-css',\r\n        severity: 'medium',\r\n        message: `${unusedPercentage.toFixed(1)}% of CSS selectors are unused`,\r\n        suggestion: 'Enable tree-shaking to remove unused styles'\r\n      });\r\n    }\r\n    \r\n    // Performance mode recommendations\r\n    const settings = game.settings.get(SYSTEM_NAME, 'performance-optimization');\r\n    if (settings.performanceMode === 'quality') {\r\n      recommendations.push({\r\n        type: 'performance-mode',\r\n        severity: 'low',\r\n        message: 'Quality mode may impact performance',\r\n        suggestion: 'Consider balanced mode for better performance'\r\n      });\r\n    }\r\n    \r\n    return recommendations;\r\n  }\r\n}\r\n\r\n","import { ANARCHY } from '../config.js';\nimport { SYSTEM_DESCRIPTION, SYSTEM_NAME, SYSTEM_PATH } from '../constants.js';\n\nexport const GLITCH_COLORSET = 'glitch';\nexport const RISK_COLORSET = 'risk';\nexport const REROLL_COLORSET = 'reroll';\nexport const REROLL_REMOVED_COLORSET = 'rerollRemoved';\nexport const REMOVED_COLORSET = 'removed';\n\nconst DICE_GLITCH = `${SYSTEM_PATH}/style/danger-point.webp`;\nconst DICE_PROWESS = `${SYSTEM_PATH}/style/anarchy-point.webp`;\n\nexport class AnarchyDice {\n  static dice3d = undefined;\n\n  static init() {\n    CONFIG.Dice.terms[AnarchyGlitchDie.DENOMINATION] = AnarchyGlitchDie;\n    CONFIG.Dice.terms[AnarchyRiskDie.DENOMINATION] = AnarchyRiskDie;\n    Hooks.once('diceSoNiceReady', (dice3d) => AnarchyDice.diceSoNiceReady(dice3d));\n    Hooks.once('ready', () => AnarchyDice.onReady());\n  }\n\n  static onReady() {\n    AnarchyDice.COLORSETS = AnarchyDice.loadColorsets();\n\n    if (game.modules.get('dice-so-nice')?.active) {\n      if (game.settings.get('core', 'noCanvas')) {\n        ui.notifications.warn(\n          \"Dice So Nice! will not display dice due to Foundry option 'Disable Game Canvas' \",\n        );\n      }\n    }\n  }\n\n  static loadColorsets() {\n    return {\n      [REROLL_COLORSET]: {\n        name: REROLL_COLORSET,\n        description: game.i18n.localize(ANARCHY.common.roll.rollTheme.reroll),\n        category: SYSTEM_DESCRIPTION,\n      },\n      [REMOVED_COLORSET]: {\n        name: RISK_COLORSET,\n        description: game.i18n.localize(ANARCHY.common.roll.rollTheme.removed),\n        category: SYSTEM_DESCRIPTION,\n      },\n      [REROLL_REMOVED_COLORSET]: {\n        name: REROLL_REMOVED_COLORSET,\n        description: game.i18n.localize(ANARCHY.common.roll.rollTheme.rerollRemoved),\n        category: SYSTEM_DESCRIPTION,\n      },\n      [GLITCH_COLORSET]: {\n        name: GLITCH_COLORSET,\n        description: game.i18n.localize(ANARCHY.common.roll.rollTheme.glitch),\n        category: SYSTEM_DESCRIPTION,\n        foreground: 'white',\n        background: '#5c0a5c',\n        outline: 'none',\n        edge: 'none',\n        texture: 'poison',\n        material: 'metal',\n      },\n      [RISK_COLORSET]: {\n        name: RISK_COLORSET,\n        description: game.i18n.localize(ANARCHY.common.roll.rollTheme.anarchyRisk),\n        category: SYSTEM_DESCRIPTION,\n        foreground: '#faecd1',\n        background: '#040101',\n        outline: 'none',\n        edge: 'none',\n        texture: 'fire',\n        material: 'metal',\n      },\n    };\n  }\n\n  static diceSoNiceReady(dice3d) {\n    AnarchyDice.dice3d = dice3d;\n    game.settings.set('dice-so-nice', 'enabledSimultaneousRollForMessage', false);\n    dice3d.addSystem({ id: SYSTEM_NAME, name: SYSTEM_DESCRIPTION });\n    /*\n     * See guides:\n     * https://gitlab.com/riccisi/foundryvtt-dice-so-nice/-/wikis/API/Hooks\n     * https://gitlab.com/riccisi/foundryvtt-dice-so-nice/-/wikis/API/Customization\n     */\n    Object.values(AnarchyDice.COLORSETS).forEach((colorset) => dice3d.addColorset(colorset));\n    dice3d.addDicePreset(AnarchyGlitchDie.diceSoNiceData());\n    dice3d.addDicePreset(AnarchyRiskDie.diceSoNiceData());\n  }\n\n  static img(path) {\n    return `<img src=\"${path}\" />`;\n  }\n}\n\nexport class AnarchyGlitchDie extends foundry.dice.terms.Die {\n  constructor(term) {\n    term.faces = 6;\n    super(term);\n  }\n\n  /** @override */\n  getResultLabel(result) {\n    switch (result.result) {\n      case '1':\n        return AnarchyDice.img(DICE_GLITCH);\n    }\n    return result.result.toString();\n  }\n\n  /** @override */\n  static DENOMINATION = 'g';\n\n  static diceSoNiceData() {\n    return {\n      type: 'dg',\n      labels: [DICE_GLITCH, '2', '3', '4', '5', '6'],\n      colorset: GLITCH_COLORSET,\n      system: SYSTEM_NAME,\n    };\n  }\n}\n\nexport class AnarchyRiskDie extends foundry.dice.terms.Die {\n  constructor(term) {\n    term.faces = 6;\n    super(term);\n  }\n\n  static DENOMINATION = 'r';\n\n  /** @override */\n  getResultLabel(result) {\n    switch (result.result) {\n      case '1':\n        return AnarchyDice.img(DICE_GLITCH);\n      case '5':\n        return AnarchyDice.img(DICE_PROWESS);\n      case '6':\n        return AnarchyDice.img(DICE_PROWESS);\n    }\n    return result.result.toString();\n  }\n\n  static diceSoNiceData() {\n    return {\n      type: 'dr',\n      labels: [DICE_GLITCH, '2', '3', '4', DICE_PROWESS, DICE_PROWESS],\n      colorset: RISK_COLORSET,\n      system: SYSTEM_NAME,\n    };\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { GLITCH_COLORSET, RISK_COLORSET } from './dice.js';\n\nexport const ROLL_THEME = {};\nconst DEFAULT_ROLL_RESULT = {\n  riskProwess: 0,\n  riskGlitch: 0,\n  riskOutcome: 'nothing',\n  glitch: 0,\n  glitchOutcome: 'nothing',\n  totalGlitch: 0,\n  drain: 0,\n  total: 0,\n  subrolls: {\n    roll: undefined,\n    reroll: undefined,\n    removed: undefined,\n    rerollForced: undefined,\n    risk: undefined,\n    glitch: undefined,\n  },\n};\n\nexport class AnarchyRoll {\n  static init() {\n    Hooks.once('ready', () => AnarchyRoll.onReady());\n  }\n\n  static onReady() {\n    Object.entries(ANARCHY.common.roll.rollTheme).forEach((entry) => {\n      ROLL_THEME[entry[0]] = game.i18n.localize(entry[1]);\n    });\n  }\n\n  /**\n   * @param {*} param : { pool: 1, reroll: 0, risk: 0, rerollForced: 0, target: 5 }\n   */\n  constructor(param) {\n    this.param = param;\n    this.param.pool = Math.max(this.param.pool ?? 0, 0);\n    this.param.reroll = Math.max(this.param.reroll ?? 0, 0);\n    this.param.rerollForced = Math.abs(this.param.rerollForced ?? 0);\n    this.param.glitch = Math.max(this.param.glitch ?? 0, 0);\n    this.param.risk = Math.max(this.param.risk ?? 0, 0);\n    this.param.edge = Math.max(this.param.edge ?? 0, 0);\n    this.param.target = this.param.edge > 0 ? 4 : (this.param.target ?? 5);\n    foundry.utils.mergeObject(this, DEFAULT_ROLL_RESULT);\n  }\n\n  async evaluate() {\n    await this.rollPool();\n    await this.rollRerolls();\n    await this.rollRerollForced();\n    await this.rollGlitchDice();\n    await this.rollAnarchyRisk();\n  }\n\n  async rollPool() {\n    this.subrolls.pool = new Roll(\n      `${this.param.pool}d6cs>=${this.param.target}[${ROLL_THEME['dicePool']}]`,\n    );\n    await this.subrolls.pool.evaluate({ async: true });\n    this.total = this.subrolls.pool.total;\n  }\n\n  async rollRerolls() {\n    const rerolls = Math.min(this.param.pool - this.total, this.param.reroll);\n    if (rerolls > 0) {\n      this.subrolls.reroll = new Roll(\n        `${rerolls}d6cs>=${this.param.target}[${ROLL_THEME['reroll']}]`,\n      );\n      await this.subrolls.reroll.evaluate({ async: true });\n      this.total += this.subrolls.reroll.total;\n    }\n  }\n\n  async rollRerollForced() {\n    const removed = Math.min(this.total, this.param.rerollForced);\n    if (removed > 0) {\n      this.subrolls.removed = new Roll(`-${removed}d1cf=1[${ROLL_THEME['removed']}]`);\n      await this.subrolls.removed.evaluate({ async: true });\n      this.subrolls.rerollForced = new Roll(\n        `${removed}d6cs>=${this.param.target}[${ROLL_THEME['rerollRemoved']}]`,\n      );\n      await this.subrolls.rerollForced.evaluate({ async: true });\n      this.total -= removed;\n      this.total += this.subrolls.rerollForced.total;\n    }\n  }\n\n  async rollGlitchDice() {\n    if (this.param.glitch > 0) {\n      // using dgcs=0 allows to roll dice for glitch, but to have them count as 0 successes\n      this.subrolls.glitch = new Roll(`${this.param.glitch}d6cf=1[${ROLL_THEME['glitch']}]`);\n      await this.subrolls.glitch.evaluate({ async: true });\n      this.subrolls.glitch.dice[0].options.appearance = { colorset: GLITCH_COLORSET };\n      this.glitch = this.subrolls.glitch.terms[0].results.filter((it) => it.result == 1).length;\n      this.glitchOutcome = this.glitch > 0 ? 'glitch' : 'nothing';\n      this.totalGlitch += this.glitch;\n    }\n  }\n\n  async rollAnarchyRisk() {\n    if (this.param.risk > 0) {\n      this.subrolls.risk = new Roll(`${this.param.risk}drcs>=5[${ROLL_THEME['anarchyRisk']}]`);\n      await this.subrolls.risk.evaluate({ async: true });\n      this.subrolls.risk.dice[0].options.appearance = { colorset: RISK_COLORSET };\n      this.riskGlitch = this.subrolls.risk.terms[0].results.filter((it) => it.result == 1).length;\n      this.riskProwess += this.subrolls.risk.terms[0].results.filter((it) => it.result >= 5).length;\n      if (this.subrolls.risk.total > 0) {\n        this.total++;\n      }\n      this.riskOutcome =\n        this.riskProwess > 0 ? 'prowess' : this.riskGlitch > 0 ? 'glitch' : 'nothing';\n      this.totalGlitch += this.riskGlitch;\n    }\n  }\n\n  async toMessage(messageData, options) {\n    options = foundry.utils.mergeObject(options ?? {}, { create: true });\n    return await this.toGroupedRoll().toMessage(messageData, options);\n  }\n\n  toGroupedRoll() {\n    let index = 1;\n    let rolls = [];\n\n    this._addRoll(rolls, this.subrolls.pool);\n    this._addRoll(rolls, this.subrolls.reroll);\n    this._addRoll(rolls, this.subrolls.removed);\n    this._addRoll(rolls, this.subrolls.rerollForced);\n    this._addRoll(rolls, this.subrolls.risk);\n    this._addRoll(rolls, this.subrolls.glitch);\n\n    rolls.forEach((r) => (r.dice[0].options.rollOrder = index++));\n\n    return Roll.fromTerms([PoolTerm.fromRolls(rolls)]);\n  }\n\n  _addRoll(rolls, roll) {\n    if (roll) {\n      rolls.push(roll);\n    }\n  }\n\n  async _displayDice(roll) {\n    if (roll) {\n      game.dice3d?.showForRoll(roll);\n    }\n  }\n\n  get hits() {\n    return this.total;\n  }\n\n  get pool() {\n    return this.param?.pool ?? 0;\n  }\n}\n","import { ANARCHY_SYSTEM, LOG_HEAD, SYSTEM_NAME, TEMPLATE } from './constants.js';\nimport { ANARCHY_SKILLS } from './skills.js';\nimport { ANARCHY_HOOKS, HooksManager } from './hooks-manager.js';\nimport { Misc } from './misc.js';\nimport { AttributeActions } from './attribute-actions.js';\n\nexport const DECLARE_MIGRATIONS = 'anarchy-declareMigration';\nconst SYSTEM_MIGRATION_CURRENT_VERSION = 'systemMigrationVersion';\n\nexport class Migration {\n  get code() {\n    return 'sample';\n  }\n\n  get version() {\n    return '0.0.0';\n  }\n\n  async migrate() {\n    return () => {};\n  }\n\n  async applyItemsUpdates(computeUpdates) {\n    await game.actors.forEach(async (actor) => {\n      const actorItemUpdates = computeUpdates(actor.items);\n      if (actorItemUpdates.length > 0) {\n        console.log(this.code, `Applying updates on actor ${actor.name} items`, actorItemUpdates);\n        await actor.updateEmbeddedDocuments('Item', actorItemUpdates);\n      }\n    });\n\n    const itemUpdates = computeUpdates(game.items);\n    if (itemUpdates.length > 0) {\n      console.log(this.code, 'Applying updates on items', itemUpdates);\n      await Item.updateDocuments(itemUpdates);\n    }\n  }\n}\n\nclass _0_3_1_MigrationMoveWordsInObjects extends Migration {\n  get version() {\n    return '0.3.1';\n  }\n  get code() {\n    return 'move-words-in-objects';\n  }\n\n  async migrate() {\n    game.actors.forEach(async (actor) => {\n      await actor.update({\n        ['system.keywords']: this._createWordObject(actor.system.keywords),\n        ['system.cues']: this._createWordObject(actor.system.cues),\n        ['system.dispositions']: this._createWordObject(actor.system.dispositions),\n      });\n    });\n  }\n\n  _createWordObject(current) {\n    return Misc.reindexIds((current ?? []).map((k) => this._keywordToObject(k)));\n  }\n  _keywordToObject(k) {\n    if (k instanceof String) {\n      return { word: k };\n    }\n    return k;\n  }\n}\n\nclass _0_3_8_MigrateWeaponDamage extends Migration {\n  get version() {\n    return '0.3.8';\n  }\n  get code() {\n    return 'migrate-weapons-strength-damage';\n  }\n\n  async migrate() {\n    const isStrengthDamageItem = (it) => it.type == TEMPLATE.itemType.weapon && it.system.strength;\n    const fixItemDamage = (it) => {\n      return {\n        _id: it.id,\n        'system.damageAttribute': TEMPLATE.attributes.strength,\n        'system.strength': undefined,\n      };\n    };\n\n    this.applyItemsUpdates((items) => items.filter(isStrengthDamageItem).map(fixItemDamage));\n  }\n}\n\nclass _0_3_14_MigrateSkillDrainConvergence extends Migration {\n  get version() {\n    return '0.3.14';\n  }\n  get code() {\n    return 'migrate-skill-drain-convergence';\n  }\n\n  async migrate() {\n    const withDrain = ANARCHY_SKILLS.filter((it) => it.hasDrain).map((it) => it.code);\n    const hasDrain = (it) =>\n      it.type == TEMPLATE.itemType.skill && withDrain.includes(it.system.code);\n    const setDrain = (it) => {\n      return { _id: it.id, 'system.hasDrain': true };\n    };\n\n    const withConvergence = ANARCHY_SKILLS.filter((it) => it.hasConvergence).map((it) => it.code);\n    const hasConvergence = (it) =>\n      it.type == TEMPLATE.itemType.skill && withConvergence.includes(it.system.code);\n    const setConvergence = (it) => {\n      return { _id: it.id, 'system.hasConvergence': true };\n    };\n\n    const computeUpdates = (items) =>\n      items.filter(hasDrain).map(setDrain).concat(items.filter(hasConvergence).map(setConvergence));\n\n    await this.applyItemsUpdates(computeUpdates);\n  }\n}\n\nclass _0_4_0_SelectWeaponDefense extends Migration {\n  get version() {\n    return '0.4.0';\n  }\n  get code() {\n    return 'migrate-select-weapon-defense';\n  }\n\n  async migrate() {\n    const findWeaponSkillWithDefense = (weapon) =>\n      ANARCHY_SKILLS.find((it) => it.defense && it.code == weapon.system.skill);\n    const setDefense = (weapon) => {\n      return {\n        _id: weapon.id,\n        'system.defense': AttributeActions.fixedDefenseCode(\n          findWeaponSkillWithDefense(weapon)?.defense,\n        ),\n      };\n    };\n\n    await this.applyItemsUpdates((items) =>\n      items\n        .filter((it) => it.isWeapon())\n        .filter(findWeaponSkillWithDefense)\n        .map(setDefense),\n    );\n  }\n}\n\nclass _0_5_0_MigrationBaseResistanceIsZero extends Migration {\n  get version() {\n    return '0.5.0';\n  }\n  get code() {\n    return 'base-resistance-is-zero';\n  }\n\n  async migrate() {\n    game.actors.forEach(async (actor) => await actor.update(this._resistanceUpdates(actor)));\n  }\n\n  _resistanceUpdates(actor) {\n    const updates = {};\n    Object.entries(actor.system.monitors).forEach((kv) => {\n      if (kv[1].resistance) {\n        updates[`system.monitors.${kv[0]}.resistance`] = 0;\n      }\n    });\n    return updates;\n  }\n}\n\nclass _0_6_0_MigrateSkillSocial extends Migration {\n  get version() {\n    return '0.6.0';\n  }\n  get code() {\n    return 'migrate-skill-social';\n  }\n\n  async migrate() {\n    const socialSkills = ANARCHY_SKILLS.filter((it) => it.isSocial).map((it) => it.code);\n    const isSocial = (it) =>\n      it.type == TEMPLATE.itemTypeskill && socialSkills.includes(it.system.code);\n    const setSocial = (it) => {\n      return { _id: it.id, 'system.isSocial': true };\n    };\n    await this.applyItemsUpdates((items) => items.filter(isSocial).map(setSocial));\n  }\n}\n\nclass _11_1_0_MigrateAndWarnAboutDefenseModifiers extends Migration {\n  get version() {\n    return '11.1.0';\n  }\n  get code() {\n    return 'migrate-defense-roll-modifiers';\n  }\n\n  constructor() {\n    super();\n    this.isDefenseModifier = (modifier) =>\n      modifier.group == 'roll' && modifier.category == 'defense';\n    this.isCorrespondingActionModifier = (modifier, defense) =>\n      modifier.group == 'roll' &&\n      modifier.effect == defense.effect &&\n      modifier.category == 'attributeAction' &&\n      modifier.subCategory == defense.subCategory;\n    this.hasDefenseModifiers = (it) =>\n      (it.system.modifiers ?? []).filter(this.isDefenseModifier).length > 0;\n  }\n\n  async migrate() {\n    const actualUpdates = [];\n    await this.applyItemsUpdates((items) => {\n      const itemsWithDefenseModifiers = items.filter(this.hasDefenseModifiers);\n      return itemsWithDefenseModifiers.map((item) =>\n        this.getItemModifiersUpdate(item, actualUpdates),\n      );\n    });\n    if (actualUpdates.length > 0)\n      ChatMessage.create({\n        whisper: ChatMessage.getWhisperRecipients('GM'),\n        content:\n          `${this.version} - Migration of defense modifiers:<ul>` +\n          actualUpdates.reduce((a, b) => a + b) +\n          `</ul></li>`,\n      });\n  }\n\n  getItemModifiersUpdate(item, actualUpdates) {\n    const itemNotes = [];\n    function addNote(action, d, m) {\n      itemNotes.push(\n        `<li> ${action}: ${d.group}/${d.effect}/${d.subCategory} : ${d.category}/${d.value} ${d.condition} => ${m.category}/${m.value} ${m.condition}</li>`,\n      );\n    }\n\n    const newModifiers = {};\n    item.system.modifiers.forEach((m) => (newModifiers[m.id] = duplicate(m)));\n\n    Object.values(newModifiers)\n      .filter((m) => this.isDefenseModifier(m))\n      .forEach((defense) => {\n        const oldDefense = duplicate(defense);\n        let actionAttributes = Object.values(newModifiers).filter((other) =>\n          this.isCorrespondingActionModifier(other, defense),\n        );\n        switch (actionAttributes.length) {\n          case 0: {\n            defense.category = ANARCHY_SYSTEM.rollType.attributeAction;\n            addNote('Changed category', oldDefense, defense);\n            break;\n          }\n          case 1: {\n            const other = actionAttributes[0];\n            foundry.utils.mergeObject(\n              other,\n              {\n                value: Math.max(defense.value, other.value),\n                condition: other.condition\n                  ? other.condition + (defense.condition ?? '')\n                  : defense.condition,\n              },\n              { overwrite: true },\n            );\n            delete newModifiers[defense.id];\n            addNote('Merged with existing', defense, other);\n            break;\n          }\n          default: {\n            delete newModifiers[defense.id];\n            addNote('Removed', defense, { category: '-', value: '-', condition: '-' });\n            break;\n          }\n        }\n      });\n    if (itemNotes.length > 0) {\n      actualUpdates.push(`<li> ${item.actor ? item.actor.name : '-standalone-'} Item ${item.name} modifiers changed:\n        <ul>${itemNotes.reduce(Misc.joiner())}</ul>\n        </li>`);\n    }\n    return { _id: item.id, 'system.modifiers': Object.values(newModifiers) };\n  }\n}\n\nclass _11_1_9_MigrateVehicleHandlingToAttribute extends Migration {\n  get version() {\n    return '11.1.9';\n  }\n  get code() {\n    return 'migrate-vehicle-handling';\n  }\n\n  async migrate() {\n    game.actors\n      .filter((it) => it.isVehicle())\n      .forEach(async (actor) => await actor._migrateHandlingToAttribute());\n  }\n}\n\nclass _11_1_12_MigrateBackWords extends Migration {\n  get version() {\n    return '11.1.12';\n  }\n  get code() {\n    return 'migrate-back-words';\n  }\n  async migrate() {\n    game.actors.forEach(async (actor) => {\n      await actor.update({\n        ['system.keywords']: this._migrateBackWords(actor.system.keywords),\n        ['system.cues']: this._migrateBackWords(actor.system.cues),\n        ['system.dispositions']: this._migrateBackWords(actor.system.dispositions),\n      });\n    });\n  }\n\n  _migrateBackWords(current) {\n    if (current) {\n      return Misc.reindexIds(current.map((k) => this._migrateBackWord(k)));\n    }\n    return [];\n  }\n\n  _migrateBackWord(k) {\n    while (k.word != undefined && !Misc.isString(k.word)) {\n      k = k.word;\n    }\n    return k;\n  }\n}\n\nclass _11_1_16_MigrateSkillsAttributes extends Migration {\n  get version() {\n    return '11.1.16';\n  }\n  get code() {\n    return 'migrate-skills-attributes';\n  }\n  async migrate() {\n    this.applyItemsUpdates((items) =>\n      items\n        .filter((it) => it.type == TEMPLATE.itemType.skill)\n        .filter((it) => it.system.attribute == '' || it.system.code == '')\n        .map((it) => {\n          return {\n            _id: it.id,\n            'system.attribute': '',\n            'system.code': TEMPLATE.attributes.knowledge,\n          };\n        }),\n    );\n  }\n}\n\nclass _12_0_1_MigrateChatMessageFlags extends Migration {\n  get version() {\n    return '12.0.1';\n  }\n  get code() {\n    return 'migrate-chatmessage-flags-messagedata';\n  }\n  async migrate() {\n    await Promise.all(\n      game.messages.map(async (message) => {\n        const json = message.getFlag(SYSTEM_SCOPE, MESSAGE_DATA);\n        if (json) {\n          await message.setFlag(SYSTEM_SCOPE, MESSAGE_DATA, JSON.parse(json));\n        }\n      }),\n    );\n  }\n}\n\nclass _12_0_4_MigrateWeaponDrain extends Migration {\n  get version() {\n    return '12.0.2';\n  }\n  get code() {\n    return 'migrate-weapon-drain';\n  }\n  async migrate() {\n    this.applyItemsUpdates((items) =>\n      items\n        .filter((it) => (it.type = TEMPLATE.itemType.weapon))\n        .filter((it) => it.hasDrain)\n        .map((it) => {\n          return {\n            _id: it.id,\n            'system.drain': 1,\n          };\n        }),\n    );\n  }\n}\n\nexport class Migrations {\n  constructor() {\n    HooksManager.register(ANARCHY_HOOKS.DECLARE_MIGRATIONS);\n\n    Hooks.once(ANARCHY_HOOKS.DECLARE_MIGRATIONS, (addMigrations) =>\n      addMigrations(\n        new _0_3_1_MigrationMoveWordsInObjects(),\n        new _0_3_8_MigrateWeaponDamage(),\n        new _0_3_14_MigrateSkillDrainConvergence(),\n        new _0_4_0_SelectWeaponDefense(),\n        new _0_5_0_MigrationBaseResistanceIsZero(),\n        new _0_6_0_MigrateSkillSocial(),\n        new _11_1_0_MigrateAndWarnAboutDefenseModifiers(),\n        new _11_1_9_MigrateVehicleHandlingToAttribute(),\n        new _11_1_12_MigrateBackWords(),\n        new _11_1_16_MigrateSkillsAttributes(),\n        new _12_0_1_MigrateChatMessageFlags(),\n        new _12_0_4_MigrateWeaponDrain(),\n      ),\n    );\n\n    game.settings.register(SYSTEM_NAME, SYSTEM_MIGRATION_CURRENT_VERSION, {\n      name: 'System Migration Version',\n      scope: 'world',\n      config: false,\n      type: String,\n      default: '0.0.0',\n    });\n  }\n\n  migrate() {\n    const currentVersion = game.settings.get(SYSTEM_NAME, SYSTEM_MIGRATION_CURRENT_VERSION);\n    if (foundry.utils.isNewerVersion(game.system.version, currentVersion)) {\n      //if (true) {\n      let migrations = [];\n      Hooks.callAll(\n        ANARCHY_HOOKS.DECLARE_MIGRATIONS,\n        (...addedMigrations) =>\n          (migrations = migrations.concat(\n            addedMigrations.filter((m) => foundry.utils.isNewerVersion(m.version, currentVersion)),\n          )),\n      );\n      Hooks.off(ANARCHY_HOOKS.DECLARE_MIGRATIONS, () => {});\n\n      if (migrations.length > 0) {\n        migrations.sort((a, b) =>\n          foundry.utils.isNewerVersion(a.version, b.version)\n            ? 1\n            : foundry.utils.isNewerVersion(b.version, a.version)\n              ? -1\n              : 0,\n        );\n        migrations.forEach(async (m) => {\n          ui.notifications.info(\n            `Executing migration ${m.code}: version ${currentVersion} is lower than ${m.version}`,\n          );\n          await m.migrate();\n        });\n        ui.notifications.info(`Migrations done, version will change to ${game.system.version}`);\n      } else {\n        console.log(\n          LOG_HEAD + `No migration needeed, version will change to ${game.system.version}`,\n        );\n      }\n      game.settings.set(SYSTEM_NAME, SYSTEM_MIGRATION_CURRENT_VERSION, game.system.version);\n    } else {\n      console.log(LOG_HEAD + `No system version changed`);\n    }\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { TEMPLATES_PATH } from '../constants.js';\nimport { Misc } from '../misc.js';\nimport { Modifiers } from '../modifiers/modifiers.js';\n\nconst HBS_TEMPLATE_CHAT_CELEBRITY_ROLL = `${TEMPLATES_PATH}/chat/celebrity-roll.hbs`;\n\nexport class RollCelebrity extends Dialog {\n  static async create(actor) {\n    const rollData = {\n      actor: actor,\n      celebrity: {\n        labelkey: ANARCHY.actor.celebrity,\n        value: actor.getCelebrityValue(),\n      },\n      modifiers: foundry.utils.mergeObject(\n        { labelkey: ANARCHY.item.tabs.modifiers },\n        Modifiers.computeModifiers(actor.items, 'other', 'celebrity'),\n      ),\n      other: {\n        labelkey: ANARCHY.common.roll.modifiers.other,\n        value: 0,\n      },\n      ANARCHY: ANARCHY,\n    };\n\n    const title = await foundry.applications.handlebars.renderTemplate(\n      `${TEMPLATES_PATH}/dialog/roll-celebrite-title.hbs`,\n      rollData,\n    );\n    const html = await foundry.applications.handlebars.renderTemplate(\n      `${TEMPLATES_PATH}/dialog/roll-celebrite.hbs`,\n      rollData,\n    );\n    new RollCelebrity(title, html, rollData).render(true);\n  }\n\n  constructor(title, html, roll) {\n    const config = {\n      title: title,\n      content: html,\n      default: 'roll',\n      buttons: {\n        roll: {\n          label: game.i18n.localize(ANARCHY.common.roll.button),\n          callback: async () => RollCelebrity.doRoll(roll),\n        },\n      },\n    };\n    const options = {\n      classes: [game.system.anarchy.styles.selectCssClass(), 'anarchy-dialog'],\n      width: 400,\n      height: 'fit-content',\n      'z-index': 99999,\n    };\n\n    super(config, options);\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n    this.bringToTop();\n    html.find('.input-celebrity-other').on('input', (event) => {\n      this.roll.other.value = Number.parseInt(event.currentTarget.value) ?? 0;\n    });\n  }\n\n  static async doRoll(rollData) {\n    const parameters = [rollData.celebrity, rollData.modifiers, rollData.other];\n    const pool = Misc.sumValues(parameters, (it) => it.value);\n    const hbsCelebrityRoll = {\n      actor: rollData.actor,\n      parameters: parameters,\n      pool: pool,\n      options: {\n        classes: [game.system.anarchy.styles.selectCssClass()],\n      },\n      ANARCHY: ANARCHY,\n    };\n    const roll = new Roll(`${pool}d6cs>=5`);\n    await roll.evaluate();\n\n    const flavor = await foundry.applications.handlebars.renderTemplate(\n      HBS_TEMPLATE_CHAT_CELEBRITY_ROLL,\n      hbsCelebrityRoll,\n    );\n    await roll.toMessage({ flavor: flavor });\n  }\n\n  // async roll() {\n  //   const parameters = [\n  //     this.roll.celebrity,\n  //     this.roll.modifiers,\n  //     this.roll.other\n  //   ];\n  //   const pool = Misc.sumValues(parameters, it => it.value);\n  //   const hbsCelebrityRoll = {\n  //     actor: this.roll.actor,\n  //     parameters: parameters,\n  //     pool: pool,\n  //     options: {\n  //       classes: [game.system.anarchy.styles.selectCssClass()]\n  //     },\n  //     ANARCHY: ANARCHY\n  //   }\n  //   const roll = new Roll(`${pool}d6cs>=5`);\n  //   await roll.evaluate();\n\n  //   const flavor = await renderTemplate(HBS_TEMPLATE_CHAT_CELEBRITY_ROLL, hbsCelebrityRoll);\n  //   await roll.toMessage({ flavor: flavor });\n  // }\n}\n","import { ANARCHY } from '../config.js';\nimport { TEMPLATE, TEMPLATES_PATH } from '../constants.js';\nimport { AnarchyBaseActor } from './base-actor.js';\nimport { ErrorManager } from '../error-manager.js';\nimport { Misc } from '../misc.js';\nimport { Modifiers } from '../modifiers/modifiers.js';\nimport { Checkbars, DEFAULT_CHECKBARS } from '../common/checkbars.js';\nimport { RollCelebrity } from '../dialog/roll-celebrity.js';\nimport { ANARCHY_HOOKS } from '../hooks-manager.js';\nimport { MATRIX, Matrix, NO_MATRIX_MONITOR } from '../matrix-helper.js';\n\nconst HBS_TEMPLATE_ACTOR_DRAIN = `${TEMPLATES_PATH}/chat/actor-drain.hbs`;\nconst HBS_TEMPLATE_ACTOR_SAY_WORD = `${TEMPLATES_PATH}/chat/actor-say-word.hbs`;\n\nexport class CharacterActor extends AnarchyBaseActor {\n  static get initiative() {\n    return (\n      AnarchyBaseActor.initiative + ' + max(@attributes.agility.value, @attributes.logic.value)'\n    );\n  }\n\n  hasOwnAnarchy() {\n    return this.hasPlayerOwner;\n  }\n\n  prepareDerivedData() {\n    this.system.monitors.physical.max = this._getMonitorMax(TEMPLATE.attributes.strength);\n    this.system.monitors.stun.max = this._getMonitorMax(TEMPLATE.attributes.willpower);\n    super.prepareDerivedData();\n    this.system.ignoreWounds = Modifiers.sumModifiers(this.items, 'other', 'ignoreWounds');\n  }\n\n  computePhysicalState() {\n    const maxMonitor =\n      Math.max(this.system.monitors.physical.max, this.system.monitors.stun.max) +\n      this.system.monitors.armor.max;\n    const dead = this.system.monitors.physical.value == this.system.monitors.physical.max;\n    const ko = this.system.monitors.stun.max == this.system.monitors.stun.value;\n    const current =\n      dead || ko\n        ? maxMonitor\n        : Math.max(this.system.monitors.physical.value, this.system.monitors.stun.value) +\n          this.system.monitors.armor.value;\n    return {\n      max: maxMonitor,\n      value: maxMonitor - current,\n    };\n  }\n\n  computeEssence() {\n    // base essence\n    const baseEssence = game.system.anarchy.hooks.callHookMethod(\n      ANARCHY_HOOKS.PROVIDE_BASE_ESSENCE,\n      this,\n    );\n    // spent essence: from cyberware/bioware\n    const spentEssence = Misc.sumValues(\n      this.items.filter((it) => it.type == 'shadowamp').map((it) => Math.abs(it.system.essence)),\n    );\n    // adjustments: from quality (that gives a \"free\" essence point), or essence losses due to vampire\n    const essenceAdjustment = Modifiers.sumModifiers(this.items, 'other', 'essenceAdjustment');\n    return baseEssence + essenceAdjustment - Math.max(0, spentEssence);\n  }\n\n  computeMalusEssence(essence = undefined) {\n    return game.system.anarchy.hooks.callHookMethod(\n      ANARCHY_HOOKS.PROVIDE_MALUS_ESSENCE,\n      this,\n      essence ?? this.computeEssence(),\n    );\n  }\n\n  getAttributes() {\n    return [\n      TEMPLATE.attributes.strength,\n      TEMPLATE.attributes.agility,\n      TEMPLATE.attributes.willpower,\n      TEMPLATE.attributes.logic,\n      TEMPLATE.attributes.charisma,\n      TEMPLATE.attributes.edge,\n    ];\n  }\n\n  getPhysicalAgility() {\n    return TEMPLATE.attributes.agility;\n  }\n\n  getCorrespondingAttribute(attribute) {\n    if (TEMPLATE.attributes.firewall == attribute) {\n      return TEMPLATE.attributes.firewall;\n    }\n    return super.getCorrespondingAttribute(attribute);\n  }\n\n  getMatrixDetails() {\n    const cyberdeck = this.getCyberdeck();\n    if (cyberdeck?.isConnected()) {\n      return {\n        hasMatrix: true,\n        logic: TEMPLATE.attributes.logic,\n        firewall: TEMPLATE.attributes.firewall,\n        monitor: cyberdeck.system.monitors.matrix,\n        overflow: cyberdeck.getMatrixOverflow(),\n        setMatrixMonitor: async (path, value) => cyberdeck.setMatrixMonitor(path, value),\n      };\n    }\n    if (this.isEmerged()) {\n      return {\n        hasMatrix: true,\n        logic: TEMPLATE.attributes.logic,\n        firewall: TEMPLATE.attributes.logic,\n        monitor: this.system.monitors.stun,\n        overflow: TEMPLATE.monitors.physical,\n        setMatrixMonitor: async (path, value) => {\n          if (path == DEFAULT_CHECKBARS.matrix.path) {\n            return await Checkbars.setCheckbar(this, TEMPLATE.monitors.stun, value);\n          }\n        },\n      };\n    }\n    return {\n      hasMatrix: false,\n      logic: TEMPLATE.attributes.logic,\n      firewall: undefined,\n      monitor: NO_MATRIX_MONITOR,\n      overflow: undefined,\n    };\n  }\n\n  isMatrixConnected(mode = undefined) {\n    mode = Matrix.resolveConnectionMode(mode);\n    let connectionMode = undefined;\n    const cyberdeck = this.getCyberdeck();\n    if (cyberdeck?.isConnected()) {\n      connectionMode = cyberdeck.getConnectionMode();\n    }\n    if (!connectionMode && this.isEmerged()) {\n      connectionMode = this.system.connectionMode;\n    }\n    if (mode == undefined) {\n      return Matrix.resolveConnectionMode(connectionMode) != MATRIX.connectionMode.disconnected;\n    }\n    return Matrix.resolveConnectionMode(connectionMode) == mode;\n  }\n  async nextConnectionMode(cyberdeck) {\n    if (cyberdeck) {\n      await cyberdeck.nextConnectionMode();\n    } else if (this.isEmerged()) {\n      const newConnectionMode = Matrix.getNextConnectionMode(this.system.connectionMode);\n      await this.update({ 'system.connectionMode': newConnectionMode });\n    }\n  }\n\n  prepareMatrixMonitor() {\n    const cyberdeck = this.getCyberdeck();\n    if (cyberdeck) {\n      cyberdeck.system.monitors.matrix.maxBonus = Modifiers.sumMonitorModifiers(\n        this.items,\n        'matrix',\n        'max',\n      );\n      cyberdeck.system.monitors.matrix.resistanceBonus = Modifiers.sumMonitorModifiers(\n        this.items,\n        'matrix',\n        'resistance',\n      );\n    }\n  }\n\n  getDamageMonitor(damageType) {\n    switch (damageType) {\n      case TEMPLATE.monitors.stun:\n      case TEMPLATE.monitors.physical:\n        return damageType;\n    }\n    return super.getDamageMonitor(damageType);\n  }\n\n  async createWord(wordType, added) {\n    this._mutateWords(wordType, (values) => values.concat([{ word: added, audio: '' }]));\n  }\n\n  async sayWord(wordType, wordId) {\n    const wordsToSay = this.getWord(wordType, wordId)?.word;\n    if (wordsToSay) {\n      ChatMessage.create({\n        speaker: { alias: this.token?.name ?? this.name },\n        content: await foundry.applications.handlebars.renderTemplate(HBS_TEMPLATE_ACTOR_SAY_WORD, {\n          actor: this,\n          wordsToSay: wordsToSay,\n        }),\n      });\n    }\n  }\n\n  getWord(wordType, wordId) {\n    return wordType ? this.system[wordType].find((it) => it.id == wordId) : undefined;\n  }\n\n  async updateWord(wordType, id, updated) {\n    this._applyWordUpdate(wordType, id, (it) =>\n      foundry.utils.mergeObject(it, { word: updated }, { overwrite: true }),\n    );\n  }\n\n  async _applyWordUpdate(wordType, id, updateFunction) {\n    this._mutateWords(wordType, (values) =>\n      values.map((it) => {\n        if (it.id == id) {\n          updateFunction(it);\n        }\n        return it;\n      }),\n    );\n  }\n\n  async deleteWord(wordType, deletedId) {\n    this._mutateWords(wordType, (values) => values.filter((it) => it.id != deletedId));\n  }\n\n  async _mutateWords(wordType, mutate = (values) => values) {\n    if (!wordType) {\n      return;\n    }\n    let newValues = mutate(this.system[wordType]);\n    Misc.reindexIds(newValues);\n    await this.update({ [`system.${wordType}`]: newValues });\n  }\n\n  getCelebrityValue() {\n    return this.system.counters.social.celebrity.value;\n  }\n  getCredibilityValue() {\n    return this.system.counters.social.credibility.value;\n  }\n  getRumorValue() {\n    return this.system.counters.social.rumor.value;\n  }\n\n  getAnarchy() {\n    if (this.hasOwnAnarchy()) {\n      return {\n        value: this.system.counters.anarchy.value,\n        max: this.system.counters.anarchy.max,\n        scene: this.getAnarchyScene(),\n      };\n    }\n    return super.getAnarchy();\n  }\n\n  getAnarchyScene() {\n    return this.system.counters.sceneAnarchy.value ?? 0;\n  }\n\n  async spendAnarchy(count) {\n    if (count > 0) {\n      const sceneAnarchy = this.getAnarchyScene();\n      const currentAnarchy = this.getAnarchyValue();\n      ErrorManager.checkSufficient(\n        ANARCHY.actor.counters.anarchy,\n        count,\n        currentAnarchy + sceneAnarchy,\n      );\n\n      const useSceneAnarchy = Math.min(sceneAnarchy, count);\n      const useAnarchy = count - useSceneAnarchy;\n\n      if (useSceneAnarchy > 0) {\n        Checkbars.addCounter(this, TEMPLATE.monitors.sceneAnarchy, -useSceneAnarchy);\n      }\n      if (this.hasPlayerOwner) {\n        await game.system.anarchy.gmAnarchy.actorGivesAnarchyToGM(this, count);\n        Checkbars.addCounter(this, TEMPLATE.monitors.anarchy, -useAnarchy);\n      } else if (useAnarchy > 0) {\n        super.spendAnarchy(useAnarchy);\n      }\n    }\n  }\n\n  canUseEdge() {\n    return true;\n  }\n\n  getWounds() {\n    const wounds =\n      Misc.divint(this.system.monitors.stun.value, 3) +\n      Misc.divint(this.system.monitors.physical.value, 3);\n    return Math.max(0, wounds - this.system.ignoreWounds);\n  }\n\n  canPilotVehicle() {\n    return true;\n  }\n\n  canSetMarks() {\n    return this.getCyberdeck()?.isConnected() || this.isEmerged();\n  }\n\n  canReceiveMarks() {\n    return this.getCyberdeck()?.isConnected();\n  }\n\n  isEmerged() {\n    return this.system.capacity == TEMPLATE.capacities.emerged;\n  }\n\n  getCyberdeck() {\n    return this.items.find((it) => it.isActive() && it.isCyberdeck());\n  }\n\n  async rollDrain(drain) {\n    if (drain) {\n      const rollDrain = new Roll(\n        `${drain}dgcf=1[${game.i18n.localize(ANARCHY.common.roll.rollTheme.drain)}]`,\n      );\n      await rollDrain.evaluate({ async: true });\n      await this.sufferDrain(rollDrain.total);\n\n      const flavor = await foundry.applications.handlebars.renderTemplate(\n        HBS_TEMPLATE_ACTOR_DRAIN,\n        {\n          ANARCHY: ANARCHY,\n          actor: this,\n          drain: rollDrain.total,\n          options: {\n            classes: game.system.anarchy.styles.selectCssClass(),\n          },\n        },\n      );\n      await rollDrain.toMessage({ flavor: flavor });\n    }\n  }\n\n  async sufferDrain(drain) {\n    if (drain != 0) {\n      await this.addCounter(TEMPLATE.monitors.stun, drain);\n    }\n  }\n\n  async rollConvergence(convergence) {\n    if (!convergence) {\n      return;\n    }\n    game.system.anarchy.gmConvergence.rollConvergence(this.id, convergence);\n  }\n\n  async rollCelebrity() {\n    await RollCelebrity.create(this);\n  }\n}\n","import { ICONS_PATH, TEMPLATE } from '../constants.js';\nimport { AnarchyBaseActor } from './base-actor.js';\n\nconst DEVICE_ATTRIBUTES = [TEMPLATE.attributes.system, TEMPLATE.attributes.firewall];\nexport class DeviceActor extends AnarchyBaseActor {\n  static get defaultIcon() {\n    return `${ICONS_PATH}/actors/cctv-camera.svg`;\n  }\n\n  static get initiative() {\n    return AnarchyBaseActor.initiative + ' + @attributes.system.value';\n  }\n\n  getMatrixDetails() {\n    return {\n      hasMatrix: true,\n      logic: TEMPLATE.attributes.system,\n      firewall: TEMPLATE.attributes.firewall,\n      monitor: this.system.monitors.matrix,\n      overflow: undefined,\n    };\n  }\n\n  getAttributes() {\n    return DEVICE_ATTRIBUTES;\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { ICONS_PATH, TEMPLATE } from '../constants.js';\nimport { ErrorManager } from '../error-manager.js';\nimport { AnarchyUsers } from '../users.js';\nimport { AnarchyBaseActor } from './base-actor.js';\n\nconst VEHICLE_ATTRIBUTES = [\n  TEMPLATE.attributes.autopilot,\n  TEMPLATE.attributes.handling,\n  TEMPLATE.attributes.firewall,\n  TEMPLATE.attributes.system,\n];\n\nexport class VehicleActor extends AnarchyBaseActor {\n  static get defaultIcon() {\n    return `${ICONS_PATH}/shadowamps/drone.svg`;\n  }\n\n  static get initiative() {\n    return (\n      AnarchyBaseActor.initiative + ' + max(@attributes.system.value, @attributes.autopilot.value)'\n    );\n  }\n\n  prepareDerivedData() {\n    this.system.monitors.matrix.max = this._getMonitorMax(TEMPLATE.attributes.system);\n    super.prepareDerivedData();\n  }\n\n  computePhysicalState() {\n    return {\n      max: this.system.monitors.structure.max,\n      value: this.system.monitors.structure.max - this.system.monitors.structure.value,\n    };\n  }\n\n  getMatrixDetails() {\n    return {\n      hasMatrix: true,\n      logic: TEMPLATE.attributes.system,\n      firewall: TEMPLATE.attributes.firewall,\n      monitor: this.system.monitors.matrix,\n      overflow: undefined,\n    };\n  }\n\n  getAttributes() {\n    return VEHICLE_ATTRIBUTES;\n  }\n\n  getPhysicalAgility() {\n    return TEMPLATE.attributes.autopilot;\n  }\n\n  getDamageMonitor(damageType) {\n    switch (damageType) {\n      case TEMPLATE.monitors.physical:\n        return TEMPLATE.monitors.structure;\n      case TEMPLATE.monitors.stun:\n        return undefined;\n    }\n    return super.getDamageMonitor(damageType);\n  }\n\n  getRightToDefend() {\n    return CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER;\n  }\n\n  async rollPilotDefense(attack) {\n    const selectedActors = AnarchyUsers.getSelectedActors();\n    ErrorManager.checkOutOfRange(ANARCHY.user.selectedTokenActors, selectedActors.length, 0, 1);\n\n    const character = AnarchyUsers.getPlayerActor(game.user);\n    const vehicleOwner = this.getOwnerActor();\n    const pilot = [...selectedActors, character, vehicleOwner]\n      .filter((actor) => actor?.testUserPermission(game.user, this.getRightToDefend()))\n      .find((actor) => actor?.canPilotVehicle());\n    if (pilot) {\n      return await pilot.rollDefense(attack);\n    } else {\n      ui.notifications.warn(\n        game.i18n.localize(ANARCHY.common.errors.noValidPilotForVehicle, {\n          vehicle: this.name,\n        }),\n      );\n    }\n  }\n  async _migrateHandlingToAttribute(actor) {\n    const fromAttribute = this.system.attributes.handling?.value ?? 0;\n    const fromOldField = this.system.handling;\n    if (fromOldField && fromAttribute < fromOldField) {\n      await this.update({\n        'system.-=handling': null,\n        'system.attributes.handling.value': fromOldField,\n      });\n    }\n  }\n}\n","import { TEMPLATES_PATH } from '../constants.js';\nimport { CharacterBaseSheet } from './character-base-sheet.js';\n\nexport class CharacterActorSheet extends CharacterBaseSheet {\n  get template() {\n    return `${TEMPLATES_PATH}/actor/character.hbs`;\n  }\n\n  /** @override */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      width: 720,\n      height: 700,\n    });\n  }\n}\n","import { AnarchyActorSheet } from './anarchy-actor-sheet.js';\n\nexport class DeviceSheet extends AnarchyActorSheet {\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      width: 450,\n      height: 550,\n    });\n  }\n\n  getData(options) {\n    let hbsData = foundry.utils.mergeObject(super.getData(options), {});\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n  }\n}\n","import { AnarchyActorSheet } from './anarchy-actor-sheet.js';\n\nexport class VehicleSheet extends AnarchyActorSheet {\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      width: 450,\n      height: 550,\n    });\n  }\n\n  getData(options) {\n    let hbsData = foundry.utils.mergeObject(super.getData(options), {});\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n  }\n}\n","import { TEMPLATES_PATH } from '../constants.js';\nimport { CharacterBaseSheet } from './character-base-sheet.js';\n\nexport class CharacterNPCSheet extends CharacterBaseSheet {\n  get template() {\n    return `${TEMPLATES_PATH}/actor/npc-sheet.hbs`;\n  }\n\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      width: 450,\n      height: 550,\n    });\n  }\n\n  getData(options) {\n    let hbsData = super.getData(options);\n    hbsData.options.classes.push('npc-sheet');\n    return hbsData;\n  }\n}\n","import { ICONS_PATH } from '../constants.js';\nimport { AnarchyBaseItem } from './anarchy-base-item.js';\n\nexport class MetatypeItem extends AnarchyBaseItem {\n  static get defaultIcon() {\n    return `${ICONS_PATH}/vitruvian-man.svg`;\n  }\n\n  async onCreateItem(options, id) {\n    this.parent?.removeOtherMetatype(this);\n  }\n}\n","import { ICONS_PATH } from '../constants.js';\nimport { TEMPLATE } from '../constants.js';\nimport { MATRIX, Matrix } from '../matrix-helper.js';\nimport { AnarchyBaseItem } from './anarchy-base-item.js';\n\nexport class CyberdeckItem extends AnarchyBaseItem {\n  static get defaultIcon() {\n    return `${ICONS_PATH}/shadowamps/cyberdeck.svg`;\n  }\n\n  getAttributes() {\n    return [TEMPLATE.attributes.firewall];\n  }\n\n  async setMatrixMonitor(checkbarPath, value) {\n    await this.update({ [checkbarPath]: value });\n  }\n\n  hasMatrixMonitor() {\n    return true;\n  }\n\n  getMatrixMonitor() {\n    return this.system.monitors.matrix;\n  }\n\n  getMatrixOverflow() {\n    switch (this.system.connectionMode) {\n      case MATRIX.connectionMode.virtual:\n        return TEMPLATE.monitors.physical;\n      case MATRIX.connectionMode.augmented:\n        return TEMPLATE.monitors.stun;\n    }\n    return undefined;\n  }\n\n  isConnected() {\n    return this.getMatrixOverflow() != undefined;\n  }\n\n  getConnectionMode() {\n    return this.system.connectionMode;\n  }\n\n  async nextConnectionMode() {\n    const newConnectionMode = Matrix.getNextConnectionMode(this.system.connectionMode);\n    await this.update({ 'system.connectionMode': newConnectionMode });\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { TEMPLATE, TEMPLATES_PATH } from '../constants.js';\nimport { Enums } from '../enums.js';\n\nexport class BaseItemSheet extends foundry.appv1.sheets.ItemSheet {\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      isGM: game.user.isGM,\n      dragDrop: [{ dragSelector: '.item ', dropSelector: null }],\n      classes: [game.system.anarchy.styles.selectCssClass(), 'sheet', 'item-sheet'],\n      tabs: [{ navSelector: '.sheet-tabs', contentSelector: '.sheet-body', initial: 'main' }],\n    });\n  }\n\n  get title() {\n    return game.i18n.localize(ANARCHY.itemType.singular[this.item.type]) + ': ' + this.item.name;\n  }\n\n  get template() {\n    const templatePath = `${TEMPLATES_PATH}/item/${this.item.type}.hbs`;\n    // Validate template path exists for this item type\n    const validItemTypes = [\n      'contact',\n      'cyberdeck',\n      'gear',\n      'metatype',\n      'quality',\n      'shadowamp',\n      'skill',\n      'weapon',\n    ];\n    if (!this.item.type || !validItemTypes.includes(this.item.type)) {\n      console.warn(\n        `BaseItemSheet: Unknown item type '${this.item.type}', falling back to gear template`,\n      );\n      return `${TEMPLATES_PATH}/item/gear.hbs`;\n    }\n    return templatePath;\n  }\n\n  getData(options) {\n    const actorAttributes = this.item.actor?.getAttributes(this.item);\n\n    const usableAttribute = this.item.actor\n      ? (attribute) => actorAttributes.includes(attribute)\n      : (attribute) => true;\n    const withKnowledge = this.item.type == TEMPLATE.itemType.skill;\n\n    let hbsData = foundry.utils.mergeObject(super.getData(options), {\n      options: {\n        isGM: game.user.isGM,\n        owner: this.document.isOwner,\n        isOwned: this.actor != undefined,\n        editable: this.isEditable,\n        cssClass: this.isEditable ? 'editable' : 'locked',\n      },\n      ENUMS: foundry.utils.mergeObject(\n        Enums.getEnums(usableAttribute, withKnowledge),\n        game.system.anarchy.modifiers.getEnums(),\n      ),\n      ANARCHY: ANARCHY,\n    });\n    hbsData.system = this.item.system;\n\n    // Apply UI customizations and theme utilities\n    if (game.system.anarchy?.uiCustomization) {\n      hbsData.uiCustomizations = game.system.anarchy.uiCustomization.getActiveCustomizations();\n      hbsData.options.classes = [\n        ...(hbsData.options.classes || []),\n        ...game.system.anarchy.uiCustomization.getCustomizationClasses('item'),\n      ];\n    }\n\n    // Add theme information\n    if (game.system.anarchy?.themeUtilities) {\n      hbsData.currentTheme = game.system.anarchy.styles.currentTheme;\n      hbsData.availableThemes = game.system.anarchy.styles.availableThemes;\n      hbsData.themeMetadata = game.system.anarchy.themeUtilities.getCurrentThemeMetadata();\n    }\n\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    // Apply UI customizations to rendered sheet\n    if (game.system.anarchy?.uiCustomization) {\n      game.system.anarchy.uiCustomization.applyCustomizationsToElement(html[0], 'item');\n    }\n\n    // Apply theme-specific enhancements\n    if (game.system.anarchy?.themeUtilities) {\n      game.system.anarchy.themeUtilities.applyThemeEnhancements(html[0], 'item');\n    }\n\n    // counters & monitors\n    html.find('a.click-checkbar-element').click(async (event) => await this.onClickMonitor(event));\n\n    html.find('.click-modifier-add').click(async (event) => await this.item.createModifier());\n    html\n      .find('.click-modifier-delete')\n      .click(async (event) => await this.item.deleteModifier(this.getEventModifierId(event)));\n    html\n      .find('.input-modifier-value')\n      .change(\n        async (event) =>\n          await this.item.changeModifierValue(\n            this.getEventModifierId(event),\n            event.currentTarget.value,\n          ),\n      );\n    html\n      .find('.input-modifier-condition')\n      .change(\n        async (event) =>\n          await this.item.changeModifierCondition(\n            this.getEventModifierId(event),\n            event.currentTarget.value,\n          ),\n      );\n    html\n      .find('.select-modifier-change')\n      .change(\n        async (event) =>\n          await this.item.changeModifierSelection(\n            this.getEventModifierId(event),\n            this.getEventModifierSelect(event),\n            event.currentTarget.value,\n          ),\n      );\n  }\n\n  async onClickMonitor(event) {\n    if (this.item.parent) {\n      const monitor = this.getEventMonitorCode(event);\n      const sourceActorId =\n        monitor == 'marks'\n          ? $(event.currentTarget).closest('.anarchy-marks').attr('data-actor-id')\n          : undefined;\n      await this.item.parent.switchMonitorCheck(\n        monitor,\n        this.getEventMonitorIndex(event),\n        this.isEventMonitorChecked(event),\n        sourceActorId,\n        item,\n      );\n    }\n  }\n\n  getEventMonitorCode(event) {\n    return $(event.currentTarget).closest('.checkbar-root').attr('data-monitor-code');\n  }\n\n  getEventMonitorIndex(event) {\n    return Number.parseInt($(event.currentTarget).attr('data-index'));\n  }\n\n  isEventMonitorChecked(event) {\n    return $(event.currentTarget).attr('data-checked') == 'true';\n  }\n\n  getEventModifierId(event) {\n    return $(event.currentTarget).closest('.define-modifier').attr('data-modifier-id');\n  }\n  getEventModifierSelect(event) {\n    return $(event.currentTarget).attr('data-modifier-select');\n  }\n}\n","import { BaseItemSheet } from './base-item-sheet.js';\n\nexport class ContactItemSheet extends BaseItemSheet {\n  getData(options) {\n    let hbsData = super.getData(options);\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n  }\n}\n","import { BaseItemSheet } from './base-item-sheet.js';\n\nexport class CyberdeckItemSheet extends BaseItemSheet {\n  getData(options) {\n    let hbsData = super.getData(options);\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    html.find('a.click-matrix-connectionMode').click(async (event) => {\n      await this.item.nextConnectionMode();\n    });\n    super.activateListeners(html);\n  }\n}\n","import { BaseItemSheet } from './base-item-sheet.js';\n\nexport class GearItemSheet extends BaseItemSheet {\n  getData(options) {\n    let hbsData = super.getData(options);\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n  }\n}\n","import { BaseItemSheet } from './base-item-sheet.js';\n\nexport class MetatypeItemSheet extends BaseItemSheet {\n  getData(options) {\n    let hbsData = super.getData(options);\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n  }\n}\n","import { BaseItemSheet } from './base-item-sheet.js';\n\nexport class QualityItemSheet extends BaseItemSheet {\n  getData(options) {\n    let hbsData = super.getData(options);\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n  }\n}\n","import { BaseItemSheet } from './base-item-sheet.js';\n\nexport class ShadowampItemSheet extends BaseItemSheet {\n  getData(options) {\n    let hbsData = super.getData(options);\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n  }\n}\n","import { BaseItemSheet } from './base-item-sheet.js';\nimport { SkillItem } from './skill-item.js';\n\nexport class SkillItemSheet extends BaseItemSheet {\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    html.find('.select-skill-code').change(async (event) => {\n      const skillCode = event.currentTarget.value;\n      const updates = SkillItem.prepareSkill(skillCode);\n      if (updates) {\n        await this.object.update(updates);\n      }\n    });\n  }\n}\n","import { AttributeActions } from '../attribute-actions.js';\nimport { BaseItemSheet } from './base-item-sheet.js';\n\nexport class WeaponItemSheet extends BaseItemSheet {\n  getData(options) {\n    let hbsData = super.getData(options);\n    hbsData.ENUMS = foundry.utils.mergeObject(\n      { defenses: AttributeActions.getDefenses() },\n      hbsData.ENUMS,\n    );\n    hbsData.hasDrain = this.item.hasDrain;\n    hbsData.hasConvergence = this.item.hasConvergence;\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n\n    html.find('.select-weapon-skill').change(async (event) => {\n      const skillCode = event.currentTarget.value;\n      const skill = game.system.anarchy.skills.get(skillCode);\n      if (skill) {\n        await this.object.update({ 'system.defense': skill.defense }, { render: false });\n      }\n    });\n  }\n}\n","import { ICONS_PATH } from '../constants.js';\nimport { AnarchyBaseItem } from './anarchy-base-item.js';\n\nexport class ContactItem extends AnarchyBaseItem {\n  static get defaultIcon() {\n    return `${ICONS_PATH}/contacts/contact.svg`;\n  }\n}\n","import { ICONS_PATH } from '../constants.js';\nimport { AnarchyBaseItem } from './anarchy-base-item.js';\n\nexport class GearItem extends AnarchyBaseItem {\n  static get defaultIcon() {\n    return `${ICONS_PATH}/gear/gear.svg`;\n  }\n}\n","import { ICONS_PATH } from '../constants.js';\nimport { AnarchyBaseItem } from './anarchy-base-item.js';\n\nexport class QualityItem extends AnarchyBaseItem {\n  static get defaultIcon() {\n    return `${ICONS_PATH}/quality-positive.svg`;\n  }\n}\n","import { ICONS_PATH } from '../constants.js';\nimport { AnarchyBaseItem } from './anarchy-base-item.js';\n\nexport class ShadowampItem extends AnarchyBaseItem {\n  static get defaultIcon() {\n    return `${ICONS_PATH}/shadowamps/other.svg`;\n  }\n}\n","import { Checkbars } from '../common/checkbars.js';\nimport { ANARCHY } from '../config.js';\nimport { SYSTEM_NAME, TEMPLATES_PATH } from '../constants.js';\nimport { RemoteCall } from '../remotecall.js';\n\nconst CONVERGENCES = 'convergences';\nconst SETTING_KEY_CONVERGENCES = `${SYSTEM_NAME}.${CONVERGENCES}`;\nconst ROLL_CONVERGENCE = 'GMConvergence.rollConvergence';\n\nconst HBS_TEMPLATE_CONVERGENCE = `${TEMPLATES_PATH}/app/gm-convergence.hbs`;\nconst HBS_TEMPLATE_CONVERGENCE_ACTORS = `${TEMPLATES_PATH}/app/gm-convergence-actors.hbs`;\nexport class GMConvergence {\n  constructor() {\n    game.settings.register(SYSTEM_NAME, CONVERGENCES, {\n      scope: 'world',\n      config: false,\n      default: [],\n      type: Array,\n    });\n    this.convergences = [];\n    Hooks.on('updateSetting', async (setting, update, options, id) =>\n      this.onUpdateSetting(setting, update, options, id),\n    );\n    Hooks.once('ready', () => this.onReady());\n  }\n\n  async onReady() {\n    await loadTemplates([HBS_TEMPLATE_CONVERGENCE, HBS_TEMPLATE_CONVERGENCE_ACTORS]);\n    this.convergences = game.settings\n      .get(SYSTEM_NAME, CONVERGENCES)\n      .filter((it) => game.actors.get(it.actorId));\n    await RemoteCall.register(ROLL_CONVERGENCE, {\n      callback: (it) => this.rollConvergence(it.actorId, it.convergence),\n      condition: (user) => user.isGM,\n    });\n  }\n\n  getConvergences() {\n    return this.convergences;\n  }\n\n  async rollConvergence(actorId, convergence) {\n    if (!RemoteCall.call(ROLL_CONVERGENCE, { actorId: actorId, convergence: convergence })) {\n      await this._gmRollConvergence(convergence, actorId);\n    }\n  }\n\n  async _gmRollConvergence(convergence, actorId) {\n    const actor = game.actors.get(actorId);\n    const rollConvergence = new Roll(\n      `${convergence}dgcf=1[${game.i18n.localize(ANARCHY.common.roll.rollTheme.convergence)}]`,\n    );\n    await rollConvergence.evaluate({ async: true });\n    this.addConvergence(actor, rollConvergence.total);\n    rollConvergence.toMessage(\n      {\n        user: game.user,\n        whisper: ChatMessage.getWhisperRecipients('GM'),\n        blind: true,\n        flavor: `Convergence for ${actor.name}: ${rollConvergence.total}`,\n      },\n      { rollType: 'blindroll' },\n    );\n  }\n\n  async addConvergence(actor, added) {\n    if (!game.user.isGM || !added) {\n      return;\n    }\n    await this.setActorConvergence(actor, this.getConvergence(actor) + added);\n  }\n\n  getConvergence(actor) {\n    if (!game.user.isGM) {\n      return 0; // undisclosed\n    }\n    return this.convergences.find((it) => it.actorId == actor.id)?.convergence ?? 0;\n  }\n\n  async setActorConvergence(actor, newConvergence) {\n    let c = this.convergences.find((it) => it.actorId == actor.id);\n    if (!c) {\n      c = { actorId: actor.id };\n      this.convergences.push(c);\n    }\n    c.convergence = newConvergence;\n    this.convergences = this.convergences.filter((it) => it.convergence > 0);\n    game.settings.set(SYSTEM_NAME, CONVERGENCES, this.convergences);\n  }\n\n  async activateListeners(html) {\n    this.toolbar = html.find('.gm-convergence-bar');\n    await this._rebuild();\n  }\n\n  async onUpdateSetting(setting, update, options, id) {\n    if (game.user.isGM && setting.key == SETTING_KEY_CONVERGENCES) {\n      await this._rebuild();\n    }\n  }\n\n  async _rebuild() {\n    this.toolbar.find('.gm-convergence-content').replaceWith(await this._renderBar());\n    this.toolbar\n      .find('a.click-checkbar-element')\n      .click(async (event) => await this._onClickConvergence(event));\n  }\n\n  async _onClickConvergence(event) {\n    const monitor = $(event.currentTarget).closest('.checkbar-root').attr('data-monitor-code');\n    const actorId = $(event.currentTarget).closest('.actor-convergence').attr('data-actor-id');\n    const index = Number.parseInt($(event.currentTarget).attr('data-index'));\n    const isChecked = $(event.currentTarget).attr('data-checked') == 'true';\n    const newConvergence = Checkbars.newValue(index, isChecked);\n    const actor = game.actors.get(actorId);\n    await this.setActorConvergence(actor, newConvergence);\n  }\n\n  async _renderBar() {\n    const actorsConvergence = {\n      convergences: this.convergences.map((it) => {\n        return {\n          actor: game.actors.get(it.actorId),\n          convergence: it.convergence,\n        };\n      }),\n    };\n    const html = await renderTemplate(HBS_TEMPLATE_CONVERGENCE_ACTORS, actorsConvergence);\n    return html;\n  }\n}\n","import { Misc } from './misc.js';\nimport { AnarchyUsers } from './users.js';\n\nexport class AnarchyCombat extends Combat {\n  static init() {\n    Hooks.on(\n      'createCombatant',\n      async (combatant, options, id) =>\n        await combatant.combat.onCreateCombatant(combatant, options, id),\n    );\n    Hooks.on(\n      'deleteCombatant',\n      async (combatant, options, id) =>\n        await combatant.combat.onDeleteCombatant(combatant, options, id),\n    );\n    Hooks.on(\n      'deleteCombat',\n      async (combat, options, id) => await combat.onDeleteCombat(options, id),\n    );\n  }\n\n  get initiative() {\n    return { formula: '2d6' };\n  }\n\n  async rollInitiative(ids, options) {\n    const selectedCombatants = ids.map((id) => this.combatants.find((c) => c.id == id));\n    const combatantsByType = Misc.classify(selectedCombatants, (it) => it.actor.type);\n\n    Object.entries(combatantsByType).forEach(async ([type, list]) => {\n      const typeActorClass = game.system.anarchy.actorClasses[type];\n      const typeIds = list.map((it) => it.id);\n      const typeOptions = foundry.utils.mergeObject(\n        { formula: typeActorClass.initiative },\n        options ?? {},\n      );\n      await super.rollInitiative(typeIds, typeOptions);\n    });\n  }\n\n  async onCreateCombatant(combatant, options, id) {\n    if (AnarchyUsers.isUniqueConnectedGM()) {\n      await combatant.actor?.onEnterCombat();\n    }\n  }\n  async onDeleteCombatant(combatant, options, id) {\n    if (AnarchyUsers.isUniqueConnectedGM()) {\n      await this._leaveCombat(combatant);\n    }\n  }\n  async onDeleteCombat(options, id) {\n    if (AnarchyUsers.isUniqueConnectedGM()) {\n      this.combatants.forEach(async (c) => await this._leaveCombat(c));\n    }\n  }\n\n  async _leaveCombat(combatant) {\n    return await combatant.actor?.onLeaveCombat();\n  }\n}\n","import { AnarchyActorSheet } from './anarchy-actor-sheet.js';\n\nexport class ICSheet extends AnarchyActorSheet {\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      width: 450,\n      height: 550,\n    });\n  }\n\n  getData(options) {\n    let hbsData = foundry.utils.mergeObject(super.getData(options), {});\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n  }\n}\n","import { AnarchyActorSheet } from './anarchy-actor-sheet.js';\n\nexport class SpriteActorSheet extends AnarchyActorSheet {\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      width: 450,\n      height: 550,\n    });\n  }\n\n  getData(options) {\n    let hbsData = foundry.utils.mergeObject(super.getData(options), {});\n    return hbsData;\n  }\n\n  activateListeners(html) {\n    super.activateListeners(html);\n  }\n}\n","import { ICONS_PATH, TEMPLATE } from '../constants.js';\nimport { AnarchyBaseActor } from './base-actor.js';\n\nconst SPRITE_ATTRIBUTES = [TEMPLATE.attributes.logic, TEMPLATE.attributes.edge];\n\nexport class SpriteActor extends AnarchyBaseActor {\n  static get defaultIcon() {\n    return `${ICONS_PATH}/misc/rss.svg`;\n  }\n\n  static get initiative() {\n    return AnarchyBaseActor.initiative + ' + @attributes.logic.value';\n  }\n\n  getMatrixDetails() {\n    return {\n      hasMatrix: true,\n      logic: TEMPLATE.attributes.logic,\n      firewall: TEMPLATE.attributes.logic,\n      monitor: this.system.monitors.matrix,\n      overflow: undefined,\n    };\n  }\n\n  getAttributes() {\n    return SPRITE_ATTRIBUTES;\n  }\n\n  isEmerged() {\n    return true;\n  }\n}\n","import { ICONS_PATH, TEMPLATE } from '../constants.js';\nimport { AnarchyBaseActor } from './base-actor.js';\n\nconst IC_ATTRIBUTES = [TEMPLATE.attributes.logic, TEMPLATE.attributes.firewall];\n\nexport class ICActor extends AnarchyBaseActor {\n  static get defaultIcon() {\n    return `${ICONS_PATH}/misc/rub-el-hizb.svg`;\n  }\n\n  static get initiative() {\n    return AnarchyBaseActor.initiative + ' + @attributes.logic.value';\n  }\n\n  getMatrixDetails() {\n    return {\n      hasMatrix: true,\n      logic: TEMPLATE.attributes.logic,\n      firewall: TEMPLATE.attributes.firewall,\n      monitor: this.system.monitors.matrix,\n      overflow: undefined,\n    };\n  }\n\n  canSetMarks() {\n    return false;\n  }\n\n  getAttributes() {\n    return IC_ATTRIBUTES;\n  }\n}\n","import { ANARCHY } from '../config.js';\nimport { TEMPLATES_PATH } from '../constants.js';\nimport { Misc } from '../misc.js';\n\nconst TEMPLATE_HUD_SHORTCUTS = `${TEMPLATES_PATH}/token/hud-shortcuts.hbs`;\n\nexport class HUDShortcuts {\n  constructor() {\n    Hooks.on(\n      'renderTokenHUD',\n      async (tokenHUD, html, tokenHUDData) =>\n        await this.addExtensionHud(tokenHUD, html, tokenHUDData._id),\n    );\n    Hooks.once('ready', () => this.onReady());\n  }\n\n  async onReady() {\n    await loadTemplates([TEMPLATE_HUD_SHORTCUTS]);\n  }\n\n  /* -------------------------------------------- */\n  async removeExtensionHud(app, html, tokenId) {\n    html.find('.control-icon.anarchy-shortcuts').remove();\n  }\n\n  async addExtensionHud(app, html, tokenId) {\n    app.hasExtension = true;\n\n    const hud = await this._renderShortcuts(tokenId);\n    html.find('.control-icon[data-action=combat]').after(hud);\n  }\n\n  async _renderShortcuts(tokenId) {\n    const token = canvas.tokens.get(tokenId);\n    const hbsHudData = {\n      tokenId: tokenId,\n      shortcuts: token.actor.getShortcuts(),\n      options: {\n        classes: [game.system.anarchy.styles.selectCssClass()],\n      },\n    };\n    const html = await foundry.applications.handlebars.renderTemplate(\n      TEMPLATE_HUD_SHORTCUTS,\n      hbsHudData,\n    );\n    const hud = $(html);\n    const list = hud.find('.anarchy-shortcuts-list');\n\n    this._toggleHudActive(hud, list);\n\n    hud.find('.anarchy-shortcuts-toggle').click((event) => {\n      this._toggleHudActive(hud, list);\n    });\n\n    list.find('.anarchy-shortcut-button').click((event) => {\n      const tokenId = $(event.currentTarget)\n        .closest('.anarchy-shortcuts-list')\n        .attr('data-token-id');\n      const shortcutType = $(event.currentTarget).attr('data-shortcut-type');\n      const shortcutId = $(event.currentTarget).attr('data-shortcut-id');\n      this.onClickShortcutButton(tokenId, shortcutType, shortcutId);\n    });\n    return hud;\n  }\n\n  onClickShortcutButton(tokenId, shortcutType, shortcutId) {\n    const token = canvas.tokens.get(tokenId);\n    const actor = token?.actor;\n    if (actor) {\n      const shortcut = actor?.getShortcut(shortcutType, shortcutId);\n      shortcut?.callback(token);\n    } else {\n      ui.notifications.warn(game.i18.localize(ANARCHY.common.errors.noTokenActor));\n    }\n  }\n\n  _toggleHudActive(hud, list) {\n    hud.toggleClass('active');\n    Misc.showControlWhen(list, hud.hasClass('active'));\n  }\n}\n","export class Tokens {\n  static getToken(tokenId) {\n    if (tokenId == undefined) {\n      return undefined;\n    }\n    let token = game.scenes.current?.tokens.get(tokenId);\n    if (token) {\n      return token;\n    }\n    for (let scene of game.scenes) {\n      token = scene.tokens.find((token) => token.id == tokenId);\n      if (token) {\n        return token;\n      }\n    }\n    console.warn('No token found in any scene with id', tokenId);\n    return undefined;\n  }\n}\n","import { ChatManager, CAN_USE_EDGE, MESSAGE_DATA, OWNING_ACTOR } from '../chat/chat-manager.js';\nimport { ANARCHY } from '../config.js';\nimport { TEMPLATES_PATH } from '../constants.js';\nimport { Enums } from '../enums.js';\nimport { Misc } from '../misc.js';\nimport { Tokens } from '../token/tokens.js';\nimport { AnarchyRoll } from './anarchy-roll.js';\nimport { ROLL_PARAMETER_CATEGORY } from './roll-parameters.js';\n\nconst HBS_TEMPLATE_CHAT_ANARCHY_ROLL = `${TEMPLATES_PATH}/chat/anarchy-roll.hbs`;\n\nconst HBS_CHAT_TEMPLATES = [\n  `${TEMPLATES_PATH}/chat/risk-outcome.hbs`,\n  `${TEMPLATES_PATH}/chat/edge-reroll-button.hbs`,\n  `${TEMPLATES_PATH}/chat/anarchy-roll-title.hbs`,\n  `${TEMPLATES_PATH}/chat/parts/actor-image.hbs`,\n  `${TEMPLATES_PATH}/chat/parts/generic-parameter.hbs`,\n  `${TEMPLATES_PATH}/chat/parts/result-mode-weapon.hbs`,\n];\n\nexport class RollManager {\n  constructor() {\n    Hooks.once('ready', () => this.onReady());\n  }\n\n  async onReady() {\n    await loadTemplates(Misc.distinct(HBS_CHAT_TEMPLATES));\n  }\n\n  async roll(roll) {\n    roll.parameters.forEach((p) => {\n      if (p.isUsed != undefined) {\n        p.used = p.isUsed(p);\n      }\n    });\n\n    roll.param = game.system.anarchy.rollParameters.compute(roll.parameters);\n    roll.param.edge = roll.parameters.find(\n      (it) => it.category == ROLL_PARAMETER_CATEGORY.edge && it.used,\n    )\n      ? 1\n      : 0;\n    roll.param.anarchy = roll.parameters.filter((it) => it.flags?.isAnarchy && it.used).length;\n    roll.options.canUseEdge = roll.options.canUseEdge && !roll.param.edge;\n    roll.param.social = {\n      credibility: roll.parameters.find((it) => it.code == 'credibility' && it.used)?.value ?? 0,\n      rumor: roll.parameters.find((it) => it.code == 'rumor' && it.used)?.value ?? 0,\n    };\n    await roll.actor.spendAnarchy(roll.param.anarchy);\n    await roll.actor.spendEdge(roll.param.edge);\n    await roll.actor.spendCredibility(roll.param.social.credibility);\n    await roll.actor.spendRumor(roll.param.social.rumor);\n    await this._roll(roll);\n  }\n\n  async edgeReroll(roll) {\n    roll = RollManager.inflateAnarchyRoll(roll);\n    // TODO: indicate edge was used for reroll\n    roll.options.canUseEdge = false;\n    await roll.actor.spendEdge(1);\n    roll.param[ROLL_PARAMETER_CATEGORY.convergence] = undefined;\n    roll.param[ROLL_PARAMETER_CATEGORY.drain] = undefined;\n    await this._roll(roll);\n  }\n\n  async _roll(roll) {\n    roll.roll = new AnarchyRoll(roll.param);\n    await roll.roll.evaluate();\n    await this._displayRollInChat(roll);\n\n    await roll.actor.rollDrain(roll.param.drain);\n    await roll.actor.rollConvergence(roll.param.convergence);\n\n    await game.system.anarchy.combatManager.manageCombat(roll);\n  }\n\n  async _displayRollInChat(hbsRoll) {\n    hbsRoll.options.classes = [game.system.anarchy.styles.selectCssClass()];\n\n    const flags = {};\n    ChatManager.prepareFlag(flags, MESSAGE_DATA, RollManager.deflateAnarchyRoll(hbsRoll));\n    ChatManager.prepareFlag(flags, CAN_USE_EDGE, hbsRoll.options.canUseEdge);\n    ChatManager.prepareFlag(flags, OWNING_ACTOR, ChatManager.messageActorRights(hbsRoll.actor));\n\n    const flavor = await foundry.applications.handlebars.renderTemplate(\n      HBS_TEMPLATE_CHAT_ANARCHY_ROLL,\n      hbsRoll,\n    );\n    const rollMessage = await hbsRoll.roll.toMessage({ flavor: flavor, flags: flags });\n    hbsRoll.chatMessageId = rollMessage.id;\n  }\n\n  static deflateAnarchyRoll(roll) {\n    if (roll) {\n      roll = deepClone(roll);\n      roll.actor = RollManager._reduceToId(roll.actor);\n      roll.skill = RollManager._reduceToId(roll.skill);\n      roll.skill = RollManager._reduceToId(roll.skill);\n      roll.weapon = RollManager._reduceToId(roll.weapon);\n      roll.item = RollManager._reduceToId(roll.item);\n      roll.parameters = RollManager._reduceParameters(roll.parameters);\n      roll.attackData = undefined;\n      roll.attributes = undefined;\n      roll.ANARCHY = undefined;\n      roll.ENUMS = undefined;\n    }\n    return roll;\n  }\n\n  static inflateAnarchyRoll(roll) {\n    if (roll) {\n      roll = deepClone(roll);\n      roll.actor = RollManager._reloadActorFromId(roll.actor, roll.tokenId);\n      roll.skill = RollManager._reloadItemFromId(roll.actor, roll.skill);\n      roll.item = RollManager._reloadItemFromId(roll.actor, roll.item);\n      roll.weapon = RollManager._reloadItemFromId(roll.actor, roll.weapon);\n      roll.attributes = roll.actor.getUsableAttributes(roll.item);\n      roll.parameters = RollManager._reloadParameters(roll, roll.parameters);\n      roll.ANARCHY = ANARCHY;\n      roll.ENUMS = Enums.getEnums();\n    }\n    return roll;\n  }\n\n  static _reduceToId(document) {\n    return document ? { id: document.id } : undefined;\n  }\n\n  static _reloadActorFromId(actor, tokenId) {\n    const token = Tokens.getToken(tokenId);\n    if (token) {\n      return token.actor;\n    }\n    return actor?.id ? game.actors.get(actor.id) : undefined;\n  }\n\n  static _reloadItemFromId(actor, item) {\n    return actor && item?.id ? actor.items.get(item.id) : undefined;\n  }\n\n  static _reduceParameters(parameters) {\n    return parameters\n      .filter((it) => it.used)\n      .map((it) => {\n        return {\n          code: it.code,\n          value: it.value,\n        };\n      });\n  }\n\n  static _reloadParameters(rollData, parameters) {\n    if (!parameters) {\n      return parameters;\n    }\n    const built = game.system.anarchy.rollParameters.build(rollData);\n    return parameters.map((p) => {\n      const initial = built.find((it) => it.code == p.code) ?? {};\n      return foundry.utils.mergeObject(p, initial, { overwrite: false });\n    });\n  }\n}\n","import { ActorDamageManager } from '../actor/actor-damage.js';\nimport {\n  ChatManager,\n  CAN_USE_EDGE,\n  MESSAGE_DATA,\n  OWNING_ACTOR,\n  PARENT_MESSAGE_ID,\n} from '../chat/chat-manager.js';\nimport { ANARCHY } from '../config.js';\nimport { ANARCHY_SYSTEM, SYSTEM_SCOPE, TEMPLATES_PATH } from '../constants.js';\nimport { RollManager } from '../roll/roll-manager.js';\n\nconst TEMPLATE_INFORM_DEFENDER = `${TEMPLATES_PATH}/combat/inform-defender.hbs`;\n\nexport class CombatManager {\n  async manageCombat(roll) {\n    switch (roll.mode) {\n      case ANARCHY_SYSTEM.rollType.weapon:\n        if (!roll.targeting || roll.roll.total == 0) {\n          return;\n        }\n        roll.targeting.targetedTokenIds?.forEach(\n          async (defenderTokenId) => await this.onAttack(defenderTokenId, roll),\n        );\n        break;\n      case ANARCHY_SYSTEM.rollType.defense:\n        // notify attacker about the defense\n        await this.onDefense(roll);\n        break;\n      case ANARCHY_SYSTEM.rollType.defensePilot:\n        await this.onDefensePilot(roll);\n      // TODO defensePilot: 'defensePilot',\n    }\n  }\n\n  async onAttack(defenderTokenId, attackRoll) {\n    const attackerTokenId = attackRoll.targeting?.attackerTokenId;\n    if (!(defenderTokenId && attackerTokenId)) {\n      return;\n    }\n    await this.displayDefenseChoice(defenderTokenId, attackRoll);\n  }\n\n  async displayDefenseChoice(\n    defenderTokenId,\n    attackRoll,\n    defenseRoll = undefined,\n    defensePilotRoll = undefined,\n  ) {\n    const attackerTokenId = attackRoll.targeting?.attackerTokenId;\n    const defender = this.getTokenActor(defenderTokenId);\n\n    const attackHits = attackRoll.roll.total;\n    const defenseHits = defenseRoll?.roll.total ?? defensePilotRoll?.roll.total ?? 0;\n    const attack = {\n      attackerTokenId: attackerTokenId,\n      defenderTokenId: defenderTokenId,\n      attackRoll: RollManager.deflateAnarchyRoll(attackRoll),\n      defenseRoll: RollManager.deflateAnarchyRoll(defenseRoll),\n      defensePilotRoll: RollManager.deflateAnarchyRoll(defensePilotRoll),\n      attack: {\n        isHit: attackHits > 0 && attackHits >= defenseHits,\n        defense: attackRoll.weapon.getDefense(),\n        pilotCanDefend: defender?.isVehicle(),\n        success: Math.max(0, attackHits - defenseHits),\n        damage: attackRoll.weapon.getDamage(),\n      },\n    };\n    // parent message is the defense, or else the attack: the last roll made.\n    // When defense is made, the attack can't be touched anymore\n    const actionChatMessageIds = [\n      attack.defenseRoll?.chatMessageId,\n      attack.defensePilotRoll?.chatMessageId,\n      attack.attackRoll.chatMessageId,\n    ];\n\n    const flags = {};\n    ChatManager.prepareFlag(\n      flags,\n      OWNING_ACTOR,\n      ChatManager.messageActorRights(defender, defender.getRightToDefend()),\n    );\n    ChatManager.prepareFlag(\n      flags,\n      PARENT_MESSAGE_ID,\n      actionChatMessageIds.find((it) => it != undefined),\n    );\n\n    const notifyMessage = await ChatMessage.create({\n      user: game.user.id,\n      whisper: defender.getAllowedUserIds(defender.getRightToDefend()),\n      content: await foundry.applications.handlebars.renderTemplate(\n        TEMPLATE_INFORM_DEFENDER,\n        foundry.utils.mergeObject(\n          {\n            ANARCHY: ANARCHY,\n            options: { classes: [game.system.anarchy.styles.selectCssClass()] },\n            attacker: this.getTokenActor(attack.attackerTokenId),\n            defender: defender,\n            weapon: attack.attackRoll.weapon,\n          },\n          attack,\n        ),\n      ),\n      flags: flags,\n    });\n    attack.choiceChatMessageId = notifyMessage.id;\n    notifyMessage.setFlag(SYSTEM_SCOPE, MESSAGE_DATA, attack);\n  }\n\n  async onDefense(roll) {\n    this._preventObsoleteChoices(roll);\n    const attackRoll = RollManager.inflateAnarchyRoll(roll.attackRoll);\n    await this.displayDefenseChoice(roll.tokenId, attackRoll, roll);\n  }\n\n  async onDefensePilot(roll) {\n    this._preventObsoleteChoices(roll);\n    const attackRoll = RollManager.inflateAnarchyRoll(roll.attackRoll);\n    await this.displayDefenseChoice(roll.tokenId, attackRoll, roll);\n  }\n\n  _preventObsoleteChoices(roll) {\n    const defenseChoiceChatMessage = game.messages.get(roll.choiceChatMessageId);\n    if (defenseChoiceChatMessage) {\n      // prevent edge on attack, remove the previous defense message\n      const attackChatMessageId =\n        defenseChoiceChatMessage.getFlag(SYSTEM_SCOPE, PARENT_MESSAGE_ID) ?? '';\n      const attackChatMessage = game.messages.get(attackChatMessageId);\n      attackChatMessage?.setFlag(SYSTEM_SCOPE, CAN_USE_EDGE, false);\n      ChatManager.removeChatMessage(roll.choiceChatMessageId);\n    }\n  }\n\n  async onClickDefendAttack(attack) {\n    const defender = this.getTokenActor(attack.defenderTokenId);\n    await defender.rollDefense(attack);\n  }\n  async onClickPilotDefendAttack(attack) {\n    const defender = this.getTokenActor(attack.defenderTokenId);\n    await defender.rollPilotDefense(attack);\n  }\n\n  async onClickApplyAttackDamage(attack) {\n    const attacker = this.getTokenActor(attack.attackerTokenId);\n    const defender = this.getTokenActor(attack.defenderTokenId);\n    const attackRoll = RollManager.inflateAnarchyRoll(attack.attackRoll);\n    await ActorDamageManager.sufferDamage(\n      defender,\n      attack.attack.damage.monitor,\n      attack.attack.damage.value,\n      attack.attack.success,\n      attack.attack.damage.noArmor,\n      attacker,\n      attackRoll.weapon,\n    );\n    this._preventObsoleteChoices(attack);\n  }\n\n  getTokenActor(tokenId) {\n    return canvas.tokens.get(tokenId)?.actor;\n  }\n}\n","import { TEMPLATES_PATH } from '../constants.js';\nimport { CharacterBaseSheet } from './character-base-sheet.js';\n\nexport class CharacterTabbedSheet extends CharacterBaseSheet {\n  get template() {\n    return `${TEMPLATES_PATH}/actor/character-tabbed.hbs`;\n  }\n\n  /** @override */\n  static get defaultOptions() {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      width: 720,\n      height: 700,\n      tabs: [{ navSelector: '.sheet-tabs', contentSelector: '.sheet-body', initial: 'main' }],\n    });\n  }\n\n  getData(options) {\n    let hbsData = super.getData(options);\n    hbsData.options.classes.push('tabbed-sheet');\n    return hbsData;\n  }\n}\n","import { LOG_HEAD, SYSTEM_NAME } from \"../modules/constants.js\";\r\n\r\nfunction resolveIntegrationsEnabled() {\r\n  try {\r\n    const env = (typeof import.meta !== 'undefined' && import.meta && import.meta.env) ? import.meta.env : {};\r\n    const explicit = (env.VITE_ENABLE_INTEGRATIONS ?? '').toString().toLowerCase();\r\n    if (explicit === '1' || explicit === 'true') return true;\r\n    const systemId = (env.VITE_SYSTEM_ID ?? '').toString().trim();\r\n    if (systemId === 'ninjanarchy') return true;\r\n  } catch (_) {\r\n    // ignore\r\n  }\r\n  return false;\r\n}\r\n\r\nexport async function loadIntegrationsIfEnabled() {\r\n  const enabled = resolveIntegrationsEnabled();\r\n  if (!enabled) return;\r\n  console.log(LOG_HEAD + `Loading integrations for ${SYSTEM_NAME}`);\r\n  // Future: dynamically import and initialize integration modules here\r\n  // Example:\r\n  // const { initMyIntegration } = await import('./plugins/my-integration.js');\r\n  // await initMyIntegration();\r\n}\r\n\r\n","import { ANARCHY } from './config.js';\r\nimport { Enums } from './enums.js';\r\nimport { LOG_HEAD, SYSTEM_NAME } from './constants.js';\r\nimport { ChatManager } from './chat/chat-manager.js';\r\nimport { GMAnarchy } from './app/gm-anarchy.js';\r\nimport { GMManager } from './app/gm-manager.js';\r\nimport { HandlebarsManager } from './handlebars-manager.js';\r\nimport { RemoteCall } from './remotecall.js';\r\nimport { Styles } from './styles.js';\r\nimport { ThemeUtilities } from './theme-utilities.js';\r\nimport { UICustomization } from './ui-customization.js';\r\nimport { UICustomizationDialog } from './ui-customization-dialog.js';\r\nimport { UICustomizationCommands } from './ui-customization-commands.js';\r\nimport { PerformanceOptimizer } from './performance-optimizer.js';\r\nimport { AnarchyUsers } from './users.js';\r\nimport { HooksManager } from './hooks-manager.js';\r\nimport { AnarchyDice } from './roll/dice.js';\r\nimport { AnarchyRoll } from './roll/anarchy-roll.js';\r\nimport { Migrations } from './migrations.js';\r\nimport { Skills } from './skills.js';\r\nimport { AnarchyBaseItem } from './item/anarchy-base-item.js';\r\nimport { AnarchyBaseActor } from './actor/base-actor.js';\r\nimport { CharacterActor } from './actor/character-actor.js';\r\nimport { DeviceActor } from './actor/device-actor.js';\r\nimport { VehicleActor } from './actor/vehicle-actor.js';\r\nimport { CharacterActorSheet } from './actor/character-sheet.js';\r\nimport { DeviceSheet } from './actor/device-sheet.js';\r\nimport { VehicleSheet } from './actor/vehicle-sheet.js';\r\nimport { CharacterNPCSheet } from './actor/character-npc-sheet.js';\r\nimport { SkillItem } from './item/skill-item.js';\r\nimport { MetatypeItem } from './item/metatype-item.js';\r\nimport { CyberdeckItem } from './item/cyberdeck-item.js';\r\nimport { WeaponItem } from './item/weapon-item.js';\r\nimport { ContactItemSheet } from './item/contact-item-sheet.js';\r\nimport { CyberdeckItemSheet } from './item/cyberdeck-item-sheet.js';\r\nimport { GearItemSheet } from './item/gear-item-sheet.js';\r\nimport { MetatypeItemSheet } from './item/metatype-item-sheet.js';\r\nimport { QualityItemSheet } from './item/quality-item-sheet.js';\r\nimport { ShadowampItemSheet } from './item/shadowamp-item-sheet.js';\r\nimport { SkillItemSheet } from './item/skill-item-sheet.js';\r\nimport { WeaponItemSheet } from './item/weapon-item-sheet.js';\r\nimport { ContactItem } from './item/contact-item.js';\r\nimport { GearItem } from './item/gear-item.js';\r\nimport { QualityItem } from './item/quality-item.js';\r\nimport { ShadowampItem } from './item/shadowamp-item.js';\r\nimport { Checkbars } from './common/checkbars.js';\r\nimport { RollParameters } from './roll/roll-parameters.js';\r\nimport { RollDialog } from './roll/roll-dialog.js';\r\nimport { GMConvergence } from './app/gm-convergence.js';\r\nimport { AnarchyCombat } from './anarchy-combat.js';\r\nimport { ICSheet } from './actor/ic-sheet.js';\r\nimport { SpriteActorSheet } from './actor/sprite-sheet.js';\r\nimport { SpriteActor } from './actor/sprite-actor.js';\r\nimport { ICActor } from './actor/ic-actor.js';\r\nimport { HUDShortcuts } from './token/hud-shortcuts.js';\r\nimport { CombatManager } from './combat/combat-manager.js';\r\nimport { RollManager } from './roll/roll-manager.js';\r\nimport { CharacterTabbedSheet } from './actor/character-tabbed-sheet.js';\r\nimport { CharacterEnhancedSheet } from './actor/character-enhanced-sheet.js';\r\nimport { Modifiers } from './modifiers/modifiers.js';\r\nimport { ActorDamageManager } from './actor/actor-damage.js';\r\nimport { AttributeActions } from './attribute-actions.js';\r\nimport { DiceCursor } from './roll/dice-cursor.js';\r\nimport { loadIntegrationsIfEnabled } from '../integrations/index.js';\r\n\r\n/* -------------------------------------------- */\r\n/*  Foundry VTT AnarchySystem Initialization    */\r\n/* -------------------------------------------- */\r\n\r\nexport class AnarchySystem {\r\n  static start() {\r\n    const anarchySystem = new AnarchySystem();\r\n    Hooks.once('init', async () => await anarchySystem.onInit());\r\n  }\r\n\r\n  async onInit() {\r\n    console.log(LOG_HEAD + 'AnarchySystem.onInit');\r\n    game.system.anarchy = this;\r\n    this.remoteCall = new RemoteCall(); // initialize remote calls registry first: used by other singleton managers\r\n\r\n    this.actorClasses = {\r\n      character: CharacterActor,\r\n      vehicle: VehicleActor,\r\n      device: DeviceActor,\r\n      sprite: SpriteActor,\r\n      ic: ICActor,\r\n    };\r\n    this.itemClasses = {\r\n      contact: ContactItem,\r\n      cyberdeck: CyberdeckItem,\r\n      gear: GearItem,\r\n      metatype: MetatypeItem,\r\n      quality: QualityItem,\r\n      shadowamp: ShadowampItem,\r\n      skill: SkillItem,\r\n      weapon: WeaponItem,\r\n    };\r\n\r\n    this.hooks = new HooksManager();\r\n    this.styles = new Styles();\r\n    this.themeUtilities = new ThemeUtilities(this.styles);\r\n    this.uiCustomization = new UICustomization(this.styles);\r\n    this.uiCustomizationCommands = new UICustomizationCommands(this.uiCustomization);\r\n    this.performanceOptimizer = new PerformanceOptimizer(this.styles, this.uiCustomization);\r\n    this.handlebarsManager = new HandlebarsManager();\r\n    this.gmAnarchy = new GMAnarchy();\r\n    this.gmConvergence = new GMConvergence();\r\n    Enums.init();\r\n\r\n    this.skills = new Skills();\r\n    this.modifiers = new Modifiers();\r\n    this.rollParameters = new RollParameters();\r\n    this.rollManager = new RollManager();\r\n    this.hudShortcuts = new HUDShortcuts();\r\n    this.combatManager = new CombatManager();\r\n\r\n    console.log(LOG_HEAD + 'AnarchySystem.onInit | loading system');\r\n    CONFIG.ANARCHY = ANARCHY;\r\n    CONFIG.Combat.documentClass = AnarchyCombat;\r\n    CONFIG.Combat.initiative = { formula: '2d6' };\r\n    CONFIG.Actor.documentClass = AnarchyBaseActor;\r\n    CONFIG.Item.documentClass = AnarchyBaseItem;\r\n\r\n    // Detect same-origin proxy: public/index.mjs sets __ANARCHY_PROXY__ when /@vite/client resolves on 30000\r\n    try {\r\n      this.proxyDetected = !!window.__ANARCHY_PROXY__;\r\n    } catch (_) {\r\n      this.proxyDetected = false;\r\n    }\r\n    game.system.anarchy.proxyDetected = this.proxyDetected;\r\n\r\n    // Register Anarchy-first settings\r\n    try {\r\n      game.settings.register(SYSTEM_NAME, 'anarchy-first-mode', {\r\n        scope: 'world',\r\n        config: true,\r\n        name: game.i18n.localize(ANARCHY.settings.anarchyFirstMode.name),\r\n        hint: game.i18n.localize(ANARCHY.settings.anarchyFirstMode.hint),\r\n        default: true,\r\n        type: Boolean,\r\n      });\r\n      game.settings.register(SYSTEM_NAME, 'allow-core-fallback', {\r\n        scope: 'world',\r\n        config: true,\r\n        name: game.i18n.localize(ANARCHY.settings.allowCoreFallback.name),\r\n        hint: game.i18n.localize(ANARCHY.settings.allowCoreFallback.hint),\r\n        default: false,\r\n        type: Boolean,\r\n      });\r\n      game.settings.register(SYSTEM_NAME, 'prefer-core-sheets', {\r\n        scope: 'client',\r\n        config: true,\r\n        name: game.i18n.localize(ANARCHY.settings.preferCoreSheets.name),\r\n        hint: game.i18n.localize(ANARCHY.settings.preferCoreSheets.hint),\r\n        default: false,\r\n        type: Boolean,\r\n      });\r\n    } catch (e) {\r\n      console.warn(LOG_HEAD + 'Settings registration failed', e);\r\n    }\r\n\r\n    // Register sheets as early and as safely as possible so we never fall back to core sheets\r\n    this.sheetsRegistered = false;\r\n    this._ensureSheetsWhenAvailable();\r\n\r\n    // Remaining feature initialization should not gate sheet availability\r\n    Checkbars.init();\r\n\r\n    WeaponItem.init();\r\n    DiceCursor.init();\r\n    RollDialog.init();\r\n    AttributeActions.init();\r\n    AnarchyCombat.init();\r\n    AnarchyUsers.init();\r\n    AnarchyDice.init();\r\n    AnarchyRoll.init();\r\n    AnarchyBaseItem.init();\r\n    AnarchyBaseActor.init();\r\n    ActorDamageManager.init();\r\n    ChatManager.init();\r\n    this.gmManager = new GMManager(this.gmAnarchy, this.gmConvergence);\r\n    console.log(LOG_HEAD + 'AnarchySystem.onInit | done');\r\n    try {\r\n      await loadIntegrationsIfEnabled();\r\n    } catch (e) {\r\n      console.warn(LOG_HEAD + 'Optional integrations failed to load. Continuing without them.', e);\r\n    }\r\n    Hooks.once('ready', () => this.onReady());\r\n\r\n    // Register unconditional render-safety to enforce Anarchy sheets\r\n    this._registerRenderSafety();\r\n\r\n    // Ensure newly created docs default to Anarchy sheets\r\n    this._registerCreationBias();\r\n\r\n    // Expose console commands for maintenance and diagnostics\r\n    this._registerConsoleCommands();\r\n  }\r\n\r\n  async onReady() {\r\n    console.log(LOG_HEAD + 'AnarchySystem.onReady');\r\n    // As a backstop, ensure sheets are registered if init-time registration raced core\r\n    if (!this.sheetsRegistered) {\r\n      this._ensureSheetsWhenAvailable();\r\n    }\r\n    \r\n    // Fix truncated sheet names and other database issues\r\n    await this._fixDatabaseCorruption();\r\n    \r\n    if (game.user.isGM) {\r\n      new Migrations().migrate();\r\n\r\n      // Optional safety migration: sweep world overrides pointing to core sheets\r\n      const DSC = foundry.applications.api.DocumentSheetConfig;\r\n      const ActorDoc = CONFIG.Actor.documentClass || Actor;\r\n      const ItemDoc = CONFIG.Item.documentClass || Item;\r\n      try {\r\n        // Set Anarchy Enhanced as world default for characters if not already\r\n        DSC.setDefaultSheet(ActorDoc, SYSTEM_NAME, CharacterEnhancedSheet);\r\n      } catch (_) {}\r\n\r\n      // Clear per-document overrides that point to core for active actors/items\r\n      try {\r\n        const actorUpdates = [];\r\n        for (const a of game.actors.contents) {\r\n          if (a.type === 'character') {\r\n            const current = a.getFlag('core', 'sheetClass');\r\n            const should = `${SYSTEM_NAME}.CharacterEnhancedSheet`;\r\n            if (!current || String(current).startsWith('core.')) {\r\n              actorUpdates.push(a.update({ 'flags.core.sheetClass': should }));\r\n            }\r\n          }\r\n        }\r\n        const itemUpdates = [];\r\n        for (const it of game.items.contents) {\r\n          const current = it.getFlag('core', 'sheetClass');\r\n          let desired = undefined;\r\n          switch (it.type) {\r\n            case 'contact':\r\n              desired = `${SYSTEM_NAME}.ContactItemSheet`;\r\n              break;\r\n            case 'cyberdeck':\r\n              desired = `${SYSTEM_NAME}.CyberdeckItemSheet`;\r\n              break;\r\n            case 'gear':\r\n              desired = `${SYSTEM_NAME}.GearItemSheet`;\r\n              break;\r\n            case 'metatype':\r\n              desired = `${SYSTEM_NAME}.MetatypeItemSheet`;\r\n              break;\r\n            case 'quality':\r\n              desired = `${SYSTEM_NAME}.QualityItemSheet`;\r\n              break;\r\n            case 'shadowamp':\r\n              desired = `${SYSTEM_NAME}.ShadowampItemSheet`;\r\n              break;\r\n            case 'skill':\r\n              desired = `${SYSTEM_NAME}.SkillItemSheet`;\r\n              break;\r\n            case 'weapon':\r\n              desired = `${SYSTEM_NAME}.WeaponItemSheet`;\r\n              break;\r\n          }\r\n          if (desired && (!current || String(current).startsWith('core.'))) {\r\n            itemUpdates.push(it.update({ 'flags.core.sheetClass': desired }));\r\n          }\r\n        }\r\n        await Promise.allSettled([...actorUpdates, ...itemUpdates]);\r\n      } catch (e) {\r\n        console.warn(LOG_HEAD + 'Sheet override cleanup skipped', e);\r\n      }\r\n    }\r\n  }\r\n\r\n  _registerRenderSafety() {\r\n    // Avoid infinite loops by tracking documents we already swapped in this tick\r\n    this._renderSafetySeen = new WeakSet();\r\n    const DSC = foundry.applications.api.DocumentSheetConfig;\r\n\r\n    const desiredActorSheetClassFor = (actor) => {\r\n      switch (actor.type) {\r\n        case 'character':\r\n          return CharacterEnhancedSheet;\r\n        case 'vehicle':\r\n          return VehicleSheet;\r\n        case 'device':\r\n          return DeviceSheet;\r\n        case 'sprite':\r\n          return SpriteActorSheet;\r\n        case 'ic':\r\n          return ICSheet;\r\n      }\r\n      return undefined;\r\n    };\r\n\r\n    const desiredItemSheetClassFor = (item) => {\r\n      switch (item.type) {\r\n        case 'contact':\r\n          return ContactItemSheet;\r\n        case 'cyberdeck':\r\n          return CyberdeckItemSheet;\r\n        case 'gear':\r\n          return GearItemSheet;\r\n        case 'metatype':\r\n          return MetatypeItemSheet;\r\n        case 'quality':\r\n          return QualityItemSheet;\r\n        case 'shadowamp':\r\n          return ShadowampItemSheet;\r\n        case 'skill':\r\n          return SkillItemSheet;\r\n        case 'weapon':\r\n          return WeaponItemSheet;\r\n      }\r\n      return undefined;\r\n    };\r\n\r\n    const swapToSheetIfNeeded = async (doc, app, desiredClass) => {\r\n      try {\r\n        if (!desiredClass) return;\r\n        if (app instanceof desiredClass) return; // already correct\r\n        if (this._renderSafetySeen.has(doc)) return; // prevent loop\r\n        this._renderSafetySeen.add(doc);\r\n\r\n        // Persist override so subsequent opens use Anarchy directly\r\n        const desiredName = `${SYSTEM_NAME}.${desiredClass.name}`;\r\n        try {\r\n          await doc.update({ 'flags.core.sheetClass': desiredName });\r\n        } catch (_) {}\r\n\r\n        // Close and reopen with the new sheet (explicitly instantiate to avoid registry timing issues)\r\n        try {\r\n          app.close({ force: true });\r\n        } catch (_) {}\r\n        // Using next frame prevents immediate re-entry\r\n        requestAnimationFrame(() => {\r\n          try {\r\n            new desiredClass(doc, {}).render(true);\r\n          } catch (_) {\r\n            try {\r\n              doc.sheet?.render(true);\r\n            } catch (_) {}\r\n          }\r\n        });\r\n        console.warn(LOG_HEAD + 'Render safety swapped sheet to Anarchy', {\r\n          doc: doc.name,\r\n          type: doc.type,\r\n          desired: desiredName,\r\n        });\r\n      } catch (e) {\r\n        console.warn(LOG_HEAD + 'Render safety swap failed', e);\r\n      } finally {\r\n        // allow future renders to evaluate again\r\n        setTimeout(() => this._renderSafetySeen.delete(doc), 0);\r\n      }\r\n    };\r\n\r\n    Hooks.on('renderActorSheet', (app) => {\r\n      const actor = app?.object;\r\n      if (!actor) return;\r\n      const desired = desiredActorSheetClassFor(actor);\r\n      swapToSheetIfNeeded(actor, app, desired);\r\n    });\r\n\r\n    Hooks.on('renderItemSheet', (app) => {\r\n      const item = app?.object;\r\n      if (!item) return;\r\n      const desired = desiredItemSheetClassFor(item);\r\n      swapToSheetIfNeeded(item, app, desired);\r\n    });\r\n  }\r\n\r\n  _ensureSheetsWhenAvailable() {\r\n    const attempt = () => {\r\n      try {\r\n        const DSC = foundry.applications?.api?.DocumentSheetConfig;\r\n        if (!DSC) return false;\r\n        if (this.sheetsRegistered) return true;\r\n        this.loadActorSheets();\r\n        this.loadItemSheets();\r\n        try {\r\n          const ActorDoc = CONFIG.Actor?.documentClass || Actor;\r\n          DSC.setDefaultSheet(ActorDoc, SYSTEM_NAME, CharacterEnhancedSheet);\r\n        } catch (_) {}\r\n        this.sheetsRegistered = true;\r\n        console.log(LOG_HEAD + 'Sheets registered');\r\n        return true;\r\n      } catch (e) {\r\n        console.error(LOG_HEAD + 'Failed to register sheets', e);\r\n        return false;\r\n      }\r\n    };\r\n\r\n    if (attempt()) return;\r\n    Hooks.once('setup', () => attempt() || Hooks.once('ready', attempt));\r\n  }\r\n\r\n  _registerCreationBias() {\r\n    const desiredActorSheetClassFor = (type) => {\r\n      switch (type) {\r\n        case 'character':\r\n          return CharacterEnhancedSheet;\r\n        case 'vehicle':\r\n          return VehicleSheet;\r\n        case 'device':\r\n          return DeviceSheet;\r\n        case 'sprite':\r\n          return SpriteActorSheet;\r\n        case 'ic':\r\n          return ICSheet;\r\n      }\r\n      return undefined;\r\n    };\r\n\r\n    const desiredItemSheetClassFor = (type) => {\r\n      switch (type) {\r\n        case 'contact':\r\n          return ContactItemSheet;\r\n        case 'cyberdeck':\r\n          return CyberdeckItemSheet;\r\n        case 'gear':\r\n          return GearItemSheet;\r\n        case 'metatype':\r\n          return MetatypeItemSheet;\r\n        case 'quality':\r\n          return QualityItemSheet;\r\n        case 'shadowamp':\r\n          return ShadowampItemSheet;\r\n        case 'skill':\r\n          return SkillItemSheet;\r\n        case 'weapon':\r\n          return WeaponItemSheet;\r\n      }\r\n      return undefined;\r\n    };\r\n\r\n    Hooks.on('preCreateActor', (doc, data, options, userId) => {\r\n      try {\r\n        const Desired = desiredActorSheetClassFor(data.type ?? doc.type);\r\n        if (!Desired) return;\r\n        const desiredName = `${SYSTEM_NAME}.${Desired.name}`;\r\n        doc.updateSource({ flags: { core: { sheetClass: desiredName } } });\r\n      } catch (_) {}\r\n    });\r\n\r\n    Hooks.on('preCreateItem', (doc, data, options, userId) => {\r\n      try {\r\n        const Desired = desiredItemSheetClassFor(data.type ?? doc.type);\r\n        if (!Desired) return;\r\n        const desiredName = `${SYSTEM_NAME}.${Desired.name}`;\r\n        doc.updateSource({ flags: { core: { sheetClass: desiredName } } });\r\n      } catch (_) {}\r\n    });\r\n\r\n    // Bias the generic create dialog toward Anarchy-supported types\r\n    Hooks.on('renderDocumentCreateDialog', (app, html, data) => {\r\n      try {\r\n        const isActor =\r\n          data?.documentClass?.name === (CONFIG.Actor?.documentClass?.name || 'Actor');\r\n        const isItem = data?.documentClass?.name === (CONFIG.Item?.documentClass?.name || 'Item');\r\n        if (!isActor && !isItem) return;\r\n        const select = html[0]?.querySelector?.('select[name=\"type\"]');\r\n        if (!select) return;\r\n        const preferredActorTypes = ['character', 'vehicle', 'device', 'sprite', 'ic'];\r\n        const preferredItemTypes = [\r\n          'contact',\r\n          'cyberdeck',\r\n          'gear',\r\n          'metatype',\r\n          'quality',\r\n          'shadowamp',\r\n          'skill',\r\n          'weapon',\r\n        ];\r\n        const preferred = isActor ? preferredActorTypes : preferredItemTypes;\r\n        const options = Array.from(select.options);\r\n        const firstPreferred = options.find((opt) => preferred.includes(opt.value));\r\n        if (firstPreferred) {\r\n          select.value = firstPreferred.value;\r\n          select.dispatchEvent(new Event('change', { bubbles: true }));\r\n        }\r\n      } catch (_) {}\r\n    });\r\n  }\r\n\r\n  _registerConsoleCommands() {\r\n    try {\r\n      const api = {\r\n        fixSheets: async () => await this.fixSheets(),\r\n        debugSheets: () => this.debugSheets(),\r\n      };\r\n      if (!window.anarchyUI) window.anarchyUI = {};\r\n      Object.assign(window.anarchyUI, api);\r\n      console.info(\r\n        LOG_HEAD + 'Console commands available: anarchyUI.fixSheets(), anarchyUI.debugSheets()',\r\n      );\r\n    } catch (_) {}\r\n  }\r\n\r\n  async _fixDatabaseCorruption() {\r\n    if (!game.user.isGM) return;\r\n    \r\n    console.log(LOG_HEAD + 'Checking for database corruption...');\r\n    let fixedCount = 0;\r\n    \r\n    // Fix truncated sheet names for actors\r\n    const actorUpdates = [];\r\n    const sheetNameMap = {\r\n      'anarchy.se': 'anarchy.CharacterEnhancedSheet',\r\n      'anarchy.Ch': 'anarchy.CharacterEnhancedSheet',\r\n      'anarchy.Cha': 'anarchy.CharacterEnhancedSheet',\r\n      'anarchy.Ve': 'anarchy.VehicleSheet',\r\n      'anarchy.De': 'anarchy.DeviceSheet',\r\n      'anarchy.Sp': 'anarchy.SpriteActorSheet',\r\n      'anarchy.IC': 'anarchy.ICSheet'\r\n    };\r\n    \r\n    for (const actor of game.actors.contents) {\r\n      const currentSheet = actor.getFlag('core', 'sheetClass');\r\n      if (currentSheet && sheetNameMap[currentSheet]) {\r\n        console.log(LOG_HEAD + `Fixing truncated sheet name for actor ${actor.name}: ${currentSheet} -> ${sheetNameMap[currentSheet]}`);\r\n        actorUpdates.push(actor.update({ \r\n          'flags.core.sheetClass': sheetNameMap[currentSheet] \r\n        }));\r\n        fixedCount++;\r\n      } else if (!currentSheet && actor.type === 'character') {\r\n        // Set default if missing\r\n        actorUpdates.push(actor.update({ \r\n          'flags.core.sheetClass': 'anarchy.CharacterEnhancedSheet' \r\n        }));\r\n        fixedCount++;\r\n      }\r\n    }\r\n    \r\n    // Fix item sheets if needed\r\n    const itemUpdates = [];\r\n    const itemSheetMap = {\r\n      'contact': 'anarchy.ContactItemSheet',\r\n      'cyberdeck': 'anarchy.CyberdeckItemSheet',\r\n      'gear': 'anarchy.GearItemSheet',\r\n      'metatype': 'anarchy.MetatypeItemSheet',\r\n      'quality': 'anarchy.QualityItemSheet',\r\n      'shadowamp': 'anarchy.ShadowampItemSheet',\r\n      'skill': 'anarchy.SkillItemSheet',\r\n      'weapon': 'anarchy.WeaponItemSheet'\r\n    };\r\n    \r\n    for (const item of game.items.contents) {\r\n      const currentSheet = item.getFlag('core', 'sheetClass');\r\n      const expectedSheet = itemSheetMap[item.type];\r\n      \r\n      if (expectedSheet && (!currentSheet || currentSheet.length < 20 || currentSheet.startsWith('core.'))) {\r\n        console.log(LOG_HEAD + `Fixing sheet for item ${item.name}: ${currentSheet || 'none'} -> ${expectedSheet}`);\r\n        itemUpdates.push(item.update({ \r\n          'flags.core.sheetClass': expectedSheet \r\n        }));\r\n        fixedCount++;\r\n      }\r\n    }\r\n    \r\n    // Apply all updates\r\n    if (actorUpdates.length || itemUpdates.length) {\r\n      await Promise.all([...actorUpdates, ...itemUpdates]);\r\n      console.log(LOG_HEAD + `Fixed ${fixedCount} corrupted sheet assignments`);\r\n      ui.notifications.info(`Anarchy System: Fixed ${fixedCount} corrupted sheet assignments`);\r\n    } else {\r\n      console.log(LOG_HEAD + 'No database corruption found');\r\n    }\r\n  }\r\n\r\n  async fixSheets() {\r\n    const DSC = foundry.applications.api.DocumentSheetConfig;\r\n    const summary = { actorsUpdated: 0, itemsUpdated: 0 };\r\n    try {\r\n      const ActorDoc = CONFIG.Actor.documentClass || Actor;\r\n      DSC.setDefaultSheet(ActorDoc, SYSTEM_NAME, CharacterEnhancedSheet);\r\n    } catch (_) {}\r\n    try {\r\n      const actorUpdates = [];\r\n      for (const a of game.actors.contents) {\r\n        const desired =\r\n          a.type === 'character' ? `${SYSTEM_NAME}.CharacterEnhancedSheet` : undefined;\r\n        if (!desired) continue;\r\n        const current = a.getFlag('core', 'sheetClass');\r\n        if (!current || String(current).startsWith('core.')) {\r\n          summary.actorsUpdated++;\r\n          actorUpdates.push(a.update({ 'flags.core.sheetClass': desired }));\r\n        }\r\n      }\r\n      const itemUpdates = [];\r\n      for (const it of game.items.contents) {\r\n        let desired = undefined;\r\n        switch (it.type) {\r\n          case 'contact':\r\n            desired = `${SYSTEM_NAME}.ContactItemSheet`;\r\n            break;\r\n          case 'cyberdeck':\r\n            desired = `${SYSTEM_NAME}.CyberdeckItemSheet`;\r\n            break;\r\n          case 'gear':\r\n            desired = `${SYSTEM_NAME}.GearItemSheet`;\r\n            break;\r\n          case 'metatype':\r\n            desired = `${SYSTEM_NAME}.MetatypeItemSheet`;\r\n            break;\r\n          case 'quality':\r\n            desired = `${SYSTEM_NAME}.QualityItemSheet`;\r\n            break;\r\n          case 'shadowamp':\r\n            desired = `${SYSTEM_NAME}.ShadowampItemSheet`;\r\n            break;\r\n          case 'skill':\r\n            desired = `${SYSTEM_NAME}.SkillItemSheet`;\r\n            break;\r\n          case 'weapon':\r\n            desired = `${SYSTEM_NAME}.WeaponItemSheet`;\r\n            break;\r\n        }\r\n        const current = it.getFlag('core', 'sheetClass');\r\n        if (desired && (!current || String(current).startsWith('core.'))) {\r\n          summary.itemsUpdated++;\r\n          itemUpdates.push(it.update({ 'flags.core.sheetClass': desired }));\r\n        }\r\n      }\r\n      await Promise.allSettled([...actorUpdates, ...itemUpdates]);\r\n    } catch (e) {\r\n      console.warn(LOG_HEAD + 'fixSheets encountered errors', e);\r\n    }\r\n    console.table(summary);\r\n    return summary;\r\n  }\r\n\r\n  debugSheets() {\r\n    try {\r\n      const defaults = {};\r\n      try {\r\n        const ActorDoc = CONFIG.Actor.documentClass || Actor;\r\n        const ItemDoc = CONFIG.Item.documentClass || Item;\r\n        // Best effort: Foundry API does not publicly expose defaults by type; report our intended targets\r\n        defaults.actor = { character: `${SYSTEM_NAME}.CharacterEnhancedSheet` };\r\n        defaults.item = {\r\n          contact: `${SYSTEM_NAME}.ContactItemSheet`,\r\n          cyberdeck: `${SYSTEM_NAME}.CyberdeckItemSheet`,\r\n          gear: `${SYSTEM_NAME}.GearItemSheet`,\r\n          metatype: `${SYSTEM_NAME}.MetatypeItemSheet`,\r\n          quality: `${SYSTEM_NAME}.QualityItemSheet`,\r\n          shadowamp: `${SYSTEM_NAME}.ShadowampItemSheet`,\r\n          skill: `${SYSTEM_NAME}.SkillItemSheet`,\r\n          weapon: `${SYSTEM_NAME}.WeaponItemSheet`,\r\n        };\r\n        console.info(LOG_HEAD + 'Intended Anarchy defaults', defaults, { ActorDoc, ItemDoc });\r\n      } catch (_) {}\r\n      const sampleActors = (game.actors?.contents || [])\r\n        .slice(0, 20)\r\n        .map((a) => ({ name: a.name, type: a.type, sheet: a.getFlag('core', 'sheetClass') }));\r\n      const sampleItems = (game.items?.contents || [])\r\n        .slice(0, 20)\r\n        .map((i) => ({ name: i.name, type: i.type, sheet: i.getFlag('core', 'sheetClass') }));\r\n      console.table(sampleActors);\r\n      console.table(sampleItems);\r\n      return { defaults, sampleActors, sampleItems };\r\n    } catch (e) {\r\n      console.warn(LOG_HEAD + 'debugSheets failed', e);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  loadActorSheets() {\r\n    const sheets = [\r\n      { class: CharacterActorSheet, types: ['character'], makeDefault: false, label: 'ANARCHY.actor.characterSheet' },\r\n      { class: CharacterNPCSheet, types: ['character'], makeDefault: false, label: 'ANARCHY.actor.characterNPCSheet' },\r\n      { class: CharacterTabbedSheet, types: ['character'], makeDefault: false, label: 'ANARCHY.actor.characterTabbedSheet' },\r\n      { class: CharacterEnhancedSheet, types: ['character'], makeDefault: true, label: 'ANARCHY.actor.characterEnhancedSheet' },\r\n      { class: VehicleSheet, types: ['vehicle'], makeDefault: true, label: 'ANARCHY.actor.vehicleSheet' },\r\n      { class: DeviceSheet, types: ['device'], makeDefault: true, label: 'ANARCHY.actor.deviceSheet' },\r\n      { class: SpriteActorSheet, types: ['sprite'], makeDefault: true, label: 'ANARCHY.actor.spriteSheet' },\r\n      { class: ICSheet, types: ['ic'], makeDefault: true, label: 'ANARCHY.actor.icSheet' }\r\n    ];\r\n\r\n    // Register sheets to CONFIG directly for V13\r\n    sheets.forEach(sheetConfig => {\r\n      sheetConfig.types.forEach(type => {\r\n        // Ensure CONFIG structure exists\r\n        if (!CONFIG.Actor.sheetClasses) CONFIG.Actor.sheetClasses = {};\r\n        if (!CONFIG.Actor.sheetClasses[type]) CONFIG.Actor.sheetClasses[type] = {};\r\n        if (!CONFIG.Actor.sheetClasses[type][SYSTEM_NAME]) CONFIG.Actor.sheetClasses[type][SYSTEM_NAME] = {};\r\n        \r\n        // Register the sheet\r\n        const sheetId = `${SYSTEM_NAME}.${sheetConfig.class.name}`;\r\n        CONFIG.Actor.sheetClasses[type][SYSTEM_NAME][sheetId] = {\r\n          id: sheetId,\r\n          cls: sheetConfig.class,\r\n          label: game.i18n.localize(sheetConfig.label),\r\n          canBeDefault: true,\r\n          canConfigure: true\r\n        };\r\n        \r\n        // Set as default if specified\r\n        if (sheetConfig.makeDefault) {\r\n          if (!game.settings.get('core', 'sheetClasses')?.Actor?.[type]) {\r\n            DocumentSheetConfig.updateDefaultSheets({\r\n              [`Actor.${type}`]: sheetId\r\n            });\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  loadItemSheets() {\r\n    const sheets = [\r\n      { class: ContactItemSheet, types: ['contact'], makeDefault: true },\r\n      { class: CyberdeckItemSheet, types: ['cyberdeck'], makeDefault: true },\r\n      { class: GearItemSheet, types: ['gear'], makeDefault: true },\r\n      { class: MetatypeItemSheet, types: ['metatype'], makeDefault: true },\r\n      { class: QualityItemSheet, types: ['quality'], makeDefault: true },\r\n      { class: ShadowampItemSheet, types: ['shadowamp'], makeDefault: true },\r\n      { class: SkillItemSheet, types: ['skill'], makeDefault: true },\r\n      { class: WeaponItemSheet, types: ['weapon'], makeDefault: true }\r\n    ];\r\n\r\n    // Register sheets to CONFIG directly for V13\r\n    sheets.forEach(sheetConfig => {\r\n      sheetConfig.types.forEach(type => {\r\n        // Ensure CONFIG structure exists\r\n        if (!CONFIG.Item.sheetClasses) CONFIG.Item.sheetClasses = {};\r\n        if (!CONFIG.Item.sheetClasses[type]) CONFIG.Item.sheetClasses[type] = {};\r\n        if (!CONFIG.Item.sheetClasses[type][SYSTEM_NAME]) CONFIG.Item.sheetClasses[type][SYSTEM_NAME] = {};\r\n        \r\n        // Register the sheet\r\n        const sheetId = `${SYSTEM_NAME}.${sheetConfig.class.name}`;\r\n        CONFIG.Item.sheetClasses[type][SYSTEM_NAME][sheetId] = {\r\n          id: sheetId,\r\n          cls: sheetConfig.class,\r\n          label: `${type.charAt(0).toUpperCase()}${type.slice(1)} Sheet`,\r\n          canBeDefault: true,\r\n          canConfigure: true\r\n        };\r\n        \r\n        // Set as default if specified\r\n        if (sheetConfig.makeDefault) {\r\n          if (!game.settings.get('core', 'sheetClasses')?.Item?.[type]) {\r\n            DocumentSheetConfig.updateDefaultSheets({\r\n              [`Item.${type}`]: sheetId\r\n            });\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n","import { AnarchySystem } from './modules/anarchy-system.js';\n\nAnarchySystem.start();\n\nimport './styles/global.scss';\n"],"names":["ANARCHY","_Misc","orderFunction","x","a","b","sortedArray","it","map","compareFunction","obj","key","list","index","array","value","t","v","divisor","params","separator","items","classifier","itemsBy","item","classification","control","condition","min","max","__publicField","Misc","actorWordTypes","_Enums","filterAttributes","withKnowledge","wordType","attribute","keyName","valueName","found","m","object","entry","ret","Enums","SYSTEM_NAME","SYSTEM_DESCRIPTION","SYSTEM_SOCKET","SYSTEM_SCOPE","SYSTEM_PATH","STYLE_PATH","TEMPLATES_PATH","ICONS_PATH","ICONS_SKILLS_PATH","LOG_HEAD","ANARCHY_DICE_BONUS","SPECIALIZATION_BONUS","PLAYER_MAX_ANARCHY","TARGET_SUCCESS","TARGET_SUCCESS_EDGE","BASE_MONITOR","TEMPLATE","ANARCHY_SYSTEM","ErrorManager","resource","required","available","error","expectedType","damageType","monitor","actor","weapon","maxTargets","targets","area","actorAction","defense","BLIND_MESSAGE_TO_GM","AnarchyUsers","RemoteCall","data","user","message","filter","u","document","sockMsg","msg","remoteCall","userMatchCondition","isMultiple","isSelectedGM","PARENT_MESSAGE_ID","MESSAGE_DATA","CAN_USE_EDGE","OWNING_ACTOR","REMOVE_CHAT_MESSAGE","CHAT_MANAGER_REMOVE_FAMILY","CHAT_MESSAGE_BUTTON_HANDLERS","chatMsg","event","ChatManager","app","html","chatMessage","showButtons","jQueryButtonSelector","_a","img","tokenId","token","actorId","rollData","chatMessageId","flags","right","flag","flagOwner","neededRights","s","faClassD6","Icons","faClass","src","cssClasses","dice","MONITORS","COUNTERS","DEFAULT_CHECKBARS","CHECKBARS","Checkbars","overrides","newBar","checked","_b","target","sourceActorId","current","checkbar","overflowMonitor","overflow","newValue","previous","marks","sourceActorMarks","source","GM_ANARCHY","GM_SCENE_ANARCHY","GM_ADD_ANARCHY","GMAnarchy","count","newAnarchy","isChecked","linkedActors","unlinkedActors","HandleDragApplication","getDocElement","options","newPosition","element","e","newElementPos","application","resolve","check","position","GM_DIFFICULTY_POOLS","SYSTEM_KEY_GM_DIFFICULTY_POOL","GMDifficulty","setting","update","id","kv","pool","difficulty","roll","flavor","GM_MANAGER","GM_MANAGER_POSITION","GM_MANAGER_INITIAL_POSITION","GM_MANAGER_TEMPLATE","GMManager","gmAnarchy","gmConvergence","doc","templatePath","templateData","templateHTML","template","ones","force","action","code","attributeFunction1","attributeFunction2","icon","actorTypes","__","actionCode","ATTR","ACTOR","ACTION","DEFENSE","ATTRIBUTE_ACTIONS","___","DEFENSES","AttributeActions","defenseCode","NO_MATRIX_MONITOR","MATRIX","Matrix","connectionMode","SHADOWAMP_TYPES","Modifiers","group","effect","category","select","attr","actions","context","contextFilter","itemModifiers","im","sumShadowamp","sumOthers","shadowampModifiers","maxPositive","negative","positive","modifier","DICE_FAS_ICONS","DiceCursor","editable","fasSource","fasArray","CharacterActorEssence","essence","ANARCHY_HOOKS","SETTING_KEY_ANARCHY_HACK","SHADOWRUN_ANARCHY_NO_HACK","HooksManager","register","provide","hack","selectedHack","hookMethod","callback","fallback","args","method","name","ROLL_PARAMETER_CATEGORY","DEFAULT_ROLL_PARAMETERS","p","selected","RollParameters","wounds","glitchModifiers","reduced","rerollForced","parameter","rollParameter","templates","hbsTemplate","parameters","actual","byCategory","sums","registeredParameter","param","computed","itemsFilter","RollDialog","skill","specialization","targeting","attack","pilot","rollParameters","attributeName","title","config","clickedValue","diceCursorHtml","itemId","SELECTED_SKILL_LIST","SETTING_KEY_SELECTED_SKILL_LIST","DEFAULT_SKILLSET_ANARCHY","KNOWLEDGE","ANARCHY_SKILLS","MATRIX_SKILLS","Skills","skills","details","skillSet","skillSetChoices","existing","skillCodes","DAMAGE_MODE","SETTING_KEY_DAMAGE_MODE","damageModeChoices","damageModeMethods","ActorDamageManager","labelkey","damageModeCode","defender","damage","success","avoidArmor","attacker","attackWeapon","sourceActor","resistance","total","resisted1","resisted2","ignoredArmor","armorResistance","armorMax","armor","armorReduction","armorDmg","armorDamage","strength","AnarchyBaseActor","updates","docData","ActorConstructor","skilla","skillb","skillaIsKnowledge","skillbIsKnowledge","skillATotal","skillBTotal","qualities","qa","qb","shadowamps","sa","sb","buttons","permission","matrix","matrixDetails","mode","cyberdeck","path","attributeValue","itemsAttributes","usableAttributes","candidateItems","candidateValues","_c","targetedTokenIds","drain","convergence","sceneAnarchy","anarchy","skillId","metatype","metatypeIds","ownerActor","attachOrCopy","actorToAttach","cloneTmp","type","search","f1","f2","setFavorite","favorite","newFavorites","f","shortcut","ConfirmationDialog","onConfirm","owner","owned","onAttach","onAttachCopy","SelectActor","actors","onActorSelected","onCancel","dialogOptions","dialogConfig","AnarchyActorSheet","startTime","hbsData","renderTime","inactive","handler","ownedActorId","itemType","newState","drag","dropActor","actionTime","field","button","input","label","el","skipLinks","content","tabs","focusableElements","firstFocusable","lastFocusable","uiCustomization","CharacterBaseSheet","newWordValue","word","CharacterEnhancedSheet","sectionClass","sectionName","option","Damage","Grammar","words","AnarchyBaseItem","ItemConstructor","checkbarPath","values","modifierId","modifiers","impact","updateFunction","mutation","SkillItem","skillCode","AREA_TARGETS","WEAPON_RANGE_PARAMETER","ranges","rangeValues","WEAPON_AREA_PARAMETER","countTargets","areaModifier","WeaponItem","actorSkill","worldSkill","damageAttributeValue","damageAttribute","actorAttribute","noArmor","range","validTargets","invalidTargets","areaTargets","HBS_PARTIAL_TEMPLATES","HandlebarsManager","str","from","to","v1","v2","i","threshold","start","end","accum","DEFAULT_CSS_CLASS","CSS_DEFAULT","DEFAULT_STYLES","Styles","style","cssClass","ThemeUtilities","stylesManager","themeId","theme","originalTheme","analysis","combo","bgColor","fgColor","ratio","color1","color2","luminance1","luminance2","lighter","darker","color","match","themeClass","iterations","measurements","endTime","allThemes","variableSets","variables","allVariables","vars","variable","themeVars","totalVariableInstances","baseThemeId","variantName","colorModifications","baseTheme","variantId","variant","accessibilityOptions","results","validation","contrastAnalysis","customizations","report","recommendations","perf","themeData","themeId1","themeId2","theme1","theme2","comparison","perf1","perf2","slower","_UICustomization_instances","probeImages_fn","UICustomization","__privateAdd","layoutPrefs","hudCustomization","visualCustomization","componentVisibility","advancedSettings","root","base","dir","candidates","probeUrls","n","__privateMethod","chosen","cssValue","layout","widthMap","heightMap","visual","fontSizeMap","iconSizeMap","spacingMap","radiusMap","shadowMap","animationMap","components","visible","className","hud","hudSizeMap","gmManager","shortcuts","advanced","component","styles","property","colorVar","settingKey","currentSettings","fontScale","iconScale","spacingScale","duration","hudScale","presetId","preset","settingValue","css","existingStyle","settings","prop","customizationVars","varName","cls","urls","checks","ok","r","idx","UICustomizationDialog","dialogData","tabId","formData","previewArea","categorySettings","exportData","dataStr","blob","url","link","file","reader","importData","UICustomizationCommands","size","spacing","speed","urlOrName","validSizes","validSpacing","validSpeeds","componentKey","validPositions","commands","cmd","actorCount","itemCount","actorUpdates","desired","itemUpdates","_d","_e","_f","_g","_h","DSC","ActorDoc","ItemDoc","actorSheets","sheets","itemSheets","sampleActors","sheetClass","sheetConstructor","sampleItems","PerformanceOptimizer","cssText","allSelectors","selector","elements","unusedCount","totalCount","removalPercentage","criticalCSS","criticalStyle","criticalRules","filename","currentTheme","lazyComponents","observer","entries","originalRender","reportThreshold","result","mutations","currentCount","optimization","currentSize","estimatedMinifiedSize","cacheStrategy","componentName","btn","cssSize","selectorCount","stylesheets","stylesheet","rule","selectorRegex","selectors","usedSelectors","cleanSelector","opt","unusedPercentage","GLITCH_COLORSET","RISK_COLORSET","REROLL_COLORSET","REROLL_REMOVED_COLORSET","REMOVED_COLORSET","DICE_GLITCH","DICE_PROWESS","_AnarchyDice","AnarchyGlitchDie","AnarchyRiskDie","dice3d","colorset","AnarchyDice","term","ROLL_THEME","DEFAULT_ROLL_RESULT","AnarchyRoll","rerolls","removed","messageData","rolls","SYSTEM_MIGRATION_CURRENT_VERSION","Migration","computeUpdates","actorItemUpdates","_0_3_1_MigrationMoveWordsInObjects","k","_0_3_8_MigrateWeaponDamage","isStrengthDamageItem","fixItemDamage","_0_3_14_MigrateSkillDrainConvergence","withDrain","hasDrain","setDrain","withConvergence","hasConvergence","setConvergence","_0_4_0_SelectWeaponDefense","findWeaponSkillWithDefense","setDefense","_0_5_0_MigrationBaseResistanceIsZero","_0_6_0_MigrateSkillSocial","socialSkills","isSocial","setSocial","_11_1_0_MigrateAndWarnAboutDefenseModifiers","actualUpdates","itemNotes","addNote","d","newModifiers","oldDefense","actionAttributes","other","_11_1_9_MigrateVehicleHandlingToAttribute","_11_1_12_MigrateBackWords","_11_1_16_MigrateSkillsAttributes","_12_0_1_MigrateChatMessageFlags","json","_12_0_4_MigrateWeaponDrain","Migrations","addMigrations","currentVersion","migrations","addedMigrations","HBS_TEMPLATE_CHAT_CELEBRITY_ROLL","RollCelebrity","hbsCelebrityRoll","HBS_TEMPLATE_ACTOR_DRAIN","HBS_TEMPLATE_ACTOR_SAY_WORD","CharacterActor","maxMonitor","dead","ko","baseEssence","spentEssence","essenceAdjustment","newConnectionMode","added","wordId","wordsToSay","updated","deletedId","mutate","newValues","currentAnarchy","useSceneAnarchy","useAnarchy","rollDrain","DEVICE_ATTRIBUTES","DeviceActor","VEHICLE_ATTRIBUTES","VehicleActor","selectedActors","character","vehicleOwner","fromAttribute","fromOldField","CharacterActorSheet","DeviceSheet","VehicleSheet","CharacterNPCSheet","MetatypeItem","CyberdeckItem","BaseItemSheet","validItemTypes","actorAttributes","usableAttribute","ContactItemSheet","CyberdeckItemSheet","GearItemSheet","MetatypeItemSheet","QualityItemSheet","ShadowampItemSheet","SkillItemSheet","WeaponItemSheet","ContactItem","GearItem","QualityItem","ShadowampItem","CONVERGENCES","SETTING_KEY_CONVERGENCES","ROLL_CONVERGENCE","HBS_TEMPLATE_CONVERGENCE","HBS_TEMPLATE_CONVERGENCE_ACTORS","GMConvergence","rollConvergence","newConvergence","c","actorsConvergence","AnarchyCombat","combatant","combat","ids","selectedCombatants","combatantsByType","typeActorClass","typeIds","typeOptions","ICSheet","SpriteActorSheet","SPRITE_ATTRIBUTES","SpriteActor","IC_ATTRIBUTES","ICActor","TEMPLATE_HUD_SHORTCUTS","HUDShortcuts","tokenHUD","tokenHUDData","hbsHudData","shortcutType","shortcutId","Tokens","scene","HBS_TEMPLATE_CHAT_ANARCHY_ROLL","HBS_CHAT_TEMPLATES","RollManager","hbsRoll","rollMessage","built","initial","TEMPLATE_INFORM_DEFENDER","CombatManager","defenderTokenId","attackRoll","attackerTokenId","defenseRoll","defensePilotRoll","attackHits","defenseHits","actionChatMessageIds","notifyMessage","defenseChoiceChatMessage","attackChatMessageId","attackChatMessage","CharacterTabbedSheet","resolveIntegrationsEnabled","env","__vite_import_meta_env__","explicit","loadIntegrationsIfEnabled","AnarchySystem","anarchySystem","should","desiredActorSheetClassFor","desiredItemSheetClassFor","swapToSheetIfNeeded","desiredClass","desiredName","attempt","userId","Desired","isActor","isItem","preferred","firstPreferred","api","fixedCount","sheetNameMap","currentSheet","itemSheetMap","expectedSheet","summary","defaults","sheetConfig","sheetId"],"mappings":"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"}